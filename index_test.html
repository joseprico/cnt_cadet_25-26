<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Estad√≠sticas - CN Terrassa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        /* Ajustes espec√≠ficos para gr√°ficos en m√≥vil */
@media (max-width: 768px) {
    /* Gr√°fico de Heatmap de Titularidades */
    #titularityHeatmapChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
   #totalTimeChart {
        min-height: 500px !important;
        max-height: 700px !important;
    } 
    /* Gr√°fico de Consistencia */
    #consistencyChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
    
    /* Contenedores de canvas para gr√°ficos horizontales */
    .card canvas[id$="Chart"] {
        min-height: 300px !important;
    }
}
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .tabs { gap: 8px; padding: 8px; }
            .tab { 
                padding: 10px 8px; 
                font-size: 13px;
                min-width: 100px;
            }
        }
        .tab.active { background: #06b6d4; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .team-score { text-align: center; }
        .team-name { font-size: 24px; font-weight: bold; color: #67e8f9; margin-bottom: 10px; }
        .score { font-size: 64px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .separator { font-size: 48px; font-weight: bold; color: #67e8f9; }
        
        @media (max-width: 768px) {
            .scoreboard { gap: 15px; padding: 15px; }
            .team-name { font-size: 18px; }
            .score { font-size: 48px; }
            .separator { font-size: 36px; }
        }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #22d3ee; }
        .periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .period-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .period-label { font-size: 14px; color: #bae6fd; margin-bottom: 8px; }
        .period-score { font-size: 32px; font-weight: bold; color: #fde047; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        .player-stat {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .player-stat {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            .player-info { margin-bottom: 8px; }
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-num {
            background: #06b6d4;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .player-num.rival { background: #ef4444; }
        .player-name { font-weight: 600; }
        .player-stats { display: flex; gap: 15px; font-size: 18px; font-weight: bold; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #bae6fd; }
        .stat-value { color: #fde047; }
        .lineup-section { margin-bottom: 20px; }
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .lineup-player {
            background: rgba(34, 197, 94, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid #22c55e;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; }
        .observations {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .btn {
            padding: 12px 24px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #0891b2; }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #bae6fd;
        }
        .hidden { display: none; }
        .top-scorers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-scorer-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank {
            background: #fbbf24;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rank.gold { background: #fbbf24; }
        .rank.silver { background: #d1d5db; }
        .rank.bronze { background: #d97706; }
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .match-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
            flex-wrap: wrap;
        }
        .match-item:hover { background: rgba(0,0,0,0.3); }
        .match-info { flex: 1; min-width: 200px; }
        
        @media (max-width: 768px) {
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            .match-info { width: 100%; }
            .match-score { margin: 10px 0 0 0 !important; }
        }
        .match-date { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .match-teams { font-size: 16px; font-weight: bold; }
        .match-score { font-size: 24px; font-weight: bold; color: #fde047; margin: 0 15px; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .comparison-table th {
            background: rgba(0,0,0,0.3);
            color: #22d3ee;
            font-weight: bold;
        }
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
            }
        }
        .win { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .draw { color: #fbbf24; font-weight: bold; }
        .titular-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .titular-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            canvas {
                max-height: 250px !important;
            }
        }
        .titular-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .titular-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .titular-quarters {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
		.match-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}

.team-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.team-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: bold;
}

.score {
    font-size: 48px;
    font-weight: bold;
    color: #fde047;
}

.vs {
    font-size: 24px;
    font-weight: bold;
    color: rgba(255,255,255,0.6);
}
        .quarter-badge {
            background: rgba(6, 182, 212, 0.3);
            border: 2px solid #06b6d4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .total-badge {
            background: #fbbf24;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #22d3ee;
        }
        .filter-bar {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                padding: 12px;
                gap: 10px;
            }
            .filter-item { width: 100%; }
            .filter-input { width: 100%; }
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            color: #bae6fd;
        }
        .filter-input {
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    color: white;
    font-size: 14px;
}
.timeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.timeline-item {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
}
.timeline-item.water-change {
    border-left-color: #06b6d4;
}

.timeline-item.goal {
    border-left-color: #22c55e;
}

.timeline-item.exclusion {
    border-left-color: #f97316;
}

.timeline-item.penalty-missed {
    border-left-color: #ef4444;
}

.timeline-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}

.timeline-player {
    font-weight: bold;
    color: #22d3ee;
}

.timeline-detail {
    font-size: 12px;
    color: #bae6fd;
    margin-top: 2px;
}

.timeline-quarter {
    background: rgba(6, 182, 212, 0.3);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #67e8f9;
    font-weight: bold;
    border: 1px solid #22d3ee;
    flex-shrink: 0;
}

.timeline-rival {
    color: #fca5a5;
}

.no-timeline {
    text-align: center;
    padding: 40px 20px;
    color: #bae6fd;
    font-size: 14px;
}
.filter-input:focus {
    outline: none;
    border-color: #22d3ee;
}
.filter-input option {
    background: #1e3a8a;
    color: white;
}
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .stats-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
        }
        .breakdown-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .breakdown-label {
            font-size: 11px;
            color: #bae6fd;
            margin-bottom: 5px;
        }
        .breakdown-value {
            font-size: 20px;
            font-weight: bold;
            color: #fde047;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
    <div style="position: absolute; top: 0; right: 0; font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">
        by Josep Rico
    </div>
    <h1>üìä Estad√≠sticas CN Terrassa</h1>
    <p>Juvenil 25/26</p>
</div>

        <!-- TABS SIEMPRE VISIBLES -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('list')">üìã Lista de Partidos</button>
            <button class="tab" onclick="showTab('comparison')">üìä Comparaci√≥n</button>
            <button class="tab" onclick="showTab('titular')">üë• Titularidad</button>
			<button class="tab" onclick="showTab('tiempo')">‚è±Ô∏è Tiempo de Juego</button>
        </div>
        </div>

        <!-- TAB: LISTA DE PARTIDOS -->
        <div id="listTab">
            <div id="loadingMatches" class="loading">
                Cargando partidos...
            </div>

            <div id="matchesView" class="hidden">
                <div class="card">
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="filter-label">Buscar rival</label>
                            <input type="text" class="filter-input" id="filterRival" placeholder="Nombre del rival..." onkeyup="filterMatches()">
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Resultado</label>
                            <select class="filter-input" id="filterResult" onchange="filterMatches()">
                                <option value="">Todos</option>
                                <option value="win">Victorias</option>
                                <option value="loss">Derrotas</option>
                                <option value="draw">Empates</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Ordenar por</label>
                            <select class="filter-input" id="sortBy" onchange="filterMatches()">
                                <option value="date-desc">Fecha (m√°s reciente)</option>
                                <option value="date-asc">Fecha (m√°s antiguo)</option>
                                <option value="score-desc">M√°s goles</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Partidos Disponibles</h2>
                    <div class="matches-list" id="availableMatches"></div>
                </div>
            </div>
	</div>
<!-- TAB: TIEMPO DE JUEGO -->
<div id="tiempoTab" class="hidden">
<div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTimePDF()" style="background: #8b5cf6; padding: 12px 20px;">
            üìÑ Generar PDF Temps de Joc
        </button>
    </div>
    <!-- Filtro por jugador -->
    <div class="card">
        <div class="filter-bar">
            <div class="filter-item">
                <label class="filter-label">Filtrar por jugador</label>
                <select class="filter-input" id="filterPlayerTime" onchange="filterByPlayerTime()">
                    <option value="">Todos los jugadores</option>
                </select>
            </div>
            <button class="btn" onclick="clearPlayerTimeFilter()" style="margin-top: 20px;">Limpiar filtro</button>
        </div>
    </div>

    <!-- Estad√≠sticas individuales del jugador seleccionado -->
    <div id="playerTimeStatsCard" class="card hidden">
        <h2 class="section-title">‚è±Ô∏è Estad√≠sticas de Tiempo - <span id="selectedPlayerTimeName"></span></h2>
        <div class="info-grid" id="playerTimeSummaryGrid"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">üìà Evoluci√≥n del Tiempo por Partido</h3>
        <canvas id="playerTimeEvolutionChart" style="max-height: 300px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">üî• Tiempo por Cuarto (Todos los Partidos)</h3>
        <canvas id="playerTimeByQuarterChart" style="max-height: 250px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">‚ö° Eficiencia por Minuto</h3>
        <div class="stats-breakdown" id="playerEfficiencyBreakdown"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">üìä Rendimiento: Titular vs Suplente</h3>
        <div class="info-grid" id="playerTitularVsSuplenteGrid"></div>
    </div>

    <!-- Separador -->
    <div style="margin: 40px 0 30px 0; text-align: center;">
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
        <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
            üìä Estad√≠sticas del Equipo
        </h2>
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
    </div>

    <!-- 1. Tiempo Total por Jugador -->
    <div class="card">
        <h2 class="section-title">üìä Tiempo Total Jugado por Jugador</h2>
        <p id="timeChartSubtitle" style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Cargando...
        </p>
        <canvas id="totalTimeChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 2. Heatmap de Tiempo por Cuarto -->
    <div class="card">
        <h2 class="section-title">üî• Heatmap: Tiempo por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="timeHeatmapTable"></table>
        </div>
    </div>

  
    <!-- 4. Distribuci√≥n de Minutos (Pastel) -->
    <div class="card">
        <h2 class="section-title">ü•ß Distribuci√≥n de Minutos del Equipo</h2>
        <canvas id="minutesDistributionChart" style="max-height: 350px;"></canvas>
    </div>

    <!-- 5. Plus/Minus por Jugador -->
    <div class="card">
        <h2 class="section-title">üìà Plus/Minus cuando est√° en el Agua</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Diferencia de goles (a favor - en contra) cuando el jugador est√° jugando
        </p>
        <canvas id="plusMinusChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 6. Balance de Carga -->
    <div class="card">
        <h2 class="section-title">‚öñÔ∏è Balance de Carga del Equipo</h2>
        <div class="info-grid" id="loadBalanceGrid"></div>
        <canvas id="loadBalanceChart" style="max-height: 250px; margin-top: 20px;"></canvas>
    </div>

    <!-- 7. An√°lisis por Cuarto -->
    <div class="card">
        <h2 class="section-title">üìä An√°lisis de Rotaci√≥n por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="quarterAnalysisTable"></table>
        </div>
    </div>

    <!-- 8. Rendimiento vs Tiempo (Dispersi√≥n) -->
    <div class="card">
        <h2 class="section-title">üéØ Rendimiento del Equipo vs Tiempo Jugado</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¬øEl equipo rinde mejor cuando ciertos jugadores juegan m√°s?
        </p>
        <canvas id="performanceVsTimeChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 9. An√°lisis de Fatiga -->
    <div class="card">
        <h2 class="section-title">üòì An√°lisis de Fatiga</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Comparaci√≥n de rendimiento: Primer cuarto vs √öltimo cuarto
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="fatigueAnalysisTable"></table>
        </div>
    </div>

    <!-- 10. Promedio de Rotaci√≥n -->
    <div class="card">
        <h2 class="section-title">üîÑ Estad√≠sticas de Rotaci√≥n</h2>
        <div class="info-grid" id="rotationStatsGrid"></div>
    </div>
</div>
            <!-- Vista de partido individual -->
            <div id="singleMatchView" class="hidden">
                <div class="card">
                    <button class="btn" onclick="backToList()" style="margin-bottom: 20px;">‚Üê Volver a la lista</button>
    <button class="btn" onclick="generateMatchPDF(currentMatch)" style="background: #8b5cf6; padding: 12px 20px; margin-bottom: 15px;">
            üìÑ Generar PDF d'aquest Partit
        </button>
    <div class="card">
        <div class="match-header">
            <div class="team-section">
                <h2>CN Terrassa</h2>
                <div class="score" id="scoreCNT">0</div>
            </div>
            <div class="vs">VS</div>
            <div class="team-section">
                <h2 id="teamRival">RIVAL</h2>
                <div class="score" id="scoreRival">0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">‚ÑπÔ∏è Informaci√≥n del Partido</h2>
        <div id="matchInfo"></div>
    </div>

    <div class="card">
        <h2 class="section-title">‚öΩ Desglose de Goles CN Terrassa</h2>
        <div class="stats-breakdown" id="goalsScoredBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">ü•Ö Desglose de Goles Recibidos</h2>
        <div class="stats-breakdown" id="goalsReceivedBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">üü• Desglose de Exclusiones</h2>
        <div class="stats-breakdown" id="exclusionsBreakdown"></div>
    </div>
	
                    
    <div class="card">
    <h2 class="section-title">üìä Estad√≠sticas Completas del Partido</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="singleMatchStatsTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
        <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">‚≠ê Criteris de Valoraci√≥ MVP</h3>
        <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
            <strong style="color: #22c55e;">Accions Positives:</strong><br>
            ‚Ä¢ Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
            ‚Ä¢ Assist√®ncia: +1 | Robatori: +1 | Blocatge: +1 | Parada: +2 | Falta rebuda: +1<br><br>
            <strong style="color: #ef4444;">Accions Negatives:</strong><br>
            ‚Ä¢ Exclusi√≥ (normal o penalty): -1 | Penalty fallat: -2 | P√®rdua: -0.5 | Tir fallat: -0.5
        </div>
    </div>
</div>

                
                <div class="card">
                    <h2 class="section-title">üìà Evoluci√≥n del Marcador por Cuartos</h2>
                    <canvas id="scoreEvolutionChart" style="max-height: 300px;"></canvas>
                </div>
    <div class="card">
                    <h2 class="section-title">Alineaciones por Cuarto</h2>
                    <div id="lineupsContainer"></div>
                </div>
               
                <div class="card">
                    <h2 class="section-title">‚öñÔ∏è Balance Ofensivo vs Defensivo</h2>
                    <canvas id="offenseDefenseChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card">
                    <h2 class="section-title">üë• Eficiencia por Jugador (Goles vs Exclusiones)</h2>
                    <canvas id="playerEfficiencyChart" style="max-height: 350px;"></canvas>
                </div>

                 <div class="card">
                    <h2 class="section-title">Estad√≠sticas CN Terrassa</h2>
                    <div class="stats-grid" id="statsCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estad√≠sticas Rival</h2>
                    <div class="stats-grid" id="statsRival"></div>
                </div>
<div class="card">
    <h2 class="section-title">‚è±Ô∏è Temps de Joc per Jugador</h2>
    <div id="playingTimesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">üß§ Parades dels Porters</h2>
    <canvas id="goalkeeperSavesChart" style="max-height: 300px;"></canvas>
</div>
            

                <div class="card">
                    <h2 class="section-title">Observaciones</h2>
                    <div class="observations" id="observations">No hay observaciones</div>
                </div>
				<div class="card">
    <h2 class="section-title">üìã Cronolog√≠a del Partido</h2>
    <div id="matchTimeline"></div>
</div>
            </div>
        </div>

      <!-- TAB: COMPARACI√ìN -->
<div id="comparisonTab" class="hidden">
    <div id="comparisonView">
	<div style="margin-bottom: 20px;">
            <button class="btn" onclick="generateGeneralPDF()" style="background: #8b5cf6; padding: 12px 20px;">
                üìÑ Generar PDF General
            </button>
        </div>
        <div class="card">
            <div class="filter-bar">
                <div class="filter-item">
                    <label class="filter-label">Filtrar por jugador</label>
                    <select class="filter-input" id="filterPlayer" onchange="filterByPlayer()">
                        <option value="">Todos los jugadores</option>
                    </select>
                </div>
                <button class="btn" onclick="clearPlayerFilter()" style="margin-top: 20px;">Limpiar filtro</button>
            </div>
        </div>

        <div id="playerStatsCard" class="card hidden">
            <h2 class="section-title">üìä Estad√≠sticas de <span id="selectedPlayerName"></span></h2>
            <div class="info-grid" id="playerSummaryGrid"></div>
            
            <h3 class="section-title" style="margin-top: 20px;">üìà Evoluci√≥n por Partido</h3>
            <canvas id="playerEvolutionChart" style="max-height: 300px;"></canvas>
            
            <h3 class="section-title" style="margin-top: 20px;">‚öΩ Desglose de Goles</h3>
            <div class="stats-breakdown" id="playerGoalsBreakdown"></div>
            
            <h3 class="section-title" style="margin-top: 20px;">üü• Exclusiones por Partido</h3>
            <canvas id="playerExclusionsChart" style="max-height: 250px;"></canvas>
        </div>

        <div class="card">
            <h2 class="section-title">Resumen de Resultados</h2>
            <div class="info-grid" id="summaryGrid"></div>
        </div>
		

        <!-- Separador entre estad√≠sticas individuales y de equipo -->
        <div style="margin: 40px 0 30px 0; text-align: center;">
            <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
            <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
                üìä Estad√≠sticas del Equipo
            </h2>
            <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
        </div>
		<!-- NUEVO: Evoluci√≥n de Resultados -->
        <div class="card">
            <h2 class="section-title">üìà Evoluci√≥n de Resultados</h2>
            <canvas id="resultsEvolutionChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- NUEVO: Diferencia de Goles por Cuarto -->
        <div class="card">
            <h2 class="section-title">‚ö° Diferencia de Goles por Cuarto</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                Promedio de diferencia (Goles a favor - Goles en contra) en cada cuarto
            </p>
            <canvas id="quarterDifferenceChart" style="max-height: 250px;"></canvas>
        </div>

        <!-- NUEVO: Mejores y Peores Partidos -->
        <div class="card">
            <h2 class="section-title">üèÜ Mejores y Peores Partidos</h2>
            <div class="info-grid" id="bestWorstGrid"></div>
        </div>

        <!-- NUEVO: Historial contra Rivales -->
        <div class="card">
            <h2 class="section-title">üéØ Historial contra Rivales</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="rivalsHistoryTable"></table>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Desglose de Goles (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Goles Recibidos (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsReceivedBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Exclusiones (Total)</h2>
            <div class="stats-breakdown" id="totalExclusionsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">ü•ß Distribuci√≥n de Goles por Jugador</h2>
            <canvas id="goalsDistributionChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
    <h2 class="section-title">üìä Comparaci√≥n de Estad√≠sticas</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="comparisonTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
        <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">‚≠ê Criteris de Valoraci√≥ MVP</h3>
        <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
            <strong style="color: #22c55e;">Accions Positives:</strong><br>
            ‚Ä¢ Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
            ‚Ä¢ Assist√®ncia: +1 | Robatori: +1 | Blocatge: +1 | Parada: +2 | Falta rebuda: +1<br><br>
            <strong style="color: #ef4444;">Accions Negatives:</strong><br>
            ‚Ä¢ Exclusi√≥ (normal o penalty): -1 | Penalty fallat: -2 | P√®rdua: -0.5 | Tir fallat: -0.5
        </div>
    </div>
</div>

        <div class="card">
            <h2 class="section-title">Top Goleadores (Todos los Partidos)</h2>
            <div class="top-scorers" id="allTimeScorers"></div>
        </div>
    </div>
</div>

        <!-- TAB: TITULARIDAD -->
<!-- TAB: TITULARIDAD -->
<div id="titularTab" class="hidden">
<div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTitularityPDF()" style="background: #8b5cf6; padding: 12px 20px;">
            üìÑ Generar PDF Titularitats
        </button>
    </div>
    <div class="card">
        <h2 class="section-title">üî• Heatmap de Titularidades</h2>
        <canvas id="titularityHeatmapChart" style="max-height: 400px;"></canvas>
    </div>
    
    <!-- Consistencia de Titularidad -->
    <div class="card">
        <h2 class="section-title">üìä Consistencia de Titularidad</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Porcentaje de cuartos en los que cada jugador fue titular
        </p>
        <canvas id="consistencyChart" style="max-height: 350px;"></canvas>
    </div>
    
    <!-- Rendimiento seg√∫n Titularidad -->
    <div class="card">
        <h2 class="section-title">‚ö° Rendimiento: Titular vs Suplente</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Media de goles y exclusiones cuando son titulares vs suplentes
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="performanceTable"></table>
        </div>
    </div>
    
    <div class="card">
        <div id="titularView"></div>
    </div>
    
    <!-- Patrones por Cuarto - MOVIDO AL FINAL -->
    <div class="card">
        <h2 class="section-title">‚è∞ Patrones por Cuarto</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¬øEn qu√© cuarto es m√°s titular cada jugador?
        </p>
        <div id="quarterPatternsGrid" class="stats-grid"></div>
    </div>
</div>

    <script>
        let allMatches = [];
        let filteredMatches = [];
        let currentMatch = null;
		let matchesWithTime = []; 
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllMatches();
        });

  async function loadAllMatches() {
    try {
        console.log('Iniciando carga de partidos...');
        const response = await fetch('https://api.github.com/repos/joseprico/CNT_juvenil_25_26/contents/');
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const files = await response.json();
        console.log('Archivos encontrados:', files.length);
        
        // Filtro estricto - solo archivos con datos de tiempo
        const jsonFiles = files.filter(f => {
            if (f.type !== 'file') return false;
            if (!f.name.startsWith('cnt_stats_')) return false;
            if (!f.name.endsWith('.json')) return false;
            
            // Excluir archivos gen√©ricos o de prueba
            if (f.name.includes('example')) return false;
            if (f.name.includes('template')) return false;
            if (f.name.includes('plantilla')) return false;
            if (f.name === 'cnt_stats_.json') return false;
            
            return true;
        });
        
        console.log('Archivos JSON de partidos:', jsonFiles.length);
        console.log('Nombres:', jsonFiles.map(f => f.name));

        if (jsonFiles.length === 0) {
            throw new Error('No se encontraron archivos de partidos (cnt_stats_*.json)');
        }

        const promises = jsonFiles.map(async file => {
            console.log('Cargando archivo:', file.name);
            const res = await fetch(file.download_url);
            if (!res.ok) {
                throw new Error(`Error cargando ${file.name}: ${res.status}`);
            }
            const matchData = await res.json();
            
            // Verificar que tiene la estructura correcta
            if (!matchData.data || !matchData.rivalTeam) {
                console.warn('Archivo con estructura incorrecta:', file.name, matchData);
            }
            
            return matchData;
        });

        allMatches = await Promise.all(promises);

// Filtrar partidos v√°lidos con nombre de rival completo
allMatches = allMatches.filter(m => {
    // Verificar estructura b√°sica
    if (!m || !m.data || m.scoreCNT === undefined || m.scoreRival === undefined) {
        console.warn('Partido sin estructura b√°sica:', m);
        return false;
    }
    
    // Verificar que el nombre del rival no sea gen√©rico
    if (!m.rivalTeam || m.rivalTeam.toLowerCase() === 'rival' || m.rivalTeam.trim() === '') {
        console.warn('Partido sin nombre de rival v√°lido:', m.rivalTeam);
        return false;
    }
    
    // Verificar que tenga jugadores
    if (!m.jugadors || m.jugadors.length === 0) {
        console.warn('Partido sin jugadores:', m);
        return false;
    }
    
    // Verificar que tenga marcadores por periodo
    if (!m.periodScores) {
        console.warn('Partido sin marcadores por periodo:', m);
        return false;
    }
    
    return true;
});

console.log('Partidos v√°lidos despu√©s del filtrado:', allMatches.length);
        
        console.log('Partidos v√°lidos cargados:', allMatches.length);
        
        // Ordenar por fecha de forma m√°s robusta
        allMatches.sort((a, b) => {
            const dateA = new Date(a.data).getTime();
            const dateB = new Date(b.data).getTime();
            return dateB - dateA; // M√°s reciente primero
        });
        
        filteredMatches = [...allMatches];

        document.getElementById('loadingMatches').classList.add('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
        
        displayMatchesList();
        displayComparison();
        displayTitularStats();
    } catch (error) {
        console.error('Error detallado:', error);
        document.getElementById('loadingMatches').innerHTML = `
            <div class="no-data">
                <p style="color: #ef4444; font-weight: bold;">‚ùå Error al cargar los partidos</p>
                <p style="font-size: 14px; margin-top: 10px; color: #fbbf24;">${error.message}</p>
                <p style="font-size: 12px; margin-top: 10px; color: #bae6fd;">
                    Verifica la consola del navegador (F12) para m√°s detalles
                </p>
                <button class="btn" onclick="loadAllMatches()" style="margin-top: 15px;">
                    üîÑ Reintentar
                </button>
            </div>
        `;
    }
}
function getQuarterRealStartTime(match, quarter) {
    // Prioritzar quarterRealStartTimes si existeix (nou sistema amb bot√≥)
    if (match.quarterRealStartTimes && match.quarterRealStartTimes[quarter]) {
        return match.quarterRealStartTimes[quarter];
    }
    
    // Fallback: usar quarterStartTimes (sistema antic)
    return match.quarterStartTimes && match.quarterStartTimes[quarter] 
        ? match.quarterStartTimes[quarter] 
        : null;
}
function getQuarterRealStartTime(match, quarter) {
    // Buscar la primera acci√≥n REAL del cuarto (gol, exclusi√≥n, cambio de agua)
    const actions = match.chronologicalActions || [];
    const quarterActions = actions.filter(a => a.quarter === quarter);
    
    if (quarterActions.length > 0) {
        // Ordenar por timestamp y devolver el primero
        quarterActions.sort((a, b) => a.timestamp - b.timestamp);
        return quarterActions[0].timestamp;
    }
    
    // Si no hay acciones, usar quarterStartTimes como fallback
    return match.quarterStartTimes[quarter];
}
function getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration) {
    if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
        return match.quarterRealEndTimes[quarter];
    }
    
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (match.quarterStartTimes[nextQuarter]) {
            return match.quarterStartTimes[nextQuarter];
        }
    }
    
    return quarterStartTime + (quarterDuration * 1000);
}
  function displayMatchesList() {
    const container = document.getElementById('availableMatches');
    
    if (filteredMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos que coincidan con los filtros</div>';
        return;
    }

    container.innerHTML = filteredMatches.map((match, idx) => {  // ‚úÖ Usar idx del map
        const date = new Date(match.data);
        const result = match.scoreCNT > match.scoreRival ? 'win' : 
                      match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
        const resultText = result === 'win' ? '‚úÖ Victoria' : 
                          result === 'loss' ? '‚ùå Derrota' : 'ü§ù Empate';
        const locationIcon = (match.matchLocation === 'home' || !match.matchLocation) ? 'üè†' : '‚úàÔ∏è';
        const locationText = (match.matchLocation === 'home' || !match.matchLocation) ? 'Casa' : 'Fuera';
        
        return `
            <div class="match-item" onclick="viewMatch(${idx})">  
                <div class="match-info">
                    <div class="match-date">${date.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                    <div class="match-teams">CN Terrassa vs ${match.rivalTeam || 'Rival'} ${locationIcon}</div>
                    <div class="${result}">${resultText} ‚Ä¢ ${locationText}</div>
                </div>
                <div class="match-score">${match.scoreCNT} - ${match.scoreRival}</div>
            </div>
        `;
    }).join('');
}

        function filterMatches() {
            const rivalFilter = document.getElementById('filterRival').value.toLowerCase();
            const resultFilter = document.getElementById('filterResult').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredMatches = allMatches.filter(match => {
                const rivalMatch = !rivalFilter || (match.rivalTeam || '').toLowerCase().includes(rivalFilter);
                
                let resultMatch = true;
                if (resultFilter) {
                    const result = match.scoreCNT > match.scoreRival ? 'win' : 
                                  match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                    resultMatch = result === resultFilter;
                }

                return rivalMatch && resultMatch;
            });

            if (sortBy === 'date-desc') {
                filteredMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
            } else if (sortBy === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.data) - new Date(b.data));
            } else if (sortBy === 'score-desc') {
                filteredMatches.sort((a, b) => b.scoreCNT - a.scoreCNT);
            }

            displayMatchesList();
        }

      function viewMatch(idx) {
    currentMatch = filteredMatches[idx];  // ‚úÖ USAR filteredMatches en lugar de allMatches
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.remove('hidden');
    displayMatchData();
}

        function backToList() {
            document.getElementById('singleMatchView').classList.add('hidden');
            document.getElementById('matchesView').classList.remove('hidden');
			const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'none';
    }
        }

   function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    // Ocultar TODOS los tabs y vistas
    document.getElementById('listTab').classList.add('hidden');
    document.getElementById('comparisonTab').classList.add('hidden');
    document.getElementById('titularTab').classList.add('hidden');
    document.getElementById('tiempoTab').classList.add('hidden');
    
    // Ocultar tambi√©n las vistas internas del listTab
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.add('hidden');

    if (tabName === 'list') {
        document.getElementById('listTab').classList.remove('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
    } else if (tabName === 'comparison') {
        document.getElementById('comparisonTab').classList.remove('hidden');
    } else if (tabName === 'titular') {
        document.getElementById('titularTab').classList.remove('hidden');
        setTimeout(() => {
            renderTitularityHeatmapChart();
        }, 100);
    } else if (tabName === 'tiempo') {
        document.getElementById('tiempoTab').classList.remove('hidden');
        setTimeout(() => {
            displayTimeStats();
        }, 100);
    }
}

 function displayMatchData() {
    document.getElementById('scoreCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('teamRival').textContent = currentMatch.rivalTeam || 'RIVAL';
// Actualitzar tamb√© el scoreboard de dalt si existeix
if (document.getElementById('scoreboardCNT')) {
    document.getElementById('scoreboardCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreboardRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('scoreboardRivalName').textContent = currentMatch.rivalTeam || 'RIVAL';
}
    const date = new Date(currentMatch.data);
    const locationIcon = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'üè†' : '‚úàÔ∏è';
    const locationText = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'Casa' : 'Fuera';
    const totalExcCNT = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.exclusions, 0);
    const totalExcRival = currentMatch.rivalStats.reduce((sum, j) => sum + j.exclusions, 0);

    // Parades dels porters
    const totalParadesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.parades || 0);
    }, 0);
    
    // Calcular totalGoals abans d'utilitzar-lo
    const totalGoals = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.gols, 0);
    
    // Noves accions
    const totalAssistenciesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.assistencies || 0);
    }, 0);

    const totalRobatorisCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.robatoris || 0);
    }, 0);

    const totalPerduesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.perdues || 0);
    }, 0);

    const totalXutsFallatsCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.xutsFallats || 0);
    }, 0);
    
    const totalBlocksCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.blocks || 0);
    }, 0);

    const totalFaltesRebudesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.faltesRebudes || 0);
    }, 0);
    
    // Efici√®ncia de tir
    const totalXutsCNT = totalGoals + totalXutsFallatsCNT;
    const eficienciaTirCNT = totalXutsCNT > 0 ? ((totalGoals / totalXutsCNT) * 100).toFixed(1) : '0.0';
    
    // Conversi√≥n H+ del CNT (goles H+ CNT / exclusiones normales rival)
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes && j.estadistiques.goalTypes['h+']) {
            totalHPlusCNT += j.estadistiques.goalTypes['h+'];
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
        }
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    // Conversi√≥n H+ del Rival (goles H+ rival / exclusiones normales CNT)
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes && j.goalTypes['h+']) {
            totalHPlusRival += j.goalTypes['h+'];
        }
    });

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            totalExclusionsNoPenaltyCNT += (j.estadistiques.exclusionTypes.normal || 0);
        }
    });

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    document.getElementById('matchInfo').innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">üìÖ Fecha</div>
                <div class="info-value">${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
            </div>
            <div class="info-item">
                <div class="info-label">${locationIcon} Ubicaci√≥n</div>
                <div class="info-value">${locationText}</div>
            </div>
            <div class="info-item">
                <div class="info-label">üü• Exclusiones CNT</div>
                <div class="info-value">${totalExcCNT}</div>
            </div>
            <div class="info-item">
                <div class="info-label">üü• Exclusiones Rival</div>
                <div class="info-value">${totalExcRival}</div>
            </div>
            ${totalParadesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üß§ Parades CNT</div>
                <div class="info-value" style="color: #c084fc;">${totalParadesCNT}</div>
            </div>
            ` : ''}
            <div class="info-item">
                <div class="info-label">üéØ Efici√®ncia Tir CNT</div>
                <div class="info-value" style="color: ${eficienciaTirCNT >= 50 ? '#22c55e' : eficienciaTirCNT >= 30 ? '#fbbf24' : '#ef4444'};">${eficienciaTirCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">üìä Conversi√≥ H+ CNT</div>
                <div class="info-value">${conversionRateCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">üìä Conversi√≥ H+ Rival</div>
                <div class="info-value">${conversionRateRival}%</div>
            </div>
            ${totalAssistenciesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üéØ Assist√®ncies CNT</div>
                <div class="info-value" style="color: #86efac;">${totalAssistenciesCNT}</div>
            </div>
            ` : ''}
            ${totalRobatorisCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üõ°Ô∏è Robatoris CNT</div>
                <div class="info-value" style="color: #7dd3fc;">${totalRobatorisCNT}</div>
            </div>
            ` : ''}
            ${totalPerduesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚ùå P√®rdues CNT</div>
                <div class="info-value" style="color: #fca5a5;">${totalPerduesCNT}</div>
            </div>
            ` : ''}
            ${totalXutsFallatsCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">üéØ‚ùå Xuts Fallats CNT</div>
                <div class="info-value" style="color: #fb923c;">${totalXutsFallatsCNT}</div>
            </div>
            ` : ''}
            ${totalBlocksCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚úã Blocks CNT</div>
                <div class="info-value" style="color: #a78bfa;">${totalBlocksCNT}</div>
            </div>
            ` : ''}
            ${totalFaltesRebudesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">‚ö†Ô∏è Faltes Rebudes</div>
                <div class="info-value" style="color: #fbbf24;">${totalFaltesRebudesCNT}</div>
            </div>
            ` : ''}
        </div>
    `;

    // Stats CNT
    document.getElementById('statsCNT').innerHTML = currentMatch.jugadors
    .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0 || 
                 (j.estadistiques.parades || 0) > 0 || (j.estadistiques.assistencies || 0) > 0 || 
                 (j.estadistiques.robatoris || 0) > 0 || (j.estadistiques.perdues || 0) > 0 || 
                 (j.estadistiques.xutsFallats || 0) > 0 || (j.estadistiques.blocks || 0) > 0 ||
                 (j.estadistiques.faltesRebudes || 0) > 0)
        .map(j => {
            const goalTypes = j.estadistiques.goalTypes || {};
            const exclusionTypes = j.estadistiques.exclusionTypes || {};
            const penaltyMissed = j.estadistiques.penaltyMissed || 0;
            const parades = j.estadistiques.parades || 0;
            const paradeTypes = j.estadistiques.paradeTypes || {};
            const assistencies = j.estadistiques.assistencies || 0;
            const robatoris = j.estadistiques.robatoris || 0;
            const perdues = j.estadistiques.perdues || 0;
            const xutsFallats = j.estadistiques.xutsFallats || 0;
            const blocks = j.estadistiques.blocks || 0;
            const faltesRebudes = j.estadistiques.faltesRebudes || 0;
            
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            
            let goalTypesText = '';
            if (goalTypes['h+']) goalTypesText += `H+:${goalTypes['h+']} `;
            if (goalTypes.penalty) goalTypesText += `P:${goalTypes.penalty} `;
            if (goalTypes.contra) goalTypesText += `C:${goalTypes.contra} `;
            if (goalTypes.boya) goalTypesText += `B:${goalTypes.boya} `;
            if (goalTypes.normal) goalTypesText += `N:${goalTypes.normal}`;
            
            let exclusionTypesText = '';
            if (exclusionTypes.normal) exclusionTypesText += `EX:${exclusionTypes.normal} `;
            if (exclusionTypes.penalty) exclusionTypesText += `P:${exclusionTypes.penalty}`;
            
            let paradeTypesText = '';
            if (paradeTypes.corner) paradeTypesText += `Corner:${paradeTypes.corner} `;
            if (paradeTypes.rebuig) paradeTypesText += `Rebuig:${paradeTypes.rebuig} `;
            if (paradeTypes.atrapa) paradeTypesText += `Atrapa:${paradeTypes.atrapa}`;
            
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${j.numero}</div>
                    <div class="player-name">${j.nom}</div>
                </div>
                <div class="player-stats">
                    ${j.estadistiques.gols > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.estadistiques.gols}</div>
                    </div>
                    ` : ''}
                    ${goalTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${goalTypesText}</div>
                    </div>
                    ` : ''}
                    ${j.estadistiques.exclusions > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.estadistiques.exclusions}</div>
                    </div>
                    ` : ''}
                    ${exclusionTypesText ? `
                    <div class="stat-item">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${exclusionTypesText}</div>
                    </div>
                    ` : ''}
                    ${parades > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üß§ Parades</div>
                        <div class="stat-value" style="color: #c084fc;">${parades}</div>
                    </div>
                    ` : ''}
                    ${paradeTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${paradeTypesText}</div>
                    </div>
                    ` : ''}
                    ${assistencies > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üéØ Asist</div>
                        <div class="stat-value" style="color: #86efac;">${assistencies}</div>
                    </div>
                    ` : ''}
                    ${robatoris > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üõ°Ô∏è Rob</div>
                        <div class="stat-value" style="color: #7dd3fc;">${robatoris}</div>
                    </div>
                    ` : ''}
                    ${perdues > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚ùå P√®rd</div>
                        <div class="stat-value" style="color: #fca5a5;">${perdues}</div>
                    </div>
                    ` : ''}
                    ${xutsFallats > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">üéØ‚ùå X.F</div>
                        <div class="stat-value" style="color: #fb923c;">${xutsFallats}</div>
                    </div>
                    ` : ''}
                    ${blocks > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚úã Block</div>
                        <div class="stat-value" style="color: #a78bfa;">${blocks}</div>
                    </div>
                    ` : ''}
                    ${faltesRebudes > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">‚ö†Ô∏è F.Reb</div>
                        <div class="stat-value" style="color: #fbbf24;">${faltesRebudes}</div>
                    </div>
                    ` : ''}
                    ${(j.estadistiques.gols > 0 || xutsFallats > 0) ? `
                    <div class="stat-item">
                        <div class="stat-label">Efic%</div>
                        <div class="stat-value" style="color: ${(() => {
                            const totalXuts = j.estadistiques.gols + xutsFallats;
                            const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100) : 0;
                            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                        })()};">
                            ${(() => {
                                const totalXuts = j.estadistiques.gols + xutsFallats;
                                const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100).toFixed(0) : 0;
                                return efic + '%';
                            })()}
                        </div>
                    </div>
                    ` : ''}
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    // Stats Rival
    const rivalPlayers = currentMatch.rivalStats.filter(p => p.name || p.gols > 0 || p.exclusions > 0);
    document.getElementById('statsRival').innerHTML = rivalPlayers.length === 0 ? '<p>No hay estad√≠sticas del rival</p>' :
        rivalPlayers.map(j => {
            const penaltyMissed = j.penaltyMissed || 0;
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num rival">${j.num}</div>
                    <div class="player-name">${j.name || 'Jugador ' + j.num}</div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.gols}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.exclusions}</div>
                    </div>
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `}).join('');

    // Alineaciones
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    document.getElementById('lineupsContainer').innerHTML = quarters.map((q, i) => {
        const lineup = currentMatch.lineups[q] || [];
        if (lineup.length === 0) return '';

        const players = lineup.map(num => {
            const player = currentMatch.jugadors.find(j => j.numero === num);
            return player ? `${player.numero}. ${player.nom.split(' ')[0]}` : num;
        }).join(', ');

        const score = currentMatch.periodScores[q];
        return `
            <div class="period-row">
                <div class="period-label">${labels[i]}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">${players}</div>
                <div class="period-score">${score.cnt} - ${score.rival}</div>
            </div>
        `;
    }).join('');

    // Desglose de tipos de goles
    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };

    const cntGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes) {
            Object.keys(cntGoalStats).forEach(type => {
                cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsScoredBreakdown').innerHTML = Object.keys(cntGoalStats)
        .filter(type => cntGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${cntGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const rivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes) {
            Object.keys(rivalGoalStats).forEach(type => {
                rivalGoalStats[type] += j.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsReceivedBreakdown').innerHTML = Object.keys(rivalGoalStats)
        .filter(type => rivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${rivalGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    // Desglose de exclusiones
    const excStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            excStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
            excStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            excStats.rival.normal += j.exclusionTypes.normal || 0;
            excStats.rival.penalty += j.exclusionTypes.penalty || 0;
        }
    });

    document.getElementById('exclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${excStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penalty</div>
            <div class="breakdown-value">${excStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${excStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penalty</div>
            <div class="breakdown-value">${excStats.rival.penalty}</div>
        </div>
    `;
	


    document.getElementById('observations').textContent = currentMatch.observacions || 'No hay observaciones';

             // Generar gr√°ficas
            renderScoreEvolutionChart();
            renderOffenseDefenseChart();
            renderPlayerEfficiencyChart();
			renderMatchTimeline();
			renderSingleMatchStatsTable();
			renderPlayingTimes();
       const pdfButton = document.getElementById('pdfMatchButton');
if (pdfButton) {
    pdfButton.style.display = 'inline-block';
}
}  // ‚Üê Aquest √©s el tancament de la funci√≥ displayMatchData()

 function renderSingleMatchStatsTable() {
    const table = document.getElementById('singleMatchStatsTable');
    if (!table || !currentMatch) return;

    const players = currentMatch.jugadors.map(j => {
        const stats = j.estadistiques;
        const goles = stats.gols;
        const xutsTotal = goles + (stats.xutsFallats || 0);
        const eficiencia = xutsTotal > 0 ? ((goles / xutsTotal) * 100).toFixed(1) : 'N/A';
        const valor = calculatePlayerValue(stats);
        
        return {
            nom: j.nom,
            numero: j.numero,
            goles: goles,
            assists: stats.assistencies || 0,
            robatoris: stats.robatoris || 0,
            perdues: stats.perdues || 0,
            xutsFallats: stats.xutsFallats || 0,
            blocatges: stats.blocatges || 0,
            parades: stats.parades || 0,
            faltesRebudes: stats.faltesRebudes || 0,
            eficiencia: eficiencia,
            exclusions: stats.exclusions,
            penaltyFallat: stats.penaltyMissed || 0,
            valor: valor
        };
    });

    // Ordenar por n√∫mero de goles (descendente)
    players.sort((a, b) => b.valor - a.valor);

    let html = `
        <thead>
            <tr>
                <th style="position: sticky; left: 0; z-index: 2; background: #0a2540;">N¬∫</th>
                <th style="position: sticky; left: 50px; z-index: 2; background: #0a2540;">Jugador</th>
                <th>Gols</th>
                <th>Exc</th>
                <th>üéØ Asist</th>
                <th>üõ°Ô∏è Rob</th>
                <th>‚ùå P√®rd</th>
                <th>üéØ‚ùå X.F</th>
                <th>‚úã Block</th>
                <th>üß§ Par</th>
                <th>‚ö†Ô∏è F.Reb</th>
                <th>Efic%</th>
                <th>‚≠ê Valor</th>
            </tr>
        </thead>
        <tbody>
    `;

    players.forEach(p => {
        const eficienciaClass = p.eficiencia !== 'N/A' ? 
            (parseFloat(p.eficiencia) >= 50 ? 'positive' : 'neutral') : '';
        const valorClass = p.valor >= 10 ? 'positive' : p.valor >= 5 ? 'neutral' : 'negative';
        
        html += `
            <tr>
                <td style="position: sticky; left: 0; z-index: 1; background: #0a2540; font-weight: bold;">
                    ${p.numero}
                </td>
                <td style="position: sticky; left: 50px; z-index: 1; background: #0a2540; font-weight: bold;">
                    ${p.nom}
                </td>
                <td><strong>${p.goles}</strong></td>
                <td class="${p.exclusions > 0 ? 'negative' : ''}">${p.exclusions}</td>
                <td class="${p.assists > 0 ? 'positive' : ''}">${p.assists}</td>
                <td class="${p.robatoris > 0 ? 'positive' : ''}">${p.robatoris}</td>
                <td class="${p.perdues > 0 ? 'negative' : ''}">${p.perdues}</td>
                <td class="negative">${p.xutsFallats}</td>
                <td class="${p.blocatges > 0 ? 'positive' : ''}">${p.blocatges}</td>
                <td class="${p.parades > 0 ? 'positive' : ''}">${p.parades}</td>
                <td class="${p.faltesRebudes > 0 ? 'positive' : ''}">${p.faltesRebudes}</td>
                <td class="${eficienciaClass}">${p.eficiencia}${p.eficiencia !== 'N/A' ? '%' : ''}</td>
                <td class="${valorClass}" style="font-weight: bold;">${p.valor.toFixed(1)}</td>
            </tr>
        `;
    });

    // Calcular totales del equipo
    const totales = {
        goles: players.reduce((sum, p) => sum + p.goles, 0),
        exclusions: players.reduce((sum, p) => sum + p.exclusions, 0),
        assists: players.reduce((sum, p) => sum + p.assists, 0),
        robatoris: players.reduce((sum, p) => sum + p.robatoris, 0),
        perdues: players.reduce((sum, p) => sum + p.perdues, 0),
        xutsFallats: players.reduce((sum, p) => sum + p.xutsFallats, 0),
        blocatges: players.reduce((sum, p) => sum + p.blocatges, 0),
        parades: players.reduce((sum, p) => sum + p.parades, 0),
        faltesRebudes: players.reduce((sum, p) => sum + p.faltesRebudes, 0),
        valor: players.reduce((sum, p) => sum + p.valor, 0)
    };
    
    const xutsTotal = totales.goles + totales.xutsFallats;
    const eficienciaTotal = xutsTotal > 0 ? ((totales.goles / xutsTotal) * 100).toFixed(1) : 'N/A';
    const valorTotalClass = totales.valor >= 50 ? 'positive' : totales.valor >= 25 ? 'neutral' : 'negative';

    html += `
            <tr style="border-top: 3px solid #22d3ee; font-weight: bold; background: rgba(34, 211, 238, 0.1);">
                <td style="position: sticky; left: 0; z-index: 1; background: rgba(34, 211, 238, 0.2);" colspan="2">
                    TOTALS EQUIP
                </td>
                <td><strong>${totales.goles}</strong></td>
                <td class="${totales.exclusions > 0 ? 'negative' : ''}">${totales.exclusions}</td>
                <td class="${totales.assists > 0 ? 'positive' : ''}">${totales.assists}</td>
                <td class="${totales.robatoris > 0 ? 'positive' : ''}">${totales.robatoris}</td>
                <td class="${totales.perdues > 0 ? 'negative' : ''}">${totales.perdues}</td>
                <td class="negative">${totales.xutsFallats}</td>
                <td class="${totales.blocatges > 0 ? 'positive' : ''}">${totales.blocatges}</td>
                <td class="${totales.parades > 0 ? 'positive' : ''}">${totales.parades}</td>
                <td class="${totales.faltesRebudes > 0 ? 'positive' : ''}">${totales.faltesRebudes}</td>
                <td class="${parseFloat(eficienciaTotal) >= 50 ? 'positive' : 'neutral'}">
                    ${eficienciaTotal}${eficienciaTotal !== 'N/A' ? '%' : ''}
                </td>
                <td class="${valorTotalClass}" style="font-weight: bold;">${totales.valor.toFixed(1)}</td>
            </tr>
        </tbody>
    `;

    table.innerHTML = html;
}
 function renderScoreEvolutionChart() {
            const ctx = document.getElementById('scoreEvolutionChart');
            if (!ctx) return;
            
            if (window.scoreEvolutionChartInstance) {
                window.scoreEvolutionChartInstance.destroy();
            }
            
            const periods = ['Inicio', '1Q', '2Q', '3Q', '4Q'];
            const cntScores = [0];
            const rivalScores = [0];
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const lastCnt = cntScores[cntScores.length - 1];
                const lastRival = rivalScores[rivalScores.length - 1];
                cntScores.push(lastCnt + currentMatch.periodScores[q].cnt);
                rivalScores.push(lastRival + currentMatch.periodScores[q].rival);
            });
            
            window.scoreEvolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: [
                        {
                            label: 'CN Terrassa',
                            data: cntScores,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: currentMatch.rivalTeam || 'Rival',
                            data: rivalScores,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderOffenseDefenseChart() {
            const ctx = document.getElementById('offenseDefenseChart');
            if (!ctx) return;
            
            if (window.offenseDefenseChartInstance) {
                window.offenseDefenseChartInstance.destroy();
            }
            
            const cntGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            const rivalGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            
            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes) {
                    Object.keys(cntGoalStats).forEach(type => {
                        cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                    });
                }
            });
            
            currentMatch.rivalStats.forEach(j => {
                if (j.goalTypes) {
                    Object.keys(rivalGoalStats).forEach(type => {
                        rivalGoalStats[type] += j.goalTypes[type] || 0;
                    });
                }
            });
            
            const labels = ['H+', 'Penalty', 'Contra', 'Boya', 'Normal'];
            const cntData = [cntGoalStats['h+'], cntGoalStats.penalty, cntGoalStats.contra, cntGoalStats.boya, cntGoalStats.normal];
            const rivalData = [rivalGoalStats['h+'], rivalGoalStats.penalty, rivalGoalStats.contra, rivalGoalStats.boya, rivalGoalStats.normal];
            
            window.offenseDefenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles a Favor',
                            data: cntData,
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Goles en Contra',
                            data: rivalData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderPlayerEfficiencyChart() {
            const ctx = document.getElementById('playerEfficiencyChart');
            if (!ctx) return;
            
            if (window.playerEfficiencyChartInstance) {
                window.playerEfficiencyChartInstance.destroy();
            }
            
            const playersWithStats = currentMatch.jugadors
                .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0)
                .sort((a, b) => b.estadistiques.gols - a.estadistiques.gols);
            
            const labels = playersWithStats.map(j => `${j.numero}. ${j.nom.split(' ')[0]}`);
            const goalsData = playersWithStats.map(j => j.estadistiques.gols);
            const exclusionsData = playersWithStats.map(j => j.estadistiques.exclusions);
            
            window.playerEfficiencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles',
                            data: goalsData,
                            backgroundColor: '#fde047'
                        },
                        {
                            label: 'Exclusiones',
                            data: exclusionsData,
                            backgroundColor: '#f97316'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

       function displayComparison() {
    if (allMatches.length === 0) return;
    populatePlayerFilter();
    
    const wins = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const losses = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
    const totalGoals = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalGoalsAgainst = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const avgGoals = (totalGoals / allMatches.length).toFixed(1);
    const avgGoalsAgainst = (totalGoalsAgainst / allMatches.length).toFixed(1);
// ‚úÖ Filtrar nom√©s partits amb dades de xuts fallats
const matchesWithShotData = allMatches.filter(m => {
    const hasXutsFallats = m.jugadors.some(j => (j.estadistiques.xutsFallats || 0) > 0);
    return hasXutsFallats;
});

const totalXutsFallats = matchesWithShotData.reduce((sum, m) => {
    return sum + m.jugadors.reduce((s, j) => s + (j.estadistiques.xutsFallats || 0), 0);
}, 0);

const totalGoalsWithShotData = matchesWithShotData.reduce((sum, m) => sum + m.scoreCNT, 0);
const totalXutsGlobal = totalGoalsWithShotData + totalXutsFallats;
const eficienciaGlobal = totalXutsGlobal > 0 ? ((totalGoalsWithShotData / totalXutsGlobal) * 100).toFixed(1) : '0.0';
const numMatchesWithShotData = matchesWithShotData.length;
    let totalPenMissedCNT = 0;
    let totalPenMissedRival = 0;
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    const globalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    const globalExcStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            totalPenMissedCNT += (j.estadistiques.penaltyMissed || 0);
            if (j.estadistiques.goalTypes) {
                Object.keys(globalGoalStats).forEach(type => {
                    globalGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                });
                if (j.estadistiques.goalTypes['h+']) {
                    totalHPlusCNT += j.estadistiques.goalTypes['h+'];
                }
            }
            if (j.estadistiques.exclusionTypes) {
                globalExcStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                globalExcStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                totalExclusionsNoPenaltyCNT += j.estadistiques.exclusionTypes.normal || 0;
            }
        });
        
        match.rivalStats.forEach(j => {
            totalPenMissedRival += (j.penaltyMissed || 0);
            if (j.goalTypes && j.goalTypes['h+']) {
                totalHPlusRival += j.goalTypes['h+'];
            }
            if (j.exclusionTypes) {
                totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
                globalExcStats.rival.normal += j.exclusionTypes.normal || 0;
                globalExcStats.rival.penalty += j.exclusionTypes.penalty || 0;
            }
        });
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    // NUEVO: Rendimiento Casa vs Fuera
    const homeMatches = allMatches.filter(m => m.matchLocation === 'home' || !m.matchLocation);
    const awayMatches = allMatches.filter(m => m.matchLocation === 'away');

    const homeWins = homeMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const homeLosses = homeMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const homeDraws = homeMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const awayWins = awayMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const awayLosses = awayMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const awayDraws = awayMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const homeGoalsFor = homeMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const homeGoalsAgainst = homeMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const awayGoalsFor = awayMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const awayGoalsAgainst = awayMatches.reduce((sum, m) => sum + m.scoreRival, 0);

    document.getElementById('summaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos Jugados</div>
            <div class="info-value">${allMatches.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Victorias</div>
            <div class="info-value win">${wins}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Derrotas</div>
            <div class="info-value loss">${losses}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Empates</div>
            <div class="info-value draw">${draws}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles a Favor</div>
            <div class="info-value">${totalGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles en Contra</div>
            <div class="info-value">${totalGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles/Partido</div>
            <div class="info-value">${avgGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles en Contra</div>
            <div class="info-value">${avgGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados CNT</div>
            <div class="info-value" style="color: ${totalPenMissedCNT === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedCNT}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados Rival</div>
            <div class="info-value" style="color: ${totalPenMissedRival === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedRival}</div>
        </div>
        <div class="info-item">
            <div class="info-label">üè† Partidos en Casa</div>
            <div class="info-value">${homeMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${homeWins}V - ${homeLosses}D - ${homeDraws}E
            </div>
        </div>
		<div class="info-item">
    <div class="info-label">üéØ Efici√®ncia Global de Tir</div>
    <div class="info-value" style="color: ${totalXutsGlobal > 0 ? (eficienciaGlobal >= 50 ? '#22c55e' : eficienciaGlobal >= 30 ? '#fbbf24' : '#ef4444') : '#bae6fd'};">
        ${totalXutsGlobal > 0 ? `${totalGoals}/${totalXutsGlobal}` : 'No hi ha dades'}<br>
        ${totalXutsGlobal > 0 ? `<span style="font-size: 14px;">(${eficienciaGlobal}%)</span>` : ''}
    </div>
</div>
        <div class="info-item">
            <div class="info-label">‚úàÔ∏è Partidos Fuera</div>
            <div class="info-value">${awayMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${awayWins}V - ${awayLosses}D - ${awayDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">üè† Media Goles Casa</div>
            <div class="info-value" style="color: #fde047;">
                ${homeMatches.length > 0 ? (homeGoalsFor / homeMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${homeMatches.length > 0 ? (homeGoalsAgainst / homeMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">‚úàÔ∏è Media Goles Fuera</div>
            <div class="info-value" style="color: #fde047;">
                ${awayMatches.length > 0 ? (awayGoalsFor / awayMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${awayMatches.length > 0 ? (awayGoalsAgainst / awayMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversi√≥n H+ CNT (Total)</div>
            <div class="info-value" style="color: ${conversionRateCNT >= 50 ? '#22c55e' : conversionRateCNT >= 30 ? '#fbbf24' : '#ef4444'}">
                ${totalHPlusCNT}/${totalExclusionsNoPenaltyRival}<br>
                <span style="font-size: 14px;">(${conversionRateCNT}%)</span>
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversi√≥n H+ Rival (Total)</div>
            <div class="info-value" style="color: ${conversionRateRival >= 50 ? '#ef4444' : conversionRateRival >= 30 ? '#fbbf24' : '#22c55e'}">
                ${totalHPlusRival}/${totalExclusionsNoPenaltyCNT}<br>
                <span style="font-size: 14px;">(${conversionRateRival}%)</span>
            </div>
        </div>
    `;

    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penaltis',
        'contra': 'Contraataques',
        'boya': 'Boya',
        'normal': 'Normales'
    };

    document.getElementById('totalGoalsBreakdown').innerHTML = Object.keys(globalGoalStats)
        .filter(type => globalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalGoalStats[type] / totalGoals) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const globalRivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };
    
    allMatches.forEach(match => {
        match.rivalStats.forEach(j => {
            if (j.goalTypes) {
                Object.keys(globalRivalGoalStats).forEach(type => {
                    globalRivalGoalStats[type] += j.goalTypes[type] || 0;
                });
            }
        });
    });

    document.getElementById('totalGoalsReceivedBreakdown').innerHTML = Object.keys(globalRivalGoalStats)
        .filter(type => globalRivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalRivalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalRivalGoalStats[type] / totalGoalsAgainst) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    document.getElementById('totalExclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${globalExcStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${globalExcStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.rival.penalty}</div>
        </div>
    `;

    const playerStats = {};
    const playerMatchAppearances = {};
    
    allMatches.forEach((match, matchIndex) => {
    match.jugadors.forEach(j => {
        const playerName = j.nom.trim();
        
        if (!playerStats[playerName]) {
            playerStats[playerName] = { 
                num: j.numero,
                name: playerName, 
                gols: 0, 
                exclusions: 0,
                penaltyMissed: 0,
                partidos: 0,
                goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                // ‚úÖ NUEVO:
                parades: 0,
                paradeTypes: { corner: 0, rebuig: 0, atrapa: 0 },
                assistencies: 0,
                robatoris: 0,
                perdues: 0,
                xutsFallats: 0,
				blocks: 0,
                faltesRebudes: 0,
                goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                paradeTypes: { corner: 0, rebuig: 0, atrapa: 0 }
            };
            playerMatchAppearances[playerName] = new Set();
        }
        
        playerStats[playerName].num = j.numero;
        playerMatchAppearances[playerName].add(matchIndex);
        
        playerStats[playerName].gols += j.estadistiques.gols;
        playerStats[playerName].exclusions += j.estadistiques.exclusions;
        playerStats[playerName].penaltyMissed += (j.estadistiques.penaltyMissed || 0);
        playerStats[playerName].parades += (j.estadistiques.parades || 0);
        playerStats[playerName].assistencies += (j.estadistiques.assistencies || 0);
        playerStats[playerName].robatoris += (j.estadistiques.robatoris || 0);
        playerStats[playerName].perdues += (j.estadistiques.perdues || 0);
        playerStats[playerName].xutsFallats += (j.estadistiques.xutsFallats || 0);
        playerStats[playerName].blocks += (j.estadistiques.blocks || 0);
        playerStats[playerName].faltesRebudes += (j.estadistiques.faltesRebudes || 0);
        playerStats[playerName].blocatges += (j.estadistiques.blocatges || 0);
playerStats[playerName].faltesRebudes += (j.estadistiques.faltesRebudes || 0);
        if (j.estadistiques.goalTypes) {
            Object.keys(playerStats[playerName].goalTypes).forEach(type => {
                playerStats[playerName].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
            });
        }
		
     if (j.estadistiques.exclusionTypes) {
    if (playerStats[playerName].exclusionTypes) {
        Object.keys(playerStats[playerName].exclusionTypes).forEach(type => {
            playerStats[playerName].exclusionTypes[type] += (j.estadistiques.exclusionTypes[type] || 0);
        });
    }
} else {
    // Si no t√© exclusionTypes, assegurem que sigui un objecte buit
    if (!playerStats[playerName].exclusionTypes) {
        playerStats[playerName].exclusionTypes = { normal: 0, penalty: 0 };
    }
}
        if (j.estadistiques.paradeTypes) {
            Object.keys(playerStats[playerName].paradeTypes).forEach(type => {
                playerStats[playerName].paradeTypes[type] += j.estadistiques.paradeTypes[type] || 0;
            });
        }
    });
});
    
    Object.keys(playerStats).forEach(name => {
        playerStats[name].partidos = playerMatchAppearances[name].size;
    });

    const players = Object.values(playerStats).sort((a, b) => {
    const valorA = calculatePlayerValue({
        goalTypes: a.goalTypes,
        assistencies: a.assistencies,
        robatoris: a.robatoris,
        blocatges: a.blocatges || 0,
        parades: a.parades,
        faltesRebudes: a.faltesRebudes || 0,
        exclusionTypes: a.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: a.penaltyMissed,
        perdues: a.perdues,
        xutsFallats: a.xutsFallats
    });
    const valorB = calculatePlayerValue({
        goalTypes: b.goalTypes,
        assistencies: b.assistencies,
        robatoris: b.robatoris,
        blocatges: b.blocatges || 0,
        parades: b.parades,
        faltesRebudes: b.faltesRebudes || 0,
        exclusionTypes: b.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: b.penaltyMissed,
        perdues: b.perdues,
        xutsFallats: b.xutsFallats
    });
    return valorB - valorA;
});

// ‚úÖ Guardar dades per ordenaci√≥
cachedPlayersData = players;
currentSortColumn = 'valor';
currentSortOrder = 'desc';

// ‚úÖ Usar la nova funci√≥ de renderitzaci√≥
renderComparisonTable(players);

    const topScorers = Object.values(playerStats)
        .filter(p => p.gols > 0)
        .sort((a, b) => b.gols - a.gols)
        .slice(0, 10);

    document.getElementById('allTimeScorers').innerHTML = topScorers.map((p, i) => {
        let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
            <div class="top-scorer-item">
                <div class="player-info">
                    <div class="rank ${rankClass}">${i + 1}</div>
                    <div class="player-num">${p.num}</div>
                    <div class="player-name">${p.name}</div>
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                    ${p.gols} ‚öΩ
                </div>
            </div>
        `;
    }).join('');
    
    renderResultsEvolution();
    renderQuarterDifference();
    renderBestWorstMatches();
    renderRivalsHistory();
    renderGoalsDistributionChart(playerStats);
	renderGoalkeeperSavesChart();
}

        function renderGoalsDistributionChart(playerStats) {
            const ctx = document.getElementById('goalsDistributionChart');
            if (!ctx) return;
            
            if (window.goalsDistributionChartInstance) {
                window.goalsDistributionChartInstance.destroy();
            }
            
            const topPlayers = Object.values(playerStats)
                .filter(p => p.gols > 0)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 8);
            
            const labels = topPlayers.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
            const data = topPlayers.map(p => p.gols);
            
            const colors = [
                '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
                '#fde047', '#fbbf24', '#f59e0b', '#d97706'
            ];
            
            window.goalsDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#1e3a8a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'right',
                            labels: { 
                                color: 'white', 
                                font: { size: 12 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} goles (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
function renderResultsEvolution() {
    const ctx = document.getElementById('resultsEvolutionChart');
    if (!ctx) return;
    
    if (window.resultsEvolutionChartInstance) {
        window.resultsEvolutionChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    // Ordenar partidos cronol√≥gicamente
    const sortedMatches = [...allMatches].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const labels = sortedMatches.map((m, i) => {
        const date = new Date(m.data);
        const rival = m.rivalTeam || 'Rival';
        return `${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })} vs ${rival.substring(0, 15)}`;
    });
    
    const goalDifferences = sortedMatches.map(m => m.scoreCNT - m.scoreRival);
    const colors = goalDifferences.map(diff => {
        if (diff > 0) return '#22c55e'; // Victoria
        if (diff < 0) return '#ef4444'; // Derrota
        return '#fbbf24'; // Empate
    });
    
    // Calcular racha actual
    let currentStreak = 0;
    let streakType = '';
    if (sortedMatches.length > 0) {
        const lastResult = sortedMatches[sortedMatches.length - 1].scoreCNT > sortedMatches[sortedMatches.length - 1].scoreRival ? 'win' : 
                          sortedMatches[sortedMatches.length - 1].scoreCNT < sortedMatches[sortedMatches.length - 1].scoreRival ? 'loss' : 'draw';
        
        for (let i = sortedMatches.length - 1; i >= 0; i--) {
            const result = sortedMatches[i].scoreCNT > sortedMatches[i].scoreRival ? 'win' : 
                          sortedMatches[i].scoreCNT < sortedMatches[i].scoreRival ? 'loss' : 'draw';
            if (result === lastResult) {
                currentStreak++;
            } else {
                break;
            }
        }
        streakType = lastResult === 'win' ? 'victorias' : lastResult === 'loss' ? 'derrotas' : 'empates';
    }
    
    window.resultsEvolutionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia de Goles',
                data: goalDifferences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Racha actual: ${currentStreak} ${streakType}`,
                    color: 'white',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const diff = context.parsed.y;
                            const result = diff > 0 ? '‚úÖ Victoria' : diff < 0 ? '‚ùå Derrota' : 'ü§ù Empate';
                            return `${result} (${diff > 0 ? '+' : ''}${diff})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Diferencia de Goles por Cuarto
function renderQuarterDifference() {
    const ctx = document.getElementById('quarterDifferenceChart');
    if (!ctx) return;
    
    if (window.quarterDifferenceChartInstance) {
        window.quarterDifferenceChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const quarterStats = {
        q1: { cnt: 0, rival: 0 },
        q2: { cnt: 0, rival: 0 },
        q3: { cnt: 0, rival: 0 },
        q4: { cnt: 0, rival: 0 }
    };
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            quarterStats[q].cnt += match.periodScores[q].cnt;
            quarterStats[q].rival += match.periodScores[q].rival;
        });
    });
    
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    const differences = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const diff = quarterStats[q].cnt - quarterStats[q].rival;
        return (diff / allMatches.length).toFixed(2);
    });
    
    const colors = differences.map(diff => parseFloat(diff) >= 0 ? '#22c55e' : '#ef4444');
    
    window.quarterDifferenceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia Promedio',
                data: differences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const q = ['q1', 'q2', 'q3', 'q4'][context.dataIndex];
                            const totalCNT = quarterStats[q].cnt;
                            const totalRival = quarterStats[q].rival;
                            return [
                                `Diferencia: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y}`,
                                `Total a favor: ${totalCNT}`,
                                `Total en contra: ${totalRival}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia Promedio de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Mejores y Peores Partidos
function renderBestWorstMatches() {
    const container = document.getElementById('bestWorstGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    // Encontrar mejor victoria
    const bestWin = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => (b.scoreCNT - b.scoreRival) - (a.scoreCNT - a.scoreRival))[0];
    
    // Encontrar peor derrota
    const worstLoss = allMatches
        .filter(m => m.scoreCNT < m.scoreRival)
        .sort((a, b) => (a.scoreCNT - a.scoreRival) - (b.scoreCNT - b.scoreRival))[0];
    
    // Partido con m√°s goles anotados
    const mostGoals = allMatches.sort((a, b) => b.scoreCNT - a.scoreCNT)[0];
    
    // Partido con menos goles recibidos (solo victorias)
    const bestDefense = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => a.scoreRival - b.scoreRival)[0];
    
    let html = '';
    
    if (bestWin) {
        const date = new Date(bestWin.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üèÜ Mejor Victoria</div>
                <div class="info-value" style="color: #22c55e;">${bestWin.scoreCNT} - ${bestWin.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestWin.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (worstLoss) {
        const date = new Date(worstLoss.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üòû Peor Derrota</div>
                <div class="info-value" style="color: #ef4444;">${worstLoss.scoreCNT} - ${worstLoss.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${worstLoss.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (mostGoals) {
        const date = new Date(mostGoals.data).toLocaleDateString('es-ES');
        const result = mostGoals.scoreCNT > mostGoals.scoreRival ? 'win' : mostGoals.scoreCNT < mostGoals.scoreRival ? 'loss' : 'draw';
        html += `
            <div class="info-item">
                <div class="info-label">‚öΩ M√°s Goles Anotados</div>
                <div class="info-value ${result}">${mostGoals.scoreCNT} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${mostGoals.rivalTeam || 'Rival'} (${mostGoals.scoreCNT}-${mostGoals.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    if (bestDefense) {
        const date = new Date(bestDefense.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">üõ°Ô∏è Mejor Defensa</div>
                <div class="info-value" style="color: #22d3ee;">${bestDefense.scoreRival} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestDefense.rivalTeam || 'Rival'} (${bestDefense.scoreCNT}-${bestDefense.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// NUEVA: Historial contra Rivales
function renderRivalsHistory() {
    const table = document.getElementById('rivalsHistoryTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const rivalsStats = {};
    
    allMatches.forEach(match => {
        const rival = match.rivalTeam || 'Rival Desconocido';
        
        if (!rivalsStats[rival]) {
            rivalsStats[rival] = {
                name: rival,
                played: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                matches: []
            };
        }
        
        rivalsStats[rival].played++;
        rivalsStats[rival].goalsFor += match.scoreCNT;
        rivalsStats[rival].goalsAgainst += match.scoreRival;
        
        if (match.scoreCNT > match.scoreRival) {
            rivalsStats[rival].wins++;
        } else if (match.scoreCNT < match.scoreRival) {
            rivalsStats[rival].losses++;
        } else {
            rivalsStats[rival].draws++;
        }
        
        rivalsStats[rival].matches.push({
            date: match.data,
            score: `${match.scoreCNT}-${match.scoreRival}`,
            result: match.scoreCNT > match.scoreRival ? 'win' : match.scoreCNT < match.scoreRival ? 'loss' : 'draw'
        });
    });
    
    const rivals = Object.values(rivalsStats).sort((a, b) => b.played - a.played);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>PJ</th>
                <th>V</th>
                <th>D</th>
                <th>E</th>
                <th>GF</th>
                <th>GC</th>
                <th>Dif</th>
                <th>%V</th>
                <th>√öltimo Resultado</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const diff = r.goalsFor - r.goalsAgainst;
                const winPercentage = r.played > 0 ? ((r.wins / r.played) * 100).toFixed(0) : 0;
                const lastMatch = r.matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const lastDate = new Date(lastMatch.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.played}</td>
                        <td class="win">${r.wins}</td>
                        <td class="loss">${r.losses}</td>
                        <td class="draw">${r.draws}</td>
                        <td>${r.goalsFor}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="color: ${diff > 0 ? '#22c55e' : diff < 0 ? '#ef4444' : '#fbbf24'}; font-weight: bold;">
                            ${diff > 0 ? '+' : ''}${diff}
                        </td>
                        <td>${winPercentage}%</td>
                        <td>
                            <span class="${lastMatch.result}">${lastMatch.score}</span>
                            <span style="font-size: 10px; color: #bae6fd; margin-left: 4px;">(${lastDate})</span>
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
        function renderTitularityHeatmapChart() {
            const ctx = document.getElementById('titularityHeatmapChart');
            if (!ctx) {
                console.log('Canvas no encontrado');
                return;
            }
            
            if (window.titularityHeatmapChartInstance) {
                window.titularityHeatmapChartInstance.destroy();
            }
            
            if (allMatches.length === 0) {
                console.log('No hay partidos cargados');
                return;
            }
            
            const titularStats = {};
            
            allMatches.forEach(match => {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                quarters.forEach(q => {
                    const lineup = match.lineups[q] || [];
                    lineup.forEach(playerNum => {
                        const player = match.jugadors.find(j => j.numero === playerNum);
                        if (player) {
                            const playerName = player.nom.trim();
                            if (!titularStats[playerName]) {
                                titularStats[playerName] = { num: player.numero, q1: 0, q2: 0, q3: 0, q4: 0 };
                            }
                            titularStats[playerName].num = player.numero;
                            titularStats[playerName][q]++;
                        }
                    });
                });
            });
            
            const players = Object.keys(titularStats)
                .sort((a, b) => {
                    const totalA = titularStats[a].q1 + titularStats[a].q2 + titularStats[a].q3 + titularStats[a].q4;
                    const totalB = titularStats[b].q1 + titularStats[b].q2 + titularStats[b].q3 + titularStats[b].q4;
                    return totalB - totalA;
                });
            
            if (players.length === 0) {
                console.log('No hay jugadores con titularidades');
                return;
            }
            
            console.log('Jugadores encontrados:', players.length);
            
            const quarters = ['1Q', '2Q', '3Q', '4Q'];
            const datasets = quarters.map((q, qIndex) => {
                const quarterKey = `q${qIndex + 1}`;
                return {
                    label: q,
                    data: players.map(p => titularStats[p][quarterKey]),
                    backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'][qIndex]
                };
            });
            
           window.titularityHeatmapChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: players.map(p => `${titularStats[p].num}. ${p.split(' ')[0]}`),
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ‚¨ÖÔ∏è CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: true,
                labels: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 10 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.x} veces titular`;
                    }
                }
            }
        },
        scales: {
            x: { 
                stacked: true,
                beginAtZero: true,
                ticks: { 
                    color: 'white', 
                    stepSize: 1,
                    font: { size: window.innerWidth < 768 ? 10 : 12 } // ‚¨ÖÔ∏è A√ëADIDO
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Veces como Titular',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            y: { 
                stacked: true,
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ‚¨ÖÔ∏è MODIFICADO
                    autoSkip: false // ‚¨ÖÔ∏è A√ëADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
        }

        function displayTitularStats() {
    const container = document.getElementById('titularView');
    
    if (allMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos cargados</div>';
        return;
    }

    const titularStats = {};
    
    allMatches.forEach(match => {
        const quarters = ['q1', 'q2', 'q3', 'q4'];
        quarters.forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    
                    if (!titularStats[playerName]) {
                        titularStats[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                        };
                    }
                    
                    titularStats[playerName].num = player.numero;
                    titularStats[playerName][q]++;
                    titularStats[playerName].total++;
                }
            });
        });
    });

    const players = Object.values(titularStats).sort((a, b) => b.total - a.total);

    container.innerHTML = `
        <h2 class="section-title">Veces como Titular por Cuarto</h2>
        <p style="margin-bottom: 15px; color: #bae6fd; font-size: 14px;">
            Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''}
        </p>
        <div class="titular-stats">
            ${players.map(p => `
                <div class="titular-item">
                    <div class="titular-header">
                        <div class="player-num">${p.num}</div>
                        <div style="flex: 1;">
                            <div class="player-name">${p.name}</div>
                            <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                Total: <span class="total-badge">${p.total}</span>
                            </div>
                        </div>
                    </div>
                    <div class="titular-quarters">
                        <div class="quarter-badge">1Q: ${p.q1}</div>
                        <div class="quarter-badge">2Q: ${p.q2}</div>
                        <div class="quarter-badge">3Q: ${p.q3}</div>
                        <div class="quarter-badge">4Q: ${p.q4}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Renderizar nuevos gr√°ficos
    renderConsistencyChart();
    renderQuarterPatterns();
    renderPerformanceTable();
}

// NUEVA FUNCI√ìN: Gr√°fico de Consistencia
function renderConsistencyChart() {
    const ctx = document.getElementById('consistencyChart');
    if (!ctx) return;
    
    if (window.consistencyChartInstance) {
        window.consistencyChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const playerConsistency = {};
    const maxPossibleTitular = allMatches.length * 4; // 4 cuartos por partido
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerConsistency[playerName]) {
                playerConsistency[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: 0,
                    total: 0
                };
            }
            playerConsistency[playerName].total += 4; // 4 cuartos posibles
        });
        
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (playerConsistency[playerName]) {
                        playerConsistency[playerName].titular++;
                    }
                }
            });
        });
    });
    
    const players = Object.values(playerConsistency)
        .map(p => ({
            ...p,
            percentage: p.total > 0 ? (p.titular / p.total * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.percentage - a.percentage);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => parseFloat(p.percentage));
    
    // Colores seg√∫n porcentaje
    const backgroundColors = data.map(percentage => {
        if (percentage >= 75) return '#22c55e'; // Verde - Titular habitual
        if (percentage >= 50) return '#fbbf24'; // Amarillo - Mixto
        if (percentage >= 25) return '#f97316'; // Naranja - Suplente habitual
        return '#ef4444'; // Rojo - Rara vez titular
    });
    
    window.consistencyChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: '% de Titularidad',
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1,
            borderColor: '#1e3a8a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ‚¨ÖÔ∏è CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: false 
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const player = players[context.dataIndex];
                        return [
                            `Titularidad: ${context.parsed.x}%`,
                            `Titular: ${player.titular}/${player.total} cuartos`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: { 
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 10 : 12 }, // ‚¨ÖÔ∏è A√ëADIDO
                    callback: function(value) {
                        return value + '%';
                    }
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Porcentaje de Titularidad',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ‚¨ÖÔ∏è A√ëADIDO
                }
            },
            y: {
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ‚¨ÖÔ∏è MODIFICADO
                    autoSkip: false // ‚¨ÖÔ∏è A√ëADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
}

// NUEVA FUNCI√ìN: Patrones por Cuarto
function renderQuarterPatterns() {
    const container = document.getElementById('quarterPatternsGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    const playerQuarters = {};
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (!playerQuarters[playerName]) {
                        playerQuarters[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0
                        };
                    }
                    playerQuarters[playerName][q]++;
                }
            });
        });
    });
    
    const players = Object.values(playerQuarters)
        .sort((a, b) => b.q1 + b.q2 + b.q3 + b.q4 - (a.q1 + a.q2 + a.q3 + a.q4));
    
    container.innerHTML = players.map(p => {
        const quarters = [
            { name: '1Q', value: p.q1 },
            { name: '2Q', value: p.q2 },
            { name: '3Q', value: p.q3 },
            { name: '4Q', value: p.q4 }
        ];
        const maxQuarter = quarters.reduce((max, q) => q.value > max.value ? q : max, quarters[0]);
        const total = p.q1 + p.q2 + p.q3 + p.q4;
        
        let pattern = '';
        if (p.q1 + p.q2 > p.q3 + p.q4) {
            pattern = 'üîµ Inicio fuerte';
        } else if (p.q3 + p.q4 > p.q1 + p.q2) {
            pattern = 'üî¥ Final de partido';
        } else {
            pattern = '‚ö™ Equilibrado';
        }
        
        return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${p.num}</div>
                    <div>
                        <div class="player-name">${p.name}</div>
                        <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                            ${pattern}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: #fde047; font-weight: bold;">
                        Prefiere: ${maxQuarter.name} (${maxQuarter.value}x)
                    </div>
                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                        Total: ${total} titularidades
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// NUEVA FUNCI√ìN: Tabla de Rendimiento - CORREGIDA
function renderPerformanceTable() {
    const table = document.getElementById('performanceTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const playerPerformance = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerPerformance[playerName]) {
                playerPerformance[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 },
                    suplente: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 }
                };
            }
            
            // Analizar cuarto por cuarto
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const isInLineup = match.lineups[q] && match.lineups[q].includes(player.numero);
                const quarterGoalsFor = match.periodScores[q].cnt;
                const quarterGoalsAgainst = match.periodScores[q].rival;
                
                if (isInLineup) {
                    // Es titular en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].titular.quarters++;
                    playerPerformance[playerName].titular.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].titular.teamGoalsAgainst += quarterGoalsAgainst;
                } else {
                    // Es suplente en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].suplente.quarters++;
                    playerPerformance[playerName].suplente.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].suplente.teamGoalsAgainst += quarterGoalsAgainst;
                }
            });
        });
    });
    
    const players = Object.values(playerPerformance)
        .filter(p => p.titular.quarters > 0 || p.suplente.quarters > 0)
        .sort((a, b) => {
            const avgA = a.titular.quarters > 0 ? (a.titular.teamGoalsFor / a.titular.quarters) : 0;
            const avgB = b.titular.quarters > 0 ? (b.titular.teamGoalsFor / b.titular.quarters) : 0;
            return avgB - avgA;
        });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th rowspan="2">N¬∫</th>
                <th rowspan="2">Jugador</th>
                <th colspan="3" style="background: rgba(34, 197, 94, 0.3);">Cuando es Titular</th>
                <th colspan="3" style="background: rgba(239, 68, 68, 0.3);">Cuando es Suplente</th>
                <th rowspan="2">Dif GF/Q</th>
                <th rowspan="2">Dif GC/Q</th>
            </tr>
            <tr>
                <th style="background: rgba(34, 197, 94, 0.2);">Cuartos</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GC/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">Cuartos</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GC/Q Equipo</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const titularAvgGF = p.titular.quarters > 0 ? (p.titular.teamGoalsFor / p.titular.quarters).toFixed(2) : '-';
                const titularAvgGC = p.titular.quarters > 0 ? (p.titular.teamGoalsAgainst / p.titular.quarters).toFixed(2) : '-';
                
                const suplenteAvgGF = p.suplente.quarters > 0 ? (p.suplente.teamGoalsFor / p.suplente.quarters).toFixed(2) : '-';
                const suplenteAvgGC = p.suplente.quarters > 0 ? (p.suplente.teamGoalsAgainst / p.suplente.quarters).toFixed(2) : '-';
                
                // Diferencia de goles A FAVOR (cuando es titular vs suplente)
                // Positivo = metemos M√ÅS goles cuando es titular (bueno)
                // Negativo = metemos MENOS goles cuando es titular (malo)
                const diffGF = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsFor / p.titular.quarters) - (p.suplente.teamGoalsFor / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGFColor = 'white';
                if (diffGF !== '-') {
                    // Verde si metemos M√ÅS goles cuando es titular (positivo)
                    // Rojo si metemos MENOS goles cuando es titular (negativo)
                    diffGFColor = parseFloat(diffGF) > 0 ? '#22c55e' : parseFloat(diffGF) < 0 ? '#ef4444' : '#fbbf24';
                }
                
                // Diferencia de goles EN CONTRA (cuando es titular vs suplente)
                // Positivo = recibimos M√ÅS goles cuando es titular (malo)
                // Negativo = recibimos MENOS goles cuando es titular (bueno)
                const diffGC = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsAgainst / p.titular.quarters) - (p.suplente.teamGoalsAgainst / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGCColor = 'white';
                if (diffGC !== '-') {
                    // Verde si recibimos MENOS goles cuando es titular (negativo)
                    // Rojo si recibimos M√ÅS goles cuando es titular (positivo)
                    diffGCColor = parseFloat(diffGC) < 0 ? '#22c55e' : parseFloat(diffGC) > 0 ? '#ef4444' : '#fbbf24';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.titular.quarters}</td>
                        <td><strong style="color: #fde047;">${titularAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${titularAvgGC}</strong></td>
                        <td>${p.suplente.quarters}</td>
                        <td><strong style="color: #fde047;">${suplenteAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${suplenteAvgGC}</strong></td>
                        <td style="color: ${diffGFColor}; font-weight: bold;">
                            ${diffGF !== '-' ? (diffGF > 0 ? '+' : '') + diffGF : '-'}
                        </td>
                        <td style="color: ${diffGCColor}; font-weight: bold;">
                            ${diffGC !== '-' ? (diffGC > 0 ? '+' : '') + diffGC : '-'}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
function populatePlayerFilter() {
    const select = document.getElementById('filterPlayer');
    
    if (allMatches.length === 0) return;
    
    const playerSet = new Set();
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
        players.map(p => `<option value="${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayer() {
    const playerName = document.getElementById('filterPlayer').value;
    
    if (!playerName) {
        document.getElementById('playerStatsCard').classList.add('hidden');
        return;
    }
    
    const playerData = {
        name: playerName,
        num: 0,
        partidos: 0,
        gols: [],
        exclusions: [],
        dates: [],
        totalGols: 0,
        totalExclusions: 0,
        goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
        penaltyMissed: 0,
        titular: { q1: 0, q2: 0, q3: 0, q4: 0 },
        totalParades: 0,
        bestParades: 0,
        paradeTypes: { corner: 0, rebuig: 0, atrapa: 0 },
        totalAssistencies: 0,
        totalRobatoris: 0,
        totalPerdues: 0,
        totalXutsFallats: 0,
        totalBlocks: 0,
        totalFaltesRebudes: 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === playerName);
        
        if (player) {
            playerData.num = player.numero;
            playerData.partidos++;
            playerData.gols.push(player.estadistiques.gols);
            playerData.exclusions.push(player.estadistiques.exclusions);
            playerData.dates.push(new Date(match.data).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
            playerData.totalGols += player.estadistiques.gols;
            playerData.totalExclusions += player.estadistiques.exclusions;
            playerData.penaltyMissed += player.estadistiques.penaltyMissed || 0;
            playerData.totalParades += (player.estadistiques.parades || 0);
            playerData.totalAssistencies += (player.estadistiques.assistencies || 0);
            playerData.totalRobatoris += (player.estadistiques.robatoris || 0);
            playerData.totalPerdues += (player.estadistiques.perdues || 0);
            playerData.totalXutsFallats += (player.estadistiques.xutsFallats || 0);
            playerData.totalBlocks += (player.estadistiques.blocks || 0);
            playerData.totalFaltesRebudes += (player.estadistiques.faltesRebudes || 0);

            if (player.estadistiques.parades && player.estadistiques.parades > playerData.bestParades) {
                playerData.bestParades = player.estadistiques.parades;
            }

            if (player.estadistiques.paradeTypes) {
                Object.keys(playerData.paradeTypes).forEach(type => {
                    playerData.paradeTypes[type] += (player.estadistiques.paradeTypes[type] || 0);
                });
            }
            
            if (player.estadistiques.goalTypes) {
                Object.keys(playerData.goalTypes).forEach(type => {
                    playerData.goalTypes[type] += (player.estadistiques.goalTypes[type] || 0);
                });
            }
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                if (match.lineups[q] && match.lineups[q].includes(player.numero)) {
                    playerData.titular[q]++;
                }
            });
        }
    });
    
    document.getElementById('playerStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerName').textContent = `${playerData.num}. ${playerName}`;
    
    // Calcular efici√®ncia de tir
    const totalXuts = playerData.totalGols + playerData.totalXutsFallats;
    const eficienciaTir = totalXuts > 0 ? ((playerData.totalGols / totalXuts) * 100).toFixed(1) : '0.0';
    const eficColor = eficienciaTir >= 50 ? '#22c55e' : eficienciaTir >= 30 ? '#fbbf24' : '#ef4444';
    
    // Calcular promitjos
    const goalsPerMatch = playerData.partidos > 0 ? (playerData.totalGols / playerData.partidos).toFixed(1) : '0.0';
    const exclusionsPerMatch = playerData.partidos > 0 ? (playerData.totalExclusions / playerData.partidos).toFixed(1) : '0.0';
    
    document.getElementById('playerSummaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos Jugados</div>
            <div class="info-value">${playerData.partidos}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Goles</div>
            <div class="info-value" style="color: #fde047;">${playerData.totalGols}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles/Partido</div>
            <div class="info-value" style="color: #fde047;">${goalsPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Exclusiones</div>
            <div class="info-value" style="color: #fca5a5;">${playerData.totalExclusions}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Exc/Partido</div>
            <div class="info-value" style="color: #fca5a5;">${exclusionsPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Eficiencia Tiro</div>
            <div class="info-value" style="color: ${eficColor}; font-weight: bold;">${eficienciaTir}%</div>
        </div>
        ${playerData.totalAssistencies > 0 ? `
        <div class="info-item">
            <div class="info-label">üéØ Assist√®ncies</div>
            <div class="info-value" style="color: #86efac;">${playerData.totalAssistencies}</div>
        </div>
        ` : ''}
        ${playerData.totalRobatoris > 0 ? `
        <div class="info-item">
            <div class="info-label">üõ°Ô∏è Robatoris</div>
            <div class="info-value" style="color: #7dd3fc;">${playerData.totalRobatoris}</div>
        </div>
        ` : ''}
        ${playerData.totalPerdues > 0 ? `
        <div class="info-item">
            <div class="info-label">‚ùå P√®rdues</div>
            <div class="info-value" style="color: #fca5a5;">${playerData.totalPerdues}</div>
        </div>
        ` : ''}
        ${playerData.totalXutsFallats > 0 ? `
        <div class="info-item">
            <div class="info-label">üéØ‚ùå Xuts Fallats</div>
            <div class="info-value" style="color: #fb923c;">${playerData.totalXutsFallats}</div>
        </div>
        ` : ''}
        ${playerData.totalBlocks > 0 ? `
        <div class="info-item">
            <div class="info-label">‚úã Blocks</div>
            <div class="info-value" style="color: #a78bfa;">${playerData.totalBlocks}</div>
        </div>
        ` : ''}
        ${playerData.totalParades > 0 ? `
        <div class="info-item">
            <div class="info-label">üß§ Parades</div>
            <div class="info-value" style="color: #c084fc;">${playerData.totalParades}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Millor Partit (Parades)</div>
            <div class="info-value" style="color: #c084fc;">${playerData.bestParades}</div>
        </div>
        ` : ''}
        ${playerData.totalFaltesRebudes > 0 ? `
        <div class="info-item">
            <div class="info-label">‚ö†Ô∏è Faltes Rebudes</div>
            <div class="info-value" style="color: #fbbf24;">${playerData.totalFaltesRebudes}</div>
        </div>
        ` : ''}
        ${playerData.penaltyMissed > 0 ? `
        <div class="info-item">
            <div class="info-label">Penalties Fallados</div>
            <div class="info-value" style="color: #ef4444;">${playerData.penaltyMissed}</div>
        </div>
        ` : ''}
    `;
    
    // Resta del codi per gr√†fics...
    renderPlayerEvolutionChart(playerData);
    renderPlayerExclusionsChart(playerData);
}

function displayPlayerStats(data) {
    document.getElementById('playerStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerName').textContent = `${data.num}. ${data.name}`;
    
    const avgGols = data.partidos > 0 ? (data.totalGols / data.partidos).toFixed(2) : 0;
    const avgExc = data.partidos > 0 ? (data.totalExclusions / data.partidos).toFixed(2) : 0;
    const totalTitular = data.titular.q1 + data.titular.q2 + data.titular.q3 + data.titular.q4;
    const maxPossibleTitular = data.partidos * 4;
    const titularPercentage = maxPossibleTitular > 0 ? ((totalTitular / maxPossibleTitular) * 100).toFixed(1) : 0;
    
    const bestMatch = Math.max(...data.gols);
    const bestMatchIndex = data.gols.indexOf(bestMatch);
    
    const isGoalkeeper = data.num === 1 || data.num === 13;

document.getElementById('playerSummaryGrid').innerHTML = `
    <div class="info-item">
        <div class="info-label">Partidos Jugados</div>
        <div class="info-value">${data.partidos}</div>
    </div>
    ${isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">üß§ Total Parades</div>
        <div class="info-value" style="color: #8b5cf6;">${data.totalParades || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Parades/Partido</div>
        <div class="info-value">${data.partidos > 0 ? (data.totalParades / data.partidos).toFixed(1) : '0.0'}</div>
    </div>
    ` : `
    <div class="info-item">
        <div class="info-label">Total Goles</div>
        <div class="info-value" style="color: #fde047;">${data.totalGols}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Goles/Partido</div>
        <div class="info-value">${avgGols}</div>
    </div>
    `}
	${!isGoalkeeper ? `
<div class="info-item">
    <div class="info-label">üéØ Efici√®ncia de Tir</div>
    <div class="info-value" style="color: ${(() => {
        const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
        const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100) : 0;
        return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
    })()};">
        ${(() => {
            const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
            const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100).toFixed(1) : '0.0';
            return totalXuts > 0 ? `${data.totalGols}/${totalXuts} (${efic}%)` : '-';
        })()}
    </div>
</div>
` : ''}
    <div class="info-item">
        <div class="info-label">Mejor Partido</div>
        <div class="info-value" style="color: #22c55e;">${isGoalkeeper ? (data.bestParades || 0) + ' parades' : bestMatch + ' goles'}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Total Exclusiones</div>
        <div class="info-value" style="color: #f97316;">${data.totalExclusions}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Exclusiones/Partido</div>
        <div class="info-value">${avgExc}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üéØ Assist√®ncies</div>
        <div class="info-value" style="color: #22c55e;">${data.totalAssistencies || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üõ°Ô∏è Robatoris</div>
        <div class="info-value" style="color: #06b6d4;">${data.totalRobatoris || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">‚ùå P√®rdues</div>
        <div class="info-value" style="color: #ef4444;">${data.totalPerdues || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">üéØ‚ùå Xuts Fallats</div>
        <div class="info-value" style="color: #f97316;">${data.totalXutsFallats || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Penaltis Fallados</div>
        <div class="info-value" style="color: ${data.penaltyMissed === 0 ? '#22c55e' : '#ef4444'};">${data.penaltyMissed}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Titularidad</div>
        <div class="info-value">${totalTitular}/${maxPossibleTitular} <span style="font-size: 14px;">(${titularPercentage}%)</span></div>
    </div>
`;
    
    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penaltis',
        'contra': 'Contraataques',
        'boya': 'Boya',
        'normal': 'Normales'
    };
    
    document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.goalTypes)
        .filter(type => data.goalTypes[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${data.goalTypes[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${data.totalGols > 0 ? ((data.goalTypes[type] / data.totalGols) * 100).toFixed(1) : 0}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';
    // ‚úÖ NUEVO: Desglossament de parades (nom√©s porters)
if (data.num === 1 || data.num === 13) {
    const paradeLabels = {
        'corner': 'Corner',
        'rebuig': 'Rebuig',
        'atrapa': 'Atrapa'
    };
    
    const paradesBreakdownHTML = Object.keys(data.paradeTypes)
        .filter(type => data.paradeTypes[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${paradeLabels[type]}</div>
                <div class="breakdown-value">${data.paradeTypes[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${data.totalParades > 0 ? ((data.paradeTypes[type] / data.totalParades) * 100).toFixed(1) : 0}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de parades</p>';
    
    // Substituir el contingut de playerGoalsBreakdown per parades si √©s porter
    document.getElementById('playerGoalsBreakdown').innerHTML = paradesBreakdownHTML;
    
    // Canviar el t√≠tol de la secci√≥
    const titleElement = document.querySelector('#playerStatsCard h3');
    if (titleElement && titleElement.textContent.includes('Desglose de Goles')) {
        titleElement.innerHTML = '<span class="section-title" style="margin-top: 20px;">üß§ Desglose de Parades</span>';
    }
}
    renderPlayerEvolutionChart(data);
    renderPlayerExclusionsChart(data);
    
    document.getElementById('playerStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    if (!ctx) return;
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Goles por Partido',
                data: data.gols,
                borderColor: '#fde047',
                backgroundColor: 'rgba(253, 224, 71, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#fde047'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerExclusionsChart(data) {
    const ctx = document.getElementById('playerExclusionsChart');
    if (!ctx) return;
    
    if (window.playerExclusionsChartInstance) {
        window.playerExclusionsChartInstance.destroy();
    }
    
    window.playerExclusionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Exclusiones por Partido',
                data: data.exclusions,
                backgroundColor: '#f97316',
                borderColor: '#ea580c',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function clearPlayerFilter() {
    document.getElementById('filterPlayer').value = '';
    document.getElementById('playerStatsCard').classList.add('hidden');
}
function renderMatchTimeline() {
    const container = document.getElementById('matchTimeline');
    if (!container || !currentMatch) return;
    
    // Verificar si hay acciones cronol√≥gicas guardadas
    if (!currentMatch.chronologicalActions || currentMatch.chronologicalActions.length === 0) {
        container.innerHTML = '<div class="no-timeline">‚ö†Ô∏è Este partido no tiene registro cronol√≥gico de acciones.<br><small style="margin-top: 8px; display: block;">Los partidos nuevos registrados con la app actualizada mostrar√°n las acciones en orden.</small></div>';
        return;
    }
    
    // Ordenar por timestamp
    const sortedActions = [...currentMatch.chronologicalActions].sort((a, b) => a.timestamp - b.timestamp);
    
    const goalTypeLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };
    
    const quarterLabels = {
        'q1': '1¬∫ Cuarto',
        'q2': '2¬∫ Cuarto',
        'q3': '3¬∫ Cuarto',
        'q4': '4¬∫ Cuarto'
    };
    
    container.innerHTML = `
        <div class="timeline">
            ${sortedActions.map(action => {
                let detailText = '';
                let icon = '';
                let cssClass = '';
                const isRival = action.team === 'rival';
                const playerClass = isRival ? 'timeline-rival' : 'timeline-player';
                const teamName = isRival ? (currentMatch.rivalTeam || 'Rival') : 'CN Terrassa';
                
                if (action.type === 'goal') {
                    icon = '‚öΩ';
                    cssClass = 'goal';
                    detailText = `Gol ${goalTypeLabels[action.goalType]}`;
                } else if (action.type === 'exclusion') {
                    icon = 'üü•';
                    cssClass = 'exclusion';
                    detailText = action.exclusionType === 'penalty' ? 'Exclusi√≥n por Penalty' : 'Exclusi√≥n';
                    
                    // Afegir informaci√≥ de qui ha rebut la falta (si √©s exclusi√≥ rival)
                    if (isRival && action.faltaSobreJugador) {
                        const jugadorCNT = currentMatch.jugadors.find(j => j.numero == action.faltaSobreJugador);
                        if (jugadorCNT) {
                            detailText += ` <span style="font-size: 11px; opacity: 0.7;">(falta sobre ${jugadorCNT.numero}. ${jugadorCNT.nom})</span>`;
                        }
                    }
                } else if (action.type === 'penalty-missed') {
                    icon = '‚ùå';
                    cssClass = 'penalty-missed';
                    detailText = 'Penalty Fallado';
                } else if (action.type === 'save') {
                    icon = 'üß§';
                    cssClass = 'save';
                    const saveTypes = {
                        'corner': 'Corner',
                        'rebuig': 'Rebuig',
                        'atrapa': 'Atrapa'
                    };
                    detailText = `Parada (${saveTypes[action.saveType] || action.saveType})`;
                } else if (action.type === 'action') {
                    // NOVES ACCIONS
                    const actionType = action.actionType;
                    if (actionType === 'assistencia') {
                        icon = 'üéØ';
                        cssClass = 'action-assist';
                        detailText = 'Assist√®ncia';
                    } else if (actionType === 'robatori') {
                        icon = 'üõ°Ô∏è';
                        cssClass = 'action-steal';
                        detailText = 'Robatori';
                    } else if (actionType === 'perdua') {
                        icon = '‚ùå';
                        cssClass = 'action-turnover';
                        detailText = 'P√®rdua';
                    } else if (actionType === 'xut' || actionType === 'xutFallat') {
                        icon = 'üéØ‚ùå';
                        cssClass = 'action-missed';
                        detailText = 'Xut Fallat';
                    } else if (actionType === 'block') {
                        icon = '‚úã';
                        cssClass = 'action-block';
                        detailText = 'Block';
                    }
                } else if (action.type === 'water-change') {
                    icon = action.action === 'in' ? 'üåä‚û°Ô∏è' : 'üåä‚¨ÖÔ∏è';
                    cssClass = 'water-change';
                    detailText = action.action === 'in' ? 'Entra al agua' : 'Sale del agua';
                }
                
                return `
                    <div class="timeline-item ${cssClass}">
                        <div class="timeline-icon">${icon}</div>
                        <div class="timeline-content">
                            <div class="${playerClass}">
                                ${action.playerNum}. ${action.playerName}
                                <span style="font-size: 11px; opacity: 0.8;">(${teamName})</span>
                            </div>
                            <div class="timeline-detail">${detailText}</div>
                        </div>
                        <div class="timeline-quarter">${quarterLabels[action.quarter] || action.quarter}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
function renderPlayingTimes() {
    const container = document.getElementById('playingTimesContainer');
    
    if (!container || !currentMatch) return;
    
    if (!currentMatch.playerWaterChanges || currentMatch.playerWaterChanges.length === 0 || !currentMatch.quarterStartTimes) {
        container.innerHTML = '<div class="no-data">‚ö†Ô∏è Aquest partit no t√© registre de temps de joc.<br><small style="margin-top: 8px; display: block;">Els partits nous registrats amb l\'app actualitzada mostraran els temps.</small></div>';
        return;
    }
    
    const quarterDuration = 480;
    const playerTimes = {};
    
    currentMatch.jugadors.forEach(player => {
        const playerNum = player.numero;
        const playerName = player.nom;
        const times = { q1: 0, q2: 0, q3: 0, q4: 0, total: 0 };
        
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const quarterStartTime = getQuarterRealStartTime(currentMatch, quarter);
            const quarterRealEndTime = currentMatch.quarterRealEndTimes?.[quarter];
            const quarterEndTime = quarterRealEndTime || (quarterStartTime + quarterDuration * 1000);
            
            if (!quarterStartTime) {
                times[quarter] = 0;
                return;
            }
            
            const lineup = currentMatch.lineups[quarter] || [];
            const isTitular = lineup.includes(playerNum);
            
            const qChanges = currentMatch.playerWaterChanges.filter(c => 
                c.playerNum === playerNum && 
                c.quarter === quarter &&
                c.timestamp >= quarterStartTime && 
                c.timestamp <= quarterEndTime
            );
            
            if (qChanges.length === 0) {
                if (isTitular) {
                    times[quarter] = quarterDuration;
                } else {
                    times[quarter] = 0;
                }
                return;
            }
            
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            const uniqueChanges = [];
            let lastTimestamp = null;
            let lastAction = null;
            
            qChanges.forEach(change => {
                if (change.timestamp === lastTimestamp && change.action === lastAction) {
                    return;
                }
                
                if (uniqueChanges.length === 0) {
                    if (isTitular && change.action === 'out') {
                        uniqueChanges.push(change);
                    } else if (!isTitular && change.action === 'in') {
                        uniqueChanges.push(change);
                    }
                } else {
                    const lastValidAction = uniqueChanges[uniqueChanges.length - 1].action;
                    if ((lastValidAction === 'in' && change.action === 'out') ||
                        (lastValidAction === 'out' && change.action === 'in')) {
                        uniqueChanges.push(change);
                    }
                }
                
                lastTimestamp = change.timestamp;
                lastAction = change.action;
            });
            
            let timeInWater = 0;
            
            if (isTitular) {
                if (uniqueChanges.length === 0) {
                    timeInWater = quarterDuration;
                } else if (uniqueChanges[0].action === 'out') {
                    timeInWater += (uniqueChanges[0].timestamp - quarterStartTime) / 1000;
                    
                    for (let i = 1; i < uniqueChanges.length; i += 2) {
                        if (i < uniqueChanges.length && uniqueChanges[i].action === 'in') {
                            const inTime = uniqueChanges[i].timestamp;
                            const outTime = (i + 1 < uniqueChanges.length && uniqueChanges[i + 1].action === 'out')
                                ? uniqueChanges[i + 1].timestamp
                                : quarterEndTime;
                            
                            const duration = (outTime - inTime) / 1000;
                            if (duration > 0 && duration <= quarterDuration) {
                                timeInWater += duration;
                            }
                        }
                    }
                }
            } else {
                for (let i = 0; i < uniqueChanges.length; i++) {
                    if (uniqueChanges[i].action === 'in') {
                        const inTime = uniqueChanges[i].timestamp;
                        const outTime = (i + 1 < uniqueChanges.length && uniqueChanges[i + 1].action === 'out')
                            ? uniqueChanges[i + 1].timestamp
                            : quarterEndTime;
                        
                        const duration = (outTime - inTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                    }
                }
            }
            
            times[quarter] = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
        });
        
        times.total = times.q1 + times.q2 + times.q3 + times.q4;
        
        playerTimes[playerNum] = {
            num: playerNum,
            name: playerName,
            times: times
        };
    });
    
    const sortedPlayers = Object.values(playerTimes).sort((a, b) => b.times.total - a.times.total);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    container.innerHTML = `
        <div style="overflow-x: auto;">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>N¬∫</th>
                        <th>Jugador</th>
                        <th>1Q</th>
                        <th>2Q</th>
                        <th>3Q</th>
                        <th>4Q</th>
                        <th>TOTAL</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedPlayers.map(p => {
                        const maxPossible = 1920;
                        const percentage = ((p.times.total / maxPossible) * 100).toFixed(1);
                        const color = percentage >= 75 ? '#22c55e' : percentage >= 50 ? '#fbbf24' : '#f97316';
                        
                        return `
                            <tr>
                                <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                                <td><strong>${p.name}</strong></td>
                                <td>${formatTime(p.times.q1)}</td>
                                <td>${formatTime(p.times.q2)}</td>
                                <td>${formatTime(p.times.q3)}</td>
                                <td>${formatTime(p.times.q4)}</td>
                                <td><strong style="color: #fde047;">${formatTime(p.times.total)}</strong></td>
                                <td><strong style="color: ${color};">${percentage}%</strong></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <p style="font-size: 12px; color: #bae6fd; margin-top: 12px; text-align: center;">
            ‚è±Ô∏è Temps m√†xim: 32 minuts (4 quarts √ó 8 minuts)
        </p>
    `;
}
// ============================================
// FUNCIONES PARA ESTAD√çSTICAS DE TIEMPO
// ============================================

function displayTimeStats() {
    console.log('=== displayTimeStats called ===');
    console.log('Total matches:', allMatches.length);
    console.log('allMatches:', allMatches);
    
    // Filtrar partidos con datos de tiempo
    matchesWithTime = allMatches.filter(m => {
        console.log('Checking match:', m.rivalTeam);
        console.log('- Has playerWaterChanges:', !!m.playerWaterChanges);
        console.log('- playerWaterChanges length:', m.playerWaterChanges ? m.playerWaterChanges.length : 0);
        console.log('- Has quarterStartTimes:', !!m.quarterStartTimes);
        
        // Excluir partidos sin datos de tiempo completos
        const hasTimeData = m.playerWaterChanges && 
                            m.playerWaterChanges.length > 0 && 
                            m.quarterStartTimes;
        
        if (!hasTimeData) {
            console.warn('Partido sin datos de tiempo completos:', m.rivalTeam);
        }
        
        return hasTimeData;
    });
    
    console.log('Matches with time data:', matchesWithTime.length);
    console.log('matchesWithTime:', matchesWithTime);
    
    if (matchesWithTime.length === 0) {
        document.getElementById('tiempoTab').innerHTML = `
            <div class="card">
                <div class="no-data">
                    <p style="color: #fbbf24; font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è No hay datos de tiempo disponibles</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Los partidos deben tener registrados los cambios de agua (playerWaterChanges) y tiempos de cuarto (quarterStartTimes) para mostrar estas estad√≠sticas.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partidos cargados: ${allMatches.length}<br>
                        Partidos con datos de tiempo: 0
                    </p>
                </div>
            </div>
        `;
        return;
    }
    
    console.log('Calling populatePlayerTimeFilter...');
    populatePlayerTimeFilter();
    
    console.log('Calling renderTotalTimeChart...');
    renderTotalTimeChart();
    
    console.log('Calling renderTimeHeatmapTable...');
    renderTimeHeatmapTable();
    
    console.log('Calling other render functions...');
    renderEfficiencyPerMinuteChart();
    renderMinutesDistributionChart();
    renderPlusMinusChart();
    renderLoadBalanceStats();
    renderQuarterAnalysisTable();
    renderPerformanceVsTimeChart();
    renderFatigueAnalysisTable();
    renderRotationStats();
    
    console.log('=== displayTimeStats finished ===');
}

function populatePlayerTimeFilter() {
    const select = document.getElementById('filterPlayerTime');
    
    if (matchesWithTime.length === 0) return;
    
    const playerSet = new Set();
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
        players.map(p => `<option value="${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayerTime() {
    const playerName = document.getElementById('filterPlayerTime').value;
    
    if (!playerName) {
        document.getElementById('playerTimeStatsCard').classList.add('hidden');
        return;
    }
    
    const playerTimeData = calculatePlayerTimeData(playerName);
    displayPlayerTimeStats(playerTimeData);
}

function clearPlayerTimeFilter() {
    document.getElementById('filterPlayerTime').value = '';
    document.getElementById('playerTimeStatsCard').classList.add('hidden');
}

function calculatePlayerTimeData(playerName) {
    const data = {
        name: playerName,
        num: 0,
        partidos: 0,
        timeByMatch: [],
        timeByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        totalTime: 0,
        gols: 0,
        exclusions: 0,
        titularTime: 0,
        suplenteTime: 0,
        titularGols: 0,
        suplenteGols: 0,
        titularExclusions: 0,
        suplenteExclusions: 0,
        dates: []
    };
    
    matchesWithTime.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === playerName);
        if (!player) return;
        
        data.num = player.numero;
        data.partidos++;
        data.gols += player.estadistiques.gols;
        data.exclusions += player.estadistiques.exclusions;
        data.dates.push(new Date(match.data).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
        
        const quarterDuration = 480;
        let matchTime = 0;
        
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const quarterEndTime = getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration);
            
            if (!quarterStartTime) return;
            
            const lineup = match.lineups[quarter] || [];
            const isTitular = lineup.includes(player.numero);
            
            const qChanges = match.playerWaterChanges.filter(c => 
                c.playerNum === player.numero && 
                c.quarter === quarter
            );
            
            const validChanges = qChanges.filter(c => 
                c.timestamp >= quarterStartTime && 
                c.timestamp <= quarterEndTime
            ).sort((a, b) => a.timestamp - b.timestamp);
            
            const cleanChanges = [];
            let lastAction = null;
            
            validChanges.forEach(change => {
                if (change.action !== lastAction) {
                    cleanChanges.push(change);
                    lastAction = change.action;
                }
            });
            
            let timeInWater = 0;
            
            if (isTitular && cleanChanges.length === 0) {
                timeInWater = quarterDuration;
            }
            else if (isTitular && cleanChanges.length > 0 && cleanChanges[0].action === 'out') {
                const firstOut = cleanChanges[0].timestamp;
                timeInWater += (firstOut - quarterStartTime) / 1000;
                
                for (let i = 1; i < cleanChanges.length; i += 2) {
                    if (i < cleanChanges.length && cleanChanges[i].action === 'in') {
                        const inTime = cleanChanges[i].timestamp;
                        const outTime = (i + 1 < cleanChanges.length && cleanChanges[i + 1].action === 'out')
                            ? cleanChanges[i + 1].timestamp
                            : quarterEndTime;
                        
                        const duration = (outTime - inTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                    }
                }
            }
            else if (!isTitular) {
                for (let i = 0; i < cleanChanges.length; i++) {
                    if (cleanChanges[i].action === 'in') {
                        const inTime = cleanChanges[i].timestamp;
                        const outTime = (i + 1 < cleanChanges.length && cleanChanges[i + 1].action === 'out')
                            ? cleanChanges[i + 1].timestamp
                            : quarterEndTime;
                        
                        const duration = (outTime - inTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                    }
                }
            }
            
            const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
            data.timeByQuarter[quarter] += quarterTime;
            matchTime += quarterTime;
            
            if (isTitular) {
                data.titularTime += quarterTime;
            } else {
                data.suplenteTime += quarterTime;
            }
        });
        
        data.timeByMatch.push(matchTime);
        data.totalTime += matchTime;
    });
    
    if (data.totalTime > 0) {
        const titularRatio = data.titularTime / data.totalTime;
        data.titularGols = Math.round(data.gols * titularRatio);
        data.suplenteGols = data.gols - data.titularGols;
        data.titularExclusions = Math.round(data.exclusions * titularRatio);
        data.suplenteExclusions = data.exclusions - data.titularExclusions;
    }
    
    data.timeByMatch.reverse();
    data.dates.reverse();
    
    return data;
}
function displayPlayerTimeStats(data) {
    document.getElementById('playerTimeStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerTimeName').textContent = `${data.num}. ${data.name}`;
    
    const avgTime = data.partidos > 0 ? (data.totalTime / data.partidos / 60).toFixed(1) : 0;
    const maxPossibleTime = data.partidos * 32;
    const timePercentage = maxPossibleTime > 0 ? ((data.totalTime / 60 / maxPossibleTime) * 100).toFixed(1) : 0;
    const goalsPerMinute = data.totalTime > 0 ? ((data.gols / (data.totalTime / 60))).toFixed(2) : 0;
    const exclusionsPerMinute = data.totalTime > 0 ? ((data.exclusions / (data.totalTime / 60))).toFixed(2) : 0;
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    document.getElementById('playerTimeSummaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos con Datos</div>
            <div class="info-value">${data.partidos}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Total Jugado</div>
            <div class="info-value" style="color: #fde047;">${formatTime(data.totalTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio/Partido</div>
            <div class="info-value">${avgTime} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">% del Tiempo M√°ximo</div>
            <div class="info-value" style="color: ${timePercentage >= 75 ? '#22c55e' : timePercentage >= 50 ? '#fbbf24' : '#f97316'};">${timePercentage}%</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Goles</div>
            <div class="info-value" style="color: #22c55e;">${data.gols}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles por Minuto</div>
            <div class="info-value">${goalsPerMinute}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Exclusiones</div>
            <div class="info-value" style="color: #f97316;">${data.exclusions}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Exclusiones por Minuto</div>
            <div class="info-value">${exclusionsPerMinute}</div>
        </div>
    `;
    
    // Eficiencia breakdown
    document.getElementById('playerEfficiencyBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">Goles / Minuto</div>
            <div class="breakdown-value" style="color: #22c55e;">${goalsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Exclusiones / Minuto</div>
            <div class="breakdown-value" style="color: #f97316;">${exclusionsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Ratio Gol/Exclusi√≥n</div>
            <div class="breakdown-value">${data.exclusions > 0 ? (data.gols / data.exclusions).toFixed(2) : data.gols}</div>
        </div>
    `;
    
    // Titular vs Suplente
    const titularMinutes = (data.titularTime / 60).toFixed(1);
    const suplenteMinutes = (data.suplenteTime / 60).toFixed(1);
    const titularGoalsPerMin = data.titularTime > 0 ? (data.titularGols / (data.titularTime / 60)).toFixed(2) : 0;
    const suplenteGoalsPerMin = data.suplenteTime > 0 ? (data.suplenteGols / (data.suplenteTime / 60)).toFixed(2) : 0;
    
    document.getElementById('playerTitularVsSuplenteGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">‚ö™ Tiempo como Titular</div>
            <div class="info-value" style="color: #22c55e;">${titularMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.titularGols} goles (${titularGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">üî¥ Tiempo como Suplente</div>
            <div class="info-value" style="color: #fbbf24;">${suplenteMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.suplenteGols} goles (${suplenteGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">‚ö° Diferencia Eficiencia</div>
            <div class="info-value" style="color: ${titularGoalsPerMin > suplenteGoalsPerMin ? '#22c55e' : '#ef4444'};">
                ${titularGoalsPerMin > suplenteGoalsPerMin ? '+ Titular' : '+ Suplente'}
            </div>
        </div>
    `;
    
    renderPlayerTimeEvolutionChart(data);
    renderPlayerTimeByQuarterChart(data);
    
    document.getElementById('playerTimeStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderPlayerTimeEvolutionChart(data) {
    const ctx = document.getElementById('playerTimeEvolutionChart');
    if (!ctx) return;
    
    if (window.playerTimeEvolutionChartInstance) {
        window.playerTimeEvolutionChartInstance.destroy();
    }
    
    const timeInMinutes = data.timeByMatch.map(t => (t / 60).toFixed(1));
    
    window.playerTimeEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Minutos Jugados',
                data: timeInMinutes,
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#06b6d4'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 32,
                    ticks: { color: 'white', stepSize: 4 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Minutos',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerTimeByQuarterChart(data) {
    const ctx = document.getElementById('playerTimeByQuarterChart');
    if (!ctx) return;
    
    if (window.playerTimeByQuarterChartInstance) {
        window.playerTimeByQuarterChartInstance.destroy();
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    const timeData = [data.timeByQuarter.q1, data.timeByQuarter.q2, data.timeByQuarter.q3, data.timeByQuarter.q4];
    
    window.playerTimeByQuarterChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tiempo Jugado (segundos)',
                data: timeData,
                backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tiempo: ${formatTime(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderTotalTimeChart() {
    const ctx = document.getElementById('totalTimeChart');
    if (!ctx) return;
    const subtitle = document.getElementById('timeChartSubtitle');
    if (subtitle) {
        const maxPossibleTime = matchesWithTime.length * 32;
        subtitle.textContent = `Basado en ${matchesWithTime.length} partido(s) - Tiempo m√°ximo: ${maxPossibleTime} minutos`;
    }
    if (window.totalTimeChartInstance) {
        window.totalTimeChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration);
                
                if (!quarterStartTime) return;
                
                const lineup = match.lineups[quarter] || [];
                const isTitular = lineup.includes(player.numero);
                
                const qChanges = match.playerWaterChanges.filter(c => 
                    c.playerNum === player.numero && 
                    c.quarter === quarter &&
                    c.timestamp >= quarterStartTime &&
                    c.timestamp <= quarterEndTime
                ).sort((a, b) => a.timestamp - b.timestamp);
                
                if (isTitular && qChanges.length === 0) {
                    playerTimes[playerName].totalTime += quarterDuration;
                    return;
                }
                
                if (!isTitular && qChanges.length === 0) {
                    return;
                }
                
                const cleanEvents = [];
                let lastAction = null;
                
                qChanges.forEach(change => {
                    if (change.action !== lastAction) {
                        cleanEvents.push(change);
                        lastAction = change.action;
                    }
                });
                
                let timeInWater = 0;
                
                if (isTitular && cleanEvents.length > 0 && cleanEvents[0].action === 'out') {
                    timeInWater += (cleanEvents[0].timestamp - quarterStartTime) / 1000;
                    
                    for (let i = 1; i < cleanEvents.length; i++) {
                        if (cleanEvents[i].action === 'in') {
                            const inTime = cleanEvents[i].timestamp;
                            const outTime = (i + 1 < cleanEvents.length && cleanEvents[i + 1].action === 'out')
                                ? cleanEvents[i + 1].timestamp
                                : quarterEndTime;
                            
                            const duration = (outTime - inTime) / 1000;
                            if (duration > 0 && duration <= quarterDuration) {
                                timeInWater += duration;
                            }
                        }
                    }
                } else if (!isTitular) {
                    for (let i = 0; i < cleanEvents.length; i++) {
                        if (cleanEvents[i].action === 'in') {
                            const inTime = cleanEvents[i].timestamp;
                            const outTime = (i + 1 < cleanEvents.length && cleanEvents[i + 1].action === 'out')
                                ? cleanEvents[i + 1].timestamp
                                : quarterEndTime;
                            
                            const duration = (outTime - inTime) / 1000;
                            if (duration > 0 && duration <= quarterDuration) {
                                timeInWater += duration;
                            }
                        }
                    }
                }
                
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes).sort((a, b) => b.totalTime - a.totalTime);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const timeInMinutes = players.map(p => (p.totalTime / 60).toFixed(1));
    const maxPossibleTime = matchesWithTime.length * 32;
    const percentages = players.map(p => ((p.totalTime / 60 / maxPossibleTime) * 100).toFixed(1));
    
    const backgroundColors = percentages.map(pct => {
        if (pct >= 75) return '#22c55e';
        if (pct >= 50) return '#fbbf24';
        if (pct >= 25) return '#f97316';
        return '#ef4444';
    });
    
    window.totalTimeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Minutos Jugados',
                data: timeInMinutes,
                backgroundColor: backgroundColors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: false 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            return [
                                `Tiempo: ${context.parsed.x} min`,
                                `Porcentaje: ${percentages[idx]}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    max: maxPossibleTime,
                    ticks: { 
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 10 : 12 }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Minutos',
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 11 : 14 }
                    }
                },
                y: { 
                    ticks: { 
                        color: 'white', 
                        font: { size: window.innerWidth < 768 ? 9 : 11 },
                        autoSkip: false
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderTimeHeatmapTable() {
    const table = document.getElementById('timeHeatmapTable');
    if (!table) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration);
                
                if (!quarterStartTime) return;
                
                const lineup = match.lineups[quarter] || [];
                const isTitular = lineup.includes(player.numero);
                
                const qChanges = match.playerWaterChanges.filter(c => 
                    c.playerNum === player.numero && 
                    c.quarter === quarter &&
                    c.timestamp >= quarterStartTime &&
                    c.timestamp <= quarterEndTime
                ).sort((a, b) => a.timestamp - b.timestamp);
                
                if (isTitular && qChanges.length === 0) {
                    playerTimes[playerName][quarter] += quarterDuration;
                    playerTimes[playerName].total += quarterDuration;
                    return;
                }
                
                if (!isTitular && qChanges.length === 0) {
                    return;
                }
                
                const cleanEvents = [];
                let lastAction = null;
                
                qChanges.forEach(change => {
                    if (change.action !== lastAction) {
                        cleanEvents.push(change);
                        lastAction = change.action;
                    }
                });
                
                let timeInWater = 0;
                
                if (isTitular && cleanEvents.length > 0 && cleanEvents[0].action === 'out') {
                    timeInWater += (cleanEvents[0].timestamp - quarterStartTime) / 1000;
                    
                    for (let i = 1; i < cleanEvents.length; i++) {
                        if (cleanEvents[i].action === 'in') {
                            const inTime = cleanEvents[i].timestamp;
                            const outTime = (i + 1 < cleanEvents.length && cleanEvents[i + 1].action === 'out')
                                ? cleanEvents[i + 1].timestamp
                                : quarterEndTime;
                            
                            const duration = (outTime - inTime) / 1000;
                            if (duration > 0 && duration <= quarterDuration) {
                                timeInWater += duration;
                            }
                        }
                    }
                } else if (!isTitular) {
                    for (let i = 0; i < cleanEvents.length; i++) {
                        if (cleanEvents[i].action === 'in') {
                            const inTime = cleanEvents[i].timestamp;
                            const outTime = (i + 1 < cleanEvents.length && cleanEvents[i + 1].action === 'out')
                                ? cleanEvents[i + 1].timestamp
                                : quarterEndTime;
                            
                            const duration = (outTime - inTime) / 1000;
                            if (duration > 0 && duration <= quarterDuration) {
                                timeInWater += duration;
                            }
                        }
                    }
                }
                
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName][quarter] += quarterTime;
                playerTimes[playerName].total += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes).sort((a, b) => b.total - a.total);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function getHeatColor(seconds, maxSeconds) {
        const ratio = seconds / maxSeconds;
        if (ratio >= 0.75) return 'background: rgba(34, 197, 94, 0.3);';
        if (ratio >= 0.5) return 'background: rgba(251, 191, 36, 0.3);';
        if (ratio >= 0.25) return 'background: rgba(249, 115, 22, 0.3);';
        return 'background: rgba(239, 68, 68, 0.3);';
    }
    
    const maxTime = Math.max(...players.map(p => p.total));
    
    const quarterTotals = { q1: 0, q2: 0, q3: 0, q4: 0, total: 0 };
    players.forEach(p => {
        quarterTotals.q1 += p.q1;
        quarterTotals.q2 += p.q2;
        quarterTotals.q3 += p.q3;
        quarterTotals.q4 += p.q4;
        quarterTotals.total += p.total;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>N¬∫</th>
                <th>Jugador</th>
                <th>1Q</th>
                <th>2Q</th>
                <th>3Q</th>
                <th>4Q</th>
                <th>TOTAL</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
                    <td style="${getHeatColor(p.q1, maxTime / 4)}">${formatTime(p.q1)}</td>
                    <td style="${getHeatColor(p.q2, maxTime / 4)}">${formatTime(p.q2)}</td>
                    <td style="${getHeatColor(p.q3, maxTime / 4)}">${formatTime(p.q3)}</td>
                    <td style="${getHeatColor(p.q4, maxTime / 4)}">${formatTime(p.q4)}</td>
                    <td style="background: rgba(34, 211, 238, 0.3);"><strong>${formatTime(p.total)}</strong></td>
                </tr>
            `).join('')}
            <tr style="background: rgba(34, 211, 238, 0.2); font-weight: bold; border-top: 2px solid #22d3ee;">
                <td colspan="2">TOTAL PER QUART</td>
                <td>${formatTime(quarterTotals.q1)}</td>
                <td>${formatTime(quarterTotals.q2)}</td>
                <td>${formatTime(quarterTotals.q3)}</td>
                <td>${formatTime(quarterTotals.q4)}</td>
                <td>${formatTime(quarterTotals.total)}</td>
            </tr>
            <tr style="background: rgba(251, 191, 36, 0.2); font-weight: bold;">
                <td colspan="2">ESPERAT (7 jug √ó 8 min)</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>224:00</td>
            </tr>
        </tbody>
    `;
}
function renderEfficiencyPerMinuteChart() {
    const ctx = document.getElementById('efficiencyPerMinuteChart');
    if (!ctx) return;
    
    if (window.efficiencyPerMinuteChartInstance) {
        window.efficiencyPerMinuteChartInstance.destroy();
    }
    
    const playerStats = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0,
                    gols: 0,
                    exclusions: 0
                };
            }
            
            playerStats[playerName].gols += player.estadistiques.gols;
            playerStats[playerName].exclusions += player.estadistiques.exclusions;
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                // Eliminar duplicados
                const uniqueChanges = [];
                const seenTimestamps = new Set();
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                qChanges.forEach(change => {
                    if (!seenTimestamps.has(change.timestamp)) {
                        seenTimestamps.add(change.timestamp);
                        uniqueChanges.push(change);
                    }
                });
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                
                if (!quarterStartTime) return;
                
                uniqueChanges.forEach(change => {
                    if (change.timestamp < quarterStartTime || change.timestamp > quarterEndTime) return;
                    
                    if (change.action === 'in' && lastInTime === null) {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const duration = (change.timestamp - lastInTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null && lastInTime < quarterEndTime) {
                    const duration = (quarterEndTime - lastInTime) / 1000;
                    if (duration > 0 && duration <= quarterDuration) {
                        timeInWater += duration;
                    }
                }
                
                // ‚úÖ LIMITAR A 8 MINUTOS POR CUARTO
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerStats[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerStats)
        .filter(p => p.totalTime > 0)
        .map(p => ({
            ...p,
            goalsPerMinute: (p.gols / (p.totalTime / 60)).toFixed(2),
            exclusionsPerMinute: (p.exclusions / (p.totalTime / 60)).toFixed(2)
        }))
        .sort((a, b) => b.goalsPerMinute - a.goalsPerMinute);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const goalsData = players.map(p => parseFloat(p.goalsPerMinute));
    const exclusionsData = players.map(p => parseFloat(p.exclusionsPerMinute));
    
    window.efficiencyPerMinuteChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Goles/Minuto',
                    data: goalsData,
                    backgroundColor: '#22c55e',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                },
                {
                    label: 'Exclusiones/Minuto',
                    data: exclusionsData,
                    backgroundColor: '#f97316',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// Funci√≥n para calcular valoraci√≥n de jugador
function calculatePlayerValue(stats) {
    let value = 0;
    
    // Acciones positivas
    if (stats.goalTypes) {
        value += (stats.goalTypes.normal || 0) * 2;      // Gol normal: +2
        value += (stats.goalTypes.contra || 0) * 2;      // Gol contraatac: +2
        value += (stats.goalTypes['h+'] || 0) * 2;       // Gol H+: +2
        value += (stats.goalTypes.penalty || 0) * 1;     // Gol penalty: +1
        value += (stats.goalTypes.boya || 0) * 2;        // Gol boya: +2
    }
    value += (stats.assistencies || 0) * 1;              // Assist√®ncia: +1
    value += (stats.robatoris || 0) * 1;                 // Robatori: +1
    value += (stats.blocatges || 0) * 1;                 // Blocatge: +1
    value += (stats.parades || 0) * 2;                   // Parada: +2
    value += (stats.faltesRebudes || 0) * 1;             // Falta rebuda: +1
    
    // Acciones negativas
    if (stats.exclusionTypes) {
        value -= (stats.exclusionTypes.normal || 0) * 1;     // Exclusi√≥ normal: -1
        value -= (stats.exclusionTypes.penalty || 0) * 1;    // Exclusi√≥ penalty: -3
    }
    value -= (stats.penaltyMissed || 0) * 2;             // Penalty fallat: -2
    value -= (stats.perdues || 0) * 0.5;                 // P√®rdua: -0.5
    value -= (stats.xutsFallats || 0) * 0.5;             // Tir fallat: -0.5
    
    return value;
}
function renderMinutesDistributionChart() {
    const ctx = document.getElementById('minutesDistributionChart');
    if (!ctx) return;
    
    if (window.minutesDistributionChartInstance) {
        window.minutesDistributionChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480; // 8 minutos m√°ximo por cuarto
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                // Eliminar duplicados
                const uniqueChanges = [];
                const seenTimestamps = new Set();
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                qChanges.forEach(change => {
                    if (!seenTimestamps.has(change.timestamp)) {
                        seenTimestamps.add(change.timestamp);
                        uniqueChanges.push(change);
                    }
                });
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                
                if (!quarterStartTime) return;
                
                uniqueChanges.forEach(change => {
                    if (change.timestamp < quarterStartTime || change.timestamp > quarterEndTime) return;
                    
                    if (change.action === 'in' && lastInTime === null) {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const duration = (change.timestamp - lastInTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                        lastInTime = null;
                    }
                });
                
                // Si todav√≠a est√° dentro al final del cuarto
                if (lastInTime !== null && lastInTime < quarterEndTime) {
                    const duration = (quarterEndTime - lastInTime) / 1000;
                    if (duration > 0 && duration <= quarterDuration) {
                        timeInWater += duration;
                    }
                }
                
                // ‚úÖ LIMITAR A 8 MINUTOS (480 segundos) POR CUARTO
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 10);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const timeInMinutes = players.map(p => (p.totalTime / 60).toFixed(1));
    
    const colors = [
        '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
        '#fde047', '#fbbf24', '#f59e0b', '#d97706',
        '#22c55e', '#16a34a'
    ];
    
    window.minutesDistributionChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: timeInMinutes,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    position: 'right',
                    labels: { 
                        color: 'white', 
                        font: { size: 12 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} min (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderPlusMinusChart() {
    const ctx = document.getElementById('plusMinusChart');
    if (!ctx) return;
    
    if (window.plusMinusChartInstance) {
        window.plusMinusChartInstance.destroy();
    }
    
    const playerPlusMinus = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const goalsFor = match.periodScores[quarter].cnt;
            const goalsAgainst = match.periodScores[quarter].rival;
            const diff = goalsFor - goalsAgainst;
            
            const playersInQuarter = new Set();
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            qChanges.forEach(change => {
                if (change.action === 'in') {
                    playersInQuarter.add(change.playerNum);
                }
            });
            
            lineup.forEach(playerNum => {
                playersInQuarter.add(playerNum);
            });
            
            playersInQuarter.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (!player) return;
                
                const playerName = player.nom.trim();
                
                if (!playerPlusMinus[playerName]) {
                    playerPlusMinus[playerName] = {
                        num: player.numero,
                        name: playerName,
                        plusMinus: 0,
                        quarters: 0
                    };
                }
                
                playerPlusMinus[playerName].plusMinus += diff;
                playerPlusMinus[playerName].quarters++;
            });
        });
    });
    
    const players = Object.values(playerPlusMinus)
        .map(p => ({
            ...p,
            avgPlusMinus: (p.plusMinus / p.quarters).toFixed(2)
        }))
        .sort((a, b) => b.plusMinus - a.plusMinus);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => p.plusMinus);
    const colors = data.map(pm => pm >= 0 ? '#22c55e' : '#ef4444');
    
    window.plusMinusChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Plus/Minus Total',
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const player = players[idx];
                            return [
                                `Plus/Minus: ${context.parsed.x > 0 ? '+' : ''}${context.parsed.x}`,
                                `Promedio: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus} por cuarto`,
                                `Cuartos jugados: ${player.quarters}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    ticks: { 
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 10 : 12 }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 11 : 14 }
                    }
                },
                y: { 
                    ticks: { 
                        color: 'white', 
                        font: { size: window.innerWidth < 768 ? 9 : 11 },
                        autoSkip: false
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
} 

function renderLoadBalanceStats() {
    const container = document.getElementById('loadBalanceGrid');
    const chartCtx = document.getElementById('loadBalanceChart');
    if (!container || !chartCtx) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                playerTimes[playerName].totalTime += Math.round(timeInWater);
            });
        });
    });
    
    const players = Object.values(playerTimes);
    const times = players.map(p => p.totalTime / 60);
    
    const maxTime = Math.max(...times);
    const minTime = Math.min(...times);
    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
    
    const variance = times.reduce((sum, time) => sum + Math.pow(time - avgTime, 2), 0) / times.length;
    const stdDev = Math.sqrt(variance);
    
    const maxPlayer = players.find(p => (p.totalTime / 60) === maxTime);
    const minPlayer = players.find(p => (p.totalTime / 60) === minTime);
    
    function formatTime(minutes) {
        const mins = Math.floor(minutes);
        const secs = Math.round((minutes - mins) * 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    let balanceStatus = '';
    let balanceColor = '';
    if (stdDev < 3) {
        balanceStatus = '‚úÖ Excelente equidad';
        balanceColor = '#22c55e';
    } else if (stdDev < 5) {
        balanceStatus = '‚ö†Ô∏è Rotaci√≥n moderada';
        balanceColor = '#fbbf24';
    } else {
        balanceStatus = '‚ùå Rotaci√≥n desigual';
        balanceColor = '#ef4444';
    }
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Desviaci√≥n Est√°ndar</div>
            <div class="info-value" style="color: ${balanceColor};">${stdDev.toFixed(1)} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio</div>
            <div class="info-value">${formatTime(avgTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con M√°s Minutos</div>
            <div class="info-value">${maxPlayer.num}. ${maxPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(maxTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Menos Minutos</div>
            <div class="info-value">${minPlayer.num}. ${minPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(minTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Diferencia M√°x-M√≠n</div>
            <div class="info-value" style="color: ${balanceColor};">${formatTime(maxTime - minTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Estado de Balance</div>
            <div class="info-value" style="color: ${balanceColor}; font-size: 16px;">${balanceStatus}</div>
        </div>
    `;
    
    if (window.loadBalanceChartInstance) {
        window.loadBalanceChartInstance.destroy();
    }
    
    window.loadBalanceChartInstance = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: ['< 15min', '15-20min', '20-25min', '25-30min', '> 30min'],
            datasets: [{
                label: 'N√∫mero de Jugadores',
                data: [
                    times.filter(t => t < 15).length,
                    times.filter(t => t >= 15 && t < 20).length,
                    times.filter(t => t >= 20 && t < 25).length,
                    times.filter(t => t >= 25 && t < 30).length,
                    times.filter(t => t >= 30).length
                ],
                backgroundColor: ['#ef4444', '#f97316', '#fbbf24', '#22c55e', '#06b6d4'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Jugadores',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderQuarterAnalysisTable() {
    const table = document.getElementById('quarterAnalysisTable');
    if (!table) return;
    
    const quarterStats = {
        q1: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q2: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q3: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q4: { changes: 0, uniquePlayers: new Set(), totalTime: 0 }
    };
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            let realChanges = 0;
            
            // Contar solo entradas que NO sean las iniciales de los titulares
            // Una entrada de un suplente = 1 cambio real
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS de jugadores que NO sean titulares iniciales
                // Esto cuenta las rotaciones reales (cuando entra un suplente)
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    realChanges++;
                }
                
                quarterStats[quarter].uniquePlayers.add(change.playerNum);
            });
            
            quarterStats[quarter].changes += realChanges;
            quarterStats[quarter].totalTime += 480;
        });
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Cuarto</th>
                <th>Total Cambios</th>
                <th>Promedio Cambios/Partido</th>
                <th>Jugadores √önicos</th>
                <th>Promedio Jugadores/Partido</th>
            </tr>
        </thead>
        <tbody>
            ${quarters.map((q, i) => {
                const avgChanges = (quarterStats[q].changes / matchesWithTime.length).toFixed(1);
                const avgPlayers = (quarterStats[q].uniquePlayers.size / matchesWithTime.length).toFixed(1);
                
                return `
                    <tr>
                        <td><strong>${labels[i]}</strong></td>
                        <td>${quarterStats[q].changes}</td>
                        <td>${avgChanges}</td>
                        <td>${quarterStats[q].uniquePlayers.size}</td>
                        <td>${avgPlayers}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function renderPerformanceVsTimeChart() {
    const ctx = document.getElementById('performanceVsTimeChart');
    if (!ctx) return;
    
    if (window.performanceVsTimeChartInstance) {
        window.performanceVsTimeChartInstance.destroy();
    }
    
    const playerMatchData = [];
    
    matchesWithTime.forEach(match => {
        const teamResult = match.scoreCNT - match.scoreRival;
        
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            let totalTime = 0;
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = match.quarterStartTimes[quarter];
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                totalTime += Math.round(timeInWater);
            });
            
            playerMatchData.push({
                player: `${player.numero}. ${playerName.split(' ')[0]}`,
                time: totalTime / 60,
                result: teamResult
            });
        });
    });
    
    const playerAvgs = {};
    playerMatchData.forEach(data => {
        if (!playerAvgs[data.player]) {
            playerAvgs[data.player] = { times: [], results: [] };
        }
        playerAvgs[data.player].times.push(data.time);
        playerAvgs[data.player].results.push(data.result);
    });
    
    const scatterData = Object.keys(playerAvgs).map(player => {
        const avgTime = playerAvgs[player].times.reduce((a, b) => a + b, 0) / playerAvgs[player].times.length;
        const avgResult = playerAvgs[player].results.reduce((a, b) => a + b, 0) / playerAvgs[player].results.length;
        return {
            x: avgTime,
            y: avgResult,
            label: player
        };
    });
    
    window.performanceVsTimeChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Jugadores',
                data: scatterData,
                backgroundColor: '#22d3ee',
                borderColor: '#06b6d4',
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return [
                                context.raw.label,
                                `Tiempo promedio: ${context.parsed.x.toFixed(1)} min`,
                                `Diferencia promedio: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y.toFixed(1)} goles`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Tiempo Promedio Jugado (minutos)',
                        color: 'white'
                    }
                },
                y: { 
                    ticks: { color: 'white' },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles Promedio',
                        color: 'white'
                    }
                }
            }
        }
    });
}

function renderFatigueAnalysisTable() {
    const table = document.getElementById('fatigueAnalysisTable');
    if (!table) return;
    
    const playerFatigue = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerFatigue[playerName]) {
                playerFatigue[playerName] = {
                    num: player.numero,
                    name: playerName,
                    q1: { gols: 0, exclusions: 0, matches: 0 },
                    q4: { gols: 0, exclusions: 0, matches: 0 }
                };
            }
            
            const playedQ1 = match.lineups.q1 && match.lineups.q1.includes(player.numero);
            const playedQ4 = match.lineups.q4 && match.lineups.q4.includes(player.numero);
            
            if (playedQ1) {
                playerFatigue[playerName].q1.matches++;
                playerFatigue[playerName].q1.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q1.exclusions += player.estadistiques.exclusions / 4;
            }
            
            if (playedQ4) {
                playerFatigue[playerName].q4.matches++;
                playerFatigue[playerName].q4.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q4.exclusions += player.estadistiques.exclusions / 4;
            }
        });
    });
    
    const players = Object.values(playerFatigue)
        .filter(p => p.q1.matches > 0 && p.q4.matches > 0)
        .sort((a, b) => a.num - b.num);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>N¬∫</th>
                <th>Jugador</th>
                <th colspan="2">1¬∫ Cuarto (Inicio)</th>
                <th colspan="2">4¬∫ Cuarto (Final)</th>
                <th>Cambio Goles</th>
                <th>Cambio Exc</th>
                <th>Fatiga</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th>Goles</th>
                <th>Exc</th>
                <th>Goles</th>
                <th>Exc</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const q1GoalsAvg = (p.q1.gols / p.q1.matches).toFixed(2);
                const q4GoalsAvg = (p.q4.gols / p.q4.matches).toFixed(2);
                const q1ExcAvg = (p.q1.exclusions / p.q1.matches).toFixed(2);
                const q4ExcAvg = (p.q4.exclusions / p.q4.matches).toFixed(2);
                
                const goalsDiff = (q4GoalsAvg - q1GoalsAvg).toFixed(2);
                const excDiff = (q4ExcAvg - q1ExcAvg).toFixed(2);
                
                let fatigueIndicator = '';
                let fatigueColor = '';
                
                if (goalsDiff < -0.2 && excDiff > 0.2) {
                    fatigueIndicator = 'üòì Alta';
                    fatigueColor = '#ef4444';
                } else if (goalsDiff < -0.1 || excDiff > 0.1) {
                    fatigueIndicator = '‚ö†Ô∏è Media';
                    fatigueColor = '#fbbf24';
                } else if (goalsDiff >= 0) {
                    fatigueIndicator = '‚úÖ Baja';
                    fatigueColor = '#22c55e';
                } else {
                    fatigueIndicator = '‚ûñ Normal';
                    fatigueColor = '#06b6d4';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${q1GoalsAvg}</td>
                        <td>${q1ExcAvg}</td>
                        <td>${q4GoalsAvg}</td>
                        <td>${q4ExcAvg}</td>
                        <td style="color: ${goalsDiff >= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${goalsDiff > 0 ? '+' : ''}${goalsDiff}
                        </td>
                        <td style="color: ${excDiff <= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${excDiff > 0 ? '+' : ''}${excDiff}
                        </td>
                        <td style="color: ${fatigueColor}; font-weight: bold;">
                            ${fatigueIndicator}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderRotationStats() {
    const container = document.getElementById('rotationStatsGrid');
    if (!container) return;
    
    let totalChanges = 0;
    let totalQuarters = 0;
    const playerRotations = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = match.quarterStartTimes[quarter];
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            // Contar solo entradas de no-titulares (rotaciones reales)
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS que no sean iniciales de titulares
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    totalChanges++;
                    
                    if (!playerRotations[change.playerNum]) {
                        playerRotations[change.playerNum] = 0;
                    }
                    playerRotations[change.playerNum]++;
                }
            });
        });
        
        totalQuarters += 4;
    });
    
    const avgChangesPerMatch = (totalChanges / matchesWithTime.length).toFixed(1);
    const avgChangesPerQuarter = (totalChanges / totalQuarters).toFixed(1);
    
    const rotationCounts = Object.values(playerRotations);
    
    if (rotationCounts.length === 0) {
        container.innerHTML = `
            <div class="info-item">
                <div class="info-label">Total de Cambios</div>
                <div class="info-value">0</div>
            </div>
            <div class="info-item" style="grid-column: 1 / -1;">
                <div style="text-align: center; color: #bae6fd; font-size: 14px;">
                    No hay cambios registrados durante los cuartos
                </div>
            </div>
        `;
        return;
    }
    
    const maxRotations = Math.max(...rotationCounts);
    const minRotations = Math.min(...rotationCounts);
    const avgRotations = (rotationCounts.reduce((a, b) => a + b, 0) / rotationCounts.length).toFixed(1);
    
    const mostRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === maxRotations
    );
    const leastRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === minRotations
    );
    
    let mostRotatedPlayer = 'N/A';
    let leastRotatedPlayer = 'N/A';
    
    matchesWithTime.forEach(match => {
        const playerMost = match.jugadors.find(j => j.numero === parseInt(mostRotatedPlayerNum));
        const playerLeast = match.jugadors.find(j => j.numero === parseInt(leastRotatedPlayerNum));
        
        if (playerMost) mostRotatedPlayer = `${playerMost.numero}. ${playerMost.nom.split(' ')[0]}`;
        if (playerLeast) leastRotatedPlayer = `${playerLeast.numero}. ${playerLeast.nom.split(' ')[0]}`;
    });
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Total de Cambios (Rotaciones)</div>
            <div class="info-value">${totalChanges}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Partido</div>
            <div class="info-value">${avgChangesPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Cuarto</div>
            <div class="info-value">${avgChangesPerQuarter}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador M√°s Rotado</div>
            <div class="info-value">${mostRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${maxRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Menos Rotado</div>
            <div class="info-value">${leastRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${minRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Rotaciones/Jugador</div>
            <div class="info-value">${avgRotations}</div>
        </div>
    `;
}

// ============================================
// FIN FUNCIONES PARA ESTAD√çSTICAS DE TIEMPO
// ============================================
function renderGoalkeeperSavesChart() {
    const ctx = document.getElementById('goalkeeperSavesChart');
    if (!ctx) return;
    
    if (window.goalkeeperSavesChartInstance) {
        window.goalkeeperSavesChartInstance.destroy();
    }
    
    const goalkeeperStats = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            if (!isGoalkeeper) return;
            
            const playerName = j.nom.trim();
            
            if (!goalkeeperStats[playerName]) {
                goalkeeperStats[playerName] = {
                    num: j.numero,
                    name: playerName,
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0 }
                };
            }
            
            goalkeeperStats[playerName].parades += (j.estadistiques.parades || 0);
            
            if (j.estadistiques.paradeTypes) {
                goalkeeperStats[playerName].paradeTypes.corner += (j.estadistiques.paradeTypes.corner || 0);
                goalkeeperStats[playerName].paradeTypes.rebuig += (j.estadistiques.paradeTypes.rebuig || 0);
                goalkeeperStats[playerName].paradeTypes.atrapa += (j.estadistiques.paradeTypes.atrapa || 0);
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length === 0) {
        ctx.parentElement.innerHTML = '<div class="no-data">No hay datos de paradas de porteros</div>';
        return;
    }
    
    const labels = goalkeepers.map(gk => `${gk.num}. ${gk.name.split(' ')[0]}`);
    
    window.goalkeeperSavesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Corner',
                    data: goalkeepers.map(gk => gk.paradeTypes.corner),
                    backgroundColor: '#fbbf24'
                },
                {
                    label: 'Rebuig',
                    data: goalkeepers.map(gk => gk.paradeTypes.rebuig),
                    backgroundColor: '#f97316'
                },
                {
                    label: 'Atrapa',
                    data: goalkeepers.map(gk => gk.paradeTypes.atrapa),
                    backgroundColor: '#8b5cf6'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ${value} parades`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Parades',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// ‚úÖ NUEVO: Variables globals per ordenaci√≥
let currentSortColumn = 'gols';
let currentSortOrder = 'desc';
let cachedPlayersData = [];

function sortTable(column) {
    if (currentSortColumn === column) {
        // Canviar ordre si √©s la mateixa columna
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        // Nova columna, ordre descendent per defecte
        currentSortColumn = column;
        currentSortOrder = 'desc';
    }
    
    const sortedPlayers = [...cachedPlayersData].sort((a, b) => {
        let valA, valB;
        
        switch(column) {
            case 'num':
                valA = a.num;
                valB = b.num;
                break;
            case 'name':
                return currentSortOrder === 'desc' 
                    ? b.name.localeCompare(a.name)
                    : a.name.localeCompare(b.name);
            case 'partidos':
                valA = a.partidos;
                valB = b.partidos;
                break;
            case 'gols':
                valA = a.gols;
                valB = b.gols;
                break;
            case 'h+':
                valA = a.goalTypes['h+'] || 0;
                valB = b.goalTypes['h+'] || 0;
                break;
            case 'penalty':
                valA = a.goalTypes.penalty || 0;
                valB = b.goalTypes.penalty || 0;
                break;
            case 'contra':
                valA = a.goalTypes.contra || 0;
                valB = b.goalTypes.contra || 0;
                break;
            case 'boya':
                valA = a.goalTypes.boya || 0;
                valB = b.goalTypes.boya || 0;
                break;
            case 'normal':
                valA = a.goalTypes.normal || 0;
                valB = b.goalTypes.normal || 0;
                break;
            case 'exclusions':
                valA = a.exclusions;
                valB = b.exclusions;
                break;
            case 'parades':
                valA = a.parades || 0;
                valB = b.parades || 0;
                break;
            case 'assistencies':
                valA = a.assistencies || 0;
                valB = b.assistencies || 0;
                break;
            case 'robatoris':
                valA = a.robatoris || 0;
                valB = b.robatoris || 0;
                break;
            case 'perdues':
                valA = a.perdues || 0;
                valB = b.perdues || 0;
                break;
            case 'xutsFallats':
                valA = a.xutsFallats || 0;
                valB = b.xutsFallats || 0;
                break;
            case 'penaltyMissed':
                valA = a.penaltyMissed || 0;
                valB = b.penaltyMissed || 0;
                break;
				case 'eficienciaTir':
			case 'blocks':
    valA = a.blocks || 0;
    valB = b.blocks || 0;
    break;
case 'faltesRebudes':
    valA = a.faltesRebudes || 0;
    valB = b.faltesRebudes || 0;
    break;
    const xutsA = a.gols + (a.xutsFallats || 0);
    const xutsB = b.gols + (b.xutsFallats || 0);
    valA = xutsA > 0 ? (a.gols / xutsA * 100) : 0;
    valB = xutsB > 0 ? (b.gols / xutsB * 100) : 0;
    break;
            case 'mediaGols':
    valA = a.partidos > 0 ? a.gols / a.partidos : 0;
    valB = b.partidos > 0 ? b.gols / b.partidos : 0;
    break;
case 'valor':
    valA = calculatePlayerValue({
        goalTypes: a.goalTypes,
        assistencies: a.assistencies,
        robatoris: a.robatoris,
        blocatges: a.blocatges,
        parades: a.parades,
        faltesRebudes: a.faltesRebudes,
        exclusionTypes: a.exclusionTypes,
        penaltyMissed: a.penaltyMissed,
        perdues: a.perdues,
        xutsFallats: a.xutsFallats
    });
    valB = calculatePlayerValue({
        goalTypes: b.goalTypes,
        assistencies: b.assistencies,
        robatoris: b.robatoris,
        blocatges: b.blocatges,
        parades: b.parades,
        faltesRebudes: b.faltesRebudes,
        exclusionTypes: b.exclusionTypes,
        penaltyMissed: b.penaltyMissed,
        perdues: b.perdues,
        xutsFallats: b.xutsFallats
    });
    break;
default:
    return 0;
        }
        
        return currentSortOrder === 'desc' ? valB - valA : valA - valB;
    });
    
    renderComparisonTable(sortedPlayers);
}

function renderComparisonTable(players) {
    const getSortIndicator = (column) => {
        if (currentSortColumn !== column) return '';
        return currentSortOrder === 'desc' ? ' ‚ñº' : ' ‚ñ≤';
    };
    
    document.getElementById('comparisonTable').innerHTML = `
        <thead>
            <tr>
                <th onclick="sortTable('num')" style="cursor: pointer;">N¬∫${getSortIndicator('num')}</th>
                <th onclick="sortTable('name')" style="cursor: pointer;">Jugador${getSortIndicator('name')}</th>
                <th onclick="sortTable('partidos')" style="cursor: pointer;">Partidos${getSortIndicator('partidos')}</th>
                <th onclick="sortTable('gols')" style="cursor: pointer;">Goles${getSortIndicator('gols')}</th>
                <th onclick="sortTable('h+')" style="cursor: pointer;">H+${getSortIndicator('h+')}</th>
                <th onclick="sortTable('penalty')" style="cursor: pointer;">Penalty${getSortIndicator('penalty')}</th>
                <th onclick="sortTable('contra')" style="cursor: pointer;">Contra${getSortIndicator('contra')}</th>
                <th onclick="sortTable('boya')" style="cursor: pointer;">Boya${getSortIndicator('boya')}</th>
                <th onclick="sortTable('normal')" style="cursor: pointer;">Normal${getSortIndicator('normal')}</th>
                <th onclick="sortTable('exclusions')" style="cursor: pointer;">Exclusiones${getSortIndicator('exclusions')}</th>
                <th onclick="sortTable('parades')" style="cursor: pointer;">üß§ Parades${getSortIndicator('parades')}</th>
                <th onclick="sortTable('assistencies')" style="cursor: pointer;">üéØ Assist${getSortIndicator('assistencies')}</th>
                <th onclick="sortTable('robatoris')" style="cursor: pointer;">üõ°Ô∏è Rob${getSortIndicator('robatoris')}</th>
                <th onclick="sortTable('perdues')" style="cursor: pointer;">‚ùå P√®rd${getSortIndicator('perdues')}</th>
                <th onclick="sortTable('xutsFallats')" style="cursor: pointer;">üö´ Xuts${getSortIndicator('xutsFallats')}</th>
                <th onclick="sortTable('penaltyMissed')" style="cursor: pointer;">Pen. Fallados${getSortIndicator('penaltyMissed')}</th>
                <th onclick="sortTable('eficienciaTir')" style="cursor: pointer;">üéØ Efic. Tir${getSortIndicator('eficienciaTir')}</th>
                <th onclick="sortTable('mediaGols')" style="cursor: pointer;">Media Goles/P${getSortIndicator('mediaGols')}</th>
                <th onclick="sortTable('valor')" style="cursor: pointer;">‚≠ê Valor${getSortIndicator('valor')}</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const valor = calculatePlayerValue({
                    goalTypes: p.goalTypes,
                    assistencies: p.assistencies,
                    robatoris: p.robatoris,
                    blocatges: p.blocatges || 0,
                    parades: p.parades,
                    faltesRebudes: p.faltesRebudes || 0,
                    exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
                    penaltyMissed: p.penaltyMissed,
                    perdues: p.perdues,
                    xutsFallats: p.xutsFallats
                });
                
                const valorColor = valor >= 10 ? '#22c55e' : valor >= 5 ? '#fbbf24' : '#ef4444';
                
                return `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.partidos}</td>
                    <td><strong style="color: #fde047;">${p.gols}</strong></td>
                    <td>${p.goalTypes['h+'] || 0}</td>
                    <td>${p.goalTypes.penalty || 0}</td>
                    <td>${p.goalTypes.contra || 0}</td>
                    <td>${p.goalTypes.boya || 0}</td>
                    <td>${p.goalTypes.normal || 0}</td>
                    <td>${p.exclusions}</td>
                    <td style="color: #8b5cf6; font-weight: bold;">${p.parades || 0}</td>
                    <td style="color: #22c55e; font-weight: bold;">${p.assistencies || 0}</td>
                    <td style="color: #06b6d4; font-weight: bold;">${p.robatoris || 0}</td>
                    <td style="color: #ef4444; font-weight: bold;">${p.perdues || 0}</td>
                    <td style="color: #f97316; font-weight: bold;">${p.xutsFallats || 0}</td>
                    <td style="color: ${(p.penaltyMissed || 0) > 0 ? '#ef4444' : '#22c55e'}; font-weight: bold;">${p.penaltyMissed || 0}</td>
                    <td style="color: ${(() => {
                        const totalXuts = p.gols + (p.xutsFallats || 0);
                        const efic = totalXuts > 0 ? (p.gols / totalXuts * 100) : 0;
                        return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                    })()}; font-weight: bold;">
                        ${(() => {
                            const totalXuts = p.gols + (p.xutsFallats || 0);
                            const efic = totalXuts > 0 ? (p.gols / totalXuts * 100).toFixed(1) : '0.0';
                            return totalXuts > 0 ? `${p.gols}/${totalXuts} (${efic}%)` : '-';
                        })()}
                    </td>
                    <td>${p.partidos > 0 ? (p.gols / p.partidos).toFixed(1) : '0.0'}</td>
                    <td style="color: ${valorColor}; font-weight: bold; font-size: 14px;">${valor.toFixed(1)}</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
// ==========================================
// TOTES LES FUNCIONS DE GENERACI√ì DE PDFs
// ==========================================

function generateGeneralPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    let yPos = 20;
    const pageHeight = 190;
    const leftMargin = 20;
    const rightMargin = 277;
    
    function checkPageBreak(neededSpace = 10) {
        if (yPos > pageHeight - neededSpace) {
            doc.addPage();
            yPos = 20;
            return true;
        }
        return false;
    }
    
    function addSeparator() {
        checkPageBreak(5);
        doc.setDrawColor(34, 211, 238);
        doc.setLineWidth(0.5);
        doc.line(leftMargin, yPos, rightMargin, yPos);
        yPos += 8;
    }
    
    // ============ PORTADA ============
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(30, 58, 138);
    doc.text('CN TERRASSA', 148.5, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(18);
    doc.setTextColor(6, 182, 212);
    doc.text('JUVENIL 25/26', 148.5, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text('INFORME GENERAL DE TEMPORADA', 148.5, yPos, { align: 'center' });
    yPos += 15;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Data: ${new Date().toLocaleDateString('ca-ES', { year: 'numeric', month: 'long', day: 'numeric' })}`, 148.5, yPos, { align: 'center' });
    yPos += 20;
    
    addSeparator();
    
    // ============ RESUM EXECUTIU ============
    const victories = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const defeats = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
    const totalGolsFavor = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalGolsContra = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('RESUM EXECUTIU', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    
    const summaryData = [
        ['Total de partits:', allMatches.length.toString()],
        ['Vict√≤ries:', `${victories} (${((victories/allMatches.length)*100).toFixed(1)}%)`],
        ['Derrotes:', `${defeats} (${((defeats/allMatches.length)*100).toFixed(1)}%)`],
        ['Empats:', `${draws} (${((draws/allMatches.length)*100).toFixed(1)}%)`],
        ['Gols a favor:', `${totalGolsFavor} (${(totalGolsFavor/allMatches.length).toFixed(1)}/partit)`],
        ['Gols en contra:', `${totalGolsContra} (${(totalGolsContra/allMatches.length).toFixed(1)}/partit)`],
        ['Difer√®ncia de gols:', `${totalGolsFavor > totalGolsContra ? '+' : ''}${totalGolsFavor - totalGolsContra}`]
    ];
    
    summaryData.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold');
        doc.text(label, leftMargin + 5, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(value, leftMargin + 60, yPos);
        yPos += 6;
    });
    
    yPos += 5;
    addSeparator();
    
    // ============ CALCULAR ESTAD√çSTIQUES ============
    const playerStats = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            const name = j.nom.trim();
            if (!playerStats[name]) {
                playerStats[name] = {
                    num: j.numero,
                    partidos: 0,
                    gols: 0,
                    exclusions: 0,
                    parades: 0,
                    assistencies: 0,
                    robatoris: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    penaltyMissed: 0,
					faltesRebudes: 0,
                    goalTypes: { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 }
                };
            }
            playerStats[name].partidos++;
            playerStats[name].gols += j.estadistiques.gols || 0;
            playerStats[name].exclusions += j.estadistiques.exclusions || 0;
            playerStats[name].parades += j.estadistiques.parades || 0;
            playerStats[name].assistencies += j.estadistiques.assistencies || 0;
            playerStats[name].robatoris += j.estadistiques.robatoris || 0;
            playerStats[name].perdues += j.estadistiques.perdues || 0;
            playerStats[name].xutsFallats += j.estadistiques.xutsFallats || 0;
            playerStats[name].penaltyMissed += j.estadistiques.penaltyMissed || 0;
			playerStats[name].faltesRebudes += j.estadistiques.faltesRebudes || 0;
            
            if (j.estadistiques.goalTypes) {
                Object.keys(j.estadistiques.goalTypes).forEach(type => {
                    playerStats[name].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
                });
            }
        });
    });
    
    // ============ TAULA COMPLETA AMB LES COLUMNES EXACTES ============
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ESTAD√çSTIQUES COMPLETES', leftMargin, yPos);
    yPos += 8;
    
    doc.setFontSize(6.5);
    
    // Cap√ßalera exacta
    const headers = ['N¬∫', 'Jugador', 'PJ', 'Gols', 'H+', 'Pen', 'Con', 'Boy', 'Nor', 'Exc', 'Par', 'Ast', 'Rob', 'P√®r', 'FR', 'Xuts', 'PenF', 'Efic%', 'G/P', 'Valor'];
    const colWidths = [7, 30, 8, 10, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 11, 9, 11];
    let xPos = leftMargin;
    
    doc.setFont(undefined, 'bold');
    doc.setFillColor(6, 182, 212);
    doc.rect(leftMargin, yPos - 3, colWidths.reduce((a,b) => a+b, 0), 5, 'F');
    doc.setTextColor(255, 255, 255);
    
    headers.forEach((header, i) => {
        doc.text(header, xPos + 0.5, yPos);
        xPos += colWidths[i];
    });
    yPos += 5;
    
    // Calcular valoraci√≥ i ordenar
    const sortedPlayers = Object.entries(playerStats).map(([name, data]) => {
        const valor = (data.gols * 3) + (data.assistencies * 2) + (data.robatoris * 1) + 
                     (data.parades * 2) - (data.perdues * 1) - (data.exclusions * 2);
        return [name, data, valor];
    }).sort((a, b) => b[2] - a[2]);
    
    doc.setTextColor(0, 0, 0);
    sortedPlayers.forEach(([name, data, valor], index) => {
        checkPageBreak(6);
        
        doc.setFont(undefined, index < 3 ? 'bold' : 'normal');
        
        if (index % 2 === 0) {
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, yPos - 3, colWidths.reduce((a,b) => a+b, 0), 5, 'F');
        }
        
        xPos = leftMargin;
        const avgGols = (data.gols / data.partidos).toFixed(1);
        const totalXuts = data.gols + data.xutsFallats;
        const efic = totalXuts > 0 ? ((data.gols / totalXuts) * 100).toFixed(1) : '0';
        
        const rowData = [
            data.num.toString(),
            name.length > 16 ? name.substring(0, 16) : name,
            data.partidos.toString(),
            data.gols.toString(),
            (data.goalTypes['h+'] || 0).toString(),
            (data.goalTypes.penalty || 0).toString(),
            (data.goalTypes.contra || 0).toString(),
            (data.goalTypes.boya || 0).toString(),
            (data.goalTypes.normal || 0).toString(),
            data.exclusions.toString(),
            data.parades.toString(),
            data.assistencies.toString(),
            data.robatoris.toString(),
            data.perdues.toString(),
			data.faltesRebudes.toString(),
            data.xutsFallats.toString(),
            data.penaltyMissed.toString(),
            efic + '%',
            avgGols,
            valor.toString()
        ];
        
        rowData.forEach((value, i) => {
            doc.text(value, xPos + 0.5, yPos, { maxWidth: colWidths[i] - 1 });
            xPos += colWidths[i];
        });
        
        yPos += 5;
    });
    
    yPos += 3;
    doc.setFontSize(6);
    doc.setFont(undefined, 'italic');
    doc.text('PJ=Partits, H+=Superioritat, Pen=Penalty, Con=Contra, Boy=Boya, Nor=Normal, Exc=Exclusions, Par=Parades, Ast=Assist√®ncies,', leftMargin, yPos);
    yPos += 3;
    doc.text('Rob=Robatoris, P√®r=P√®rdues, FR=Faltes Rebudes, Xuts=Xuts Fallats, PenF=Penalties Fallats, Efic%=Efici√®ncia Tir, G/P=Gols/Partit, Valor=Valoraci√≥ Global', leftMargin, yPos);
    yPos += 3;
    doc.text('Valoraci√≥ = Gols√ó3 + Assist√ó2 + Rob√ó1 + Parades√ó2 - P√®rdues√ó1 - Exclusions√ó2', leftMargin, yPos);
    yPos += 10;
    
    addSeparator();
    
    // ============ TOP PERFORMERS ============
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('TOP PERFORMERS', leftMargin, yPos);
    yPos += 12;
    
    const colWidth = (rightMargin - leftMargin) / 4 - 5;
    const col1X = leftMargin;
    const col2X = leftMargin + colWidth + 10;
    const col3X = leftMargin + (colWidth + 10) * 2;
    const col4X = leftMargin + (colWidth + 10) * 3;
    
    let col1Y = yPos, col2Y = yPos, col3Y = yPos, col4Y = yPos;
    
    doc.setFontSize(9);
    
    // Col 1: Top Golejadors
    doc.setFont(undefined, 'bold');
    doc.text('ü•á Top 10 Golejadors', col1X, col1Y);
    col1Y += 5;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    
    Object.entries(playerStats).sort((a, b) => b[1].gols - a[1].gols).slice(0, 10).forEach(([name, data]) => {
        doc.text(`${data.num}. ${name.substring(0, 14)}: ${data.gols}`, col1X + 2, col1Y);
        col1Y += 4;
    });
    
    // Col 2: Top Assistents
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('üéØ Top 10 Assistents', col2X, col2Y);
    col2Y += 5;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    
    Object.entries(playerStats).sort((a, b) => b[1].assistencies - a[1].assistencies).slice(0, 10).forEach(([name, data]) => {
        doc.text(`${data.num}. ${name.substring(0, 14)}: ${data.assistencies}`, col2X + 2, col2Y);
        col2Y += 4;
    });
    
    // Col 3: Top Porters
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('üß§ Top 10 Porters', col3X, col3Y);
    col3Y += 5;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    
    Object.entries(playerStats).filter(([_, d]) => d.parades > 0).sort((a, b) => b[1].parades - a[1].parades).slice(0, 10).forEach(([name, data]) => {
        doc.text(`${data.num}. ${name.substring(0, 14)}: ${data.parades}`, col3X + 2, col3Y);
        col3Y += 4;
    });
    
    // Col 4: Top Defensors
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('üõ°Ô∏è Top 10 Defensors', col4X, col4Y);
    col4Y += 5;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    
    Object.entries(playerStats).sort((a, b) => b[1].robatoris - a[1].robatoris).slice(0, 10).forEach(([name, data]) => {
        doc.text(`${data.num}. ${name.substring(0, 14)}: ${data.robatoris}`, col4X + 2, col4Y);
        col4Y += 4;
    });
    
    // ============ EVOLUCI√ì DE RESULTATS ============
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('EVOLUCI√ì DE RESULTATS', leftMargin, yPos);
    yPos += 12;
    
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    
    let leftColY = yPos;
    let rightColY = yPos;
    const colWidthEvol = (rightMargin - leftMargin) / 2 - 10;
    
    allMatches.forEach((match, index) => {
        const useLeftCol = index % 2 === 0;
        const currentX = useLeftCol ? leftMargin : leftMargin + colWidthEvol + 20;
        let currentY = useLeftCol ? leftColY : rightColY;
        
        if (currentY > pageHeight - 15) {
            doc.addPage();
            leftColY = 20;
            rightColY = 20;
            currentY = 20;
        }
        
        const date = new Date(match.data).toLocaleDateString('ca-ES', { 
            day: '2-digit', 
            month: '2-digit',
            year: 'numeric'
        });
        
        const location = match.matchLocation === 'home' ? 'üè†' : '‚úàÔ∏è';
        const result = match.scoreCNT > match.scoreRival ? 'V' : 
                      match.scoreCNT < match.scoreRival ? 'D' : 'E';
        
        if (result === 'V') doc.setTextColor(34, 197, 94);
        else if (result === 'D') doc.setTextColor(239, 68, 68);
        else doc.setTextColor(251, 191, 36);
        
        doc.setFont(undefined, 'bold');
        doc.text(`${date} ${location}`, currentX, currentY);
        doc.setFont(undefined, 'normal');
        currentY += 3;
        
        doc.setTextColor(0, 0, 0);
        const rivalText = match.rivalTeam.length > 22 ? match.rivalTeam.substring(0, 22) : match.rivalTeam;
        doc.text(`vs ${rivalText}`, currentX + 1, currentY);
        currentY += 3;
        doc.text(`${match.scoreCNT}-${match.scoreRival} (${result})`, currentX + 1, currentY);
        
        const q1 = `${match.periodScores?.q1?.cnt || 0}-${match.periodScores?.q1?.rival || 0}`;
        const q2 = `${match.periodScores?.q2?.cnt || 0}-${match.periodScores?.q2?.rival || 0}`;
        const q3 = `${match.periodScores?.q3?.cnt || 0}-${match.periodScores?.q3?.rival || 0}`;
        const q4 = `${match.periodScores?.q4?.cnt || 0}-${match.periodScores?.q4?.rival || 0}`;
        
        currentY += 3;
        doc.setFontSize(6);
        doc.text(`${q1}|${q2}|${q3}|${q4}`, currentX + 1, currentY);
        doc.setFontSize(7);
        
        currentY += 5;
        
        if (useLeftCol) leftColY = currentY;
        else rightColY = currentY;
    });
    
    const fileName = `CNT_Informe_General_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    alert('‚úÖ PDF generat correctament!');
}

function generateTimePDF() {
    if (matchesWithTime.length === 0) {
        alert('‚ö†Ô∏è No hi ha dades de temps disponibles per generar el PDF');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    let yPos = 20;
    const pageHeight = 190;
    const leftMargin = 20;
    const rightMargin = 277;
    
    function checkPageBreak(neededSpace = 10) {
        if (yPos > pageHeight - neededSpace) {
            doc.addPage();
            yPos = 20;
            return true;
        }
        return false;
    }
    
    // T√≠tol
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CN TERRASSA JUVENIL 25/26', 148.5, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(14);
    doc.text('INFORME DE TEMPS DE JOC', 148.5, yPos, { align: 'center' });
    yPos += 12;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Basat en ${matchesWithTime.length} partit(s) amb dades de temps`, 148.5, yPos, { align: 'center' });
    yPos += 15;
    
    // Calcular temps totals per jugador
    const playerTimes = {};
    const quarterDuration = 480;
    const maxPossibleTime = matchesWithTime.length * 32 * 60;
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0,
                    partidos: 0,
                    q1: 0, q2: 0, q3: 0, q4: 0
                };
            }
            
            playerTimes[playerName].partidos++;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => 
                    c.playerNum === player.numero && c.quarter === quarter
                );
                
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = match.quarterStartTimes?.[quarter];
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = match.quarterRealEndTimes?.[quarter] || 
                                          (quarterStartTime + quarterDuration * 1000);
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                const quarterTime = Math.round(timeInWater);
                playerTimes[playerName][quarter] += quarterTime;
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const sortedPlayers = Object.values(playerTimes).sort((a, b) => b.totalTime - a.totalTime);
    
    // Taula de temps COMPLETA
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('TEMPS DE JOC PER JUGADOR I QUART', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(8);
    
    // Cap√ßalera de taula
    doc.setFont(undefined, 'bold');
    doc.setFillColor(6, 182, 212);
    doc.rect(leftMargin, yPos - 4, rightMargin - leftMargin, 6, 'F');
    doc.setTextColor(255, 255, 255);
    
    doc.text('#', leftMargin + 2, yPos);
    doc.text('Jugador', leftMargin + 12, yPos);
    doc.text('Partits', leftMargin + 70, yPos);
    doc.text('1Q', leftMargin + 95, yPos);
    doc.text('2Q', leftMargin + 120, yPos);
    doc.text('3Q', leftMargin + 145, yPos);
    doc.text('4Q', leftMargin + 170, yPos);
    doc.text('Temps Total', leftMargin + 195, yPos);
    doc.text('Mitjana/Partit', leftMargin + 225, yPos);
    doc.text('%', leftMargin + 255, yPos);
    yPos += 6;
    
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    sortedPlayers.forEach((player, index) => {
        checkPageBreak(8);
        
        if (index % 2 === 0) {
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, yPos - 4, rightMargin - leftMargin, 6, 'F');
        }
        
        const totalMinutes = Math.floor(player.totalTime / 60);
        const totalSeconds = player.totalTime % 60;
        const avgMinutes = Math.floor((player.totalTime / player.partidos) / 60);
        const avgSeconds = Math.floor((player.totalTime / player.partidos) % 60);
        const percentage = ((player.totalTime / (maxPossibleTime)) * 100).toFixed(1);
        
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        };
        
        doc.text(`${player.num}`, leftMargin + 2, yPos);
        doc.text(player.name.length > 28 ? player.name.substring(0, 28) : player.name, leftMargin + 12, yPos);
        doc.text(`${player.partidos}`, leftMargin + 70, yPos);
        doc.text(formatTime(player.q1), leftMargin + 95, yPos);
        doc.text(formatTime(player.q2), leftMargin + 120, yPos);
        doc.text(formatTime(player.q3), leftMargin + 145, yPos);
        doc.text(formatTime(player.q4), leftMargin + 170, yPos);
        doc.text(`${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`, leftMargin + 195, yPos);
        doc.text(`${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`, leftMargin + 225, yPos);
        doc.text(`${percentage}%`, leftMargin + 255, yPos);
        
        yPos += 6;
    });
    
    const fileName = `CNT_Temps_Joc_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    alert('‚úÖ PDF de temps generat correctament!');
}

function generateTitularityPDF() {
    if (allMatches.length === 0) {
        alert('‚ö†Ô∏è No hi ha dades de titularitats disponibles');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    let yPos = 20;
    const pageHeight = 190;
    const leftMargin = 20;
    const rightMargin = 277;
    
    function checkPageBreak(neededSpace = 10) {
        if (yPos > pageHeight - neededSpace) {
            doc.addPage();
            yPos = 20;
            return true;
        }
        return false;
    }
    
    function addSeparator() {
        checkPageBreak(5);
        doc.setDrawColor(34, 211, 238);
        doc.setLineWidth(0.5);
        doc.line(leftMargin, yPos, rightMargin, yPos);
        yPos += 8;
    }
    
    // T√≠tol
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CN TERRASSA JUVENIL 25/26', 148.5, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(14);
    doc.text('INFORME DE TITULARITATS', 148.5, yPos, { align: 'center' });
    yPos += 12;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Basat en ${allMatches.length} partit(s)`, 148.5, yPos, { align: 'center' });
    yPos += 15;
    
    addSeparator();
    
    // Calcular estad√≠stiques de titularitat
    const titularStats = {};
    const totalQuarters = allMatches.length * 4;
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (!titularStats[playerName]) {
                        titularStats[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0,
                            total: 0
                        };
                    }
                    titularStats[playerName][q]++;
                    titularStats[playerName].total++;
                }
            });
        });
    });
    
    const sortedPlayers = Object.values(titularStats).sort((a, b) => b.total - a.total);
    
    // ============ RESUM GENERAL ============
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('RESUM GENERAL', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Total de quarts analitzats: ${totalQuarters}`, leftMargin + 5, yPos);
    yPos += 6;
    doc.text(`Jugadors amb titularitats: ${sortedPlayers.length}`, leftMargin + 5, yPos);
    yPos += 10;
    
    addSeparator();
    
    // ============ TAULA DE TITULARITATS ============
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ESTAD√çSTIQUES DE TITULARITAT PER JUGADOR', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(8);
    
    // Cap√ßalera
    doc.setFont(undefined, 'bold');
    doc.setFillColor(6, 182, 212);
    doc.rect(leftMargin, yPos - 4, rightMargin - leftMargin, 6, 'F');
    doc.setTextColor(255, 255, 255);
    
    doc.text('#', leftMargin + 2, yPos);
    doc.text('Jugador', leftMargin + 12, yPos);
    doc.text('1Q', leftMargin + 85, yPos);
    doc.text('2Q', leftMargin + 110, yPos);
    doc.text('3Q', leftMargin + 135, yPos);
    doc.text('4Q', leftMargin + 160, yPos);
    doc.text('Total', leftMargin + 185, yPos);
    doc.text('%', leftMargin + 215, yPos);
    doc.text('Patr√≥', leftMargin + 235, yPos);
    yPos += 6;
    
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    sortedPlayers.forEach((player, index) => {
        checkPageBreak(8);
        
        if (index % 2 === 0) {
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, yPos - 4, rightMargin - leftMargin, 6, 'F');
        }
        
        const percentage = ((player.total / totalQuarters) * 100).toFixed(1);
        
        let pattern = '';
        if (player.q1 + player.q2 > player.q3 + player.q4) {
            pattern = 'Inici fort';
        } else if (player.q3 + player.q4 > player.q1 + player.q2) {
            pattern = 'Final partit';
        } else {
            pattern = 'Equilibrat';
        }
        
        doc.text(`${player.num}`, leftMargin + 2, yPos);
        doc.text(player.name.substring(0, 35), leftMargin + 12, yPos);
        doc.text(`${player.q1}`, leftMargin + 85, yPos);
        doc.text(`${player.q2}`, leftMargin + 110, yPos);
        doc.text(`${player.q3}`, leftMargin + 135, yPos);
        doc.text(`${player.q4}`, leftMargin + 160, yPos);
        doc.text(`${player.total}`, leftMargin + 185, yPos);
        doc.text(`${percentage}%`, leftMargin + 215, yPos);
        doc.text(pattern, leftMargin + 235, yPos);
        
        yPos += 6;
    });
    
    yPos += 10;
    addSeparator();
    
    // ============ CONSIST√àNCIA DE TITULARITAT ============
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('CONSIST√àNCIA DE TITULARITAT', leftMargin, yPos);
    yPos += 8;
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Percentatge de quarts en els que cada jugador ha estat titular', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(8);
    
    sortedPlayers.forEach((player, index) => {
        checkPageBreak(6);
        
        const percentage = ((player.total / totalQuarters) * 100).toFixed(1);
        
        const barWidth = (percentage / 100) * 150;
        doc.setFillColor(6, 182, 212);
        doc.rect(leftMargin + 60, yPos - 3, barWidth, 4, 'F');
        
        doc.setFont(undefined, 'normal');
        doc.text(`${player.num}. ${player.name.substring(0, 25)}`, leftMargin, yPos);
        doc.text(`${percentage}%`, leftMargin + 220, yPos);
        
        yPos += 6;
    });
    
    yPos += 10;
    addSeparator();
    
    // ============ PATRONS PER QUART ============
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('PATRONS DE TITULARITAT PER QUART', leftMargin, yPos);
    yPos += 8;
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Quart preferit i patr√≥ de cada jugador', leftMargin, yPos);
    yPos += 12;
    
    doc.setFontSize(8);
    
    sortedPlayers.forEach((player, index) => {
        checkPageBreak(10);
        
        const quarters = [
            { name: '1Q', value: player.q1 },
            { name: '2Q', value: player.q2 },
            { name: '3Q', value: player.q3 },
            { name: '4Q', value: player.q4 }
        ];
        const maxQuarter = quarters.reduce((max, q) => q.value > max.value ? q : max, quarters[0]);
        
        let pattern = '';
        let patternIcon = '';
        if (player.q1 + player.q2 > player.q3 + player.q4) {
            pattern = 'Inici fort (m√©s titular 1a meitat)';
            patternIcon = 'üìò';
        } else if (player.q3 + player.q4 > player.q1 + player.q2) {
            pattern = 'Final de partit (m√©s titular 2a meitat)';
            patternIcon = 'üìï';
        } else {
            pattern = 'Equilibrat';
            patternIcon = '‚ö™';
        }
        
        doc.setFont(undefined, 'bold');
        doc.text(`${player.num}. ${player.name}`, leftMargin + 5, yPos);
        yPos += 5;
        
        doc.setFont(undefined, 'normal');
        doc.text(`Prefer√®ncia: ${maxQuarter.name} (${maxQuarter.value}x titular de ${allMatches.length} possibles)`, leftMargin + 10, yPos);
        yPos += 4;
        doc.text(`Patr√≥: ${patternIcon} ${pattern}`, leftMargin + 10, yPos);
        yPos += 4;
        doc.text(`Distribuci√≥: 1Q=${player.q1} | 2Q=${player.q2} | 3Q=${player.q3} | 4Q=${player.q4}`, leftMargin + 10, yPos);
        yPos += 8;
    });
    
    const fileName = `CNT_Titularitats_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
    alert('‚úÖ PDF de titularitats generat correctament!');
}

function generateMatchPDF(match) {
    if (!match) {
        alert('‚ö†Ô∏è No hi ha cap partit seleccionat');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    let yPos = 20;
    const pageHeight = 190;
    const leftMargin = 20;
    const rightMargin = 277;
    
    function checkPageBreak(neededSpace = 10) {
        if (yPos > pageHeight - neededSpace) {
            doc.addPage();
            yPos = 20;
            return true;
        }
        return false;
    }
    
    function addSeparator() {
        checkPageBreak(5);
        doc.setDrawColor(34, 211, 238);
        doc.setLineWidth(0.5);
        doc.line(leftMargin, yPos, rightMargin, yPos);
        yPos += 8;
    }
    
    // ============ CAP√áALERA ============
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('CN TERRASSA - INFORME DE PARTIT', 148.5, yPos, { align: 'center' });
    yPos += 12;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    const matchDate = new Date(match.data).toLocaleDateString('ca-ES', { 
        year: 'numeric', month: 'long', day: 'numeric' 
    });
    doc.text(`Data: ${matchDate}`, leftMargin, yPos);
    yPos += 7;
    doc.text(`Rival: ${match.rivalTeam}`, leftMargin, yPos);
    yPos += 7;
    doc.text(`Localitzaci√≥: ${match.matchLocation === 'home' ? 'Casa üè†' : 'Fora ‚úàÔ∏è'}`, leftMargin, yPos);
    yPos += 10;
    
    // Marcador final
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    const result = match.scoreCNT > match.scoreRival ? 'VICT√íRIA' : 
                  match.scoreCNT < match.scoreRival ? 'DERROTA' : 'EMPAT';
    
    if (result === 'VICT√íRIA') doc.setTextColor(34, 197, 94);
    else if (result === 'DERROTA') doc.setTextColor(239, 68, 68);
    else doc.setTextColor(251, 191, 36);
    
    doc.text(`${match.scoreCNT} - ${match.scoreRival}`, 148.5, yPos, { align: 'center' });
    yPos += 8;
    doc.setFontSize(12);
    doc.text(`(${result})`, 148.5, yPos, { align: 'center' });
    yPos += 12;
    
    doc.setTextColor(0, 0, 0);
    addSeparator();
    
    // ============ MARCADORS PER QUART ============
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('Marcadors per Quart:', leftMargin, yPos);
    yPos += 7;
    doc.setFont(undefined, 'normal');
    
    ['q1', 'q2', 'q3', 'q4'].forEach((q, i) => {
        const cntScore = match.periodScores?.[q]?.cnt || 0;
        const rivalScore = match.periodScores?.[q]?.rival || 0;
        doc.text(`${i+1}¬∫ Quart: ${cntScore} - ${rivalScore}`, leftMargin + 5, yPos);
        yPos += 5;
    });
    
    yPos += 5;
    addSeparator();
    
    // ============ ESTAD√çSTIQUES D'EQUIP ============
    doc.setFont(undefined, 'bold');
    doc.text('Estad√≠stiques d\'Equip CN Terrassa:', leftMargin, yPos);
    yPos += 7;
    doc.setFont(undefined, 'normal');
    doc.setFontSize(9);
    
    const totalGols = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.gols || 0), 0);
    const totalExc = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.exclusions || 0), 0);
    const totalParades = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.parades || 0), 0);
    const totalAssist = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.assistencies || 0), 0);
    const totalRob = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.robatoris || 0), 0);
    const totalPer = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.perdues || 0), 0);
    const totalXF = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.xutsFallats || 0), 0);
    const totalPM = match.jugadors.reduce((sum, j) => sum + (j.estadistiques.penaltyMissed || 0), 0);
    
    const col1Stats = [
        ['Total Gols:', totalGols],
        ['Total Exclusions:', totalExc],
        ['Temps Morts:', match.tempsMortCNT || 0]
    ];
    
    const col2Stats = [
        ['Total Assist√®ncies:', totalAssist],
        ['Total Robatoris:', totalRob],
        ['Total P√®rdues:', totalPer]
    ];
    
    const col3Stats = [
        ['Total Parades:', totalParades],
        ['Xuts Fallats:', totalXF],
        ['Penalties Fallats:', totalPM]
    ];
    
    const startY = yPos;
    col1Stats.forEach(([label, value], i) => {
        doc.text(label, leftMargin + 5, startY + (i * 5));
        doc.text(value.toString(), leftMargin + 50, startY + (i * 5));
    });
    
    col2Stats.forEach(([label, value], i) => {
        doc.text(label, leftMargin + 95, startY + (i * 5));
        doc.text(value.toString(), leftMargin + 140, startY + (i * 5));
    });
    
    col3Stats.forEach(([label, value], i) => {
        doc.text(label, leftMargin + 180, startY + (i * 5));
        doc.text(value.toString(), leftMargin + 225, startY + (i * 5));
    });
    
    yPos = startY + 20;
    addSeparator();
    
    // ============ TAULA COMPLETA JUGADORS AMB LES COLUMNES EXACTES ============
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ESTAD√çSTIQUES INDIVIDUALS COMPLETES', 148.5, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(6.5);
    
    // Cap√ßalera exacta igual que la taula general
    const headers = ['N¬∫', 'Jugador', 'Gols', 'H+', 'Pen', 'Con', 'Boy', 'Nor', 'Exc', 'Par', 'Ast', 'Rob', 'P√®r', 'FR', 'Xuts', 'PenF', 'Efic%', 'Valor'];
    const colWidths = [7, 38, 11, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 10, 10, 12, 12];
    let xPos = leftMargin;
    
    doc.setFont(undefined, 'bold');
    doc.setFillColor(6, 182, 212);
    doc.rect(leftMargin, yPos - 3, colWidths.reduce((a,b) => a+b, 0), 5, 'F');
    doc.setTextColor(255, 255, 255);
    
    headers.forEach((header, i) => {
        doc.text(header, xPos + 0.5, yPos);
        xPos += colWidths[i];
    });
    yPos += 5;
    
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    // Ordenar per valoraci√≥
    const sortedPlayers = [...match.jugadors].map(j => {
        const valor = (j.estadistiques.gols || 0) * 3 + 
                     (j.estadistiques.assistencies || 0) * 2 + 
                     (j.estadistiques.robatoris || 0) * 1 + 
                     (j.estadistiques.parades || 0) * 2 - 
                     (j.estadistiques.perdues || 0) * 1 - 
                     (j.estadistiques.exclusions || 0) * 2;
        return { ...j, valor };
    }).sort((a, b) => b.valor - a.valor);
    
    sortedPlayers.forEach((j, index) => {
        checkPageBreak(6);
        
        if (index % 2 === 0) {
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, yPos - 3, colWidths.reduce((a,b) => a+b, 0), 5, 'F');
        }
        
        xPos = leftMargin;
        
        const totalXuts = (j.estadistiques.gols || 0) + (j.estadistiques.xutsFallats || 0);
        const efic = totalXuts > 0 ? (((j.estadistiques.gols || 0) / totalXuts) * 100).toFixed(1) : '0';
        
        const rowData = [
            j.numero.toString(),
            j.nom.length > 20 ? j.nom.substring(0, 20) : j.nom,
            (j.estadistiques.gols || 0).toString(),
            (j.estadistiques.goalTypes?.['h+'] || 0).toString(),
            (j.estadistiques.goalTypes?.penalty || 0).toString(),
            (j.estadistiques.goalTypes?.contra || 0).toString(),
            (j.estadistiques.goalTypes?.boya || 0).toString(),
            (j.estadistiques.goalTypes?.normal || 0).toString(),
            (j.estadistiques.exclusions || 0).toString(),
            (j.estadistiques.parades || 0).toString(),
            (j.estadistiques.assistencies || 0).toString(),
            (j.estadistiques.robatoris || 0).toString(),
            (j.estadistiques.perdues || 0).toString(),
			(j.estadistiques.faltesRebudes || 0).toString(),
            (j.estadistiques.xutsFallats || 0).toString(),
            (j.estadistiques.penaltyMissed || 0).toString(),
            efic + '%',
            j.valor.toString()
        ];
        
        rowData.forEach((value, i) => {
            doc.text(value, xPos + 0.5, yPos);
            xPos += colWidths[i];
        });
        
        yPos += 5;
    });
    
    yPos += 3;
    doc.setFontSize(6);
    doc.setFont(undefined, 'italic');
    doc.text('H+=Superioritat, Pen=Penalty, Con=Contra, Boy=Boya, Nor=Normal, Exc=Exclusions, Par=Parades, Ast=Assist√®ncies,', leftMargin, yPos);
    yPos += 3;
    doc.text('Rob=Robatoris, P√®r=P√®rdues, FR=Faltes Rebudes, Xuts=Xuts Fallats, PenF=Penalties Fallats, Efic%=Efici√®ncia Tir, G/P=Gols/Partit, Valor=Valoraci√≥ Global', leftMargin, yPos);
    yPos += 8;
    
    addSeparator();
    
    // ============ ALINEACIONS ============
    checkPageBreak(40);
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Alineacions per Quart:', leftMargin, yPos);
    yPos += 10;
    
    doc.setFontSize(9);
    
    ['q1', 'q2', 'q3', 'q4'].forEach((q, i) => {
        checkPageBreak(12);
        
        doc.setFont(undefined, 'bold');
        doc.text(`${i+1}¬∫ Quart:`, leftMargin + 5, yPos);
        yPos += 5;
        doc.setFont(undefined, 'normal');
        
        if (match.lineups && match.lineups[q] && match.lineups[q].length > 0) {
            const lineup = match.lineups[q].map(num => {
                const player = match.jugadors.find(j => j.numero === num);
                return `${num}. ${player ? player.nom.split(' ')[0] : '?'}`;
            }).join(', ');
            
            const lines = doc.splitTextToSize(lineup, rightMargin - leftMargin - 10);
            lines.forEach(line => {
                doc.text(line, leftMargin + 10, yPos);
                yPos += 5;
            });
        } else {
            doc.text('Sense alineaci√≥', leftMargin + 10, yPos);
            yPos += 5;
        }
        yPos += 3;
    });
    
    // ============ OBSERVACIONS ============
    if (match.observacions && match.observacions.trim() !== '') {
        yPos += 5;
        addSeparator();
        
        checkPageBreak(20);
        
        doc.setFont(undefined, 'bold');
        doc.text('Observacions:', leftMargin, yPos);
        yPos += 6;
        doc.setFont(undefined, 'normal');
        
        const lines = doc.splitTextToSize(match.observacions, rightMargin - leftMargin);
        lines.forEach(line => {
            checkPageBreak(6);
            doc.text(line, leftMargin, yPos);
            yPos += 5;
        });
    }
    
    const fileName = `CNT_Partit_${new Date(match.data).toISOString().split('T')[0]}_${match.rivalTeam.replace(/\s+/g, '_')}.pdf`;
    doc.save(fileName);
    
    alert('‚úÖ PDF del partit generat amb TOTES les estad√≠stiques!');
}
   </script>
   <script>
    // üîí Bloqueo de clic derecho y atajos
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", event => {
      if ((event.ctrlKey && ["s", "u"].includes(event.key.toLowerCase())) ||
          event.key === "F12") {
        event.preventDefault();
      }
    });
    </script>
</body>
</html>
