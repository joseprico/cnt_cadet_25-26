name: Notificar nou partit Cadet

on:
  push:
    paths:
      - 'cnt_stats_*.json'
  workflow_dispatch:

jobs:
  notify-new-match:
    runs-on: ubuntu-latest
    
    # Evitar bucle infinit
    if: github.event.head_commit.author.username != 'github-actions[bot]'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Detect new match file
        id: detect
        run: |
          echo "üîç Detectant fitxers nous de partits..."
          
          # Obtenir fitxers modificats en aquest commit
          NEW_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'cnt_stats_.*\.json' || true)
          
          if [ -z "$NEW_FILES" ]; then
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No s'han detectat fitxers nous de partits"
          else
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "files=$NEW_FILES" >> $GITHUB_OUTPUT
            echo "‚úÖ Fitxers nous detectats:"
            echo "$NEW_FILES"
          fi
      
      - name: Debug secrets
        if: steps.detect.outputs.has_new == 'true'
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
        run: |
          echo "üîç Verificant secrets..."
          
          if [ -z "$ONESIGNAL_APP_ID" ]; then
            echo "‚ùå ONESIGNAL_APP_ID est√† buit!"
          else
            echo "‚úÖ ONESIGNAL_APP_ID present (longitud: ${#ONESIGNAL_APP_ID})"
            echo "   Primers 8 chars: ${ONESIGNAL_APP_ID:0:8}..."
          fi
          
          if [ -z "$ONESIGNAL_API_KEY" ]; then
            echo "‚ùå ONESIGNAL_API_KEY est√† buida!"
          else
            echo "‚úÖ ONESIGNAL_API_KEY present (longitud: ${#ONESIGNAL_API_KEY})"
            echo "   Primers 8 chars: ${ONESIGNAL_API_KEY:0:8}..."
          fi
      
      - name: Send notification
        if: steps.detect.outputs.has_new == 'true'
        env:
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
        run: |
          python3 << 'EOF'
          import json
          import requests
          import os
          import sys
          
          def send_notification(title, message, url="https://joseprico.github.io/"):
              """Envia notificaci√≥ via OneSignal"""
              app_id = os.environ.get('ONESIGNAL_APP_ID', '')
              api_key = os.environ.get('ONESIGNAL_API_KEY', '')
              
              if not app_id or not api_key:
                  print("‚ö†Ô∏è OneSignal credentials no configurades")
                  return False
              
              headers = {
                  "Authorization": f"Basic {api_key}",
                  "Content-Type": "application/json"
              }
              
              payload = {
                  "app_id": app_id,
                  "filters": [
                      {"field": "session_count", "relation": ">", "value": "0"}
                  ],
                  "headings": {"ca": title, "es": title, "en": title},
                  "contents": {"ca": message, "es": message, "en": message},
                  "url": url
              }
              
              try:
                  response = requests.post(
                      "https://onesignal.com/api/v1/notifications",
                      headers=headers,
                      json=payload,
                      timeout=10
                  )
                  
                  print(f"üìä Response status: {response.status_code}")
                  print(f"üìä Response body: {response.text}")
                  
                  if response.status_code == 200:
                      response_data = response.json()
                      notification_id = response_data.get('id', '')
                      recipients = response_data.get('recipients', None)
                      
                      if notification_id:
                          print(f"‚úÖ Notificaci√≥ enviada correctament")
                          print(f"üÜî Notification ID: {notification_id}")
                          
                          if recipients is not None:
                              print(f"üì± Recipients: {recipients}")
                              if recipients == 0:
                                  print("‚ö†Ô∏è WARNING: 0 recipients reportats per OneSignal")
                          else:
                              print(f"üì± Recipients: No disponible (usat filtres)")
                              print(f"   La notificaci√≥ s'ha enviat correctament per√≤ OneSignal")
                              print(f"   no retorna el nombre de recipients quan s'usen filtres.")
                          
                          return True
                      else:
                          print(f"‚ùå Error: No s'ha rebut ID de notificaci√≥")
                          return False
                  else:
                      print(f"‚ùå Error enviant notificaci√≥ ({response.status_code}): {response.text}")
                      return False
              except Exception as e:
                  print(f"‚ùå Error de connexi√≥: {e}")
                  return False
          
          # Obtenir nom del fitxer nou des de les variables d'entorn
          files = "${{ steps.detect.outputs.files }}"
          
          print(f"üì§ Processant fitxers: {files}")
          
          for filename in files.split('\n'):
              if not filename or not filename.endswith('.json'):
                  continue
              
              try:
                  # Llegir el fitxer del partit
                  with open(filename, 'r', encoding='utf-8') as f:
                      match_data = json.load(f)
                  
                  # Extreure informaci√≥ del partit amb l'estructura correcta
                  rival = match_data.get('rivalTeam', 'Rival desconegut')
                  date_raw = match_data.get('data', '')
                  temporada = match_data.get('temporada', '')
                  our_score = match_data.get('scoreCNT', 0)
                  rival_score = match_data.get('scoreRival', 0)
                  
                  # Formatar la data si existeix
                  date = ''
                  if date_raw:
                      try:
                          from datetime import datetime
                          dt = datetime.fromisoformat(date_raw.replace('Z', '+00:00'))
                          date = dt.strftime('%d/%m/%Y')
                      except:
                          date = date_raw
                  
                  # Determinar resultat
                  if our_score > rival_score:
                      emoji = "üéâ"
                      result = "Vict√≤ria!"
                  elif our_score < rival_score:
                      emoji = "üí™"
                      result = "Derrota"
                  else:
                      emoji = "ü§ù"
                      result = "Empat"
                  
                  # Extreure equip (CADET o JUVENIL) de temporada
                  team = "CADET"
                  if temporada and "JUVENIL" in temporada.upper():
                      team = "JUVENIL"
                  
                  # Construir missatge
                  title = f"CN Terrassa {team} - {result}"
                  message = f"{emoji} CN Terrassa {our_score} - {rival_score} {rival}"
                  if date:
                      message += f"\nüìÖ {date}"
                  
                  # Enviar notificaci√≥
                  print(f"\n{'='*60}")
                  print(f"Enviant notificaci√≥ per: {filename}")
                  print(f"Title: {title}")
                  print(f"Message: {message}")
                  print(f"{'='*60}\n")
                  
                  send_notification(title, message)
                  
              except Exception as e:
                  print(f"‚ùå Error processant {filename}: {e}")
                  import traceback
                  traceback.print_exc()
          
          print("\n‚úÖ Proc√©s de notificacions completat!")
          EOF
      
      - name: Create summary
        if: always()
        run: |
          echo "### üîî Notificaci√≥ nou partit CADET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data:** $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.detect.outputs.has_new }}" == "true" ]; then
            echo "‚úÖ **Estat:** Nou partit detectat i notificaci√≥ enviada" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fitxers nous:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.detect.outputs.files }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **Estat:** No s'han detectat nous partits" >> $GITHUB_STEP_SUMMARY
          fi
