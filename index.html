<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Estad√≠sticas - CN Terrassa</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .tabs { gap: 8px; padding: 8px; }
            .tab { 
                padding: 10px 8px; 
                font-size: 13px;
                min-width: 100px;
            }
        }
        .tab.active { background: #06b6d4; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .team-score { text-align: center; }
        .team-name { font-size: 24px; font-weight: bold; color: #67e8f9; margin-bottom: 10px; }
        .score { font-size: 64px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .separator { font-size: 48px; font-weight: bold; color: #67e8f9; }
        
        @media (max-width: 768px) {
            .scoreboard { gap: 15px; padding: 15px; }
            .team-name { font-size: 18px; }
            .score { font-size: 48px; }
            .separator { font-size: 36px; }
        }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #22d3ee; }
        .periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .period-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .period-label { font-size: 14px; color: #bae6fd; margin-bottom: 8px; }
        .period-score { font-size: 32px; font-weight: bold; color: #fde047; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        .player-stat {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .player-stat {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            .player-info { margin-bottom: 8px; }
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-num {
            background: #06b6d4;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .player-num.rival { background: #ef4444; }
        .player-name { font-weight: 600; }
        .player-stats { display: flex; gap: 15px; font-size: 18px; font-weight: bold; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #bae6fd; }
        .stat-value { color: #fde047; }
        .lineup-section { margin-bottom: 20px; }
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .lineup-player {
            background: rgba(34, 197, 94, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid #22c55e;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; }
        .observations {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .btn {
            padding: 12px 24px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #0891b2; }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #bae6fd;
        }
        .hidden { display: none; }
        .top-scorers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-scorer-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank {
            background: #fbbf24;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rank.gold { background: #fbbf24; }
        .rank.silver { background: #d1d5db; }
        .rank.bronze { background: #d97706; }
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .match-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
            flex-wrap: wrap;
        }
        .match-item:hover { background: rgba(0,0,0,0.3); }
        .match-info { flex: 1; min-width: 200px; }
        
        @media (max-width: 768px) {
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            .match-info { width: 100%; }
            .match-score { margin: 10px 0 0 0 !important; }
        }
        .match-date { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .match-teams { font-size: 16px; font-weight: bold; }
        .match-score { font-size: 24px; font-weight: bold; color: #fde047; margin: 0 15px; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .comparison-table th {
            background: rgba(0,0,0,0.3);
            color: #22d3ee;
            font-weight: bold;
        }
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
            }
        }
        .win { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .draw { color: #fbbf24; font-weight: bold; }
        .titular-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .titular-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .titular-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .titular-quarters {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .quarter-badge {
            background: rgba(6, 182, 212, 0.3);
            border: 2px solid #06b6d4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .total-badge {
            background: #fbbf24;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #22d3ee;
        }
        .filter-bar {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                padding: 12px;
                gap: 10px;
            }
            .filter-item { width: 100%; }
            .filter-input { width: 100%; }
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            color: #bae6fd;
        }
        .filter-input {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        .filter-input:focus {
            outline: none;
            border-color: #22d3ee;
        }
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .stats-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
        }
        .breakdown-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .breakdown-label {
            font-size: 11px;
            color: #bae6fd;
            margin-bottom: 5px;
        }
        .breakdown-value {
            font-size: 20px;
            font-weight: bold;
            color: #fde047;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Estad√≠sticas CN Terrassa</h1>
            <p>Cadet 25/26</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('list')">üìã Lista de Partidos</button>
            <button class="tab" onclick="showTab('comparison')">üìä Comparaci√≥n</button>
            <button class="tab" onclick="showTab('titular')">üë• Titularidad</button>
        </div>

        <!-- TAB: LISTA DE PARTIDOS -->
        <div id="listTab">
            <div id="loadingMatches" class="loading">
                Cargando partidos...
            </div>

            <div id="matchesView" class="hidden">
                <div class="card">
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="filter-label">Buscar rival</label>
                            <input type="text" class="filter-input" id="filterRival" placeholder="Nombre del rival..." onkeyup="filterMatches()">
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Resultado</label>
                            <select class="filter-input" id="filterResult" onchange="filterMatches()">
                                <option value="">Todos</option>
                                <option value="win">Victorias</option>
                                <option value="loss">Derrotas</option>
                                <option value="draw">Empates</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Ordenar por</label>
                            <select class="filter-input" id="sortBy" onchange="filterMatches()">
                                <option value="date-desc">Fecha (m√°s reciente)</option>
                                <option value="date-asc">Fecha (m√°s antiguo)</option>
                                <option value="score-desc">M√°s goles</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Partidos Disponibles</h2>
                    <div class="matches-list" id="availableMatches"></div>
                </div>
            </div>

            <!-- Vista de partido individual -->
            <div id="singleMatchView" class="hidden">
                <div class="card">
                    <button class="btn" onclick="backToList()" style="margin-bottom: 15px;">‚Üê Volver a la lista</button>
                    
                    <div class="scoreboard">
                        <div class="team-score">
                            <div class="team-name">CN TERRASSA</div>
                            <div class="score" id="scoreCNT">0</div>
                        </div>
                        <div class="separator">-</div>
                        <div class="team-score">
                            <div class="team-name" id="teamRival">RIVAL</div>
                            <div class="score" id="scoreRival">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Informaci√≥n del Partido</h2>
                    <div class="info-grid" id="infoGrid"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Desglose de Goles CN Terrassa</h2>
                    <div class="stats-breakdown" id="goalsBreakdown"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Desglose de Exclusiones</h2>
                    <div class="stats-breakdown" id="exclusionsBreakdown"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Marcadores por Periodo</h2>
                    <div class="periods-grid" id="periodsGrid"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">üèÜ Top Goleadores - CN Terrassa</h2>
                    <div class="top-scorers" id="topScorersCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">üèÜ Top Goleadores - Rival</h2>
                    <div class="top-scorers" id="topScorersRival"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estad√≠sticas CN Terrassa</h2>
                    <div class="stats-grid" id="statsCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estad√≠sticas Rival</h2>
                    <div class="stats-grid" id="statsRival"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Alineaciones por Cuarto</h2>
                    <div id="lineupsContainer"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Observaciones</h2>
                    <div class="observations" id="observations">No hay observaciones</div>
                </div>
            </div>
        </div>

        <!-- TAB: COMPARACI√ìN -->
        <div id="comparisonTab" class="hidden">
            <div id="comparisonView">
                <div class="card">
                    <h2 class="section-title">Resumen de Resultados</h2>
                    <div class="info-grid" id="summaryGrid"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Desglose de Goles (Total)</h2>
                    <div class="stats-breakdown" id="totalGoalsBreakdown"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Desglose de Exclusiones (Total)</h2>
                    <div class="stats-breakdown" id="totalExclusionsBreakdown"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Comparaci√≥n de Estad√≠sticas</h2>
                    <div style="overflow-x: auto;">
                        <table class="comparison-table" id="comparisonTable"></table>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Top Goleadores (Todos los Partidos)</h2>
                    <div class="top-scorers" id="allTimeScorers"></div>
                </div>
            </div>
        </div>

        <!-- TAB: TITULARIDAD -->
        <div id="titularTab" class="hidden">
            <div class="card">
                <div id="titularView"></div>
            </div>
        </div>
    </div>

    <script>
        let allMatches = [];
        let filteredMatches = [];
        let currentMatch = null;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllMatches();
        });

        async function loadAllMatches() {
            try {
                const response = await fetch('https://api.github.com/repos/joseprico/cnt_cadet_25-26/contents/');
                const files = await response.json();
                
                const jsonFiles = files.filter(f => 
                    f.name.startsWith('cnt_stats_') && f.name.endsWith('.json')
                );

                const promises = jsonFiles.map(async file => {
                    const res = await fetch(file.download_url);
                    return await res.json();
                });

                allMatches = await Promise.all(promises);
                allMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
                filteredMatches = [...allMatches];

                document.getElementById('loadingMatches').classList.add('hidden');
                document.getElementById('matchesView').classList.remove('hidden');
                
                displayMatchesList();
                displayComparison();
                displayTitularStats();
            } catch (error) {
                console.error('Error cargando partidos:', error);
                document.getElementById('loadingMatches').innerHTML = `
                    <div class="no-data">
                        <p>No se pudieron cargar los partidos autom√°ticamente.</p>
                        <p style="font-size: 14px; margin-top: 10px;">Aseg√∫rate de que los archivos JSON est√°n en el repositorio.</p>
                    </div>
                `;
            }
        }

        function displayMatchesList() {
            const container = document.getElementById('availableMatches');
            
            if (filteredMatches.length === 0) {
                container.innerHTML = '<div class="no-data">No hay partidos que coincidan con los filtros</div>';
                return;
            }

            container.innerHTML = filteredMatches.map((match, idx) => {
                const date = new Date(match.data);
                const result = match.scoreCNT > match.scoreRival ? 'win' : 
                              match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                const resultText = result === 'win' ? '‚úÖ Victoria' : 
                                  result === 'loss' ? '‚ùå Derrota' : 'ü§ù Empate';
                
                return `
                    <div class="match-item" onclick="viewMatch(${allMatches.indexOf(match)})">
                        <div class="match-info">
                            <div class="match-date">${date.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                            <div class="match-teams">CN Terrassa vs ${match.rivalTeam || 'Rival'}</div>
                            <div class="${result}">${resultText}</div>
                        </div>
                        <div class="match-score">${match.scoreCNT} - ${match.scoreRival}</div>
                    </div>
                `;
            }).join('');
        }

        function filterMatches() {
            const rivalFilter = document.getElementById('filterRival').value.toLowerCase();
            const resultFilter = document.getElementById('filterResult').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredMatches = allMatches.filter(match => {
                const rivalMatch = !rivalFilter || (match.rivalTeam || '').toLowerCase().includes(rivalFilter);
                
                let resultMatch = true;
                if (resultFilter) {
                    const result = match.scoreCNT > match.scoreRival ? 'win' : 
                                  match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                    resultMatch = result === resultFilter;
                }

                return rivalMatch && resultMatch;
            });

            if (sortBy === 'date-desc') {
                filteredMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
            } else if (sortBy === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.data) - new Date(b.data));
            } else if (sortBy === 'score-desc') {
                filteredMatches.sort((a, b) => b.scoreCNT - a.scoreCNT);
            }

            displayMatchesList();
        }

        function viewMatch(idx) {
            currentMatch = allMatches[idx];
            document.getElementById('matchesView').classList.add('hidden');
            document.getElementById('singleMatchView').classList.remove('hidden');
            displayMatchData();
        }

        function backToList() {
            document.getElementById('singleMatchView').classList.add('hidden');
            document.getElementById('matchesView').classList.remove('hidden');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('listTab').classList.add('hidden');
            document.getElementById('comparisonTab').classList.add('hidden');
            document.getElementById('titularTab').classList.add('hidden');

            if (tabName === 'list') {
                document.getElementById('listTab').classList.remove('hidden');
            } else if (tabName === 'comparison') {
                document.getElementById('comparisonTab').classList.remove('hidden');
            } else if (tabName === 'titular') {
                document.getElementById('titularTab').classList.remove('hidden');
            }
        }

        function displayMatchData() {
            document.getElementById('scoreCNT').textContent = currentMatch.scoreCNT || 0;
            document.getElementById('scoreRival').textContent = currentMatch.scoreRival || 0;
            document.getElementById('teamRival').textContent = currentMatch.rivalTeam || 'RIVAL';

            const date = new Date(currentMatch.data);
            const totalExcCNT = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.exclusions, 0);
            const totalExcRival = currentMatch.rivalStats.reduce((sum, j) => sum + j.exclusions, 0);

            let totalHPlus = 0;
            let totalExclusionsNoPenalty = 0;
            
            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes && j.estadistiques.goalTypes['h+']) {
                    totalHPlus += j.estadistiques.goalTypes['h+'];
                }
            });
            
            currentMatch.rivalStats.forEach(j => {
                if (j.exclusionTypes) {
                    totalExclusionsNoPenalty += (j.exclusionTypes.normal || 0);
                }
            });
            
            const conversionRate = totalExclusionsNoPenalty > 0 ? 
                ((totalHPlus / totalExclusionsNoPenalty) * 100).toFixed(1) : '0.0';

            document.getElementById('infoGrid').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Fecha</div>
                    <div class="info-value">${date.toLocaleDateString('es-ES')}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Temporada</div>
                    <div class="info-value">${currentMatch.temporada || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Temps Mort CNT</div>
                    <div class="info-value">${currentMatch.tempsMortCNT || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Temps Mort Rival</div>
                    <div class="info-value">${currentMatch.tempsMortRival || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Exclusiones CNT</div>
                    <div class="info-value">${totalExcCNT}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Exclusiones Rival</div>
                    <div class="info-value">${totalExcRival}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Conversi√≥n H+</div>
                    <div class="info-value" style="color: ${conversionRate >= 50 ? '#22c55e' : conversionRate >= 30 ? '#fbbf24' : '#ef4444'}">
                        ${totalHPlus}/${totalExclusionsNoPenalty}<br>
                        <span style="font-size: 14px;">(${conversionRate}%)</span>
                    </div>
                </div>
            `;

            // Desglose de goles
            const goalStats = {
                'h+': 0,
                'penalty': 0,
                'contra': 0,
                'boya': 0,
                'normal': 0
            };

            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes) {
                    Object.keys(goalStats).forEach(type => {
                        goalStats[type] += j.estadistiques.goalTypes[type] || 0;
                    });
                }
            });

            const goalLabels = {
                'h+': 'Superioridad (H+)',
                'penalty': 'Penaltis',
                'contra': 'Contraataques',
                'boya': 'Boya',
                'normal': 'Normales'
            };

            document.getElementById('goalsBreakdown').innerHTML = Object.keys(goalStats)
                .filter(type => goalStats[type] > 0)
                .map(type => `
                    <div class="breakdown-item">
                        <div class="breakdown-label">${goalLabels[type]}</div>
                        <div class="breakdown-value">${goalStats[type]}</div>
                    </div>
                `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

            // Desglose de exclusiones
            const excStats = {
                cnt: { normal: 0, penalty: 0 },
                rival: { normal: 0, penalty: 0 }
            };

            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.exclusionTypes) {
                    excStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                    excStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                }
            });

            currentMatch.rivalStats.forEach(j => {
                if (j.exclusionTypes) {
                    excStats.rival.normal += j.exclusionTypes.normal || 0;
                    excStats.rival.penalty += j.exclusionTypes.penalty || 0;
                }
            });

            document.getElementById('exclusionsBreakdown').innerHTML = `
                <div class="breakdown-item">
                    <div class="breakdown-label">CNT - Normales</div>
                    <div class="breakdown-value">${excStats.cnt.normal}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">CNT - Penaltis</div>
                    <div class="breakdown-value">${excStats.cnt.penalty}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Rival - Normales</div>
                    <div class="breakdown-value">${excStats.rival.normal}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Rival - Penaltis</div>
                    <div class="breakdown-value">${excStats.rival.penalty}</div>
                </div>
            `;

            // Periodos
            if (currentMatch.periodScores) {
                const periods = ['q1', 'q2', 'q3', 'q4'];
                const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
                
                document.getElementById('periodsGrid').innerHTML = periods.map((q, i) => `
                    <div class="period-card">
                        <div class="period-label">${labels[i]}</div>
                        <div class="period-score">
                            ${currentMatch.periodScores[q].cnt} - ${currentMatch.periodScores[q].rival}
                        </div>
                    </div>
                `).join('');
            }

            // Top goleadores CNT
            const cntScorers = currentMatch.jugadors
                .filter(j => j.estadistiques.gols > 0)
                .sort((a, b) => b.estadistiques.gols - a.estadistiques.gols)
                .slice(0, 5);

            document.getElementById('topScorersCNT').innerHTML = cntScorers.length === 0 ? '<p>No hay goleadores</p>' :
                cntScorers.map((j, i) => {
                    let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return `
                        <div class="top-scorer-item">
                            <div class="player-info">
                                <div class="rank ${rankClass}">${i + 1}</div>
                                <div class="player-num">${j.numero}</div>
                                <div class="player-name">${j.nom}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                                ${j.estadistiques.gols} ‚öΩ
                            </div>
                        </div>
                    `;
                }).join('');

            // Top goleadores Rival
            const rivalScorers = currentMatch.rivalStats
                .filter(j => j.gols > 0 && j.name)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 5);

            document.getElementById('topScorersRival').innerHTML = rivalScorers.length === 0 ? '<p>No hay goleadores</p>' :
                rivalScorers.map((j, i) => {
                    let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return `
                        <div class="top-scorer-item">
                            <div class="player-info">
                                <div class="rank ${rankClass}">${i + 1}</div>
                                <div class="player-num rival">${j.num}</div>
                                <div class="player-name">${j.name}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                                ${j.gols} ‚öΩ
                            </div>
                        </div>
                    `;
                }).join('');

            // Stats CNT
            document.getElementById('statsCNT').innerHTML = currentMatch.jugadors.map(j => {
                const goalTypes = j.estadistiques.goalTypes || {};
                const exclusionTypes = j.estadistiques.exclusionTypes || {};
                
                let goalTypesText = '';
                if (goalTypes['h+']) goalTypesText += `H+:${goalTypes['h+']} `;
                if (goalTypes.penalty) goalTypesText += `P:${goalTypes.penalty} `;
                if (goalTypes.contra) goalTypesText += `C:${goalTypes.contra} `;
                if (goalTypes.boya) goalTypesText += `B:${goalTypes.boya} `;
                if (goalTypes.normal) goalTypesText += `N:${goalTypes.normal}`;
                
                let exclusionTypesText = '';
                if (exclusionTypes.normal) exclusionTypesText += `EX:${exclusionTypes.normal} `;
                if (exclusionTypes.penalty) exclusionTypesText += `P:${exclusionTypes.penalty}`;
                
                return `
                    <div class="player-stat">
                        <div class="player-info">
                            <div class="player-num">${j.numero}</div>
                            <div class="player-name">${j.nom}</div>
                        </div>
                        <div class="player-stats">
                            <div class="stat-item">
                                <div class="stat-label">Gols</div>
                                <div class="stat-value">${j.estadistiques.gols}</div>
                                ${goalTypesText ? `<div style="font-size: 9px; color: #bae6fd; margin-top: 2px;">${goalTypesText}</div>` : ''}
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Exc</div>
                                <div class="stat-value">${j.estadistiques.exclusions}</div>
                                ${exclusionTypesText ? `<div style="font-size: 9px; color: #bae6fd; margin-top: 2px;">${exclusionTypesText}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Stats Rival
            const rivalPlayers = currentMatch.rivalStats.filter(p => p.name || p.gols > 0 || p.exclusions > 0);
            document.getElementById('statsRival').innerHTML = rivalPlayers.length === 0 ? '<p>No hay estad√≠sticas del rival</p>' :
                rivalPlayers.map(j => `
                    <div class="player-stat">
                        <div class="player-info">
                            <div class="player-num rival">${j.num}</div>
                            <div class="player-name">${j.name || 'Jugador ' + j.num}</div>
                        </div>
                        <div class="player-stats">
                            <div class="stat-item">
                                <div class="stat-label">Gols</div>
                                <div class="stat-value">${j.gols}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Exc</div>
                                <div class="stat-value">${j.exclusions}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

            // Alineaciones
            const quarters = ['q1', 'q2', 'q3', 'q4'];
            const labels = ['1¬∫ Cuarto', '2¬∫ Cuarto', '3¬∫ Cuarto', '4¬∫ Cuarto'];
            document.getElementById('lineupsContainer').innerHTML = quarters.map((q, i) => {
                const lineup = currentMatch.lineups[q] || [];
                if (lineup.length === 0) return '';

                const players = lineup.map(num => {
                    const player = currentMatch.jugadors.find(j => j.numero === num);
                    return player ? `${player.numero}. ${player.nom.split(' ')[0]}` : num;
                });

                return `
                    <div class="lineup-section">
                        <h3 style="margin-bottom: 10px; color: #22d3ee;">${labels[i]}</h3>
                        <div class="lineup-grid">
                            ${players.map(p => `<div class="lineup-player">${p}</div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('observations').textContent = currentMatch.observacions || 'No hay observaciones';
        }

        function displayComparison() {
            if (allMatches.length === 0) return;

            const wins = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
            const losses = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
            const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
            const totalGoals = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
            const totalGoalsAgainst = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
            const avgGoals = (totalGoals / allMatches.length).toFixed(1);
            const avgGoalsAgainst = (totalGoalsAgainst / allMatches.length).toFixed(1);

            let totalHPlus = 0;
            let totalExclusionsNoPenalty = 0;
            
            // Estad√≠sticas globales de tipos de goles
            const globalGoalStats = {
                'h+': 0,
                'penalty': 0,
                'contra': 0,
                'boya': 0,
                'normal': 0
            };

            // Estad√≠sticas globales de exclusiones
            const globalExcStats = {
                cnt: { normal: 0, penalty: 0 },
                rival: { normal: 0, penalty: 0 }
            };
            
            allMatches.forEach(match => {
                match.jugadors.forEach(j => {
                    if (j.estadistiques.goalTypes) {
                        Object.keys(globalGoalStats).forEach(type => {
                            globalGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                        });
                        if (j.estadistiques.goalTypes['h+']) {
                            totalHPlus += j.estadistiques.goalTypes['h+'];
                        }
                    }
                    if (j.estadistiques.exclusionTypes) {
                        globalExcStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                        globalExcStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                    }
                });
                
                match.rivalStats.forEach(j => {
                    if (j.exclusionTypes) {
                        totalExclusionsNoPenalty += (j.exclusionTypes.normal || 0);
                        globalExcStats.rival.normal += j.exclusionTypes.normal || 0;
                        globalExcStats.rival.penalty += j.exclusionTypes.penalty || 0;
                    }
                });
            });
            
            const conversionRate = totalExclusionsNoPenalty > 0 ? 
                ((totalHPlus / totalExclusionsNoPenalty) * 100).toFixed(1) : '0.0';

            document.getElementById('summaryGrid').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Partidos Jugados</div>
                    <div class="info-value">${allMatches.length}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Victorias</div>
                    <div class="info-value win">${wins}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Derrotas</div>
                    <div class="info-value loss">${losses}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Empates</div>
                    <div class="info-value draw">${draws}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Goles a Favor</div>
                    <div class="info-value">${totalGoals}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Goles en Contra</div>
                    <div class="info-value">${totalGoalsAgainst}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Media Goles/Partido</div>
                    <div class="info-value">${avgGoals}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Media Goles en Contra</div>
                    <div class="info-value">${avgGoalsAgainst}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Conversi√≥n H+ (Total)</div>
                    <div class="info-value" style="color: ${conversionRate >= 50 ? '#22c55e' : conversionRate >= 30 ? '#fbbf24' : '#ef4444'}">
                        ${totalHPlus}/${totalExclusionsNoPenalty}<br>
                        <span style="font-size: 14px;">(${conversionRate}%)</span>
                    </div>
                </div>
            `;

            // Desglose global de goles
            const goalLabels = {
                'h+': 'Superioridad (H+)',
                'penalty': 'Penaltis',
                'contra': 'Contraataques',
                'boya': 'Boya',
                'normal': 'Normales'
            };

            document.getElementById('totalGoalsBreakdown').innerHTML = Object.keys(globalGoalStats)
                .filter(type => globalGoalStats[type] > 0)
                .map(type => `
                    <div class="breakdown-item">
                        <div class="breakdown-label">${goalLabels[type]}</div>
                        <div class="breakdown-value">${globalGoalStats[type]}</div>
                        <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                            ${((globalGoalStats[type] / totalGoals) * 100).toFixed(1)}%
                        </div>
                    </div>
                `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

            // Desglose global de exclusiones
            document.getElementById('totalExclusionsBreakdown').innerHTML = `
                <div class="breakdown-item">
                    <div class="breakdown-label">CNT - Normales</div>
                    <div class="breakdown-value">${globalExcStats.cnt.normal}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">CNT - Penaltis</div>
                    <div class="breakdown-value">${globalExcStats.cnt.penalty}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Rival - Normales</div>
                    <div class="breakdown-value">${globalExcStats.rival.normal}</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Rival - Penaltis</div>
                    <div class="breakdown-value">${globalExcStats.rival.penalty}</div>
                </div>
            `;

            // Tabla comparativa de jugadores - identificados por NOMBRE
            const playerStats = {};
            const playerMatchAppearances = {}; // Para trackear en qu√© partidos aparece cada jugador
            
            allMatches.forEach((match, matchIndex) => {
                match.jugadors.forEach(j => {
                    const playerName = j.nom.trim();
                    
                    if (!playerStats[playerName]) {
                        playerStats[playerName] = { 
                            num: j.numero, // Guardamos el √∫ltimo n√∫mero que us√≥
                            name: playerName, 
                            gols: 0, 
                            exclusions: 0, 
                            partidos: 0,
                            goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 }
                        };
                        playerMatchAppearances[playerName] = new Set();
                    }
                    
                    // Actualizar el n√∫mero (puede cambiar entre partidos)
                    playerStats[playerName].num = j.numero;
                    
                    // Marcar que el jugador apareci√≥ en este partido
                    playerMatchAppearances[playerName].add(matchIndex);
                    
                    playerStats[playerName].gols += j.estadistiques.gols;
                    playerStats[playerName].exclusions += j.estadistiques.exclusions;
                    
                    if (j.estadistiques.goalTypes) {
                        Object.keys(j.estadistiques.goalTypes).forEach(type => {
                            playerStats[playerName].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
                        });
                    }
                });
            });
            
            // Asignar el n√∫mero de partidos basado en las apariciones √∫nicas
            Object.keys(playerStats).forEach(name => {
                playerStats[name].partidos = playerMatchAppearances[name].size;
            });

            const players = Object.values(playerStats).sort((a, b) => b.gols - a.gols);

            document.getElementById('comparisonTable').innerHTML = `
                <thead>
                    <tr>
                        <th>N¬∫</th>
                        <th>Jugador</th>
                        <th>Partidos</th>
                        <th>Goles</th>
                        <th>H+</th>
                        <th>Penalty</th>
                        <th>Contra</th>
                        <th>Boya</th>
                        <th>Normal</th>
                        <th>Exclusiones</th>
                        <th>Media Goles/P</th>
                    </tr>
                </thead>
                <tbody>
                    ${players.map(p => `
                        <tr>
                            <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                            <td><strong>${p.name}</strong></td>
                            <td>${p.partidos}</td>
                            <td><strong style="color: #fde047;">${p.gols}</strong></td>
                            <td>${p.goalTypes['h+'] || 0}</td>
                            <td>${p.goalTypes.penalty || 0}</td>
                            <td>${p.goalTypes.contra || 0}</td>
                            <td>${p.goalTypes.boya || 0}</td>
                            <td>${p.goalTypes.normal || 0}</td>
                            <td>${p.exclusions}</td>
                            <td>${p.partidos > 0 ? (p.gols / p.partidos).toFixed(1) : '0.0'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // Top goleadores hist√≥ricos
            const topScorers = Object.values(playerStats)
                .filter(p => p.gols > 0)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 10);

            document.getElementById('allTimeScorers').innerHTML = topScorers.map((p, i) => {
                let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `
                    <div class="top-scorer-item">
                        <div class="player-info">
                            <div class="rank ${rankClass}">${i + 1}</div>
                            <div class="player-num">${p.num}</div>
                            <div class="player-name">${p.name}</div>
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                            ${p.gols} ‚öΩ
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayTitularStats() {
            const container = document.getElementById('titularView');
            
            if (allMatches.length === 0) {
                container.innerHTML = '<div class="no-data">No hay partidos cargados</div>';
                return;
            }

            const titularStats = {};
            
            allMatches.forEach(match => {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                quarters.forEach(q => {
                    const lineup = match.lineups[q] || [];
                    lineup.forEach(playerNum => {
                        // Encontrar el jugador por n√∫mero en este partido espec√≠fico
                        const player = match.jugadors.find(j => j.numero === playerNum);
                        if (player) {
                            const playerName = player.nom.trim();
                            
                            if (!titularStats[playerName]) {
                                titularStats[playerName] = {
                                    num: player.numero,
                                    name: playerName,
                                    q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                                };
                            }
                            
                            // Actualizar el n√∫mero (puede cambiar entre partidos)
                            titularStats[playerName].num = player.numero;
                            titularStats[playerName][q]++;
                            titularStats[playerName].total++;
                        }
                    });
                });
            });

            const players = Object.values(titularStats).sort((a, b) => b.total - a.total);

            container.innerHTML = `
                <h2 class="section-title">Veces como Titular por Cuarto</h2>
                <p style="margin-bottom: 15px; color: #bae6fd; font-size: 14px;">
                    Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''}
                </p>
                <div class="titular-stats">
                    ${players.map(p => `
                        <div class="titular-item">
                            <div class="titular-header">
                                <div class="player-num">${p.num}</div>
                                <div style="flex: 1;">
                                    <div class="player-name">${p.name}</div>
                                    <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                        Total: <span class="total-badge">${p.total}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="titular-quarters">
                                <div class="quarter-badge">1Q: ${p.q1}</div>
                                <div class="quarter-badge">2Q: ${p.q2}</div>
                                <div class="quarter-badge">3Q: ${p.q3}</div>
                                <div class="quarter-badge">4Q: ${p.q4}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>
</html>