<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://clubnatacioterrassa.cat/wp-content/uploads/CNT_Escut_Blau.png.webp" type="image/webp">
	<title>Visualizador de Estadísticas - CN Terrassa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        /* Ajustes específicos para gráficos en móvil */
@media (max-width: 768px) {
    /* Gráfico de Heatmap de Titularidades */
    #titularityHeatmapChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
   #totalTimeChart {
        min-height: 500px !important;
        max-height: 700px !important;
    } 
    /* Gráfico de Consistencia */
    #consistencyChart {
        min-height: 400px !important;
        max-height: 600px !important;
    }
    
    /* Contenedores de canvas para gráficos horizontales */
    .card canvas[id$="Chart"] {
        min-height: 300px !important;
    }
}
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 12px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .tabs { gap: 8px; padding: 8px; }
            .tab { 
                padding: 10px 8px; 
                font-size: 13px;
                min-width: 100px;
            }
        }
        .tab.active { background: #06b6d4; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .team-score { text-align: center; }
        .team-name { font-size: 24px; font-weight: bold; color: #67e8f9; margin-bottom: 10px; }
        .score { font-size: 64px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .separator { font-size: 48px; font-weight: bold; color: #67e8f9; }
        
        @media (max-width: 768px) {
            .scoreboard { gap: 15px; padding: 15px; }
            .team-name { font-size: 18px; }
            .score { font-size: 48px; }
            .separator { font-size: 36px; }
        }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #22d3ee; }
        .periods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .period-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .period-label { font-size: 14px; color: #bae6fd; margin-bottom: 8px; }
        .period-score { font-size: 32px; font-weight: bold; color: #fde047; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        .player-stat {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .player-stat {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            .player-info { margin-bottom: 8px; }
        }
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.stats-table th,
.stats-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.stats-table th {
    background: rgba(6, 182, 212, 0.3);
    font-weight: bold;
    color: white;
}

.stats-table td {
    color: white;
}

.stats-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-num {
            background: #06b6d4;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .player-num.rival { background: #ef4444; }
        .player-name { font-weight: 600; }
        .player-stats { display: flex; gap: 15px; font-size: 18px; font-weight: bold; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #bae6fd; }
        .stat-value { color: #fde047; }
        .lineup-section { margin-bottom: 20px; }
        .lineup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .lineup-player {
            background: rgba(34, 197, 94, 0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid #22c55e;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .info-value { font-size: 18px; font-weight: bold; }
        .observations {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .btn {
            padding: 12px 24px;
            background: #06b6d4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #0891b2; }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #bae6fd;
        }
        .hidden { display: none; }
        .top-scorers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .top-scorer-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rank {
            background: #fbbf24;
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .rank.gold { background: #fbbf24; }
        .rank.silver { background: #d1d5db; }
        .rank.bronze { background: #d97706; }
        .matches-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .match-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            gap: 15px;
            flex-wrap: wrap;
        }
        .match-item:hover { background: rgba(0,0,0,0.3); }
        .match-info { flex: 1; min-width: 200px; }
        
        @media (max-width: 768px) {
            .match-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
            }
            .match-info { width: 100%; }
            .match-score { margin: 10px 0 0 0 !important; }
        }
        .match-date { font-size: 12px; color: #bae6fd; margin-bottom: 5px; }
        .match-teams { font-size: 16px; font-weight: bold; }
        .match-score { font-size: 24px; font-weight: bold; color: #fde047; margin: 0 15px; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .comparison-table th {
            background: rgba(0,0,0,0.3);
            color: #22d3ee;
            font-weight: bold;
        }
        .comparison-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
            }
        }
        .win { color: #22c55e; font-weight: bold; }
        .loss { color: #ef4444; font-weight: bold; }
        .draw { color: #fbbf24; font-weight: bold; }
        .titular-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .titular-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            canvas {
                max-height: 250px !important;
            }
        }
        .titular-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .titular-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .titular-quarters {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
		.match-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    padding: 20px;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
}

.team-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.goal-zone-heatmap {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    max-width: 300px;
    margin: 0 auto;
    background: rgba(0, 0, 0, 0.2);
    padding: 10px;
    border-radius: 8px;
}

.goal-zone-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    font-size: 16px;
    font-weight: bold;
    transition: transform 0.2s;
}

.goal-zone-cell:hover {
    transform: scale(1.05);
    border-color: #22d3ee;
}

.zone-label {
    font-size: 9px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 2px;
}

.zone-count {
    font-size: 18px;
    color: white;
}

.individual-zone-card {
    background: rgba(0, 0, 0, 0.2);
    padding: 12px;
    border-radius: 8px;
}

.individual-zone-card .player-name {
    font-size: 12px;
    font-weight: bold;
    color: #22d3ee;
    margin-bottom: 8px;
    text-align: center;
}

.individual-zone-card .goal-zone-heatmap {
    max-width: 180px;
}

.individual-zone-card .zone-count {
    font-size: 14px;
}
.team-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: bold;
}

.score {
    font-size: 48px;
    font-weight: bold;
    color: #fde047;
}

.vs {
    font-size: 24px;
    font-weight: bold;
    color: rgba(255,255,255,0.6);
}
        .quarter-badge {
            background: rgba(6, 182, 212, 0.3);
            border: 2px solid #06b6d4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .total-badge {
            background: #fbbf24;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #22d3ee;
        }
        .filter-bar {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-bar {
                padding: 12px;
                gap: 10px;
            }
            .filter-item { width: 100%; }
            .filter-input { width: 100%; }
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 12px;
            color: #bae6fd;
        }
        .filter-input {
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    color: white;
    font-size: 14px;
}
.timeline {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.timeline-item {
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 8px;
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
}
.timeline-item.water-change {
    border-left-color: #06b6d4;
}

.timeline-item.goal {
    border-left-color: #22c55e;
}

.timeline-item.exclusion {
    border-left-color: #f97316;
}

.timeline-item.penalty-missed {
    border-left-color: #ef4444;
}

.timeline-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}

.timeline-player {
    font-weight: bold;
    color: #22d3ee;
}

.timeline-detail {
    font-size: 12px;
    color: #bae6fd;
    margin-top: 2px;
}

.timeline-quarter {
    background: rgba(6, 182, 212, 0.3);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #67e8f9;
    font-weight: bold;
    border: 1px solid #22d3ee;
    flex-shrink: 0;
}

.timeline-rival {
    color: #fca5a5;
}

.no-timeline {
    text-align: center;
    padding: 40px 20px;
    color: #bae6fd;
    font-size: 14px;
}
.filter-input:focus {
    outline: none;
    border-color: #22d3ee;
}
.filter-input option {
    background: #1e3a8a;
    color: white;
}
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .stats-breakdown {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }
        }
        .breakdown-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .breakdown-label {
            font-size: 11px;
            color: #bae6fd;
            margin-bottom: 5px;
        }
        .breakdown-value {
            font-size: 20px;
            font-weight: bold;
            color: #fde047;
        }
		@media print {
    /* Ocultar elements que no vols imprimir */
    .btn, .filter-bar, .tabs {
        display: none !important;
    }
    
    /* Ajustar mides per impressió */
    body {
        background: white;
    }
    
    .card {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
    </style>
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-D460QXC8C3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-D460QXC8C3');
</script>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
    <div style="position: absolute; top: 0; right: 0; font-size: 12px; color: rgba(255,255,255,0.6); font-style: italic;">
        by Josep Rico
    </div>
    <h1>📊 Estadísticas CN Terrassa</h1>
    <p>Cadet 25/26</p>
</div>

        <!-- TABS SIEMPRE VISIBLES -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('list')">📋 Lista de Partidos</button>
            <button class="tab" onclick="showTab('comparison')">📊 Comparación</button>
            <button class="tab" onclick="showTab('titular')">👥 Titularidad</button>
			<button class="tab" onclick="showTab('tiempo')">⏱️ Tiempo de Juego</button>
        </div>
        </div>

        <!-- TAB: LISTA DE PARTIDOS -->
        <div id="listTab">
            <div id="loadingMatches" class="loading">
                Cargando partidos...
            </div>

            <div id="matchesView" class="hidden">
                <div class="card">
                    <div class="filter-bar">
                        <div class="filter-item">
                            <label class="filter-label">Buscar rival</label>
                            <input type="text" class="filter-input" id="filterRival" placeholder="Nombre del rival..." onkeyup="filterMatches()">
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Resultado</label>
                            <select class="filter-input" id="filterResult" onchange="filterMatches()">
                                <option value="">Todos</option>
                                <option value="win">Victorias</option>
                                <option value="loss">Derrotas</option>
                                <option value="draw">Empates</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label class="filter-label">Ordenar por</label>
                            <select class="filter-input" id="sortBy" onchange="filterMatches()">
                                <option value="date-desc">Fecha (más reciente)</option>
                                <option value="date-asc">Fecha (más antiguo)</option>
                                <option value="score-desc">Más goles</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Partidos Disponibles</h2>
                    <div class="matches-list" id="availableMatches"></div>
                </div>
            </div>
	</div>
<!-- TAB: TIEMPO DE JUEGO -->
<div id="tiempoTab" class="hidden">
 <!--
 <div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTimePDF()" style="background: #8b5cf6; padding: 12px 20px;">
            📄 Generar PDF Temps de Joc
        </button>
    </div>
	-->
	<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            🖨️ Imprimir / Exportar PDF
        </button>
    </div>
    <!-- Filtro por jugador -->
    <div class="card">
        <div class="filter-bar">
            <div class="filter-item">
                <label class="filter-label">Filtrar por jugador</label>
                <select class="filter-input" id="filterPlayerTime" onchange="filterByPlayerTime()">
                    <option value="">Todos los jugadores</option>
                </select>
            </div>
            <button class="btn" onclick="clearPlayerTimeFilter()" style="margin-top: 20px;">Limpiar filtro</button>
        </div>
    </div>

    <!-- Estadísticas individuales del jugador seleccionado -->
    <div id="playerTimeStatsCard" class="card hidden">
        <h2 class="section-title">⏱️ Estadísticas de Tiempo - <span id="selectedPlayerTimeName"></span></h2>
        <div class="info-grid" id="playerTimeSummaryGrid"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">📈 Evolución del Tiempo por Partido</h3>
        <canvas id="playerTimeEvolutionChart" style="max-height: 300px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">🔥 Tiempo por Cuarto (Todos los Partidos)</h3>
        <canvas id="playerTimeByQuarterChart" style="max-height: 250px;"></canvas>
        
        <h3 class="section-title" style="margin-top: 20px;">⚡ Eficiencia por Minuto</h3>
        <div class="stats-breakdown" id="playerEfficiencyBreakdown"></div>
        
        <h3 class="section-title" style="margin-top: 20px;">📊 Rendimiento: Titular vs Suplente</h3>
        <div class="info-grid" id="playerTitularVsSuplenteGrid"></div>
    </div>

    <!-- Separador -->
    <div style="margin: 40px 0 30px 0; text-align: center;">
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
        <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
            📊 Estadísticas del Equipo
        </h2>
        <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
    </div>

    <!-- 1. Tiempo Total por Jugador -->
    <div class="card">
        <h2 class="section-title">📊 Tiempo Total Jugado por Jugador</h2>
        <p id="timeChartSubtitle" style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Cargando...
        </p>
        <canvas id="totalTimeChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 2. Heatmap de Tiempo por Cuarto -->
    <div class="card">
        <h2 class="section-title">🔥 Heatmap: Tiempo por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="timeHeatmapTable"></table>
        </div>
    </div>

  
    <!-- 4. Distribución de Minutos (Pastel) -->
    <div class="card">
        <h2 class="section-title">🥧 Distribución de Minutos del Equipo</h2>
        <canvas id="minutesDistributionChart" style="max-height: 350px;"></canvas>
    </div>

    <!-- 5. Plus/Minus por Jugador -->
    <div class="card">
        <h2 class="section-title">📈 Plus/Minus cuando está en el Agua</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Diferencia de goles (a favor - en contra) cuando el jugador está jugando
        </p>
        <canvas id="plusMinusChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 6. Balance de Carga -->
    <div class="card">
        <h2 class="section-title">⚖️ Balance de Carga del Equipo</h2>
        <div class="info-grid" id="loadBalanceGrid"></div>
        <canvas id="loadBalanceChart" style="max-height: 250px; margin-top: 20px;"></canvas>
    </div>

    <!-- 7. Análisis por Cuarto -->
    <div class="card">
        <h2 class="section-title">📊 Análisis de Rotación por Cuarto</h2>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="quarterAnalysisTable"></table>
        </div>
    </div>

    <!-- 8. Rendimiento vs Tiempo (Dispersión) -->
    <div class="card">
        <h2 class="section-title">🎯 Rendimiento del Equipo vs Tiempo Jugado</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¿El equipo rinde mejor cuando ciertos jugadores juegan más?
        </p>
        <canvas id="performanceVsTimeChart" style="max-height: 400px;"></canvas>
    </div>

    <!-- 9. Análisis de Fatiga -->
    <div class="card">
        <h2 class="section-title">😓 Análisis de Fatiga</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Comparación de rendimiento: Primer cuarto vs Último cuarto
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="fatigueAnalysisTable"></table>
        </div>
    </div>

    <!-- 10. Promedio de Rotación -->
    <div class="card">
        <h2 class="section-title">🔄 Estadísticas de Rotación</h2>
        <div class="info-grid" id="rotationStatsGrid"></div>
    </div>
</div>
         
		   <!-- Vista de partido individual -->
            <div id="singleMatchView" class="hidden">
                <div class="card">
                    <button class="btn" onclick="backToList()" style="margin-bottom: 20px;">← Volver a la lista</button>
  <!--  <button class="btn" onclick="generateMatchPDF(currentMatch)" style="background: #8b5cf6; padding: 12px 20px; margin-bottom: 15px;">
            📄 Generar PDF d'aquest Partit
        </button>-->
		
		<button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
    🖨️ Imprimir / Exportar PDF
</button>
    <div class="card">
        <div class="match-header">
            <div class="team-section">
                <h2>CN Terrassa</h2>
                <div class="score" id="scoreCNT">0</div>
            </div>
            <div class="vs">VS</div>
            <div class="team-section">
                <h2 id="teamRival">RIVAL</h2>
                <div class="score" id="scoreRival">0</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">ℹ️ Información del Partido</h2>
        <div id="matchInfo"></div>
    </div>

    <div class="card">
        <h2 class="section-title">⚽ Desglose de Goles CN Terrassa</h2>
        <div class="stats-breakdown" id="goalsScoredBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">🥅 Desglose de Goles Recibidos</h2>
        <div class="stats-breakdown" id="goalsReceivedBreakdown"></div>
    </div>

    <div class="card">
        <h2 class="section-title">🟥 Desglose de Exclusiones</h2>
        <div class="stats-breakdown" id="exclusionsBreakdown"></div>
    </div>
	
                    
    <div class="card">
    <h2 class="section-title">📊 Estadísticas Completas del Partido</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="singleMatchStatsTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
    <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">⭐ Criteris de Valoració MVP</h3>
    <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
        <strong style="color: #22c55e;">Accions Positives:</strong><br>
        • Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
        • Assistència: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
        <strong style="color: #ef4444;">Accions Negatives:</strong><br>
        • Exclusió (normal o penalty): -1 | Penalty fallat: -2 | Pèrdua: -0.5 | Tir fallat: -0.5 | Gol rebut (porters): -0.5
    </div>
</div>
</div>

                
                <div class="card">
                    <h2 class="section-title">📈 Evolución del Marcador por Cuartos</h2>
                    <canvas id="scoreEvolutionChart" style="max-height: 300px;"></canvas>
                </div>
    <div class="card">
                    <h2 class="section-title">Alineaciones por Cuarto</h2>
                    <div id="lineupsContainer"></div>
                </div>
               
                <div class="card">
                    <h2 class="section-title">⚖️ Balance Ofensivo vs Defensivo</h2>
                    <canvas id="offenseDefenseChart" style="max-height: 300px;"></canvas>
                </div>

                <div class="card">
                    <h2 class="section-title">👥 Eficiencia por Jugador (Goles vs Exclusiones)</h2>
                    <canvas id="playerEfficiencyChart" style="max-height: 350px;"></canvas>
                </div>

                 <div class="card">
                    <h2 class="section-title">Estadísticas CN Terrassa</h2>
                    <div class="stats-grid" id="statsCNT"></div>
                </div>

                <div class="card">
                    <h2 class="section-title">Estadísticas Rival</h2>
                    <div class="stats-grid" id="statsRival"></div>
                </div>
<div class="card">
    <h2 class="section-title">⏱️ Temps de Joc per Jugador</h2>
    <div id="playingTimesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">🧤 Parades dels Porters</h2>
    <canvas id="goalkeeperSavesChart" style="max-height: 300px;"></canvas>
</div>
            

                <div class="card">
                    <h2 class="section-title">Observaciones</h2>
                    <div class="observations" id="observations">No hay observaciones</div>
                </div>
				<div class="card">
    <h2 class="section-title">🎯 Zones de Porteria CN Terrassa</h2>
    <div id="matchGoalZonesContainer"></div>
</div>  
<div class="card" id="swimRacesCard" style="display: none;">
    <h2 class="section-title">🏊 Curses Inicials</h2>
    <div id="matchSwimRacesContainer"></div>
</div>
<div class="card">
    <h2 class="section-title">📋 Cronología del Partido</h2>
    <div id="matchTimeline"></div>
</div>
            </div>
        </div>

      <!-- TAB: COMPARACIÓN -->
<div id="comparisonTab" class="hidden">
    <div id="comparisonView">
	<!--<div style="margin-bottom: 20px;">
            <button class="btn" onclick="generateGeneralPDF()" style="background: #8b5cf6; padding: 12px 20px;">
                📄 Generar PDF General
            </button>
        </div>-->
        <div style="margin-bottom: 20px;">
            <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
                🖨️ Imprimir / Exportar PDF
            </button>
        </div>
        <div class="card">
            <div class="filter-bar">
                <div class="filter-item">
                    <label class="filter-label">Filtrar por jugador</label>
                    <select class="filter-input" id="filterPlayer" onchange="filterByPlayer()">
                        <option value="">Todos los jugadores</option>
                    </select>
                </div>
                <button class="btn" onclick="clearPlayerFilter()" style="margin-top: 20px;">Limpiar filtro</button>
            </div>
        </div>

        <div id="playerStatsCard" class="card hidden">
            <h2 class="section-title">📊 Estadísticas de <span id="selectedPlayerName"></span></h2>
            <div class="info-grid" id="playerSummaryGrid"></div>
            
            <h3 class="section-title" style="margin-top: 20px;">📈 Evolución por Partido</h3>
            <canvas id="playerEvolutionChart" style="max-height: 300px;"></canvas>
            
            <h3 class="section-title" style="margin-top: 20px;">⚽ Desglose de Goles</h3>
            <div class="stats-breakdown" id="playerGoalsBreakdown"></div>
			
			<div id="playerGoalZonesContainer"></div>
<div id="goalkeeperReceivedZonesContainer"></div>
            
            <h3 class="section-title" style="margin-top: 20px;">🟥 Exclusiones por Partido</h3>
            <canvas id="playerExclusionsChart" style="max-height: 250px;"></canvas>
        </div>

       
		

        <!-- Separador entre estadísticas individuales y de equipo -->
        <div style="margin: 40px 0 30px 0; text-align: center;">
            <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-bottom: 15px;"></div>
            <h2 style="font-size: 28px; font-weight: bold; color: #22d3ee; text-transform: uppercase; letter-spacing: 2px;">
                📊 Estadísticas del Equipo
            </h2>
            <div style="height: 3px; background: linear-gradient(to right, transparent, #22d3ee, transparent); margin-top: 15px;"></div>
        </div>
		 <div class="card">
            <h2 class="section-title">Resumen de Resultados</h2>
            <div class="info-grid" id="summaryGrid"></div>
        </div>
		<!-- NUEVO: Evolución de Resultados -->
        <div class="card">
            <h2 class="section-title">📈 Evolución de Resultados</h2>
            <canvas id="resultsEvolutionChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- NUEVO: Diferencia de Goles por Cuarto -->
        <div class="card">
            <h2 class="section-title">⚡ Diferencia de Goles por Cuarto</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                Promedio de diferencia (Goles a favor - Goles en contra) en cada cuarto
            </p>
            <canvas id="quarterDifferenceChart" style="max-height: 250px;"></canvas>
        </div>

        <!-- NUEVO: Mejores y Peores Partidos -->
        <div class="card">
            <h2 class="section-title">🏆 Mejores y Peores Partidos</h2>
            <div class="info-grid" id="bestWorstGrid"></div>
        </div>

        <!-- NUEVO: Historial contra Rivales -->
        <div class="card">
            <h2 class="section-title">🎯 Historial contra Rivales</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table" id="rivalsHistoryTable"></table>
            </div>
        </div>
        <div class="card">
            <h2 class="section-title">Desglose de Goles (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Goles Recibidos (Total)</h2>
            <div class="stats-breakdown" id="totalGoalsReceivedBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">Desglose de Exclusiones (Total)</h2>
            <div class="stats-breakdown" id="totalExclusionsBreakdown"></div>
        </div>

        <div class="card">
            <h2 class="section-title">🥧 Distribución de Goles por Jugador</h2>
            <canvas id="goalsDistributionChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
    <h2 class="section-title">📊 Comparación de Estadísticas</h2>
    <div style="overflow-x: auto;">
        <table class="comparison-table" id="comparisonTable"></table>
    </div>
    <div style="margin-top: 20px; padding: 15px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; border-left: 4px solid #22d3ee;">
    <h3 style="color: #22d3ee; margin-bottom: 10px; font-size: 14px;">⭐ Criteris de Valoració MVP</h3>
    <div style="font-size: 12px; color: #bae6fd; line-height: 1.8;">
        <strong style="color: #22c55e;">Accions Positives:</strong><br>
        • Gol normal/contraatac/H+/boya: +2 | Gol penalty: +1<br>
        • Assistència: +1 | Robatori: +1 | Blocatge: +1 | Parada: +1 | Parada penal: +2 | Falta rebuda: +1<br><br>
        <strong style="color: #ef4444;">Accions Negatives:</strong><br>
        • Exclusió (normal o penalty): -1 | Penalty fallat: -2 | Pèrdua: -0.5 | Tir fallat: -0.5 | Gol rebut (porters): -0.5
    </div>
</div>
</div>

        <div class="card">
            <h2 class="section-title">Top Goleadores (Todos los Partidos)</h2>
            <div class="top-scorers" id="allTimeScorers"></div>
        </div>
		<div id="swimRacesStatsContainer"></div>
    </div>
    </div>
	
</div>

        <!-- TAB: TITULARIDAD -->
<!-- TAB: TITULARIDAD -->
<div id="titularTab" class="hidden">
<!--<div style="margin-bottom: 20px;">
        <button class="btn" onclick="generateTitularityPDF()" style="background: #8b5cf6; padding: 12px 20px;">
            📄 Generar PDF Titularitats
        </button>
    </div>-->
	<div style="margin-bottom: 20px;">
        <button class="btn" onclick="window.print()" style="background: #8b5cf6; padding: 12px 20px;">
            🖨️ Imprimir / Exportar PDF
        </button>
    </div>
    <div class="card">
        <h2 class="section-title">🔥 Heatmap de Titularidades</h2>
        <canvas id="titularityHeatmapChart" style="max-height: 400px;"></canvas>
    </div>
    
    <!-- Consistencia de Titularidad -->
    <div class="card">
        <h2 class="section-title">📊 Consistencia de Titularidad</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Porcentaje de cuartos en los que cada jugador fue titular
        </p>
        <canvas id="consistencyChart" style="max-height: 350px;"></canvas>
    </div>
    
    <!-- Rendimiento según Titularidad -->
    <div class="card">
        <h2 class="section-title">⚡ Rendimiento: Titular vs Suplente</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Media de goles y exclusiones cuando son titulares vs suplentes
        </p>
        <div style="overflow-x: auto;">
            <table class="comparison-table" id="performanceTable"></table>
        </div>
    </div>
    
    <div class="card">
        <div id="titularView"></div>
    </div>
    
    <!-- Patrones por Cuarto - MOVIDO AL FINAL -->
    <div class="card">
        <h2 class="section-title">⏰ Patrones por Cuarto</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            ¿En qué cuarto es más titular cada jugador?
        </p>
        <div id="quarterPatternsGrid" class="stats-grid"></div>
    </div>
</div>

    <script>
        let allMatches = [];
        let filteredMatches = [];
        let currentMatch = null;
		let matchesWithTime = []; 
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllMatches();
        });

  async function loadAllMatches() {
    try {
        console.log('Iniciando carga de partidos...');
        const response = await fetch('https://api.github.com/repos/joseprico/cnt_cadet_25-26/contents/');
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
        }
        
        const files = await response.json();
        console.log('Archivos encontrados:', files.length);
        
        // Filtro estricto - solo archivos con datos de tiempo
        const jsonFiles = files.filter(f => {
            if (f.type !== 'file') return false;
            if (!f.name.startsWith('cnt_stats_')) return false;
            if (!f.name.endsWith('.json')) return false;
            
            // Excluir archivos genéricos o de prueba
            if (f.name.includes('example')) return false;
            if (f.name.includes('template')) return false;
            if (f.name.includes('plantilla')) return false;
            if (f.name === 'cnt_stats_.json') return false;
            
            return true;
        });
        
        console.log('Archivos JSON de partidos:', jsonFiles.length);
        console.log('Nombres:', jsonFiles.map(f => f.name));

        if (jsonFiles.length === 0) {
            throw new Error('No se encontraron archivos de partidos (cnt_stats_*.json)');
        }

        const promises = jsonFiles.map(async file => {
            console.log('Cargando archivo:', file.name);
            const res = await fetch(file.download_url);
            if (!res.ok) {
                throw new Error(`Error cargando ${file.name}: ${res.status}`);
            }
            const matchData = await res.json();
			normalizeAllPlayers(matchData);

			// Normalitza estadístiques de tots els jugadors perquè no peti si falten camps
(matchData.data?.players || []).forEach(p => {
  p.estadistiques = p.estadistiques || {};
  p.estadistiques.paradeTypes = {
    corner: 0, rebuig: 0, atrapa: 0, penal: 0,
    ...(p.estadistiques.paradeTypes || {})
  };
});
            
            // Verificar que tiene la estructura correcta
            if (!matchData.data || !matchData.rivalTeam) {
                console.warn('Archivo con estructura incorrecta:', file.name, matchData);
            }
            
            return matchData;
        });

        allMatches = await Promise.all(promises);

// Filtrar partidos válidos con nombre de rival completo
allMatches = allMatches.filter(m => {
    // Verificar estructura básica
    if (!m || !m.data || m.scoreCNT === undefined || m.scoreRival === undefined) {
        console.warn('Partido sin estructura básica:', m);
        return false;
    }
    
    // Verificar que el nombre del rival no sea genérico
    if (!m.rivalTeam || m.rivalTeam.toLowerCase() === 'rival' || m.rivalTeam.trim() === '') {
        console.warn('Partido sin nombre de rival válido:', m.rivalTeam);
        return false;
    }
    
    // Verificar que tenga jugadores
    if (!m.jugadors || m.jugadors.length === 0) {
        console.warn('Partido sin jugadores:', m);
        return false;
    }
    
    // Verificar que tenga marcadores por periodo
    if (!m.periodScores) {
        console.warn('Partido sin marcadores por periodo:', m);
        return false;
    }
    
    return true;
});

console.log('Partidos válidos después del filtrado:', allMatches.length);
        
        console.log('Partidos válidos cargados:', allMatches.length);
        
        // Ordenar por fecha de forma más robusta
        allMatches.sort((a, b) => {
            const dateA = new Date(a.data).getTime();
            const dateB = new Date(b.data).getTime();
            return dateB - dateA; // Más reciente primero
        });
        
        filteredMatches = [...allMatches];

        document.getElementById('loadingMatches').classList.add('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
        
        displayMatchesList();
        displayComparison();
        displayTitularStats();
    } catch (error) {
        console.error('Error detallado:', error);
        document.getElementById('loadingMatches').innerHTML = `
            <div class="no-data">
                <p style="color: #ef4444; font-weight: bold;">❌ Error al cargar los partidos</p>
                <p style="font-size: 14px; margin-top: 10px; color: #fbbf24;">${error.message}</p>
                <p style="font-size: 12px; margin-top: 10px; color: #bae6fd;">
                    Verifica la consola del navegador (F12) para más detalles
                </p>
                <button class="btn" onclick="loadAllMatches()" style="margin-top: 15px;">
                    🔄 Reintentar
                </button>
            </div>
        `;
    }
}
  function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
function getQuarterRealStartTime(match, quarter) {
    // Prioritzar quarterRealStartTimes si existeix (nou sistema amb botó)
    if (match.quarterRealStartTimes && match.quarterRealStartTimes[quarter]) {
        return match.quarterRealStartTimes[quarter];
    }
    
    // Fallback: usar quarterStartTimes (sistema antic)
    return match.quarterStartTimes && match.quarterStartTimes[quarter] 
        ? match.quarterStartTimes[quarter] 
        : null;
}
function getQuarterRealStartTime(match, quarter) {
    // Buscar la primera acción REAL del cuarto (gol, exclusión, cambio de agua)
    const actions = match.chronologicalActions || [];
    const quarterActions = actions.filter(a => a.quarter === quarter);
    
    if (quarterActions.length > 0) {
        // Ordenar por timestamp y devolver el primero
        quarterActions.sort((a, b) => a.timestamp - b.timestamp);
        return quarterActions[0].timestamp;
    }
    
    // Si no hay acciones, usar quarterStartTimes como fallback
    return match.quarterStartTimes[quarter];
}
function getQuarterEndTime(match, quarter, quarterStartTime, quarterDuration) {
    if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
        return match.quarterRealEndTimes[quarter];
    }
    
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (match.quarterStartTimes[nextQuarter]) {
            return match.quarterStartTimes[nextQuarter];
        }
    }
    
    return quarterStartTime + (quarterDuration * 1000);
}
  function displayMatchesList() {
    const container = document.getElementById('availableMatches');
    
    if (filteredMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos que coincidan con los filtros</div>';
        return;
    }

    container.innerHTML = filteredMatches.map((match, idx) => {  // ✅ Usar idx del map
        const date = new Date(match.data);
        const result = match.scoreCNT > match.scoreRival ? 'win' : 
                      match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
        const resultText = result === 'win' ? '✅ Victoria' : 
                          result === 'loss' ? '❌ Derrota' : '🤝 Empate';
        const locationIcon = (match.matchLocation === 'home' || !match.matchLocation) ? '🏠' : '✈️';
        const locationText = (match.matchLocation === 'home' || !match.matchLocation) ? 'Casa' : 'Fuera';
        
        return `
            <div class="match-item" onclick="viewMatch(${idx})">  
                <div class="match-info">
                    <div class="match-date">${date.toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                    <div class="match-teams">CN Terrassa vs ${match.rivalTeam || 'Rival'} ${locationIcon}</div>
                    <div class="${result}">${resultText} • ${locationText}</div>
                </div>
                <div class="match-score">${match.scoreCNT} - ${match.scoreRival}</div>
            </div>
        `;
    }).join('');
}

        function filterMatches() {
            const rivalFilter = document.getElementById('filterRival').value.toLowerCase();
            const resultFilter = document.getElementById('filterResult').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredMatches = allMatches.filter(match => {
                const rivalMatch = !rivalFilter || (match.rivalTeam || '').toLowerCase().includes(rivalFilter);
                
                let resultMatch = true;
                if (resultFilter) {
                    const result = match.scoreCNT > match.scoreRival ? 'win' : 
                                  match.scoreCNT < match.scoreRival ? 'loss' : 'draw';
                    resultMatch = result === resultFilter;
                }

                return rivalMatch && resultMatch;
            });

            if (sortBy === 'date-desc') {
                filteredMatches.sort((a, b) => new Date(b.data) - new Date(a.data));
            } else if (sortBy === 'date-asc') {
                filteredMatches.sort((a, b) => new Date(a.data) - new Date(b.data));
            } else if (sortBy === 'score-desc') {
                filteredMatches.sort((a, b) => b.scoreCNT - a.scoreCNT);
            }

            displayMatchesList();
        }

      function viewMatch(idx) {
    currentMatch = filteredMatches[idx];  // ✅ USAR filteredMatches en lugar de allMatches
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.remove('hidden');
    displayMatchData();
}

        function backToList() {
            document.getElementById('singleMatchView').classList.add('hidden');
            document.getElementById('matchesView').classList.remove('hidden');
			const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'none';
    }
        }

   function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    // Ocultar TODOS los tabs y vistas
    document.getElementById('listTab').classList.add('hidden');
    document.getElementById('comparisonTab').classList.add('hidden');
    document.getElementById('titularTab').classList.add('hidden');
    document.getElementById('tiempoTab').classList.add('hidden');
    
    // Ocultar también las vistas internas del listTab
    document.getElementById('matchesView').classList.add('hidden');
    document.getElementById('singleMatchView').classList.add('hidden');

    if (tabName === 'list') {
        document.getElementById('listTab').classList.remove('hidden');
        document.getElementById('matchesView').classList.remove('hidden');
    } else if (tabName === 'comparison') {
        document.getElementById('comparisonTab').classList.remove('hidden');
    } else if (tabName === 'titular') {
        document.getElementById('titularTab').classList.remove('hidden');
        setTimeout(() => {
            renderTitularityHeatmapChart();
        }, 100);
    } else if (tabName === 'tiempo') {
        document.getElementById('tiempoTab').classList.remove('hidden');
        setTimeout(() => {
            displayTimeStats();
        }, 100);
    }
}

 function displayMatchData() {
    document.getElementById('scoreCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('teamRival').textContent = currentMatch.rivalTeam || 'RIVAL';
// Actualitzar també el scoreboard de dalt si existeix
if (document.getElementById('scoreboardCNT')) {
    document.getElementById('scoreboardCNT').textContent = currentMatch.scoreCNT || 0;
    document.getElementById('scoreboardRival').textContent = currentMatch.scoreRival || 0;
    document.getElementById('scoreboardRivalName').textContent = currentMatch.rivalTeam || 'RIVAL';
}
    const date = new Date(currentMatch.data);
    const locationIcon = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? '🏠' : '✈️';
    const locationText = (currentMatch.matchLocation === 'home' || !currentMatch.matchLocation) ? 'Casa' : 'Fuera';
    const totalExcCNT = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.exclusions, 0);
    const totalExcRival = currentMatch.rivalStats.reduce((sum, j) => sum + j.exclusions, 0);

    // Parades dels porters
    const totalParadesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.parades || 0);
    }, 0);
    
    // Calcular totalGoals abans d'utilitzar-lo
    const totalGoals = currentMatch.jugadors.reduce((sum, j) => sum + j.estadistiques.gols, 0);
    
    // Noves accions
    const totalAssistenciesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.assistencies || 0);
    }, 0);

    const totalRobatorisCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.robatoris || 0);
    }, 0);

    const totalPerduesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.perdues || 0);
    }, 0);

    const totalXutsFallatsCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.xutsFallats || 0);
    }, 0);
    
    const totalBlocksCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.blocks || 0);
    }, 0);

    const totalFaltesRebudesCNT = currentMatch.jugadors.reduce((sum, j) => {
        return sum + (j.estadistiques.faltesRebudes || 0);
    }, 0);
    
    // Eficiència de tir
    const totalXutsCNT = totalGoals + totalXutsFallatsCNT;
    const eficienciaTirCNT = totalXutsCNT > 0 ? ((totalGoals / totalXutsCNT) * 100).toFixed(1) : '0.0';
    
    // Conversión H+ del CNT (goles H+ CNT / exclusiones normales rival)
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes && j.estadistiques.goalTypes['h+']) {
            totalHPlusCNT += j.estadistiques.goalTypes['h+'];
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
        }
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    // Conversión H+ del Rival (goles H+ rival / exclusiones normales CNT)
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes && j.goalTypes['h+']) {
            totalHPlusRival += j.goalTypes['h+'];
        }
    });

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            totalExclusionsNoPenaltyCNT += (j.estadistiques.exclusionTypes.normal || 0);
        }
    });

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    document.getElementById('matchInfo').innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">📅 Fecha</div>
                <div class="info-value">${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
            </div>
            <div class="info-item">
                <div class="info-label">${locationIcon} Ubicación</div>
                <div class="info-value">${locationText}</div>
            </div>
            <div class="info-item">
                <div class="info-label">🟥 Exclusiones CNT</div>
                <div class="info-value">${totalExcCNT}</div>
            </div>
            <div class="info-item">
                <div class="info-label">🟥 Exclusiones Rival</div>
                <div class="info-value">${totalExcRival}</div>
            </div>
            ${totalParadesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🧤 Parades CNT</div>
                <div class="info-value" style="color: #c084fc;">${totalParadesCNT}</div>
            </div>
            ` : ''}
            <div class="info-item">
                <div class="info-label">🎯 Eficiència Tir CNT</div>
                <div class="info-value" style="color: ${eficienciaTirCNT >= 50 ? '#22c55e' : eficienciaTirCNT >= 30 ? '#fbbf24' : '#ef4444'};">${eficienciaTirCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">📊 Conversió H+ CNT</div>
                <div class="info-value">${conversionRateCNT}%</div>
            </div>
            <div class="info-item">
                <div class="info-label">📊 Conversió H+ Rival</div>
                <div class="info-value">${conversionRateRival}%</div>
            </div>
            ${totalAssistenciesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🎯 Assistències CNT</div>
                <div class="info-value" style="color: #86efac;">${totalAssistenciesCNT}</div>
            </div>
            ` : ''}
            ${totalRobatorisCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🛡️ Robatoris CNT</div>
                <div class="info-value" style="color: #7dd3fc;">${totalRobatorisCNT}</div>
            </div>
            ` : ''}
            ${totalPerduesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">❌ Pèrdues CNT</div>
                <div class="info-value" style="color: #fca5a5;">${totalPerduesCNT}</div>
            </div>
            ` : ''}
            ${totalXutsFallatsCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">🎯❌ Xuts Fallats CNT</div>
                <div class="info-value" style="color: #fb923c;">${totalXutsFallatsCNT}</div>
            </div>
            ` : ''}
            ${totalBlocksCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">✋ Blocks CNT</div>
                <div class="info-value" style="color: #a78bfa;">${totalBlocksCNT}</div>
            </div>
            ` : ''}
            ${totalFaltesRebudesCNT > 0 ? `
            <div class="info-item">
                <div class="info-label">⚠️ Faltes Rebudes</div>
                <div class="info-value" style="color: #fbbf24;">${totalFaltesRebudesCNT}</div>
            </div>
            ` : ''}
        </div>
    `;

    // Stats CNT
    document.getElementById('statsCNT').innerHTML = currentMatch.jugadors
    .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0 || 
                 (j.estadistiques.parades || 0) > 0 || (j.estadistiques.assistencies || 0) > 0 || 
                 (j.estadistiques.robatoris || 0) > 0 || (j.estadistiques.perdues || 0) > 0 || 
                 (j.estadistiques.xutsFallats || 0) > 0 || (j.estadistiques.blocks || 0) > 0 ||
                 (j.estadistiques.faltesRebudes || 0) > 0)
        .map(j => {
            const goalTypes = j.estadistiques.goalTypes || {};
            const exclusionTypes = j.estadistiques.exclusionTypes || {};
            const penaltyMissed = j.estadistiques.penaltyMissed || 0;
            const parades = j.estadistiques.parades || 0;
            const paradeTypes = j.estadistiques.paradeTypes || {};
            const assistencies = j.estadistiques.assistencies || 0;
            const robatoris = j.estadistiques.robatoris || 0;
            const perdues = j.estadistiques.perdues || 0;
            const xutsFallats = j.estadistiques.xutsFallats || 0;
            const blocks = j.estadistiques.blocks || 0;
            const faltesRebudes = j.estadistiques.faltesRebudes || 0;
            
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            
            let goalTypesText = '';
            if (goalTypes['h+']) goalTypesText += `H+:${goalTypes['h+']} `;
            if (goalTypes.penalty) goalTypesText += `P:${goalTypes.penalty} `;
            if (goalTypes.contra) goalTypesText += `C:${goalTypes.contra} `;
            if (goalTypes.boya) goalTypesText += `B:${goalTypes.boya} `;
            if (goalTypes.normal) goalTypesText += `N:${goalTypes.normal}`;
            
            let exclusionTypesText = '';
            if (exclusionTypes.normal) exclusionTypesText += `EX:${exclusionTypes.normal} `;
            if (exclusionTypes.penalty) exclusionTypesText += `P:${exclusionTypes.penalty}`;
            
            let paradeTypesText = '';
            if (paradeTypes.corner) paradeTypesText += `Corner:${paradeTypes.corner} `;
            if (paradeTypes.rebuig) paradeTypesText += `Rebuig:${paradeTypes.rebuig} `;
            if (paradeTypes.atrapa) paradeTypesText += `Atrapa:${paradeTypes.atrapa}`;
			if (paradeTypes.penal) paradeTypesText += `Penal:${paradeTypes.penal} `;
            
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${j.numero}</div>
                    <div class="player-name">${j.nom}</div>
                </div>
                <div class="player-stats">
                    ${j.estadistiques.gols > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.estadistiques.gols}</div>
                    </div>
                    ` : ''}
                    ${goalTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${goalTypesText}</div>
                    </div>
                    ` : ''}
                    ${j.estadistiques.exclusions > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.estadistiques.exclusions}</div>
                    </div>
                    ` : ''}
                    ${exclusionTypesText ? `
                    <div class="stat-item">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${exclusionTypesText}</div>
                    </div>
                    ` : ''}
                    ${parades > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🧤 Parades</div>
                        <div class="stat-value" style="color: #c084fc;">${parades}</div>
                    </div>
                    ` : ''}
                    ${paradeTypesText ? `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">Tipus</div>
                        <div class="stat-value" style="font-size: 11px;">${paradeTypesText}</div>
                    </div>
                    ` : ''}
                    ${assistencies > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🎯 Asist</div>
                        <div class="stat-value" style="color: #86efac;">${assistencies}</div>
                    </div>
                    ` : ''}
                    ${robatoris > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🛡️ Rob</div>
                        <div class="stat-value" style="color: #7dd3fc;">${robatoris}</div>
                    </div>
                    ` : ''}
                    ${perdues > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">❌ Pèrd</div>
                        <div class="stat-value" style="color: #fca5a5;">${perdues}</div>
                    </div>
                    ` : ''}
                    ${xutsFallats > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">🎯❌ X.F</div>
                        <div class="stat-value" style="color: #fb923c;">${xutsFallats}</div>
                    </div>
                    ` : ''}
                    ${blocks > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">✋ Block</div>
                        <div class="stat-value" style="color: #a78bfa;">${blocks}</div>
                    </div>
                    ` : ''}
                    ${faltesRebudes > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">⚠️ F.Reb</div>
                        <div class="stat-value" style="color: #fbbf24;">${faltesRebudes}</div>
                    </div>
                    ` : ''}
                    ${(j.estadistiques.gols > 0 || xutsFallats > 0) ? `
                    <div class="stat-item">
                        <div class="stat-label">Efic%</div>
                        <div class="stat-value" style="color: ${(() => {
                            const totalXuts = j.estadistiques.gols + xutsFallats;
                            const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100) : 0;
                            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                        })()};">
                            ${(() => {
                                const totalXuts = j.estadistiques.gols + xutsFallats;
                                const efic = totalXuts > 0 ? (j.estadistiques.gols / totalXuts * 100).toFixed(0) : 0;
                                return efic + '%';
                            })()}
                        </div>
                    </div>
                    ` : ''}
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');

    // Stats Rival
    const rivalPlayers = currentMatch.rivalStats.filter(p => p.name || p.gols > 0 || p.exclusions > 0);
    document.getElementById('statsRival').innerHTML = rivalPlayers.length === 0 ? '<p>No hay estadísticas del rival</p>' :
        rivalPlayers.map(j => {
            const penaltyMissed = j.penaltyMissed || 0;
            return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num rival">${j.num}</div>
                    <div class="player-name">${j.name || 'Jugador ' + j.num}</div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-label">Gols</div>
                        <div class="stat-value">${j.gols}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Exc</div>
                        <div class="stat-value">${j.exclusions}</div>
                    </div>
                    ${penaltyMissed > 0 ? `
                    <div class="stat-item">
                        <div class="stat-label">Pen.F</div>
                        <div class="stat-value" style="color: #ef4444;">${penaltyMissed}</div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `}).join('');

    // Alineaciones
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    document.getElementById('lineupsContainer').innerHTML = quarters.map((q, i) => {
        const lineup = currentMatch.lineups[q] || [];
        if (lineup.length === 0) return '';

        const players = lineup.map(num => {
            const player = currentMatch.jugadors.find(j => j.numero === num);
            return player ? `${player.numero}. ${player.nom.split(' ')[0]}` : num;
        }).join(', ');

        const score = currentMatch.periodScores[q];
        return `
            <div class="period-row">
                <div class="period-label">${labels[i]}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">${players}</div>
                <div class="period-score">${score.cnt} - ${score.rival}</div>
            </div>
        `;
    }).join('');

    // Desglose de tipos de goles
    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };

    const cntGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.goalTypes) {
            Object.keys(cntGoalStats).forEach(type => {
                cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsScoredBreakdown').innerHTML = Object.keys(cntGoalStats)
        .filter(type => cntGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${cntGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const rivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    currentMatch.rivalStats.forEach(j => {
        if (j.goalTypes) {
            Object.keys(rivalGoalStats).forEach(type => {
                rivalGoalStats[type] += j.goalTypes[type] || 0;
            });
        }
    });

    document.getElementById('goalsReceivedBreakdown').innerHTML = Object.keys(rivalGoalStats)
        .filter(type => rivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${rivalGoalStats[type]}</div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    // Desglose de exclusiones
    const excStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    currentMatch.jugadors.forEach(j => {
        if (j.estadistiques.exclusionTypes) {
            excStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
            excStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
        }
    });

    currentMatch.rivalStats.forEach(j => {
        if (j.exclusionTypes) {
            excStats.rival.normal += j.exclusionTypes.normal || 0;
            excStats.rival.penalty += j.exclusionTypes.penalty || 0;
        }
    });

    document.getElementById('exclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${excStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penalty</div>
            <div class="breakdown-value">${excStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${excStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penalty</div>
            <div class="breakdown-value">${excStats.rival.penalty}</div>
        </div>
    `;
	


    document.getElementById('observations').textContent = currentMatch.observacions || 'No hay observaciones';

    
// ============ MVP DEL PARTIT ============
const playersWithValue = currentMatch.jugadors.map(j => {
    const valor = calculatePlayerValue({
        gols: j.estadistiques.gols,
        goalTypes: j.estadistiques.goalTypes,
        assistencies: j.estadistiques.assistencies,
        robatoris: j.estadistiques.robatoris,
        blocatges: j.estadistiques.blocks || 0,
        parades: j.estadistiques.parades,
        faltesRebudes: j.estadistiques.faltesRebudes || 0,
        exclusions: j.estadistiques.exclusions,
        exclusionTypes: j.estadistiques.exclusionTypes || { normal: 0, penalty: 0 },
        penaltyMissed: j.estadistiques.penaltyMissed,
        perdues: j.estadistiques.perdues,
        xutsFallats: j.estadistiques.xutsFallats,
        golsRebuts: 0
    });
    return { ...j, valor };
}).sort((a, b) => b.valor - a.valor);

const mvp = playersWithValue[0];
const top3 = playersWithValue.slice(0, 3);

document.getElementById('matchInfo').insertAdjacentHTML('afterend', `
    <div class="card" style="margin-top: 20px;">
        <h2 class="section-title">🏆 MVP del Partit</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
            ${top3.map((player, index) => {
                const medals = ['🥇', '🥈', '🥉'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 3px solid ${borderColors[index]}; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 36px;">
                            ${medals[index]}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: 40px; height: 40px; font-size: 18px;">${player.numero}</div>
                            <div>
                                <div style="font-weight: bold; font-size: 16px; color: ${colors[index]};">${player.nom}</div>
                                <div style="font-size: 12px; color: #bae6fd;">Valoració: ${player.valor.toFixed(1)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                            ${player.estadistiques.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold;">${player.estadistiques.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold;">${player.estadistiques.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Robatoris</div>
                                    <div style="color: #3b82f6; font-weight: bold;">${player.estadistiques.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold;">${player.estadistiques.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.estadistiques.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Faltes R.</div>
                                    <div style="color: #fbbf24; font-weight: bold;">${player.estadistiques.faltesRebudes}</div>
                                </div>
                            ` : ''}
                            ${player.estadistiques.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold;">${player.estadistiques.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    </div>
`);


	// Generar gráficas
    renderScoreEvolutionChart();
    renderOffenseDefenseChart();
    renderPlayerEfficiencyChart();
    renderMatchTimeline();
    renderSingleMatchStatsTable();
    renderPlayingTimes();
    renderMatchGoalZones();
    
    // ✅ AFEGIR AQUÍ les zones de gols rebuts pels porters
    
    // Zones de Porteria dels Porters (només per aquest partit)
    const matchGoalkeeperZones = {
        1: { num: 1, name: 'MAX VALLS', totalGolsRebuts: 0, zones: {} },
        13: { num: 13, name: 'ERIC MORA', totalGolsRebuts: 0, zones: {} }
    };
    
    // Inicialitzar zones
    [1, 13].forEach(gkNum => {
        matchGoalkeeperZones[gkNum].zones = {
            'top-left': 0, 'top-center': 0, 'top-right': 0,
            'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
            'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
            'unknown': 0
        };
    });
    
    // Calcular zones dels gols rebuts en aquest partit
    currentMatch.jugadors.forEach(j => {
        if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
            Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                const count = j.estadistiques.golsRebutsZones[zone] || 0;
                matchGoalkeeperZones[j.numero].zones[zone] += count;
                matchGoalkeeperZones[j.numero].totalGolsRebuts += count;
            });
        }
    });
    
    // Només mostrar si hi ha dades
    const hasGoalkeeperData = matchGoalkeeperZones[1].totalGolsRebuts > 0 || 
                              matchGoalkeeperZones[13].totalGolsRebuts > 0;
    
    if (hasGoalkeeperData) {
        const matchGkZonesHTML = `
            <div class="card" id="goalkeeperZonesCard">
                <h2 class="section-title">🧤 Zones de Gols Rebuts pels Porters</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${[1, 13].map(gkNum => {
                        const gk = matchGoalkeeperZones[gkNum];
                        if (gk.totalGolsRebuts === 0) return '';
                        
                        const zoneOrder = [
                            'top-left', 'top-center', 'top-right',
                            'mid-left', 'mid-center', 'mid-right',
                            'bottom-left', 'bottom-center', 'bottom-right'
                        ];
                        
                        const zoneLabels = {
                            'top-left': '⬆️E',
                            'top-center': '⬆️C',
                            'top-right': '⬆️D',
                            'mid-left': '➡️E',
                            'mid-center': '🎯',
                            'mid-right': '⬅️D',
                            'bottom-left': '⬇️E',
                            'bottom-center': '⬇️B',
                            'bottom-right': '⬇️D'
                        };
                        
                        const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                        
                        // Trobar zona més feble
                        const weakestZone = zoneOrder.reduce((max, zone) => 
                            (gk.zones[zone] || 0) > (gk.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const weakestZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[weakestZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${gk.num}. ${gk.name.split(' ')[0]}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${gk.totalGolsRebuts} gols rebuts
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 200px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = gk.zones[zone] || 0;
                                        const percentage = gk.totalGolsRebuts > 0 ? 
                                            ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabels[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${gk.zones[weakestZone] > 0 ? `
                                    <div style="text-align: center; margin-top: 10px; font-size: 10px; color: #fca5a5;">
                                        ⚠️ Zona més vulnerable: ${weakestZoneLabel} (${gk.zones[weakestZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        // ✅ Inserir DESPRÉS del segon card de zones (el que té id matchGoalZonesContainer)
        // Buscar tots els cards amb zones
        const allCards = document.querySelectorAll('.card');
        let matchZonesCard = null;
        
        allCards.forEach(card => {
            if (card.querySelector('#matchGoalZonesContainer')) {
                matchZonesCard = card;
            }
        });
        
        if (matchZonesCard) {
            // Esborrar si ja existeix
            const existingGKCard = document.getElementById('goalkeeperZonesCard');
            if (existingGKCard) {
                existingGKCard.remove();
            }
            
            matchZonesCard.insertAdjacentHTML('afterend', matchGkZonesHTML);
        }
    }
    
    const pdfButton = document.getElementById('pdfMatchButton');
    if (pdfButton) {
        pdfButton.style.display = 'inline-block';
    }
}  // ← Tancament de displayMatchData()
       

 function renderSingleMatchStatsTable() {
    const table = document.getElementById('singleMatchStatsTable');
    if (!table || !currentMatch) return;

    const players = currentMatch.jugadors.map(j => {
        const stats = j.estadistiques;
        const goles = stats.gols;
        const xutsTotal = goles + (stats.xutsFallats || 0);
        const eficiencia = xutsTotal > 0 ? ((goles / xutsTotal) * 100).toFixed(1) : '0.0';
        
        // ✅ SUMAR blocks i blocatges
        const totalBlocks = (stats.blocks || 0) + (stats.blocatges || 0);
        
        const valor = calculatePlayerValue({
            gols: stats.gols,
            goalTypes: stats.goalTypes,
            assistencies: stats.assistencies,
            robatoris: stats.robatoris,
            blocatges: totalBlocks,  // Usar el total aquí
            parades: stats.parades,
            faltesRebudes: stats.faltesRebudes || 0,
            exclusions: stats.exclusions,
            exclusionTypes: stats.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: stats.penaltyMissed,
            perdues: stats.perdues,
            xutsFallats: stats.xutsFallats
        });

        return {
            num: j.numero,
            nom: j.nom,
            gols: goles,
            hPlus: stats.goalTypes?.['h+'] || 0,
            penalty: stats.goalTypes?.penalty || 0,
            contra: stats.goalTypes?.contra || 0,
            boya: stats.goalTypes?.boya || 0,
            normal: stats.goalTypes?.normal || 0,
            exclusions: stats.exclusions,
            parades: stats.parades || 0,
            assistencies: stats.assistencies || 0,
            robatoris: stats.robatoris || 0,
            blocks: totalBlocks,  // ✅ AFEGIR AQUESTA LÍNIA
            perdues: stats.perdues || 0,
            faltesRebudes: stats.faltesRebudes || 0,
            xutsFallats: stats.xutsFallats || 0,
            penaltyMissed: stats.penaltyMissed || 0,
            eficiencia: eficiencia,
            valor: valor.toFixed(1)
        };
    }).sort((a, b) => b.valor - a.valor);

    table.innerHTML = `
        <thead>
            <tr>
                <th>Nº</th>
                <th>Jugador</th>
                <th>Gols</th>
                <th>H+</th>
                <th>Pen</th>
                <th>Con</th>
                <th>Boy</th>
                <th>Nor</th>
                <th>Exc</th>
                <th>🧤 Par</th>
                <th>🎯 Ast</th>
                <th>🛡️ Rob</th>
                <th>🚫 Blk</th>
                <th>❌ Pèr</th>
                <th>⚠️ FR</th>
                <th>Xuts</th>
                <th>PenF</th>
                <th>Efic%</th>
                <th>⭐ Valor</th>
            </tr>
        </thead>
        <tbody>
            ${players.map((p, index) => {
                // Colors per al podi
                const rankColor = index === 0 ? 'background: rgba(255, 215, 0, 0.2);' :
                                 index === 1 ? 'background: rgba(192, 192, 192, 0.2);' :
                                 index === 2 ? 'background: rgba(205, 127, 50, 0.2);' : '';
                
                return `
                    <tr style="${rankColor}">
                        <td>${p.num}</td>
                        <td><strong>${p.nom.split(' ')[0]}</strong></td>
                        <td>${p.gols}</td>
                        <td>${p.hPlus}</td>
                        <td>${p.penalty}</td>
                        <td>${p.contra}</td>
                        <td>${p.boya}</td>
                        <td>${p.normal}</td>
                        <td>${p.exclusions}</td>
                        <td>${p.parades}</td>
                        <td>${p.assistencies}</td>
                        <td>${p.robatoris}</td>
                        <td>${p.blocks}</td>
                        <td>${p.perdues}</td>
                        <td>${p.faltesRebudes}</td>
                        <td>${p.xutsFallats}</td>
                        <td>${p.penaltyMissed}</td>
                        <td>${p.eficiencia}%</td>
                        <td><strong>${p.valor}</strong></td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
 function renderScoreEvolutionChart() {
            const ctx = document.getElementById('scoreEvolutionChart');
            if (!ctx) return;
            
            if (window.scoreEvolutionChartInstance) {
                window.scoreEvolutionChartInstance.destroy();
            }
            
            const periods = ['Inicio', '1Q', '2Q', '3Q', '4Q'];
            const cntScores = [0];
            const rivalScores = [0];
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const lastCnt = cntScores[cntScores.length - 1];
                const lastRival = rivalScores[rivalScores.length - 1];
                cntScores.push(lastCnt + currentMatch.periodScores[q].cnt);
                rivalScores.push(lastRival + currentMatch.periodScores[q].rival);
            });
            
            window.scoreEvolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: periods,
                    datasets: [
                        {
                            label: 'CN Terrassa',
                            data: cntScores,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: currentMatch.rivalTeam || 'Rival',
                            data: rivalScores,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderOffenseDefenseChart() {
            const ctx = document.getElementById('offenseDefenseChart');
            if (!ctx) return;
            
            if (window.offenseDefenseChartInstance) {
                window.offenseDefenseChartInstance.destroy();
            }
            
            const cntGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            const rivalGoalStats = { 'h+': 0, 'penalty': 0, 'contra': 0, 'boya': 0, 'normal': 0 };
            
            currentMatch.jugadors.forEach(j => {
                if (j.estadistiques.goalTypes) {
                    Object.keys(cntGoalStats).forEach(type => {
                        cntGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                    });
                }
            });
            
            currentMatch.rivalStats.forEach(j => {
                if (j.goalTypes) {
                    Object.keys(rivalGoalStats).forEach(type => {
                        rivalGoalStats[type] += j.goalTypes[type] || 0;
                    });
                }
            });
            
            const labels = ['H+', 'Penalty', 'Contra', 'Boya', 'Normal'];
            const cntData = [cntGoalStats['h+'], cntGoalStats.penalty, cntGoalStats.contra, cntGoalStats.boya, cntGoalStats.normal];
            const rivalData = [rivalGoalStats['h+'], rivalGoalStats.penalty, rivalGoalStats.contra, rivalGoalStats.boya, rivalGoalStats.normal];
            
            window.offenseDefenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles a Favor',
                            data: cntData,
                            backgroundColor: '#22c55e'
                        },
                        {
                            label: 'Goles en Contra',
                            data: rivalData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function renderPlayerEfficiencyChart() {
            const ctx = document.getElementById('playerEfficiencyChart');
            if (!ctx) return;
            
            if (window.playerEfficiencyChartInstance) {
                window.playerEfficiencyChartInstance.destroy();
            }
            
            const playersWithStats = currentMatch.jugadors
                .filter(j => j.estadistiques.gols > 0 || j.estadistiques.exclusions > 0)
                .sort((a, b) => b.estadistiques.gols - a.estadistiques.gols);
            
            const labels = playersWithStats.map(j => `${j.numero}. ${j.nom.split(' ')[0]}`);
            const goalsData = playersWithStats.map(j => j.estadistiques.gols);
            const exclusionsData = playersWithStats.map(j => j.estadistiques.exclusions);
            
            window.playerEfficiencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Goles',
                            data: goalsData,
                            backgroundColor: '#fde047'
                        },
                        {
                            label: 'Exclusiones',
                            data: exclusionsData,
                            backgroundColor: '#f97316'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: 'white', stepSize: 1 },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

function displayComparison() {
    if (allMatches.length === 0) return;
    populatePlayerFilter();
    
    const wins = allMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const losses = allMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const draws = allMatches.filter(m => m.scoreCNT === m.scoreRival).length;
    const totalGoals = allMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalGoalsAgainst = allMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const avgGoals = (totalGoals / allMatches.length).toFixed(1);
    const avgGoalsAgainst = (totalGoalsAgainst / allMatches.length).toFixed(1);

    // Filtrar només partits amb dades de xuts fallats
    const matchesWithShotData = allMatches.filter(m => {
        const hasXutsFallats = m.jugadors.some(j => (j.estadistiques.xutsFallats || 0) > 0);
        return hasXutsFallats;
    });

    const totalXutsFallats = matchesWithShotData.reduce((sum, m) => {
        return sum + m.jugadors.reduce((s, j) => s + (j.estadistiques.xutsFallats || 0), 0);
    }, 0);

    const totalGoalsWithShotData = matchesWithShotData.reduce((sum, m) => sum + m.scoreCNT, 0);
    const totalXutsGlobal = totalGoalsWithShotData + totalXutsFallats;
    const eficienciaGlobal = totalXutsGlobal > 0 ? ((totalGoalsWithShotData / totalXutsGlobal) * 100).toFixed(1) : '0.0';
    const numMatchesWithShotData = matchesWithShotData.length;
    
    let totalPenMissedCNT = 0;
    let totalPenMissedRival = 0;
    let totalHPlusCNT = 0;
    let totalExclusionsNoPenaltyRival = 0;
    let totalHPlusRival = 0;
    let totalExclusionsNoPenaltyCNT = 0;

    const globalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };

    const globalExcStats = {
        cnt: { normal: 0, penalty: 0 },
        rival: { normal: 0, penalty: 0 }
    };

    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            totalPenMissedCNT += (j.estadistiques.penaltyMissed || 0);
            if (j.estadistiques.goalTypes) {
                Object.keys(globalGoalStats).forEach(type => {
                    globalGoalStats[type] += j.estadistiques.goalTypes[type] || 0;
                });
                if (j.estadistiques.goalTypes['h+']) {
                    totalHPlusCNT += j.estadistiques.goalTypes['h+'];
                }
            }
            if (j.estadistiques.exclusionTypes) {
                globalExcStats.cnt.normal += j.estadistiques.exclusionTypes.normal || 0;
                globalExcStats.cnt.penalty += j.estadistiques.exclusionTypes.penalty || 0;
                totalExclusionsNoPenaltyCNT += j.estadistiques.exclusionTypes.normal || 0;
            }
        });
        
        match.rivalStats.forEach(j => {
            totalPenMissedRival += (j.penaltyMissed || 0);
            if (j.goalTypes && j.goalTypes['h+']) {
                totalHPlusRival += j.goalTypes['h+'];
            }
            if (j.exclusionTypes) {
                totalExclusionsNoPenaltyRival += (j.exclusionTypes.normal || 0);
                globalExcStats.rival.normal += j.exclusionTypes.normal || 0;
                globalExcStats.rival.penalty += j.exclusionTypes.penalty || 0;
            }
        });
    });

    const conversionRateCNT = totalExclusionsNoPenaltyRival > 0 ? 
        ((totalHPlusCNT / totalExclusionsNoPenaltyRival) * 100).toFixed(1) : '0.0';

    const conversionRateRival = totalExclusionsNoPenaltyCNT > 0 ? 
        ((totalHPlusRival / totalExclusionsNoPenaltyCNT) * 100).toFixed(1) : '0.0';

    // NUEVO: Rendimiento Casa vs Fuera
    const homeMatches = allMatches.filter(m => m.matchLocation === 'home' || !m.matchLocation);
    const awayMatches = allMatches.filter(m => m.matchLocation === 'away');

    const homeWins = homeMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const homeLosses = homeMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const homeDraws = homeMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const awayWins = awayMatches.filter(m => m.scoreCNT > m.scoreRival).length;
    const awayLosses = awayMatches.filter(m => m.scoreCNT < m.scoreRival).length;
    const awayDraws = awayMatches.filter(m => m.scoreCNT === m.scoreRival).length;

    const homeGoalsFor = homeMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const homeGoalsAgainst = homeMatches.reduce((sum, m) => sum + m.scoreRival, 0);
    const awayGoalsFor = awayMatches.reduce((sum, m) => sum + m.scoreCNT, 0);
    const awayGoalsAgainst = awayMatches.reduce((sum, m) => sum + m.scoreRival, 0);

    document.getElementById('summaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos Jugados</div>
            <div class="info-value">${allMatches.length}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Victorias</div>
            <div class="info-value win">${wins}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Derrotas</div>
            <div class="info-value loss">${losses}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Empates</div>
            <div class="info-value draw">${draws}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles a Favor</div>
            <div class="info-value">${totalGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles en Contra</div>
            <div class="info-value">${totalGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles/Partido</div>
            <div class="info-value">${avgGoals}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Media Goles en Contra</div>
            <div class="info-value">${avgGoalsAgainst}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados CNT</div>
            <div class="info-value" style="color: ${totalPenMissedCNT === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedCNT}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Penaltis Fallados Rival</div>
            <div class="info-value" style="color: ${totalPenMissedRival === 0 ? '#22c55e' : '#ef4444'}">${totalPenMissedRival}</div>
        </div>
        <div class="info-item">
            <div class="info-label">🏠 Partidos en Casa</div>
            <div class="info-value">${homeMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${homeWins}V - ${homeLosses}D - ${homeDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🎯 Eficiència Global de Tir</div>
            <div class="info-value" style="color: ${totalXutsGlobal > 0 ? (eficienciaGlobal >= 50 ? '#22c55e' : eficienciaGlobal >= 30 ? '#fbbf24' : '#ef4444') : '#bae6fd'};">
                ${totalXutsGlobal > 0 ? `${totalGoals}/${totalXutsGlobal}` : 'No hi ha dades'}<br>
                ${totalXutsGlobal > 0 ? `<span style="font-size: 14px;">(${eficienciaGlobal}%)</span>` : ''}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">✈️ Partidos Fuera</div>
            <div class="info-value">${awayMatches.length}</div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                ${awayWins}V - ${awayLosses}D - ${awayDraws}E
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🏠 Media Goles Casa</div>
            <div class="info-value" style="color: #fde047;">
                ${homeMatches.length > 0 ? (homeGoalsFor / homeMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${homeMatches.length > 0 ? (homeGoalsAgainst / homeMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">✈️ Media Goles Fuera</div>
            <div class="info-value" style="color: #fde047;">
                ${awayMatches.length > 0 ? (awayGoalsFor / awayMatches.length).toFixed(1) : '-'}
            </div>
            <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                GC: ${awayMatches.length > 0 ? (awayGoalsAgainst / awayMatches.length).toFixed(1) : '-'}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversión H+ CNT (Total)</div>
            <div class="info-value" style="color: ${conversionRateCNT >= 50 ? '#22c55e' : conversionRateCNT >= 30 ? '#fbbf24' : '#ef4444'}">
                ${totalHPlusCNT}/${totalExclusionsNoPenaltyRival}<br>
                <span style="font-size: 14px;">(${conversionRateCNT}%)</span>
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Conversión H+ Rival (Total)</div>
            <div class="info-value" style="color: ${conversionRateRival >= 50 ? '#ef4444' : conversionRateRival >= 30 ? '#fbbf24' : '#22c55e'}">
                ${totalHPlusRival}/${totalExclusionsNoPenaltyCNT}<br>
                <span style="font-size: 14px;">(${conversionRateRival}%)</span>
            </div>
        </div>
    `;

    const goalLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penaltis',
        'contra': 'Contraataques',
        'boya': 'Boya',
        'normal': 'Normales'
    };

    document.getElementById('totalGoalsBreakdown').innerHTML = Object.keys(globalGoalStats)
        .filter(type => globalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalGoalStats[type] / totalGoals) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    const globalRivalGoalStats = {
        'h+': 0,
        'penalty': 0,
        'contra': 0,
        'boya': 0,
        'normal': 0
    };
    
    allMatches.forEach(match => {
        match.rivalStats.forEach(j => {
            if (j.goalTypes) {
                Object.keys(globalRivalGoalStats).forEach(type => {
                    globalRivalGoalStats[type] += j.goalTypes[type] || 0;
                });
            }
        });
    });

    document.getElementById('totalGoalsReceivedBreakdown').innerHTML = Object.keys(globalRivalGoalStats)
        .filter(type => globalRivalGoalStats[type] > 0)
        .map(type => `
            <div class="breakdown-item">
                <div class="breakdown-label">${goalLabels[type]}</div>
                <div class="breakdown-value">${globalRivalGoalStats[type]}</div>
                <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                    ${((globalRivalGoalStats[type] / totalGoalsAgainst) * 100).toFixed(1)}%
                </div>
            </div>
        `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';

    document.getElementById('totalExclusionsBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Normales</div>
            <div class="breakdown-value">${globalExcStats.cnt.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">CNT - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.cnt.penalty}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Normales</div>
            <div class="breakdown-value">${globalExcStats.rival.normal}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Rival - Penaltis</div>
            <div class="breakdown-value">${globalExcStats.rival.penalty}</div>
        </div>
    `;

    const playerStats = {};
    const playerMatchAppearances = {};
    
    allMatches.forEach((match, matchIndex) => {
        match.jugadors.forEach(j => {
            const playerName = j.nom.trim();
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = { 
                    num: j.numero,
                    name: playerName, 
                    gols: 0, 
                    exclusions: 0,
                    penaltyMissed: 0,
                    partidos: 0,
                    goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
                    assistencies: 0,
                    robatoris: 0,
                    perdues: 0,
                    xutsFallats: 0,
                    blocks: 0,
                    faltesRebudes: 0,
                    exclusionTypes: { normal: 0, penalty: 0 }
                };
                playerMatchAppearances[playerName] = new Set();
            }
            
            playerStats[playerName].num = j.numero;
            playerMatchAppearances[playerName].add(matchIndex);
            
            playerStats[playerName].gols += j.estadistiques.gols;
            playerStats[playerName].exclusions += j.estadistiques.exclusions;
            playerStats[playerName].penaltyMissed += (j.estadistiques.penaltyMissed || 0);
            playerStats[playerName].parades += (j.estadistiques.parades || 0);
            playerStats[playerName].assistencies += (j.estadistiques.assistencies || 0);
            playerStats[playerName].robatoris += (j.estadistiques.robatoris || 0);
            playerStats[playerName].perdues += (j.estadistiques.perdues || 0);
            playerStats[playerName].xutsFallats += (j.estadistiques.xutsFallats || 0);
            playerStats[playerName].blocks += (j.estadistiques.blocks || 0);
            playerStats[playerName].faltesRebudes += (j.estadistiques.faltesRebudes || 0);
            playerStats[playerName].blocatges += (j.estadistiques.blocatges || 0);
            
            if (j.estadistiques.goalTypes) {
                Object.keys(playerStats[playerName].goalTypes).forEach(type => {
                    playerStats[playerName].goalTypes[type] += j.estadistiques.goalTypes[type] || 0;
                });
            }
            
            if (j.estadistiques.exclusionTypes) {
                if (playerStats[playerName].exclusionTypes) {
                    Object.keys(playerStats[playerName].exclusionTypes).forEach(type => {
                        playerStats[playerName].exclusionTypes[type] += (j.estadistiques.exclusionTypes[type] || 0);
                    });
                }
            } else {
                if (!playerStats[playerName].exclusionTypes) {
                    playerStats[playerName].exclusionTypes = { normal: 0, penalty: 0 };
                }
            }
            
            if (j.estadistiques.paradeTypes) {
                Object.keys(playerStats[playerName].paradeTypes).forEach(type => {
                    playerStats[playerName].paradeTypes[type] += j.estadistiques.paradeTypes[type] || 0;
                });
            }
        });
    });
    
    Object.keys(playerStats).forEach(name => {
        playerStats[name].partidos = playerMatchAppearances[name].size;
    });

    const players = Object.values(playerStats).map(p => {
        const valor = calculatePlayerValue({
            gols: p.gols,
            goalTypes: p.goalTypes,
            assistencies: p.assistencies,
            robatoris: p.robatoris,
            blocatges: p.blocks || 0,
            parades: p.parades,
            faltesRebudes: p.faltesRebudes || 0,
            exclusions: p.exclusions,
            exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: p.penaltyMissed,
            perdues: p.perdues,
            xutsFallats: p.xutsFallats
        });
        return { ...p, valor };
    }).sort((a, b) => b.valor - a.valor);

    cachedPlayersData = players;
    currentSortColumn = 'valor';
    currentSortOrder = 'desc';

    renderComparisonTable(players);

    const topScorers = Object.values(playerStats)
        .filter(p => p.gols > 0)
        .sort((a, b) => b.gols - a.gols)
        .slice(0, 10);

    document.getElementById('allTimeScorers').innerHTML = topScorers.map((p, i) => {
        let rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
            <div class="top-scorer-item">
                <div class="player-info">
                    <div class="rank ${rankClass}">${i + 1}</div>
                    <div class="player-num">${p.num}</div>
                    <div class="player-name">${p.name}</div>
                </div>
                <div style="font-size: 24px; font-weight: bold; color: #fde047;">
                    ${p.gols} 🥅🏐
                </div>
            </div>
        `;
    }).join('');

    renderResultsEvolution();
    renderQuarterDifference();
    renderBestWorstMatches();
    renderRivalsHistory();

    // ============ RANKING MVP GLOBAL ============
    const playersWithAvgValue = Object.values(playerStats).map(p => {
        const valor = calculatePlayerValue({
            gols: p.gols,
            goalTypes: p.goalTypes,
            assistencies: p.assistencies,
            robatoris: p.robatoris,
            blocatges: p.blocks || 0,
            parades: p.parades,
            faltesRebudes: p.faltesRebudes || 0,
            exclusions: p.exclusions,
            exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
            penaltyMissed: p.penaltyMissed,
            perdues: p.perdues,
            xutsFallats: p.xutsFallats
        });
        const avgValor = p.partidos > 0 ? valor / p.partidos : 0;
        return { ...p, valorTotal: valor, valorMitja: avgValor };
    }).sort((a, b) => b.valorMitja - a.valorMitja);

    const mvpContainer = document.createElement('div');
    mvpContainer.className = 'card';
    mvpContainer.innerHTML = `
        <h2 class="section-title">🏆 Ràn­­quing MVP de la Temporada</h2>
        <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
            Top 10 jugadors amb millor valoració mitjana per partit
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            ${playersWithAvgValue.slice(0, 10).map((player, index) => {
                const medals = ['🥇', '🥈', '🥉'];
                const colors = ['#fbbf24', '#d1d5db', '#d97706'];
                const borderColors = ['#f59e0b', '#9ca3af', '#ea580c'];
                const bgColors = [
                    'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.1))',
                    'linear-gradient(135deg, rgba(209, 213, 219, 0.3), rgba(156, 163, 175, 0.1))',
                    'linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(234, 88, 12, 0.1))'
                ];
                
                return `
                    <div style="background: ${index < 3 ? bgColors[index] : 'rgba(0,0,0,0.2)'}; 
                                padding: 15px; border-radius: 8px; 
                                border: ${index < 3 ? '3px' : '2px'} solid ${index < 3 ? borderColors[index] : 'rgba(255,255,255,0.2)'}; 
                                position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; font-size: ${index < 3 ? '36px' : '24px'};">
                            ${index < 3 ? medals[index] : `#${index + 1}`}
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <div class="player-num" style="width: ${index < 3 ? '45px' : '40px'}; height: ${index < 3 ? '45px' : '40px'}; font-size: ${index < 3 ? '20px' : '16px'};">${player.num}</div>
                            <div>
                                <div style="font-weight: bold; font-size: ${index < 3 ? '18px' : '16px'}; color: ${index < 3 ? colors[index] : '#fff'};">${player.name}</div>
                                <div style="font-size: 11px; color: #bae6fd;">
                                    Valor/Partit: <strong style="color: ${index < 3 ? colors[index] : '#22d3ee'};">${player.valorMitja.toFixed(1)}</strong>
                                </div>
                                <div style="font-size: 10px; color: #94a3b8;">
                                    ${player.partidos} partits • Total: ${player.valorTotal.toFixed(0)}
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 6px;">
                            ${player.gols > 0 ? `
                                <div style="background: rgba(253, 224, 71, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Gols</div>
                                    <div style="color: #fde047; font-weight: bold; font-size: 13px;">${player.gols}</div>
                                </div>
                            ` : ''}
                            ${(player.assistencies || 0) > 0 ? `
                                <div style="background: rgba(6, 182, 212, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Assists</div>
                                    <div style="color: #06b6d4; font-weight: bold; font-size: 13px;">${player.assistencies}</div>
                                </div>
                            ` : ''}
                            ${(player.robatoris || 0) > 0 ? `
                                <div style="background: rgba(59, 130, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Rob</div>
                                    <div style="color: #3b82f6; font-weight: bold; font-size: 13px;">${player.robatoris}</div>
                                </div>
                            ` : ''}
                            ${(player.parades || 0) > 0 ? `
                                <div style="background: rgba(139, 92, 246, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Parades</div>
                                    <div style="color: #8b5cf6; font-weight: bold; font-size: 13px;">${player.parades}</div>
                                </div>
                            ` : ''}
                            ${(player.faltesRebudes || 0) > 0 ? `
                                <div style="background: rgba(251, 191, 36, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">FR</div>
                                    <div style="color: #fbbf24; font-weight: bold; font-size: 13px;">${player.faltesRebudes}</div>
                                </div>
                            ` : ''}
                            ${player.exclusions > 0 ? `
                                <div style="background: rgba(239, 68, 68, 0.2); padding: 4px; border-radius: 4px; text-align: center;">
                                    <div style="color: #bae6fd; font-size: 9px;">Exc</div>
                                    <div style="color: #ef4444; font-weight: bold; font-size: 13px;">${player.exclusions}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;

    const comparisonTable = document.querySelector('#comparisonView');
    const tableCard = comparisonTable.querySelector('.card:has(#comparisonTable)');
    if (tableCard) {
        tableCard.parentNode.insertBefore(mvpContainer, tableCard);
    }

    renderGoalsDistributionChart(playerStats);

    // ✅ ZONES DE GOL DELS JUGADORS
    renderGoalZoneStats();

    // ✅ ZONES DE GOLS REBUTS PELS PORTERS
    const goalkeeperZones = renderGoalkeeperZoneStats();

    const goalkeeperZonesHTML = `
        <div class="card" id="goalkeeperZonesCard">
            <h2 class="section-title">🧤 Anàlisi de Gols Rebuts pels Porters</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On reben més gols els nostres porters
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${[1, 13].map(gkNum => {
                    const gk = goalkeeperZones[gkNum];
                    if (gk.totalGolsRebuts === 0) return '';
                    
                    const zoneOrder = [
                        'top-left', 'top-center', 'top-right',
                        'mid-left', 'mid-center', 'mid-right',
                        'bottom-left', 'bottom-center', 'bottom-right'
                    ];
                    
                    const zoneLabels = {
                        'top-left': '⬆️ Esq',
                        'top-center': '⬆️ Centre',
                        'top-right': '⬆️ Dret',
                        'mid-left': '➡️ Esq',
                        'mid-center': '🎯 Centre',
                        'mid-right': '⬅️ Dret',
                        'bottom-left': '⬇️ Esq',
                        'bottom-center': '⬇️ Baix',
                        'bottom-right': '⬇️ Dret'
                    };
                    
                    const maxCount = Math.max(...zoneOrder.map(z => gk.zones[z] || 0));
                    
                    return `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 14px; font-weight: bold; color: #22d3ee;">
                                    ${gk.num}. ${gk.name.split(' ')[0]}
                                </div>
                                <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                    Total gols rebuts: ${gk.totalGolsRebuts}
                                </div>
                            </div>
                            
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = gk.zones[zone] || 0;
                                    const percentage = gk.totalGolsRebuts > 0 ? 
                                        ((count / gk.totalGolsRebuts) * 100).toFixed(1) : 0;
                                    const intensity = maxCount > 0 ? count / maxCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabels[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">
                                                ${percentage}%
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${gk.zones.unknown > 0 ? `
                                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                                    ❓ Gols sense zona: ${gk.zones.unknown}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;

    // Inserir el HTML dels porters ABANS de la taula de comparació
    const comparisonTableCard = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    if (comparisonTableCard) {
        const existingGKCard = document.getElementById('goalkeeperZonesCard');
        if (existingGKCard) {
            existingGKCard.remove();
        }
        comparisonTableCard.insertAdjacentHTML('beforebegin', goalkeeperZonesHTML);
    }

    // ✅ SWIM RACES I GOALKEEPER SAVES AL FINAL
    document.getElementById('swimRacesStatsContainer').innerHTML = renderSwimRacesStats();
    renderGoalkeeperSavesChart();
}
	

        function renderGoalsDistributionChart(playerStats) {
            const ctx = document.getElementById('goalsDistributionChart');
            
			if (!ctx) return;
            
            if (window.goalsDistributionChartInstance) {
                window.goalsDistributionChartInstance.destroy();
            }
            
            const topPlayers = Object.values(playerStats)
                .filter(p => p.gols > 0)
                .sort((a, b) => b.gols - a.gols)
                .slice(0, 8);
            
            const labels = topPlayers.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
            const data = topPlayers.map(p => p.gols);
            
            const colors = [
                '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
                '#fde047', '#fbbf24', '#f59e0b', '#d97706'
            ];
            
            window.goalsDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#1e3a8a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'right',
                            labels: { 
                                color: 'white', 
                                font: { size: 12 },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} goles (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
function renderResultsEvolution() {
    const ctx = document.getElementById('resultsEvolutionChart');
    if (!ctx) return;
    
    if (window.resultsEvolutionChartInstance) {
        window.resultsEvolutionChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    // Ordenar partidos cronológicamente
    const sortedMatches = [...allMatches].sort((a, b) => new Date(a.data) - new Date(b.data));
    
    const labels = sortedMatches.map((m, i) => {
        const date = new Date(m.data);
        const rival = m.rivalTeam || 'Rival';
        return `${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' })} vs ${rival.substring(0, 15)}`;
    });
    
    const goalDifferences = sortedMatches.map(m => m.scoreCNT - m.scoreRival);
    const colors = goalDifferences.map(diff => {
        if (diff > 0) return '#22c55e'; // Victoria
        if (diff < 0) return '#ef4444'; // Derrota
        return '#fbbf24'; // Empate
    });
    
    // Calcular racha actual
    let currentStreak = 0;
    let streakType = '';
    if (sortedMatches.length > 0) {
        const lastResult = sortedMatches[sortedMatches.length - 1].scoreCNT > sortedMatches[sortedMatches.length - 1].scoreRival ? 'win' : 
                          sortedMatches[sortedMatches.length - 1].scoreCNT < sortedMatches[sortedMatches.length - 1].scoreRival ? 'loss' : 'draw';
        
        for (let i = sortedMatches.length - 1; i >= 0; i--) {
            const result = sortedMatches[i].scoreCNT > sortedMatches[i].scoreRival ? 'win' : 
                          sortedMatches[i].scoreCNT < sortedMatches[i].scoreRival ? 'loss' : 'draw';
            if (result === lastResult) {
                currentStreak++;
            } else {
                break;
            }
        }
        streakType = lastResult === 'win' ? 'victorias' : lastResult === 'loss' ? 'derrotas' : 'empates';
    }
    
    window.resultsEvolutionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia de Goles',
                data: goalDifferences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Racha actual: ${currentStreak} ${streakType}`,
                    color: 'white',
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const diff = context.parsed.y;
                            const result = diff > 0 ? '✅ Victoria' : diff < 0 ? '❌ Derrota' : '🤝 Empate';
                            return `${result} (${diff > 0 ? '+' : ''}${diff})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Diferencia de Goles por Cuarto
function renderQuarterDifference() {
    const ctx = document.getElementById('quarterDifferenceChart');
    if (!ctx) return;
    
    if (window.quarterDifferenceChartInstance) {
        window.quarterDifferenceChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const quarterStats = {
        q1: { cnt: 0, rival: 0 },
        q2: { cnt: 0, rival: 0 },
        q3: { cnt: 0, rival: 0 },
        q4: { cnt: 0, rival: 0 }
    };
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            quarterStats[q].cnt += match.periodScores[q].cnt;
            quarterStats[q].rival += match.periodScores[q].rival;
        });
    });
    
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    const differences = ['q1', 'q2', 'q3', 'q4'].map(q => {
        const diff = quarterStats[q].cnt - quarterStats[q].rival;
        return (diff / allMatches.length).toFixed(2);
    });
    
    const colors = differences.map(diff => parseFloat(diff) >= 0 ? '#22c55e' : '#ef4444');
    
    window.quarterDifferenceChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Diferencia Promedio',
                data: differences,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const q = ['q1', 'q2', 'q3', 'q4'][context.dataIndex];
                            const totalCNT = quarterStats[q].cnt;
                            const totalRival = quarterStats[q].rival;
                            return [
                                `Diferencia: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y}`,
                                `Total a favor: ${totalCNT}`,
                                `Total en contra: ${totalRival}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Diferencia Promedio de Goles',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

// NUEVA: Mejores y Peores Partidos
function renderBestWorstMatches() {
    const container = document.getElementById('bestWorstGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    // Encontrar mejor victoria
    const bestWin = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => (b.scoreCNT - b.scoreRival) - (a.scoreCNT - a.scoreRival))[0];
    
    // Encontrar peor derrota
    const worstLoss = allMatches
        .filter(m => m.scoreCNT < m.scoreRival)
        .sort((a, b) => (a.scoreCNT - a.scoreRival) - (b.scoreCNT - b.scoreRival))[0];
    
    // Partido con más goles anotados
    const mostGoals = allMatches.sort((a, b) => b.scoreCNT - a.scoreCNT)[0];
    
    // Partido con menos goles recibidos (solo victorias)
    const bestDefense = allMatches
        .filter(m => m.scoreCNT > m.scoreRival)
        .sort((a, b) => a.scoreRival - b.scoreRival)[0];
    
    let html = '';
    
    if (bestWin) {
        const date = new Date(bestWin.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">🏆 Mejor Victoria</div>
                <div class="info-value" style="color: #22c55e;">${bestWin.scoreCNT} - ${bestWin.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestWin.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (worstLoss) {
        const date = new Date(worstLoss.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">😞 Peor Derrota</div>
                <div class="info-value" style="color: #ef4444;">${worstLoss.scoreCNT} - ${worstLoss.scoreRival}</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${worstLoss.rivalTeam || 'Rival'}<br>${date}
                </div>
            </div>
        `;
    }
    
    if (mostGoals) {
        const date = new Date(mostGoals.data).toLocaleDateString('es-ES');
        const result = mostGoals.scoreCNT > mostGoals.scoreRival ? 'win' : mostGoals.scoreCNT < mostGoals.scoreRival ? 'loss' : 'draw';
        html += `
            <div class="info-item">
                <div class="info-label">⚽ Más Goles Anotados</div>
                <div class="info-value ${result}">${mostGoals.scoreCNT} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${mostGoals.rivalTeam || 'Rival'} (${mostGoals.scoreCNT}-${mostGoals.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    if (bestDefense) {
        const date = new Date(bestDefense.data).toLocaleDateString('es-ES');
        html += `
            <div class="info-item">
                <div class="info-label">🛡️ Mejor Defensa</div>
                <div class="info-value" style="color: #22d3ee;">${bestDefense.scoreRival} goles</div>
                <div style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                    vs ${bestDefense.rivalTeam || 'Rival'} (${bestDefense.scoreCNT}-${bestDefense.scoreRival})<br>${date}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// NUEVA: Historial contra Rivales
function renderRivalsHistory() {
    const table = document.getElementById('rivalsHistoryTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const rivalsStats = {};
    
    allMatches.forEach(match => {
        const rival = match.rivalTeam || 'Rival Desconocido';
        
        if (!rivalsStats[rival]) {
            rivalsStats[rival] = {
                name: rival,
                played: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                matches: []
            };
        }
        
        rivalsStats[rival].played++;
        rivalsStats[rival].goalsFor += match.scoreCNT;
        rivalsStats[rival].goalsAgainst += match.scoreRival;
        
        if (match.scoreCNT > match.scoreRival) {
            rivalsStats[rival].wins++;
        } else if (match.scoreCNT < match.scoreRival) {
            rivalsStats[rival].losses++;
        } else {
            rivalsStats[rival].draws++;
        }
        
        rivalsStats[rival].matches.push({
            date: match.data,
            score: `${match.scoreCNT}-${match.scoreRival}`,
            result: match.scoreCNT > match.scoreRival ? 'win' : match.scoreCNT < match.scoreRival ? 'loss' : 'draw'
        });
    });
    
    const rivals = Object.values(rivalsStats).sort((a, b) => b.played - a.played);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Rival</th>
                <th>PJ</th>
                <th>V</th>
                <th>D</th>
                <th>E</th>
                <th>GF</th>
                <th>GC</th>
                <th>Dif</th>
                <th>%V</th>
                <th>Último Resultado</th>
            </tr>
        </thead>
        <tbody>
            ${rivals.map(r => {
                const diff = r.goalsFor - r.goalsAgainst;
                const winPercentage = r.played > 0 ? ((r.wins / r.played) * 100).toFixed(0) : 0;
                const lastMatch = r.matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const lastDate = new Date(lastMatch.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                
                return `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.played}</td>
                        <td class="win">${r.wins}</td>
                        <td class="loss">${r.losses}</td>
                        <td class="draw">${r.draws}</td>
                        <td>${r.goalsFor}</td>
                        <td>${r.goalsAgainst}</td>
                        <td style="color: ${diff > 0 ? '#22c55e' : diff < 0 ? '#ef4444' : '#fbbf24'}; font-weight: bold;">
                            ${diff > 0 ? '+' : ''}${diff}
                        </td>
                        <td>${winPercentage}%</td>
                        <td>
                            <span class="${lastMatch.result}">${lastMatch.score}</span>
                            <span style="font-size: 10px; color: #bae6fd; margin-left: 4px;">(${lastDate})</span>
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
        function renderTitularityHeatmapChart() {
            const ctx = document.getElementById('titularityHeatmapChart');
            if (!ctx) {
                console.log('Canvas no encontrado');
                return;
            }
            
            if (window.titularityHeatmapChartInstance) {
                window.titularityHeatmapChartInstance.destroy();
            }
            
            if (allMatches.length === 0) {
                console.log('No hay partidos cargados');
                return;
            }
            
            const titularStats = {};
            
            allMatches.forEach(match => {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                quarters.forEach(q => {
                    const lineup = match.lineups[q] || [];
                    lineup.forEach(playerNum => {
                        const player = match.jugadors.find(j => j.numero === playerNum);
                        if (player) {
                            const playerName = player.nom.trim();
                            if (!titularStats[playerName]) {
                                titularStats[playerName] = { num: player.numero, q1: 0, q2: 0, q3: 0, q4: 0 };
                            }
                            titularStats[playerName].num = player.numero;
                            titularStats[playerName][q]++;
                        }
                    });
                });
            });
            
            const players = Object.keys(titularStats)
                .sort((a, b) => {
                    const totalA = titularStats[a].q1 + titularStats[a].q2 + titularStats[a].q3 + titularStats[a].q4;
                    const totalB = titularStats[b].q1 + titularStats[b].q2 + titularStats[b].q3 + titularStats[b].q4;
                    return totalB - totalA;
                });
            
            if (players.length === 0) {
                console.log('No hay jugadores con titularidades');
                return;
            }
            
            console.log('Jugadores encontrados:', players.length);
            
            const quarters = ['1Q', '2Q', '3Q', '4Q'];
            const datasets = quarters.map((q, qIndex) => {
                const quarterKey = `q${qIndex + 1}`;
                return {
                    label: q,
                    data: players.map(p => titularStats[p][quarterKey]),
                    backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'][qIndex]
                };
            });
            
           window.titularityHeatmapChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: players.map(p => `${titularStats[p].num}. ${p.split(' ')[0]}`),
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ⬅️ CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: true,
                labels: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 10 : 14 } // ⬅️ AÑADIDO
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.x} veces titular`;
                    }
                }
            }
        },
        scales: {
            x: { 
                stacked: true,
                beginAtZero: true,
                ticks: { 
                    color: 'white', 
                    stepSize: 1,
                    font: { size: window.innerWidth < 768 ? 10 : 12 } // ⬅️ AÑADIDO
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Veces como Titular',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ⬅️ AÑADIDO
                }
            },
            y: { 
                stacked: true,
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ⬅️ MODIFICADO
                    autoSkip: false // ⬅️ AÑADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
        }

        function displayTitularStats() {
    const container = document.getElementById('titularView');
    
    if (allMatches.length === 0) {
        container.innerHTML = '<div class="no-data">No hay partidos cargados</div>';
        return;
    }

    const titularStats = {};
    
    allMatches.forEach(match => {
        const quarters = ['q1', 'q2', 'q3', 'q4'];
        quarters.forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    
                    if (!titularStats[playerName]) {
                        titularStats[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                        };
                    }
                    
                    titularStats[playerName].num = player.numero;
                    titularStats[playerName][q]++;
                    titularStats[playerName].total++;
                }
            });
        });
    });

    const players = Object.values(titularStats).sort((a, b) => b.total - a.total);

    container.innerHTML = `
        <h2 class="section-title">Veces como Titular por Cuarto</h2>
        <p style="margin-bottom: 15px; color: #bae6fd; font-size: 14px;">
            Basado en ${allMatches.length} partido${allMatches.length !== 1 ? 's' : ''}
        </p>
        <div class="titular-stats">
            ${players.map(p => `
                <div class="titular-item">
                    <div class="titular-header">
                        <div class="player-num">${p.num}</div>
                        <div style="flex: 1;">
                            <div class="player-name">${p.name}</div>
                            <div style="font-size: 12px; color: #bae6fd; margin-top: 4px;">
                                Total: <span class="total-badge">${p.total}</span>
                            </div>
                        </div>
                    </div>
                    <div class="titular-quarters">
                        <div class="quarter-badge">1Q: ${p.q1}</div>
                        <div class="quarter-badge">2Q: ${p.q2}</div>
                        <div class="quarter-badge">3Q: ${p.q3}</div>
                        <div class="quarter-badge">4Q: ${p.q4}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    // Renderizar nuevos gráficos
    renderConsistencyChart();
    renderQuarterPatterns();
    renderPerformanceTable();
}

// NUEVA FUNCIÓN: Gráfico de Consistencia
function renderConsistencyChart() {
    const ctx = document.getElementById('consistencyChart');
    if (!ctx) return;
    
    if (window.consistencyChartInstance) {
        window.consistencyChartInstance.destroy();
    }
    
    if (allMatches.length === 0) return;
    
    const playerConsistency = {};
    const maxPossibleTitular = allMatches.length * 4; // 4 cuartos por partido
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerConsistency[playerName]) {
                playerConsistency[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: 0,
                    total: 0
                };
            }
            playerConsistency[playerName].total += 4; // 4 cuartos posibles
        });
        
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (playerConsistency[playerName]) {
                        playerConsistency[playerName].titular++;
                    }
                }
            });
        });
    });
    
    const players = Object.values(playerConsistency)
        .map(p => ({
            ...p,
            percentage: p.total > 0 ? (p.titular / p.total * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.percentage - a.percentage);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => parseFloat(p.percentage));
    
    // Colores según porcentaje
    const backgroundColors = data.map(percentage => {
        if (percentage >= 75) return '#22c55e'; // Verde - Titular habitual
        if (percentage >= 50) return '#fbbf24'; // Amarillo - Mixto
        if (percentage >= 25) return '#f97316'; // Naranja - Suplente habitual
        return '#ef4444'; // Rojo - Rara vez titular
    });
    
    window.consistencyChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: '% de Titularidad',
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1,
            borderColor: '#1e3a8a'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // ⬅️ CAMBIADO
        indexAxis: 'y',
        plugins: {
            legend: { 
                display: false 
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const player = players[context.dataIndex];
                        return [
                            `Titularidad: ${context.parsed.x}%`,
                            `Titular: ${player.titular}/${player.total} cuartos`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: { 
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 10 : 12 }, // ⬅️ AÑADIDO
                    callback: function(value) {
                        return value + '%';
                    }
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: {
                    display: true,
                    text: 'Porcentaje de Titularidad',
                    color: 'white',
                    font: { size: window.innerWidth < 768 ? 11 : 14 } // ⬅️ AÑADIDO
                }
            },
            y: {
                ticks: { 
                    color: 'white', 
                    font: { size: window.innerWidth < 768 ? 9 : 11 }, // ⬅️ MODIFICADO
                    autoSkip: false // ⬅️ AÑADIDO - Muestra todas las etiquetas
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    }
});
}

// NUEVA FUNCIÓN: Patrones por Cuarto
function renderQuarterPatterns() {
    const container = document.getElementById('quarterPatternsGrid');
    if (!container) return;
    
    if (allMatches.length === 0) return;
    
    const playerQuarters = {};
    
    allMatches.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(q => {
            const lineup = match.lineups[q] || [];
            lineup.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (player) {
                    const playerName = player.nom.trim();
                    if (!playerQuarters[playerName]) {
                        playerQuarters[playerName] = {
                            num: player.numero,
                            name: playerName,
                            q1: 0, q2: 0, q3: 0, q4: 0
                        };
                    }
                    playerQuarters[playerName][q]++;
                }
            });
        });
    });
    
    const players = Object.values(playerQuarters)
        .sort((a, b) => b.q1 + b.q2 + b.q3 + b.q4 - (a.q1 + a.q2 + a.q3 + a.q4));
    
    container.innerHTML = players.map(p => {
        const quarters = [
            { name: '1Q', value: p.q1 },
            { name: '2Q', value: p.q2 },
            { name: '3Q', value: p.q3 },
            { name: '4Q', value: p.q4 }
        ];
        const maxQuarter = quarters.reduce((max, q) => q.value > max.value ? q : max, quarters[0]);
        const total = p.q1 + p.q2 + p.q3 + p.q4;
        
        let pattern = '';
        if (p.q1 + p.q2 > p.q3 + p.q4) {
            pattern = '🔵 Inicio fuerte';
        } else if (p.q3 + p.q4 > p.q1 + p.q2) {
            pattern = '🔴 Final de partido';
        } else {
            pattern = '⚪ Equilibrado';
        }
        
        return `
            <div class="player-stat">
                <div class="player-info">
                    <div class="player-num">${p.num}</div>
                    <div>
                        <div class="player-name">${p.name}</div>
                        <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                            ${pattern}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; color: #fde047; font-weight: bold;">
                        Prefiere: ${maxQuarter.name} (${maxQuarter.value}x)
                    </div>
                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                        Total: ${total} titularidades
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// NUEVA FUNCIÓN: Tabla de Rendimiento - CORREGIDA
function renderPerformanceTable() {
    const table = document.getElementById('performanceTable');
    if (!table) return;
    
    if (allMatches.length === 0) return;
    
    const playerPerformance = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            if (!playerPerformance[playerName]) {
                playerPerformance[playerName] = {
                    num: player.numero,
                    name: playerName,
                    titular: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 },
                    suplente: { teamGoalsFor: 0, teamGoalsAgainst: 0, quarters: 0 }
                };
            }
            
            // Analizar cuarto por cuarto
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                const isInLineup = match.lineups[q] && match.lineups[q].includes(player.numero);
                const quarterGoalsFor = match.periodScores[q].cnt;
                const quarterGoalsAgainst = match.periodScores[q].rival;
                
                if (isInLineup) {
                    // Es titular en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].titular.quarters++;
                    playerPerformance[playerName].titular.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].titular.teamGoalsAgainst += quarterGoalsAgainst;
                } else {
                    // Es suplente en este cuarto - contamos goles del EQUIPO
                    playerPerformance[playerName].suplente.quarters++;
                    playerPerformance[playerName].suplente.teamGoalsFor += quarterGoalsFor;
                    playerPerformance[playerName].suplente.teamGoalsAgainst += quarterGoalsAgainst;
                }
            });
        });
    });
    
    const players = Object.values(playerPerformance)
        .filter(p => p.titular.quarters > 0 || p.suplente.quarters > 0)
        .sort((a, b) => {
            const avgA = a.titular.quarters > 0 ? (a.titular.teamGoalsFor / a.titular.quarters) : 0;
            const avgB = b.titular.quarters > 0 ? (b.titular.teamGoalsFor / b.titular.quarters) : 0;
            return avgB - avgA;
        });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th rowspan="2">Nº</th>
                <th rowspan="2">Jugador</th>
                <th colspan="3" style="background: rgba(34, 197, 94, 0.3);">Cuando es Titular</th>
                <th colspan="3" style="background: rgba(239, 68, 68, 0.3);">Cuando es Suplente</th>
                <th rowspan="2">Dif GF/Q</th>
                <th rowspan="2">Dif GC/Q</th>
            </tr>
            <tr>
                <th style="background: rgba(34, 197, 94, 0.2);">Cuartos</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(34, 197, 94, 0.2);">GC/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">Cuartos</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GF/Q Equipo</th>
                <th style="background: rgba(239, 68, 68, 0.2);">GC/Q Equipo</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const titularAvgGF = p.titular.quarters > 0 ? (p.titular.teamGoalsFor / p.titular.quarters).toFixed(2) : '-';
                const titularAvgGC = p.titular.quarters > 0 ? (p.titular.teamGoalsAgainst / p.titular.quarters).toFixed(2) : '-';
                
                const suplenteAvgGF = p.suplente.quarters > 0 ? (p.suplente.teamGoalsFor / p.suplente.quarters).toFixed(2) : '-';
                const suplenteAvgGC = p.suplente.quarters > 0 ? (p.suplente.teamGoalsAgainst / p.suplente.quarters).toFixed(2) : '-';
                
                // Diferencia de goles A FAVOR (cuando es titular vs suplente)
                // Positivo = metemos MÁS goles cuando es titular (bueno)
                // Negativo = metemos MENOS goles cuando es titular (malo)
                const diffGF = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsFor / p.titular.quarters) - (p.suplente.teamGoalsFor / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGFColor = 'white';
                if (diffGF !== '-') {
                    // Verde si metemos MÁS goles cuando es titular (positivo)
                    // Rojo si metemos MENOS goles cuando es titular (negativo)
                    diffGFColor = parseFloat(diffGF) > 0 ? '#22c55e' : parseFloat(diffGF) < 0 ? '#ef4444' : '#fbbf24';
                }
                
                // Diferencia de goles EN CONTRA (cuando es titular vs suplente)
                // Positivo = recibimos MÁS goles cuando es titular (malo)
                // Negativo = recibimos MENOS goles cuando es titular (bueno)
                const diffGC = p.titular.quarters > 0 && p.suplente.quarters > 0 
                    ? ((p.titular.teamGoalsAgainst / p.titular.quarters) - (p.suplente.teamGoalsAgainst / p.suplente.quarters)).toFixed(2)
                    : '-';
                
                let diffGCColor = 'white';
                if (diffGC !== '-') {
                    // Verde si recibimos MENOS goles cuando es titular (negativo)
                    // Rojo si recibimos MÁS goles cuando es titular (positivo)
                    diffGCColor = parseFloat(diffGC) < 0 ? '#22c55e' : parseFloat(diffGC) > 0 ? '#ef4444' : '#fbbf24';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${p.titular.quarters}</td>
                        <td><strong style="color: #fde047;">${titularAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${titularAvgGC}</strong></td>
                        <td>${p.suplente.quarters}</td>
                        <td><strong style="color: #fde047;">${suplenteAvgGF}</strong></td>
                        <td><strong style="color: #ef4444;">${suplenteAvgGC}</strong></td>
                        <td style="color: ${diffGFColor}; font-weight: bold;">
                            ${diffGF !== '-' ? (diffGF > 0 ? '+' : '') + diffGF : '-'}
                        </td>
                        <td style="color: ${diffGCColor}; font-weight: bold;">
                            ${diffGC !== '-' ? (diffGC > 0 ? '+' : '') + diffGC : '-'}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}
function populatePlayerFilter() {
    const select = document.getElementById('filterPlayer');
    
    if (allMatches.length === 0) return;
    
    const playerSet = new Set();
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
        players.map(p => `<option value="${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayer() {
    const playerName = document.getElementById('filterPlayer').value;
    
    if (!playerName) {
        document.getElementById('playerStatsCard').classList.add('hidden');
        return;
    }
    
    const playerData = {
        name: playerName,
        num: 0,
        partidos: 0,
        gols: [],
        exclusions: [],
        dates: [],
        totalGols: 0,
        totalExclusions: 0,
        goalTypes: { 'h+': 0, penalty: 0, contra: 0, boya: 0, normal: 0 },
        penaltyMissed: 0,
        titular: { q1: 0, q2: 0, q3: 0, q4: 0 },
        totalParades: 0,
        bestParades: 0,
        paradeTypes: { corner: 0, rebuig: 0, atrapa: 0, penal: 0 },
        totalAssistencies: 0,
        totalRobatoris: 0,
        totalPerdues: 0,
        totalXutsFallats: 0,
        totalBlocks: 0,
        totalFaltesRebudes: 0,
        swimRacesWon: 0,
        swimRacesLost: 0,
        swimRacesTotal: 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === playerName);
        
        if (player) {
            playerData.num = player.numero;
            playerData.partidos++;
            playerData.gols.push(player.estadistiques.gols);
            playerData.exclusions.push(player.estadistiques.exclusions);
            playerData.dates.push(new Date(match.data).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }));
            playerData.totalGols += player.estadistiques.gols;
            playerData.totalExclusions += player.estadistiques.exclusions;
            playerData.penaltyMissed += player.estadistiques.penaltyMissed || 0;
            playerData.totalParades += (player.estadistiques.parades || 0);
            playerData.totalAssistencies += (player.estadistiques.assistencies || 0);
            playerData.totalRobatoris += (player.estadistiques.robatoris || 0);
            playerData.totalPerdues += (player.estadistiques.perdues || 0);
            playerData.totalXutsFallats += (player.estadistiques.xutsFallats || 0);
            playerData.totalBlocks += (player.estadistiques.blocks || 0);
            playerData.totalFaltesRebudes += (player.estadistiques.faltesRebudes || 0);

            if (player.estadistiques.parades && player.estadistiques.parades > playerData.bestParades) {
                playerData.bestParades = player.estadistiques.parades;
            }

            if (player.estadistiques.paradeTypes) {
                Object.keys(playerData.paradeTypes).forEach(type => {
                    playerData.paradeTypes[type] += (player.estadistiques.paradeTypes[type] || 0);
                });
            }
            
            if (player.estadistiques.goalTypes) {
                Object.keys(playerData.goalTypes).forEach(type => {
                    playerData.goalTypes[type] += (player.estadistiques.goalTypes[type] || 0);
                });
            }
            
            ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                if (match.lineups[q] && match.lineups[q].includes(player.numero)) {
                    playerData.titular[q]++;
                }
            });
        }
        
        // ✅ Comptar curses guanyades/perdudes (FORA del if player)
        if (match.chronologicalActions && playerData.num) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.playerNum === playerData.num) {
                    playerData.swimRacesTotal++;
                    if (action.result === 'win') {
                        playerData.swimRacesWon++;
                    } else {
                        playerData.swimRacesLost++;
                    }
                }
            });
        }
    });
    
    // ✅ Cridar displayPlayerStats amb les dades
    displayPlayerStats(playerData);
}
function renderPlayerGoalZones(data) {
     console.log('🥅 renderGoalkeeperReceivedZones CRIDAT amb:', data.name);   
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');
    
    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('playerGoalZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'playerGoalZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones totals del jugador
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.nom.trim() === data.name);
        if (player && player.estadistiques.goalZones) {
            Object.keys(player.estadistiques.goalZones).forEach(zone => {
                zones[zone] = (zones[zone] || 0) + (player.estadistiques.goalZones[zone] || 0);
            });
        }
    });
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">🎯 Zones de Porteria</h3>
            <div class="no-data">No hi ha dades de zones disponibles</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq', 'top-center': '⬆️ Centre', 'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq', 'mid-center': '🎯 Centre', 'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq', 'bottom-center': '⬇️ Baix', 'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const preferredZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const preferredZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">🎯 Zones de Porteria</h3>
        <div style="background: rgba(34, 211, 238, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #bae6fd;">Zona preferida</div>
            <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                ${preferredZoneNames[preferredZone]} (${zones[preferredZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ❓ Gols sense zona: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
            Total amb zona: ${totalGols} de ${data.totalGols} gols
        </div>
    `;
}
function renderGoalkeeperReceivedZones(data) {
console.log('🎯 renderPlayerGoalZones CRIDAT amb:', data.name);    
    
    const goalsBreakdown = document.getElementById('playerGoalsBreakdown');

    if (!goalsBreakdown) return;
    
    let zonesContainer = document.getElementById('goalkeeperReceivedZonesContainer');
    if (!zonesContainer) {
        zonesContainer = document.createElement('div');
        zonesContainer.id = 'goalkeeperReceivedZonesContainer';
        zonesContainer.style.marginTop = '30px';
        goalsBreakdown.parentNode.insertBefore(zonesContainer, goalsBreakdown.nextSibling);
    }
    
    // Calcular zones de gols rebuts
    const zones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    let totalGolsRebuts = 0;
    
    allMatches.forEach(match => {
        const player = match.jugadors.find(j => j.numero === data.num);
        if (player && player.estadistiques.golsRebutsZones) {
            Object.keys(player.estadistiques.golsRebutsZones).forEach(zone => {
                const count = player.estadistiques.golsRebutsZones[zone] || 0;
                zones[zone] = (zones[zone] || 0) + count;
                totalGolsRebuts += count;
            });
        }
    });
    
    if (totalGolsRebuts === 0) {
        zonesContainer.innerHTML = `
            <h3 class="section-title">🥅 Zones de Gols Rebuts</h3>
            <div class="no-data">No hi ha dades de zones de gols rebuts</div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️E', 'top-center': '⬆️C', 'top-right': '⬆️D',
        'mid-left': '➡️E', 'mid-center': '🎯', 'mid-right': '⬅️D',
        'bottom-left': '⬇️E', 'bottom-center': '⬇️B', 'bottom-right': '⬇️D'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    const weakestZone = zoneOrder.reduce((max, zone) => 
        (zones[zone] || 0) > (zones[max] || 0) ? zone : max, zoneOrder[0]);
    
    const weakestZoneNames = {
        'top-left': 'Dalt Esquerra', 'top-center': 'Dalt Centre', 'top-right': 'Dalt Dreta',
        'mid-left': 'Centre Esquerra', 'mid-center': 'Centre', 'mid-right': 'Centre Dreta',
        'bottom-left': 'Baix Esquerra', 'bottom-center': 'Baix Centre', 'bottom-right': 'Baix Dreta'
    };
    
    zonesContainer.innerHTML = `
        <h3 class="section-title">🥅 Zones de Gols Rebuts</h3>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
            <div style="font-size: 12px; color: #fca5a5;">Zona més feble</div>
            <div style="font-size: 18px; color: #ef4444; font-weight: bold; margin-top: 4px;">
                ${weakestZoneNames[weakestZone]} (${zones[weakestZone]} gols)
            </div>
        </div>
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGolsRebuts > 0 ? ((count / totalGolsRebuts) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fca5a5;">
            Total de gols rebuts amb zona: ${totalGolsRebuts}
        </div>
    `;
}
function displayPlayerStats(data) {

	document.getElementById('playerStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerName').textContent = `${data.num}. ${data.name}`;
    // ✅ NETEJA els contenidors de zones anteriors
    const oldGoalZones = document.getElementById('playerGoalZonesContainer');
    if (oldGoalZones) oldGoalZones.remove();
    
    const oldGkZones = document.getElementById('goalkeeperReceivedZonesContainer');
    if (oldGkZones) oldGkZones.remove();
    
    const avgGols = data.partidos > 0 ? (data.totalGols / data.partidos).toFixed(2) : 0;
    const avgExc = data.partidos > 0 ? (data.totalExclusions / data.partidos).toFixed(2) : 0;
    const totalTitular = data.titular.q1 + data.titular.q2 + data.titular.q3 + data.titular.q4;
    const maxPossibleTitular = data.partidos * 4;
    const titularPercentage = maxPossibleTitular > 0 ? ((totalTitular / maxPossibleTitular) * 100).toFixed(1) : 0;
    
    const bestMatch = Math.max(...data.gols);
    const bestMatchIndex = data.gols.indexOf(bestMatch);
    
    const isGoalkeeper = data.num === 1 || data.num === 13;

document.getElementById('playerSummaryGrid').innerHTML = `
    <div class="info-item">
        <div class="info-label">Partidos Jugados</div>
        <div class="info-value">${data.partidos}</div>
    </div>
    ${isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">🧤 Total Parades</div>
        <div class="info-value" style="color: #8b5cf6;">${data.totalParades || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Parades/Partido</div>
        <div class="info-value">${data.partidos > 0 ? (data.totalParades / data.partidos).toFixed(1) : '0.0'}</div>
    </div>
    ` : `
    <div class="info-item">
        <div class="info-label">Total Goles</div>
        <div class="info-value" style="color: #fde047;">${data.totalGols}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Goles/Partido</div>
        <div class="info-value">${avgGols}</div>
    </div>
    `}
    ${!isGoalkeeper ? `
    <div class="info-item">
        <div class="info-label">🎯 Eficiència de Tir</div>
        <div class="info-value" style="color: ${(() => {
            const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
            const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100) : 0;
            return efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
        })()};">
            ${(() => {
                const totalXuts = data.totalGols + (data.totalXutsFallats || 0);
                const efic = totalXuts > 0 ? (data.totalGols / totalXuts * 100).toFixed(1) : '0.0';
                return totalXuts > 0 ? `${data.totalGols}/${totalXuts} (${efic}%)` : '-';
            })()}
        </div>
    </div>
    ` : ''}
    <div class="info-item">
        <div class="info-label">Mejor Partido</div>
        <div class="info-value" style="color: #22c55e;">${isGoalkeeper ? (data.bestParades || 0) + ' parades' : bestMatch + ' goles'}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Total Exclusiones</div>
        <div class="info-value" style="color: #f97316;">${data.totalExclusions}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Media Exclusiones/Partido</div>
        <div class="info-value">${avgExc}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🎯 Assistències</div>
        <div class="info-value" style="color: #22c55e;">${data.totalAssistencies || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🛡️ Robatoris</div>
        <div class="info-value" style="color: #06b6d4;">${data.totalRobatoris || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">❌ Pèrdues</div>
        <div class="info-value" style="color: #ef4444;">${data.totalPerdues || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">🎯❌ Xuts Fallats</div>
        <div class="info-value" style="color: #f97316;">${data.totalXutsFallats || 0}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Penaltis Fallados</div>
        <div class="info-value" style="color: ${data.penaltyMissed === 0 ? '#22c55e' : '#ef4444'};">${data.penaltyMissed}</div>
    </div>
    <div class="info-item">
        <div class="info-label">Titularidad</div>
        <div class="info-value">${totalTitular}/${maxPossibleTitular} <span style="font-size: 14px;">(${titularPercentage}%)</span></div>
    </div>
    ${data.swimRacesTotal > 0 ? `
    <div class="info-item">
        <div class="info-label">🏊 Curses Guanyades</div>
        <div class="info-value" style="color: #22c55e;">${data.swimRacesWon}/${data.swimRacesTotal}</div>
    </div>
    <div class="info-item">
        <div class="info-label">% Curses</div>
        <div class="info-value" style="color: ${data.swimRacesTotal > 0 && (data.swimRacesWon / data.swimRacesTotal * 100) >= 50 ? '#22c55e' : '#ef4444'};">
            ${data.swimRacesTotal > 0 ? ((data.swimRacesWon / data.swimRacesTotal) * 100).toFixed(1) : '0'}%
        </div>
    </div>
    ` : ''}
`;

// Desglossament de gols o parades segons tipus de jugador
const goalLabels = {
    'h+': 'Superioridad (H+)',
    'penalty': 'Penaltis',
    'contra': 'Contraataques',
    'boya': 'Boya',
    'normal': 'Normales'
};

const paradeLabels = {
    'corner': 'Corner',
    'rebuig': 'Rebuig',
    'atrapa': 'Atrapa',
    'penal': 'Penal'
};
    
    if (isGoalkeeper) {
        // Per porters: mostrar parades
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.paradeTypes)
            .filter(type => data.paradeTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${paradeLabels[type]}</div>
                    <div class="breakdown-value">${data.paradeTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalParades > 0 ? ((data.paradeTypes[type] / data.totalParades) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de parades</p>';
        
        // Canviar el títol
        const titleElement = document.querySelector('#playerStatsCard h3');
        if (titleElement && titleElement.textContent.includes('Desglose de Goles')) {
            titleElement.textContent = '🧤 Desglose de Parades';
        }
        
        // Zones de gols rebuts pels porters
        renderGoalkeeperReceivedZones(data);
        
    } else {
        // Per jugadors de camp: mostrar gols
        document.getElementById('playerGoalsBreakdown').innerHTML = Object.keys(data.goalTypes)
            .filter(type => data.goalTypes[type] > 0)
            .map(type => `
                <div class="breakdown-item">
                    <div class="breakdown-label">${goalLabels[type]}</div>
                    <div class="breakdown-value">${data.goalTypes[type]}</div>
                    <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                        ${data.totalGols > 0 ? ((data.goalTypes[type] / data.totalGols) * 100).toFixed(1) : 0}%
                    </div>
                </div>
            `).join('') || '<p class="no-data" style="padding: 20px;">No hay datos de tipos de goles</p>';
        
        // Zones de gols per jugadors de camp
        renderPlayerGoalZones(data);
    }
    
    renderPlayerEvolutionChart(data);
    renderPlayerExclusionsChart(data);
    
    document.getElementById('playerStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderSwimRacesStats() {
    if (allMatches.length === 0) return;
    
    const swimStats = {};
    
    // Inicialitzar
    players.forEach(p => {
        swimStats[p.name] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '<div class="no-data">No hi ha dades de curses</div>';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">🏊 Estadístiques de Curses Inicials</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>🏆 Guanyades</th>
                            <th>❌ Perdudes</th>
                            <th>Total</th>
                            <th>% Èxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderPlayerEvolutionChart(data) {
    const ctx = document.getElementById('playerEvolutionChart');
    if (!ctx) return;
    
    if (window.playerEvolutionChartInstance) {
        window.playerEvolutionChartInstance.destroy();
    }
    
    window.playerEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Goles por Partido',
                data: data.gols,
                borderColor: '#fde047',
                backgroundColor: 'rgba(253, 224, 71, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#fde047'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerExclusionsChart(data) {
    const ctx = document.getElementById('playerExclusionsChart');
    if (!ctx) return;
    
    if (window.playerExclusionsChartInstance) {
        window.playerExclusionsChartInstance.destroy();
    }
    
    window.playerExclusionsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Exclusiones por Partido',
                data: data.exclusions,
                backgroundColor: '#f97316',
                borderColor: '#ea580c',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function clearPlayerFilter() {
    document.getElementById('filterPlayer').value = '';
    document.getElementById('playerStatsCard').classList.add('hidden');
}
function renderMatchTimeline() {
    const container = document.getElementById('matchTimeline');
    const swimRacesContainer = document.getElementById('matchSwimRacesContainer');
    const swimRacesCard = document.getElementById('swimRacesCard');
    
    if (!container || !currentMatch) return;
    
    // Verificar si hay acciones cronológicas guardadas
    if (!currentMatch.chronologicalActions || currentMatch.chronologicalActions.length === 0) {
        container.innerHTML = '<div class="no-timeline">⚠️ Este partido no tiene registro cronológico de acciones.<br><small style="margin-top: 8px; display: block;">Los partidos nuevos registrados con la app actualizada mostrarán las acciones en orden.</small></div>';
        
        // Ocultar card de curses si no hi ha dades
        if (swimRacesCard) swimRacesCard.style.display = 'none';
        
        return;
    }
    
    // ========== RENDERITZAR CURSES INICIALS (ABANS DE LA CRONOLOGIA) ==========
    const swimRaces = currentMatch.chronologicalActions?.filter(a => a.type === 'swim-race') || [];

    if (swimRaces.length > 0 && swimRacesContainer && swimRacesCard) {
        const swimHTML = `
            ${swimRaces.map(race => {
                const icon = race.result === 'win' ? '✅' : '❌';
                const color = race.result === 'win' ? '#22c55e' : '#ef4444';
                const quarter = race.quarter.toUpperCase();
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 6px; background: rgba(0,0,0,0.2); border-radius: 6px; border-left: 3px solid ${color};">
                        <span style="color: #bae6fd; font-weight: 600; min-width: 80px;">${quarter}</span>
                        <span style="color: white; flex: 1; text-align: center;">${race.playerName.split(' ')[0]}</span>
                        <span style="color: ${color}; font-weight: bold; min-width: 100px; text-align: right;">${icon} ${race.result === 'win' ? 'Guanyada' : 'Perduda'}</span>
                    </div>
                `;
            }).join('')}
        `;
        
        swimRacesContainer.innerHTML = swimHTML;
        swimRacesCard.style.display = 'block';
    } else {
        // Ocultar el card de curses si no n'hi ha
        if (swimRacesCard) swimRacesCard.style.display = 'none';
    }
 
    // ========== RENDERITZAR CRONOLOGIA DEL PARTIT ==========
    // Ordenar por timestamp
    const sortedActions = [...currentMatch.chronologicalActions]
        .sort((a, b) => a.timestamp - b.timestamp);
    
    const goalTypeLabels = {
        'h+': 'Superioridad (H+)',
        'penalty': 'Penalty',
        'contra': 'Contraataque',
        'boya': 'Boya',
        'normal': 'Normal'
    };
    
    const quarterLabels = {
        'q1': '1º Cuarto',
        'q2': '2º Cuarto',
        'q3': '3º Cuarto',
        'q4': '4º Cuarto'
    };
    
    container.innerHTML = `
        <div class="timeline">
            ${sortedActions.map(action => {
                let detailText = '';
                let icon = '';
                let cssClass = '';
                const isRival = action.team === 'rival';
                const playerClass = isRival ? 'timeline-rival' : 'timeline-player';
                const teamName = isRival ? (currentMatch.rivalTeam || 'Rival') : 'CN Terrassa';
                
                // PRIMER: Comprovar si és una acció (robatori, assistència, pèrdua, xut)
                if (action.type === 'action') {
                    if (action.actionType === 'robatori') {
                        icon = '🤚';
                        cssClass = 'goal';
                        detailText = 'Robatori';
                    } else if (action.actionType === 'perdua') {
                        icon = '🔄';
                        cssClass = 'exclusion';
                        detailText = 'Pèrdua de pilota';
                    } else if (action.actionType === 'assistencia') {
                        icon = '🎯';
                        cssClass = 'goal';
                        detailText = 'Assistència';
                    } else if (action.actionType === 'xut') {
                        icon = '🥅❌';
                        cssClass = 'exclusion';
                        detailText = 'Xut fallat';
                    }
					else if (action.actionType === 'block') {
					icon = '🚫';
					cssClass = 'goal';
					detailText = 'Blocatge';}
                } else if (action.type === 'save') {
                    icon = '🧤';
    cssClass = 'goal';
    detailText = action.saveType === 'atrapa' ? 'Aturada - Atrapa' : 'Aturada - Desvia';
                } else if (action.type === 'goal') {
                    icon = '🥅🏐';
                    cssClass = 'goal';
                    detailText = `Gol ${goalTypeLabels[action.goalType]}`;
                } else if (action.type === 'exclusion') {
    if (action.exclusionType === 'penalty') {
        icon = '🔴🏐';
        detailText = 'Penalty cometido';
    } else {
        icon = '🔴⏱️';
        detailText = 'Exclusión 20 seg.';
    }
    cssClass = 'exclusion';
    
    // Afegir informació de qui ha rebut la falta (si és exclusió rival)
    if (isRival && action.faltaSobreJugador) {
        const jugadorCNT = currentMatch.jugadors.find(j => j.numero == action.faltaSobreJugador);
        if (jugadorCNT) {
            detailText += ` <span style="font-size: 11px; opacity: 0.7;">(falta sobre ${jugadorCNT.numero}. ${jugadorCNT.nom.split(' ')[0]})</span>`;
        }
    }
                } else if (action.type === 'water-change') {
                    icon = action.action === 'in' ? '🏊🟢' : '🏊🔴';
                    cssClass = 'water-change';
                    detailText = action.action === 'in' ? 'Entra al agua' : 'Sale del agua';
                } else if (action.type === 'swim-race') {
                    icon = action.result === 'win' ? '🏊✅' : '🏊❌';
                    cssClass = action.result === 'win' ? 'goal' : 'exclusion';
                    detailText = `Cursa inici quart - ${action.result === 'win' ? 'Guanyada' : 'Perduda'}`;
                }
                
                return `
                    <div class="timeline-item ${cssClass}">
                        <div class="timeline-icon">${icon}</div>
                        <div class="timeline-content">
                            <div class="${playerClass}">
                                ${action.playerNum}. ${action.playerName}
                                <span style="font-size: 11px; opacity: 0.8;">(${teamName})</span>
                            </div>
                            <div class="timeline-detail">${detailText}</div>
                        </div>
                        <div class="timeline-quarter">${quarterLabels[action.quarter] || action.quarter}</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
function renderPlayingTimes() {
    const container = document.getElementById('playingTimesContainer');
    
    if (!container || !currentMatch) return;
    
    if (!currentMatch.playerWaterChanges || currentMatch.playerWaterChanges.length === 0 || !currentMatch.quarterStartTimes) {
        container.innerHTML = '<div class="no-data">⚠️ Aquest partit no té registre de temps de joc.</div>';
        return;
    }
    
    // Utilitzar la funció centralitzada
    const playerTimes = calculateMatchPlayingTimes(currentMatch);
    const players = Object.values(playerTimes).sort((a, b) => b.totalTime - a.totalTime);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const maxTime = 32 * 60; // 32 minuts màxim
    
    container.innerHTML = `
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Nº</th>
                    <th>Jugador</th>
                    <th>1Q</th>
                    <th>2Q</th>
                    <th>3Q</th>
                    <th>4Q</th>
                    <th>TOTAL</th>
                    <th>%</th>
                </tr>
            </thead>
            <tbody>
                ${players.map(p => {
                    const percentage = ((p.totalTime / maxTime) * 100).toFixed(1);
                    const color = percentage >= 75 ? '#22c55e' : percentage >= 50 ? '#fbbf24' : '#f97316';
                    
                    return `
                        <tr>
                            <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                            <td><strong>${p.name}</strong></td>
                            <td>${formatTime(p.q1)}</td>
                            <td>${formatTime(p.q2)}</td>
                            <td>${formatTime(p.q3)}</td>
                            <td>${formatTime(p.q4)}</td>
                            <td><strong style="color: #fde047;">${formatTime(p.totalTime)}</strong></td>
                            <td><strong style="color: ${color};">${percentage}%</strong></td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
        <p style="font-size: 12px; color: #bae6fd; margin-top: 12px; text-align: center;">
            ⏱️ Temps màxim: 32 minuts (4 quarts × 8 minuts)
        </p>
    `;
}
// ============================================
// FUNCIONES PARA ESTADÍSTICAS DE TIEMPO
// ============================================

function displayTimeStats() {
    console.log('=== displayTimeStats called ===');
    console.log('Total matches:', allMatches.length);
    console.log('allMatches:', allMatches);
    
    // Filtrar partidos con datos de tiempo
    matchesWithTime = allMatches.filter(m => {
        console.log('Checking match:', m.rivalTeam);
        console.log('- Has playerWaterChanges:', !!m.playerWaterChanges);
        console.log('- playerWaterChanges length:', m.playerWaterChanges ? m.playerWaterChanges.length : 0);
        console.log('- Has quarterStartTimes:', !!m.quarterStartTimes);
        
        // Excluir partidos sin datos de tiempo completos
        const hasTimeData = m.playerWaterChanges && 
                            m.playerWaterChanges.length > 0 && 
                            m.quarterStartTimes;
        
        if (!hasTimeData) {
            console.warn('Partido sin datos de tiempo completos:', m.rivalTeam);
        }
        
        return hasTimeData;
    });
    
    console.log('Matches with time data:', matchesWithTime.length);
    console.log('matchesWithTime:', matchesWithTime);
    
    if (matchesWithTime.length === 0) {
        document.getElementById('tiempoTab').innerHTML = `
            <div class="card">
                <div class="no-data">
                    <p style="color: #fbbf24; font-size: 18px; margin-bottom: 10px;">⚠️ No hay datos de tiempo disponibles</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Los partidos deben tener registrados los cambios de agua (playerWaterChanges) y tiempos de cuarto (quarterStartTimes) para mostrar estas estadísticas.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partidos cargados: ${allMatches.length}<br>
                        Partidos con datos de tiempo: 0
                    </p>
                </div>
            </div>
        `;
        return;
    }
    
    console.log('Calling populatePlayerTimeFilter...');
    populatePlayerTimeFilter();
    
    console.log('Calling renderTotalTimeChart...');
    renderTotalTimeChart();
    
    console.log('Calling renderTimeHeatmapTable...');
    renderTimeHeatmapTable();
   
    console.log('Calling other render functions...');
    renderEfficiencyPerMinuteChart();
    renderMinutesDistributionChart();
    renderPlusMinusChart();
    renderLoadBalanceStats();
    renderQuarterAnalysisTable();
    renderPerformanceVsTimeChart();
    renderFatigueAnalysisTable();
    renderRotationStats();
    
    console.log('=== displayTimeStats finished ===');
}

function populatePlayerTimeFilter() {
    const select = document.getElementById('filterPlayerTime');
    
    if (matchesWithTime.length === 0) return;
    
    const playerSet = new Set();
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(j => {
            playerSet.add(JSON.stringify({ num: j.numero, name: j.nom.trim() }));
        });
    });
    
    const players = Array.from(playerSet)
        .map(p => JSON.parse(p))
        .sort((a, b) => a.num - b.num);
    
    select.innerHTML = '<option value="">Todos los jugadores</option>' +
        players.map(p => `<option value="${p.name}">${p.num}. ${p.name}</option>`).join('');
}

function filterByPlayerTime() {
    const playerName = document.getElementById('filterPlayerTime').value;
    
    if (!playerName) {
        document.getElementById('playerTimeStatsCard').classList.add('hidden');
        return;
    }
    
    const playerTimeData = calculatePlayerTimeData(playerName);
    displayPlayerTimeStats(playerTimeData);
}

function clearPlayerTimeFilter() {
    document.getElementById('filterPlayerTime').value = '';
    document.getElementById('playerTimeStatsCard').classList.add('hidden');
}

function calculatePlayerTimeData(player) {
    const data = {
        num: player.numero,
        name: player.nom,
        partidos: 0,
        totalTime: 0,
        timeByQuarter: { q1: 0, q2: 0, q3: 0, q4: 0 },
        timeByMatch: [],
        dates: [],
        gols: 0,
        exclusions: 0,
        titularTime: 0,
        suplenteTime: 0,
        titularGols: 0,
        suplenteGols: 0,
        titularExclusions: 0,
        suplenteExclusions: 0
    };
    
    matchesWithTime.forEach(match => {
        const matchPlayer = match.jugadors.find(j => j.numero === player.numero);
        if (!matchPlayer) return;
        
        data.partidos++;
        data.dates.push(match.data ? new Date(match.data).toLocaleDateString('ca-ES') : 'N/A');
        data.gols += matchPlayer.estadistiques?.gols || 0;
        data.exclusions += matchPlayer.estadistiques?.exclusions || 0;
        
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        const playerTime = matchTimes[player.numero];
        
        if (playerTime) {
            let matchTime = 0;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const isTitular = match.lineups?.[quarter]?.includes(player.numero);
                const quarterTime = playerTime[quarter];
                
                data.timeByQuarter[quarter] += quarterTime;
                matchTime += quarterTime;
                
                if (isTitular) {
                    data.titularTime += quarterTime;
                } else {
                    data.suplenteTime += quarterTime;
                }
            });
            
            data.timeByMatch.push(matchTime);
            data.totalTime += matchTime;
        }
    });
    
    // Calcular proporció de gols/exclusions segons temps de titular/suplent
    if (data.totalTime > 0) {
        const titularRatio = data.titularTime / data.totalTime;
        data.titularGols = Math.round(data.gols * titularRatio);
        data.suplenteGols = data.gols - data.titularGols;
        data.titularExclusions = Math.round(data.exclusions * titularRatio);
        data.suplenteExclusions = data.exclusions - data.titularExclusions;
    }
    
    data.timeByMatch.reverse();
    data.dates.reverse();
    
    return data;
}
function displayPlayerTimeStats(data) {
    document.getElementById('playerTimeStatsCard').classList.remove('hidden');
    document.getElementById('selectedPlayerTimeName').textContent = `${data.num}. ${data.name}`;
    
    const avgTime = data.partidos > 0 ? (data.totalTime / data.partidos / 60).toFixed(1) : 0;
    const maxPossibleTime = data.partidos * 32;
    const timePercentage = maxPossibleTime > 0 ? ((data.totalTime / 60 / maxPossibleTime) * 100).toFixed(1) : 0;
    const goalsPerMinute = data.totalTime > 0 ? ((data.gols / (data.totalTime / 60))).toFixed(2) : 0;
    const exclusionsPerMinute = data.totalTime > 0 ? ((data.exclusions / (data.totalTime / 60))).toFixed(2) : 0;
    
  
    
    document.getElementById('playerTimeSummaryGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">Partidos con Datos</div>
            <div class="info-value">${data.partidos}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Total Jugado</div>
            <div class="info-value" style="color: #fde047;">${formatTime(data.totalTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio/Partido</div>
            <div class="info-value">${avgTime} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">% del Tiempo Máximo</div>
            <div class="info-value" style="color: ${timePercentage >= 75 ? '#22c55e' : timePercentage >= 50 ? '#fbbf24' : '#f97316'};">${timePercentage}%</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Goles</div>
            <div class="info-value" style="color: #22c55e;">${data.gols}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Goles por Minuto</div>
            <div class="info-value">${goalsPerMinute}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Total Exclusiones</div>
            <div class="info-value" style="color: #f97316;">${data.exclusions}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Exclusiones por Minuto</div>
            <div class="info-value">${exclusionsPerMinute}</div>
        </div>
    `;
    
    // Eficiencia breakdown
    document.getElementById('playerEfficiencyBreakdown').innerHTML = `
        <div class="breakdown-item">
            <div class="breakdown-label">Goles / Minuto</div>
            <div class="breakdown-value" style="color: #22c55e;">${goalsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Exclusiones / Minuto</div>
            <div class="breakdown-value" style="color: #f97316;">${exclusionsPerMinute}</div>
        </div>
        <div class="breakdown-item">
            <div class="breakdown-label">Ratio Gol/Exclusión</div>
            <div class="breakdown-value">${data.exclusions > 0 ? (data.gols / data.exclusions).toFixed(2) : data.gols}</div>
        </div>
    `;
    
    // Titular vs Suplente
    const titularMinutes = (data.titularTime / 60).toFixed(1);
    const suplenteMinutes = (data.suplenteTime / 60).toFixed(1);
    const titularGoalsPerMin = data.titularTime > 0 ? (data.titularGols / (data.titularTime / 60)).toFixed(2) : 0;
    const suplenteGoalsPerMin = data.suplenteTime > 0 ? (data.suplenteGols / (data.suplenteTime / 60)).toFixed(2) : 0;
    
    document.getElementById('playerTitularVsSuplenteGrid').innerHTML = `
        <div class="info-item">
            <div class="info-label">⚪ Tiempo como Titular</div>
            <div class="info-value" style="color: #22c55e;">${titularMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.titularGols} goles (${titularGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">🔴 Tiempo como Suplente</div>
            <div class="info-value" style="color: #fbbf24;">${suplenteMinutes} min</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${data.suplenteGols} goles (${suplenteGoalsPerMin}/min)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">⚡ Diferencia Eficiencia</div>
            <div class="info-value" style="color: ${titularGoalsPerMin > suplenteGoalsPerMin ? '#22c55e' : '#ef4444'};">
                ${titularGoalsPerMin > suplenteGoalsPerMin ? '+ Titular' : '+ Suplente'}
            </div>
        </div>
    `;
    
    renderPlayerTimeEvolutionChart(data);
    renderPlayerTimeByQuarterChart(data);
    
    document.getElementById('playerTimeStatsCard').scrollIntoView({ behavior: 'smooth' });
}

function renderPlayerTimeEvolutionChart(data) {
    const ctx = document.getElementById('playerTimeEvolutionChart');
    if (!ctx) return;
    
    if (window.playerTimeEvolutionChartInstance) {
        window.playerTimeEvolutionChartInstance.destroy();
    }
    
    const timeInMinutes = data.timeByMatch.map(t => (t / 60).toFixed(1));
    
    window.playerTimeEvolutionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Minutos Jugados',
                data: timeInMinutes,
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#06b6d4'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 32,
                    ticks: { color: 'white', stepSize: 4 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Minutos',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderPlayerTimeByQuarterChart(data) {
    const ctx = document.getElementById('playerTimeByQuarterChart');
    if (!ctx) return;
    
    if (window.playerTimeByQuarterChartInstance) {
        window.playerTimeByQuarterChartInstance.destroy();
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    const timeData = [data.timeByQuarter.q1, data.timeByQuarter.q2, data.timeByQuarter.q3, data.timeByQuarter.q4];
    
    window.playerTimeByQuarterChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tiempo Jugado (segundos)',
                data: timeData,
                backgroundColor: ['#22d3ee', '#06b6d4', '#0891b2', '#0e7490'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tiempo: ${formatTime(context.parsed.y)}`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}


// ============================================
// FUNCIONS AUXILIARS NECESSÀRIES (afegir ABANS de renderTotalTimeChart)
// ============================================

function getQuarterEndTimeHelper(quarterStartTimes, quarterRealEndTimes, quarter, quarterDuration) {
    // Prioritzar el temps real de finalització si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del següent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (quarterDuration * 1000);
}

function calculatePlayerWaterPercentage(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    // Verificar si el jugador és titular
    const lineup = lineups ? lineups[quarter] : [];
    const isTitular = lineup && lineup.includes(playerNum);
    
    // Obtenir els canvis del jugador
    const qChanges = playerWaterChanges
        .filter(c => c.playerNum === playerNum && c.quarter === quarter)
        .sort((a, b) => a.timestamp - b.timestamp);
    
    // Si és titular i no té canvis → 100% del temps
    if (isTitular && qChanges.length === 0) {
        return 1.0; // 100%
    }
    
    // Si NO és titular i no té canvis → 0% del temps
    if (!isTitular && qChanges.length === 0) {
        return 0.0; // 0%
    }
    
    const totalQuarterTime = (quarterEndTime - quarterStartTime) / 1000;
    if (totalQuarterTime <= 0) {
        return 0.0;
    }
    
    // Netejar canvis duplicats consecutius
    const cleanChanges = [];
    let lastAction = null;
    qChanges.forEach(change => {
        if (change.action !== lastAction) {
            cleanChanges.push(change);
            lastAction = change.action;
        }
    });
    
    let timeInWater = 0;
    
    if (isTitular) {
        // Titular: comença dins
        let lastInTime = quarterStartTime;
        
        cleanChanges.forEach(change => {
            if (change.action === 'out') {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            } else if (change.action === 'in') {
                lastInTime = change.timestamp;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    } else {
        // Suplent: comença fora
        let lastInTime = null;
        
        cleanChanges.forEach(change => {
            if (change.action === 'in') {
                lastInTime = change.timestamp;
            } else if (change.action === 'out' && lastInTime !== null) {
                timeInWater += (change.timestamp - lastInTime) / 1000;
                lastInTime = null;
            }
        });
        
        if (lastInTime !== null) {
            timeInWater += (quarterEndTime - lastInTime) / 1000;
        }
    }
    
    // Retornar el percentatge (0.0 a 1.0)
    return Math.min(timeInWater / totalQuarterTime, 1.0);
}

/**
 * SUBSTITUIR L'EXISTENT: Calcula el temps real aplicant el percentatge als 8 minuts teòrics
 */
function calculateQuarterTimeForPlayerHelper(playerNum, quarter, playerWaterChanges, quarterStartTime, quarterEndTime, lineups) {
    const QUARTER_DURATION = 480; // 8 minuts = 480 segons
    
    if (!quarterStartTime) {
        return 0;
    }
    
    // Obtenir el percentatge de temps dins de l'aigua
    const percentage = calculatePlayerWaterPercentage(
        playerNum, 
        quarter, 
        playerWaterChanges, 
        quarterStartTime, 
        quarterEndTime, 
        lineups
    );
    
    // Aplicar aquest percentatge als 8 minuts teòrics
    const adjustedTime = QUARTER_DURATION * percentage;
    
    return Math.round(adjustedTime);
}

function calculateMatchPlayingTimes(match) {
    const playerTimes = {};
    const quarterDuration = 480; // 8 minuts en segons
    const totalQuarterTime = 3360; // 7 jugadors x 480 segons = 3360 segons
    
    // Inicialitzar jugadors
    match.jugadors.forEach(player => {
        playerTimes[player.numero] = {
            num: player.numero,
            name: player.nom,
            q1: 0,
            q2: 0,
            q3: 0,
            q4: 0,
            totalTime: 0,
            partidos: 1
        };
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    
    quarters.forEach(quarter => {
        const quarterStartTime = match.quarterStartTimes?.[quarter];
        if (!quarterStartTime) return;
        
        // Calcular el temps de finalització del quart
        const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
        const currentIndex = quarterOrder.indexOf(quarter);
        let quarterEndTime;
        
        if (match.quarterRealEndTimes && match.quarterRealEndTimes[quarter]) {
            quarterEndTime = match.quarterRealEndTimes[quarter];
        } else if (currentIndex < 3) {
            const nextQuarter = quarterOrder[currentIndex + 1];
            if (match.quarterStartTimes[nextQuarter]) {
                quarterEndTime = match.quarterStartTimes[nextQuarter];
            } else {
                quarterEndTime = quarterStartTime + (quarterDuration * 1000);
            }
        } else {
            quarterEndTime = quarterStartTime + (quarterDuration * 1000);
        }
        
        const quarterChanges = match.playerWaterChanges
            .filter(c => c.quarter === quarter)
            .sort((a, b) => a.timestamp - b.timestamp);
        
        // Primer pas: calcular temps reals i identificar jugadors que juguen tot el quart
        const rawTimes = {};
        const playersFullQuarter = [];
        let sumRawTimesPartial = 0;
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            const isTitular = match.lineups?.[quarter]?.includes(playerNum);
            
            const playerChanges = quarterChanges.filter(c => c.playerNum === playerNum);
            
            // Eliminar canvis duplicats consecutius
            const cleanChanges = [];
            let lastAction = null;
            playerChanges.forEach(change => {
                if (change.action !== lastAction) {
                    cleanChanges.push(change);
                    lastAction = change.action;
                }
            });
            
            let timeInWater = 0;
            let playsFullQuarter = false;
            
            if (isTitular) {
                let lastInTime = quarterStartTime;
                
                cleanChanges.forEach(change => {
                    if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    } else if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    }
                });
                
                if (lastInTime !== null) {
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                // Si és titular i no té canvis d'out, juga tot el quart
               if (timeInWater > 847) {
    playsFullQuarter = true;
}
                console.log(`Jugador ${playerNum}: ${timeInWater.toFixed(0)}s, Titular: ${isTitular}, Canvis: ${cleanChanges.length}, Juga complet: ${playsFullQuarter}`);
            } else {
                let lastInTime = null;
                
                cleanChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
            }
            console.log(`Jugador ${playerNum}: ${timeInWater.toFixed(0)}s, Titular: ${isTitular}, Canvis: ${cleanChanges.length}, Juga complet: ${playsFullQuarter}`);
            rawTimes[playerNum] = Math.max(0, Math.min(timeInWater, quarterDuration));
            
            if (playsFullQuarter) {
                playersFullQuarter.push(playerNum);
            } else {
                sumRawTimesPartial += rawTimes[playerNum];
            }
        });
        
        // Segon pas: assignar temps
        const timeUsedByFullQuarter = playersFullQuarter.length * quarterDuration;
        const remainingTime = totalQuarterTime - timeUsedByFullQuarter;
        
        match.jugadors.forEach(player => {
            const playerNum = player.numero;
            
            if (playersFullQuarter.includes(playerNum)) {
                // Jugador que juga tot el quart: exactament 480 segons
                playerTimes[playerNum][quarter] = quarterDuration;
            } else {
                // Jugador parcial: ponderar amb el temps restant
                if (sumRawTimesPartial > 0) {
                    const adjustedTime = Math.round((rawTimes[playerNum] / sumRawTimesPartial) * remainingTime);
                    playerTimes[playerNum][quarter] = adjustedTime;
                } else {
                    playerTimes[playerNum][quarter] = 0;
                }
            }
            
            playerTimes[playerNum].totalTime += playerTimes[playerNum][quarter];
        });
    });
    
    return playerTimes;
}

function renderTotalTimeChart() {
    const ctx = document.getElementById('totalTimeChart');
    if (!ctx) return;
    
    if (window.totalTimeChartInstance) {
        window.totalTimeChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    partidos: 0
                };
            }
            
            playerTimes[playerName].totalTime += playerTime.totalTime;
            playerTimes[playerName].partidos += 1;
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 15);
    
    document.getElementById('timeChartSubtitle').textContent = 
        `Basado en ${matchesWithTime.length} partido(s) con datos de tiempo`;
    
    window.totalTimeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: players.map(p => `${p.num}. ${p.name}`),
            datasets: [{
                label: 'Tiempo Total (segundos)',
                data: players.map(p => p.totalTime),
                backgroundColor: 'rgba(34, 211, 238, 0.7)',
                borderColor: 'rgba(34, 211, 238, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const seconds = context.parsed.y;
                            const minutes = Math.floor(seconds / 60);
                            const secs = seconds % 60;
                            return `${minutes}:${secs.toString().padStart(2, '0')} minutos`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return formatTime(value);
                        }
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
function renderTimeHeatmapTable() {
    const table = document.getElementById('timeHeatmapTable');
    if (!table) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció amb ponderació
        const matchTimes = calculateMatchPlayingTimes(match);
        
        Object.values(matchTimes).forEach(playerTime => {
            const playerName = playerTime.name.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    q1: 0, q2: 0, q3: 0, q4: 0, total: 0
                };
            }
            
            playerTimes[playerName].q1 += playerTime.q1;
            playerTimes[playerName].q2 += playerTime.q2;
            playerTimes[playerName].q3 += playerTime.q3;
            playerTimes[playerName].q4 += playerTime.q4;
            playerTimes[playerName].total += playerTime.totalTime;
        });
    });
    
    const players = Object.values(playerTimes).sort((a, b) => b.total - a.total);
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function getHeatColor(seconds, maxSeconds) {
        const ratio = seconds / maxSeconds;
        if (ratio >= 0.75) return 'background: rgba(34, 197, 94, 0.3);';
        if (ratio >= 0.5) return 'background: rgba(251, 191, 36, 0.3);';
        if (ratio >= 0.25) return 'background: rgba(249, 115, 22, 0.3);';
        return 'background: rgba(239, 68, 68, 0.3);';
    }
    
    const maxTime = Math.max(...players.map(p => p.total));
    
    const quarterTotals = { q1: 0, q2: 0, q3: 0, q4: 0, total: 0 };
    players.forEach(p => {
        quarterTotals.q1 += p.q1;
        quarterTotals.q2 += p.q2;
        quarterTotals.q3 += p.q3;
        quarterTotals.q4 += p.q4;
        quarterTotals.total += p.total;
    });
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Nº</th>
                <th>Jugador</th>
                <th>1Q</th>
                <th>2Q</th>
                <th>3Q</th>
                <th>4Q</th>
                <th>TOTAL</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
                    <td style="${getHeatColor(p.q1, maxTime / 4)}">${formatTime(p.q1)}</td>
                    <td style="${getHeatColor(p.q2, maxTime / 4)}">${formatTime(p.q2)}</td>
                    <td style="${getHeatColor(p.q3, maxTime / 4)}">${formatTime(p.q3)}</td>
                    <td style="${getHeatColor(p.q4, maxTime / 4)}">${formatTime(p.q4)}</td>
                    <td style="background: rgba(34, 211, 238, 0.3);"><strong>${formatTime(p.total)}</strong></td>
                </tr>
            `).join('')}
            <tr style="background: rgba(34, 211, 238, 0.2); font-weight: bold; border-top: 2px solid #22d3ee;">
                <td colspan="2">TOTAL PER QUART</td>
                <td>${formatTime(quarterTotals.q1)}</td>
                <td>${formatTime(quarterTotals.q2)}</td>
                <td>${formatTime(quarterTotals.q3)}</td>
                <td>${formatTime(quarterTotals.q4)}</td>
                <td>${formatTime(quarterTotals.total)}</td>
            </tr>
            <tr style="background: rgba(251, 191, 36, 0.2); font-weight: bold;">
                <td colspan="2">ESPERAT (7 jug × 8 min)</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>56:00</td>
                <td>224:00</td>
            </tr>
        </tbody>
    `;
}
  
function renderEfficiencyPerMinuteChart() {
    const ctx = document.getElementById('efficiencyPerMinuteChart');
    if (!ctx) return;
    
    if (window.efficiencyPerMinuteChartInstance) {
        window.efficiencyPerMinuteChartInstance.destroy();
    }
    
    const playerStats = {};
    
    matchesWithTime.forEach(match => {
        // Utilitzar la funció centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            const playerName = playerTime.name;
            
            if (!playerStats[playerName]) {
                playerStats[playerName] = {
                    num: playerTime.num,
                    name: playerName,
                    totalTime: 0,
                    gols: 0,
                    exclusions: 0
                };
            }
            
            playerStats[playerName].totalTime += playerTime.total;
            playerStats[playerName].gols += player.estadistiques.gols;
            playerStats[playerName].exclusions += player.estadistiques.exclusions;
        });
    });
    
    const players = Object.values(playerStats)
        .filter(p => p.totalTime > 0)
        .map(p => ({
            ...p,
            goalsPerMinute: (p.gols / (p.totalTime / 60)).toFixed(2),
            exclusionsPerMinute: (p.exclusions / (p.totalTime / 60)).toFixed(2)
        }))
        .sort((a, b) => b.goalsPerMinute - a.goalsPerMinute);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const goalsData = players.map(p => parseFloat(p.goalsPerMinute));
    const exclusionsData = players.map(p => parseFloat(p.exclusionsPerMinute));
    
    window.efficiencyPerMinuteChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Goles/Minuto',
                    data: goalsData,
                    backgroundColor: '#22c55e',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                },
                {
                    label: 'Exclusiones/Minuto',
                    data: exclusionsData,
                    backgroundColor: '#f97316',
                    borderWidth: 1,
                    borderColor: '#1e3a8a'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: { 
                    ticks: { color: 'white', font: { size: 11 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// Función para calcular valoración de jugador
function calculatePlayerValue(stats) {
    // Assegurar que stats existeix
    if (!stats) return 0;
    
    // Obtenir estadístiques amb valors per defecte
    const gols = stats.gols ?? 0;
    const goalTypes = stats.goalTypes || {};
    const exclusionTypes = stats.exclusionTypes || {};
    const paradeTypes = stats.paradeTypes || {};
    
    // Accions positives
    const normalGoals = (goalTypes.normal || 0) + (goalTypes['h+'] || 0) + 
                       (goalTypes.contra || 0) + (goalTypes.boya || 0);
    const penaltyGoals = goalTypes.penalty || 0;
    
    // Altres accions positives
    const assists = stats.assistencies || stats.assists || 0;
    const steals = stats.robatoris || stats.steals || 0;
    const blocks = stats.blocks || stats.blocatges || 0;
    const foulsReceived = stats.faltesRebudes || stats.foulReceived || 0;
    
    // ⚠️ CANVI: Parades ara sumen +1 (abans +2)
    const saves = (paradeTypes.corner || 0) + (paradeTypes.rebuig || 0) + 
                 (paradeTypes.atrapa || 0);
    const penaltySaves = paradeTypes.penal || 0;
    
    // Accions negatives
    const exclusions = stats.exclusions || 0;
    const penaltyMissed = stats.penaltyMissed || 0;
    const turnovers = stats.perdues || stats.turnovers || 0;
    const shotsMissed = stats.xutsFallats || stats.shotsMissed || 0;
    
    // ⚠️ NOU: Gols rebuts pel porter
    const golsRebuts = stats.golsRebuts || 0;
    
    // CÀLCUL DEL VALOR
    let valor = 0;
    
    // Positives
    valor += normalGoals * 2;      // Gols normals: +2
    valor += penaltyGoals * 1;     // Gols penalty: +1
    valor += assists * 1;          // Assistències: +1
    valor += steals * 1;           // Robatoris: +1
    valor += blocks * 1;           // Blocks: +1
    valor += saves * 1;            // ⚠️ CANVI: Parades: +1 (abans +2)
    valor += penaltySaves * 2;     // ⚠️ CANVI: Parades penalty: +2 (abans +3)
    valor += foulsReceived * 1;    // Faltes rebudes: +1
    
    // Negatives
    valor += exclusions * (-1);    // Exclusions: -1
    valor += penaltyMissed * (-2); // Penalty fallat: -2
    valor += turnovers * (-0.5);   // Pèrdues: -0.5
    valor += shotsMissed * (-0.5); // Xuts fallats: -0.5
    valor += golsRebuts * (-0.5);    // ⚠️ NOU: Gols rebuts: -0.5
    
    return valor;
}
function renderMinutesDistributionChart() {
    const ctx = document.getElementById('minutesDistributionChart');
    if (!ctx) return;
    
    if (window.minutesDistributionChartInstance) {
        window.minutesDistributionChartInstance.destroy();
    }
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480; // 8 minutos máximo por cuarto
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                // Eliminar duplicados
                const uniqueChanges = [];
                const seenTimestamps = new Set();
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                qChanges.forEach(change => {
                    if (!seenTimestamps.has(change.timestamp)) {
                        seenTimestamps.add(change.timestamp);
                        uniqueChanges.push(change);
                    }
                });
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                
                if (!quarterStartTime) return;
                
                uniqueChanges.forEach(change => {
                    if (change.timestamp < quarterStartTime || change.timestamp > quarterEndTime) return;
                    
                    if (change.action === 'in' && lastInTime === null) {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        const duration = (change.timestamp - lastInTime) / 1000;
                        if (duration > 0 && duration <= quarterDuration) {
                            timeInWater += duration;
                        }
                        lastInTime = null;
                    }
                });
                
                // Si todavía está dentro al final del cuarto
                if (lastInTime !== null && lastInTime < quarterEndTime) {
                    const duration = (quarterEndTime - lastInTime) / 1000;
                    if (duration > 0 && duration <= quarterDuration) {
                        timeInWater += duration;
                    }
                }
                
                // ✅ LIMITAR A 8 MINUTOS (480 segundos) POR CUARTO
                const quarterTime = Math.min(Math.max(0, Math.round(timeInWater)), quarterDuration);
                playerTimes[playerName].totalTime += quarterTime;
            });
        });
    });
    
    const players = Object.values(playerTimes)
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 10);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const timeInMinutes = players.map(p => (p.totalTime / 60).toFixed(1));
    
    const colors = [
        '#22d3ee', '#06b6d4', '#0891b2', '#0e7490',
        '#fde047', '#fbbf24', '#f59e0b', '#d97706',
        '#22c55e', '#16a34a'
    ];
    
    window.minutesDistributionChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: timeInMinutes,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    position: 'right',
                    labels: { 
                        color: 'white', 
                        font: { size: 12 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} min (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function renderPlusMinusChart() {
    const ctx = document.getElementById('plusMinusChart');
    if (!ctx) return;
    
    if (window.plusMinusChartInstance) {
        window.plusMinusChartInstance.destroy();
    }
    
    const playerPlusMinus = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const goalsFor = match.periodScores[quarter].cnt;
            const goalsAgainst = match.periodScores[quarter].rival;
            const diff = goalsFor - goalsAgainst;
            
            const playersInQuarter = new Set();
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            qChanges.forEach(change => {
                if (change.action === 'in') {
                    playersInQuarter.add(change.playerNum);
                }
            });
            
            lineup.forEach(playerNum => {
                playersInQuarter.add(playerNum);
            });
            
            playersInQuarter.forEach(playerNum => {
                const player = match.jugadors.find(j => j.numero === playerNum);
                if (!player) return;
                
                const playerName = player.nom.trim();
                
                if (!playerPlusMinus[playerName]) {
                    playerPlusMinus[playerName] = {
                        num: player.numero,
                        name: playerName,
                        plusMinus: 0,
                        quarters: 0
                    };
                }
                
                playerPlusMinus[playerName].plusMinus += diff;
                playerPlusMinus[playerName].quarters++;
            });
        });
    });
    
    const players = Object.values(playerPlusMinus)
        .map(p => ({
            ...p,
            avgPlusMinus: (p.plusMinus / p.quarters).toFixed(2)
        }))
        .sort((a, b) => b.plusMinus - a.plusMinus);
    
    const labels = players.map(p => `${p.num}. ${p.name.split(' ')[0]}`);
    const data = players.map(p => p.plusMinus);
    const colors = data.map(pm => pm >= 0 ? '#22c55e' : '#ef4444');
    
    window.plusMinusChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Plus/Minus Total',
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const player = players[idx];
                            return [
                                `Plus/Minus: ${context.parsed.x > 0 ? '+' : ''}${context.parsed.x}`,
                                `Promedio: ${player.avgPlusMinus > 0 ? '+' : ''}${player.avgPlusMinus} por cuarto`,
                                `Cuartos jugados: ${player.quarters}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    ticks: { 
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 10 : 12 }
                    },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles',
                        color: 'white',
                        font: { size: window.innerWidth < 768 ? 11 : 14 }
                    }
                },
                y: { 
                    ticks: { 
                        color: 'white', 
                        font: { size: window.innerWidth < 768 ? 9 : 11 },
                        autoSkip: false
                    },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
} 

function renderLoadBalanceStats() {
    const container = document.getElementById('loadBalanceGrid');
    const chartCtx = document.getElementById('loadBalanceChart');
    if (!container || !chartCtx) return;
    
    const playerTimes = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerTimes[playerName]) {
                playerTimes[playerName] = {
                    num: player.numero,
                    name: playerName,
                    totalTime: 0
                };
            }
            
            const quarterDuration = 480;
            
            ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
                const qChanges = match.playerWaterChanges.filter(c => c.playerNum === player.numero && c.quarter === quarter);
                if (qChanges.length === 0) return;
                
                qChanges.sort((a, b) => a.timestamp - b.timestamp);
                
                let timeInWater = 0;
                let lastInTime = null;
                const quarterStartTime = getQuarterRealStartTime(match, quarter);
                
                if (!quarterStartTime) return;
                
                qChanges.forEach(change => {
                    if (change.action === 'in') {
                        lastInTime = change.timestamp;
                    } else if (change.action === 'out' && lastInTime !== null) {
                        timeInWater += (change.timestamp - lastInTime) / 1000;
                        lastInTime = null;
                    }
                });
                
                if (lastInTime !== null) {
                    const quarterEndTime = quarterStartTime + quarterDuration * 1000;
                    timeInWater += (quarterEndTime - lastInTime) / 1000;
                }
                
                playerTimes[playerName].totalTime += Math.round(timeInWater);
            });
        });
    });
    
    const players = Object.values(playerTimes);
    const times = players.map(p => p.totalTime / 60);
    
    const maxTime = Math.max(...times);
    const minTime = Math.min(...times);
    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
    
    const variance = times.reduce((sum, time) => sum + Math.pow(time - avgTime, 2), 0) / times.length;
    const stdDev = Math.sqrt(variance);
    
    const maxPlayer = players.find(p => (p.totalTime / 60) === maxTime);
    const minPlayer = players.find(p => (p.totalTime / 60) === minTime);
    
    function formatTime(minutes) {
        const mins = Math.floor(minutes);
        const secs = Math.round((minutes - mins) * 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    let balanceStatus = '';
    let balanceColor = '';
    if (stdDev < 3) {
        balanceStatus = '✅ Excelente equidad';
        balanceColor = '#22c55e';
    } else if (stdDev < 5) {
        balanceStatus = '⚠️ Rotación moderada';
        balanceColor = '#fbbf24';
    } else {
        balanceStatus = '❌ Rotación desigual';
        balanceColor = '#ef4444';
    }
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Desviación Estándar</div>
            <div class="info-value" style="color: ${balanceColor};">${stdDev.toFixed(1)} min</div>
        </div>
        <div class="info-item">
            <div class="info-label">Tiempo Promedio</div>
            <div class="info-value">${formatTime(avgTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Más Minutos</div>
            <div class="info-value">${maxPlayer.num}. ${maxPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(maxTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador con Menos Minutos</div>
            <div class="info-value">${minPlayer.num}. ${minPlayer.name.split(' ')[0]}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${formatTime(minTime)}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Diferencia Máx-Mín</div>
            <div class="info-value" style="color: ${balanceColor};">${formatTime(maxTime - minTime)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Estado de Balance</div>
            <div class="info-value" style="color: ${balanceColor}; font-size: 16px;">${balanceStatus}</div>
        </div>
    `;
    
    if (window.loadBalanceChartInstance) {
        window.loadBalanceChartInstance.destroy();
    }
    
    window.loadBalanceChartInstance = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: ['< 15min', '15-20min', '20-25min', '25-30min', '> 30min'],
            datasets: [{
                label: 'Número de Jugadores',
                data: [
                    times.filter(t => t < 15).length,
                    times.filter(t => t >= 15 && t < 20).length,
                    times.filter(t => t >= 20 && t < 25).length,
                    times.filter(t => t >= 25 && t < 30).length,
                    times.filter(t => t >= 30).length
                ],
                backgroundColor: ['#ef4444', '#f97316', '#fbbf24', '#22c55e', '#06b6d4'],
                borderWidth: 1,
                borderColor: '#1e3a8a'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Jugadores',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}

function renderQuarterAnalysisTable() {
    const table = document.getElementById('quarterAnalysisTable');
    if (!table) return;
    
    const quarterStats = {
        q1: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q2: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q3: { changes: 0, uniquePlayers: new Set(), totalTime: 0 },
        q4: { changes: 0, uniquePlayers: new Set(), totalTime: 0 }
    };
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = getQuarterRealStartTime(match, quarter);
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            let realChanges = 0;
            
            // Contar solo entradas que NO sean las iniciales de los titulares
            // Una entrada de un suplente = 1 cambio real
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS de jugadores que NO sean titulares iniciales
                // Esto cuenta las rotaciones reales (cuando entra un suplente)
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    realChanges++;
                }
                
                quarterStats[quarter].uniquePlayers.add(change.playerNum);
            });
            
            quarterStats[quarter].changes += realChanges;
            quarterStats[quarter].totalTime += 480;
        });
    });
    
    const quarters = ['q1', 'q2', 'q3', 'q4'];
    const labels = ['1º Cuarto', '2º Cuarto', '3º Cuarto', '4º Cuarto'];
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Cuarto</th>
                <th>Total Cambios</th>
                <th>Promedio Cambios/Partido</th>
                <th>Jugadores Únicos</th>
                <th>Promedio Jugadores/Partido</th>
            </tr>
        </thead>
        <tbody>
            ${quarters.map((q, i) => {
                const avgChanges = (quarterStats[q].changes / matchesWithTime.length).toFixed(1);
                const avgPlayers = (quarterStats[q].uniquePlayers.size / matchesWithTime.length).toFixed(1);
                
                return `
                    <tr>
                        <td><strong>${labels[i]}</strong></td>
                        <td>${quarterStats[q].changes}</td>
                        <td>${avgChanges}</td>
                        <td>${quarterStats[q].uniquePlayers.size}</td>
                        <td>${avgPlayers}</td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}


function renderPerformanceVsTimeChart() {
    const ctx = document.getElementById('performanceVsTimeChart');
    if (!ctx) return;
    
    if (window.performanceVsTimeChartInstance) {
        window.performanceVsTimeChartInstance.destroy();
    }
    
    const playerMatchData = [];
    
    matchesWithTime.forEach(match => {
        const teamResult = match.scoreCNT - match.scoreRival;
        
        // Utilitzar la funció centralitzada
        const playerTimes = calculateMatchPlayingTimes(match);
        
        Object.values(playerTimes).forEach(playerTime => {
            const player = match.jugadors.find(j => j.numero === playerTime.num);
            if (!player) return;
            
            playerMatchData.push({
                player: `${playerTime.num}. ${playerTime.name}`,
                time: playerTime.total / 60, // convertir a minuts
                gols: player.estadistiques.gols,
                result: teamResult
            });
        });
    });
    
    const playerAvgs = {};
    playerMatchData.forEach(data => {
        if (!playerAvgs[data.player]) {
            playerAvgs[data.player] = { times: [], results: [] };
        }
        playerAvgs[data.player].times.push(data.time);
        playerAvgs[data.player].results.push(data.result);
    });
    
    const scatterData = Object.keys(playerAvgs).map(player => {
        const avgTime = playerAvgs[player].times.reduce((a, b) => a + b, 0) / playerAvgs[player].times.length;
        const avgResult = playerAvgs[player].results.reduce((a, b) => a + b, 0) / playerAvgs[player].results.length;
        return {
            x: avgTime,
            y: avgResult,
            label: player
        };
    });
    
    window.performanceVsTimeChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Jugadores',
                data: scatterData,
                backgroundColor: '#22d3ee',
                borderColor: '#06b6d4',
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return [
                                context.raw.label,
                                `Tiempo promedio: ${context.parsed.x.toFixed(1)} min`,
                                `Diferencia promedio: ${context.parsed.y > 0 ? '+' : ''}${context.parsed.y.toFixed(1)} goles`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Tiempo Promedio Jugado (minutos)',
                        color: 'white'
                    }
                },
                y: { 
                    ticks: { color: 'white' },
                    grid: { 
                        color: 'rgba(255,255,255,0.1)',
                        drawBorder: false
                    },
                    title: {
                        display: true,
                        text: 'Diferencia de Goles Promedio',
                        color: 'white'
                    }
                }
            }
        }
    });
}

function renderFatigueAnalysisTable() {
    const table = document.getElementById('fatigueAnalysisTable');
    if (!table) return;
    
    const playerFatigue = {};
    
    matchesWithTime.forEach(match => {
        match.jugadors.forEach(player => {
            const playerName = player.nom.trim();
            
            if (!playerFatigue[playerName]) {
                playerFatigue[playerName] = {
                    num: player.numero,
                    name: playerName,
                    q1: { gols: 0, exclusions: 0, matches: 0 },
                    q4: { gols: 0, exclusions: 0, matches: 0 }
                };
            }
            
            const playedQ1 = match.lineups.q1 && match.lineups.q1.includes(player.numero);
            const playedQ4 = match.lineups.q4 && match.lineups.q4.includes(player.numero);
            
            if (playedQ1) {
                playerFatigue[playerName].q1.matches++;
                playerFatigue[playerName].q1.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q1.exclusions += player.estadistiques.exclusions / 4;
            }
            
            if (playedQ4) {
                playerFatigue[playerName].q4.matches++;
                playerFatigue[playerName].q4.gols += player.estadistiques.gols / 4;
                playerFatigue[playerName].q4.exclusions += player.estadistiques.exclusions / 4;
            }
        });
    });
    
    const players = Object.values(playerFatigue)
        .filter(p => p.q1.matches > 0 && p.q4.matches > 0)
        .sort((a, b) => a.num - b.num);
    
    table.innerHTML = `
        <thead>
            <tr>
                <th>Nº</th>
                <th>Jugador</th>
                <th colspan="2">1º Cuarto (Inicio)</th>
                <th colspan="2">4º Cuarto (Final)</th>
                <th>Cambio Goles</th>
                <th>Cambio Exc</th>
                <th>Fatiga</th>
            </tr>
            <tr style="font-size: 11px;">
                <th></th>
                <th></th>
                <th>Goles</th>
                <th>Exc</th>
                <th>Goles</th>
                <th>Exc</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const q1GoalsAvg = (p.q1.gols / p.q1.matches).toFixed(2);
                const q4GoalsAvg = (p.q4.gols / p.q4.matches).toFixed(2);
                const q1ExcAvg = (p.q1.exclusions / p.q1.matches).toFixed(2);
                const q4ExcAvg = (p.q4.exclusions / p.q4.matches).toFixed(2);
                
                const goalsDiff = (q4GoalsAvg - q1GoalsAvg).toFixed(2);
                const excDiff = (q4ExcAvg - q1ExcAvg).toFixed(2);
                
                let fatigueIndicator = '';
                let fatigueColor = '';
                
                if (goalsDiff < -0.2 && excDiff > 0.2) {
                    fatigueIndicator = '😓 Alta';
                    fatigueColor = '#ef4444';
                } else if (goalsDiff < -0.1 || excDiff > 0.1) {
                    fatigueIndicator = '⚠️ Media';
                    fatigueColor = '#fbbf24';
                } else if (goalsDiff >= 0) {
                    fatigueIndicator = '✅ Baja';
                    fatigueColor = '#22c55e';
                } else {
                    fatigueIndicator = '➖ Normal';
                    fatigueColor = '#06b6d4';
                }
                
                return `
                    <tr>
                        <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                        <td><strong>${p.name}</strong></td>
                        <td>${q1GoalsAvg}</td>
                        <td>${q1ExcAvg}</td>
                        <td>${q4GoalsAvg}</td>
                        <td>${q4ExcAvg}</td>
                        <td style="color: ${goalsDiff >= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${goalsDiff > 0 ? '+' : ''}${goalsDiff}
                        </td>
                        <td style="color: ${excDiff <= 0 ? '#22c55e' : '#ef4444'}; font-weight: bold;">
                            ${excDiff > 0 ? '+' : ''}${excDiff}
                        </td>
                        <td style="color: ${fatigueColor}; font-weight: bold;">
                            ${fatigueIndicator}
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function renderRotationStats() {
    const container = document.getElementById('rotationStatsGrid');
    if (!container) return;
    
    let totalChanges = 0;
    let totalQuarters = 0;
    const playerRotations = {};
    
    matchesWithTime.forEach(match => {
        ['q1', 'q2', 'q3', 'q4'].forEach(quarter => {
            const qChanges = match.playerWaterChanges.filter(c => c.quarter === quarter);
            const quarterStartTime = match.quarterStartTimes[quarter];
            const lineup = match.lineups[quarter] || [];
            
            // Ordenar cambios por timestamp
            qChanges.sort((a, b) => a.timestamp - b.timestamp);
            
            // Contar solo entradas de no-titulares (rotaciones reales)
            qChanges.forEach(change => {
                const isTitular = lineup.includes(change.playerNum);
                const isInitialEntry = change.action === 'in' && 
                                      Math.abs(change.timestamp - quarterStartTime) < 5000;
                
                // Contar solo ENTRADAS que no sean iniciales de titulares
                if (change.action === 'in' && !(isTitular && isInitialEntry)) {
                    totalChanges++;
                    
                    if (!playerRotations[change.playerNum]) {
                        playerRotations[change.playerNum] = 0;
                    }
                    playerRotations[change.playerNum]++;
                }
            });
        });
        
        totalQuarters += 4;
    });
    
    const avgChangesPerMatch = (totalChanges / matchesWithTime.length).toFixed(1);
    const avgChangesPerQuarter = (totalChanges / totalQuarters).toFixed(1);
    
    const rotationCounts = Object.values(playerRotations);
    
    if (rotationCounts.length === 0) {
        container.innerHTML = `
            <div class="info-item">
                <div class="info-label">Total de Cambios</div>
                <div class="info-value">0</div>
            </div>
            <div class="info-item" style="grid-column: 1 / -1;">
                <div style="text-align: center; color: #bae6fd; font-size: 14px;">
                    No hay cambios registrados durante los cuartos
                </div>
            </div>
        `;
        return;
    }
    
    const maxRotations = Math.max(...rotationCounts);
    const minRotations = Math.min(...rotationCounts);
    const avgRotations = (rotationCounts.reduce((a, b) => a + b, 0) / rotationCounts.length).toFixed(1);
    
    const mostRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === maxRotations
    );
    const leastRotatedPlayerNum = Object.keys(playerRotations).find(
        num => playerRotations[num] === minRotations
    );
    
    let mostRotatedPlayer = 'N/A';
    let leastRotatedPlayer = 'N/A';
    
    matchesWithTime.forEach(match => {
        const playerMost = match.jugadors.find(j => j.numero === parseInt(mostRotatedPlayerNum));
        const playerLeast = match.jugadors.find(j => j.numero === parseInt(leastRotatedPlayerNum));
        
        if (playerMost) mostRotatedPlayer = `${playerMost.numero}. ${playerMost.nom.split(' ')[0]}`;
        if (playerLeast) leastRotatedPlayer = `${playerLeast.numero}. ${playerLeast.nom.split(' ')[0]}`;
    });
    
    container.innerHTML = `
        <div class="info-item">
            <div class="info-label">Total de Cambios (Rotaciones)</div>
            <div class="info-value">${totalChanges}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Partido</div>
            <div class="info-value">${avgChangesPerMatch}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Cambios/Cuarto</div>
            <div class="info-value">${avgChangesPerQuarter}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Más Rotado</div>
            <div class="info-value">${mostRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${maxRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Jugador Menos Rotado</div>
            <div class="info-value">${leastRotatedPlayer}</div>
            <div style="font-size: 11px; color: #bae6fd; margin-top: 4px;">
                ${minRotations} entradas al agua
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Promedio Rotaciones/Jugador</div>
            <div class="info-value">${avgRotations}</div>
        </div>
    `;
}

// ============================================
// FIN FUNCIONES PARA ESTADÍSTICAS DE TIEMPO
// ============================================
function renderGoalkeeperSavesChart() {
    const ctx = document.getElementById('goalkeeperSavesChart');
    if (!ctx) return;
    
    if (window.goalkeeperSavesChartInstance) {
        window.goalkeeperSavesChartInstance.destroy();
    }
    
    const goalkeeperStats = {};
    
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            const isGoalkeeper = j.numero === 1 || j.numero === 13;
            if (!isGoalkeeper) return;
            
            const playerName = j.nom.trim();
            
            if (!goalkeeperStats[playerName]) {
                goalkeeperStats[playerName] = {
                    num: j.numero,
                    name: playerName,
                    parades: 0,
                    paradeTypes: { corner: 0, rebuig: 0, atrapa: 0,penal: 0 }
                };
            }
            
            goalkeeperStats[playerName].parades += (j.estadistiques.parades || 0);
            
            if (j.estadistiques.paradeTypes) {
                goalkeeperStats[playerName].paradeTypes.corner += (j.estadistiques.paradeTypes.corner || 0);
                goalkeeperStats[playerName].paradeTypes.rebuig += (j.estadistiques.paradeTypes.rebuig || 0);
                goalkeeperStats[playerName].paradeTypes.atrapa += (j.estadistiques.paradeTypes.atrapa || 0);
				goalkeeperStats[playerName].paradeTypes.penal += (j.estadistiques.paradeTypes.penal || 0);
            }
        });
    });
    
    const goalkeepers = Object.values(goalkeeperStats);
    
    if (goalkeepers.length === 0) {
        ctx.parentElement.innerHTML = '<div class="no-data">No hay datos de paradas de porteros</div>';
        return;
    }
    
    const labels = goalkeepers.map(gk => `${gk.num}. ${gk.name.split(' ')[0]}`);
    
    window.goalkeeperSavesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
  {
    label: 'Corner',
    data: goalkeepers.map(gk => (gk.paradeTypes?.corner ?? 0)),
    backgroundColor: '#3b82f6'
  },
  {
    label: 'Rebuig',
    data: goalkeepers.map(gk => (gk.paradeTypes?.rebuig ?? 0)),
    backgroundColor: '#f97316'
  },
  {
    label: 'Atrapa',
    data: goalkeepers.map(gk => (gk.paradeTypes?.atrapa ?? 0)),
    backgroundColor: '#22c55e'
  },
  {
    label: 'Penal',
    data: goalkeepers.map(gk => (gk.paradeTypes?.penal ?? 0)),
    backgroundColor: '#eab308'
  }
]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: 'white', font: { size: 14 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y || 0;
                            return `${label}: ${value} parades`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    title: {
                        display: true,
                        text: 'Parades',
                        color: 'white'
                    }
                },
                x: { 
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
}
// ✅ NUEVO: Variables globals per ordenació
let currentSortColumn = 'gols';
let currentSortOrder = 'desc';
let cachedPlayersData = [];

function sortTable(column) {
    if (currentSortColumn === column) {
        // Canviar ordre si és la mateixa columna
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        // Nova columna, ordre descendent per defecte
        currentSortColumn = column;
        currentSortOrder = 'desc';
    }
    
    const sortedPlayers = [...cachedPlayersData].sort((a, b) => {
        let valA, valB;
        
        switch(column) {
            case 'num':
                valA = a.num;
                valB = b.num;
                break;
            case 'name':
                return currentSortOrder === 'desc' 
                    ? b.name.localeCompare(a.name)
                    : a.name.localeCompare(b.name);
            case 'partidos':
                valA = a.partidos;
                valB = b.partidos;
                break;
            case 'gols':
                valA = a.gols;
                valB = b.gols;
                break;
            case 'h+':
                valA = a.goalTypes['h+'] || 0;
                valB = b.goalTypes['h+'] || 0;
                break;
            case 'penalty':
                valA = a.goalTypes.penalty || 0;
                valB = b.goalTypes.penalty || 0;
                break;
            case 'contra':
                valA = a.goalTypes.contra || 0;
                valB = b.goalTypes.contra || 0;
                break;
            case 'boya':
                valA = a.goalTypes.boya || 0;
                valB = b.goalTypes.boya || 0;
                break;
            case 'normal':
                valA = a.goalTypes.normal || 0;
                valB = b.goalTypes.normal || 0;
                break;
            case 'exclusions':
                valA = a.exclusions;
                valB = b.exclusions;
                break;
            case 'parades':
                valA = a.parades || 0;
                valB = b.parades || 0;
                break;
            case 'assistencies':
                valA = a.assistencies || 0;
                valB = b.assistencies || 0;
                break;
            case 'robatoris':
                valA = a.robatoris || 0;
                valB = b.robatoris || 0;
                break;
            case 'perdues':
                valA = a.perdues || 0;
                valB = b.perdues || 0;
                break;
			case 'blocks':
    valA = (a.blocks || 0) + (a.blocatges || 0);
    valB = (b.blocks || 0) + (b.blocatges || 0);
    break;	
            case 'xutsFallats':
                valA = a.xutsFallats || 0;
                valB = b.xutsFallats || 0;
                break;
            case 'penaltyMissed':
                valA = a.penaltyMissed || 0;
                valB = b.penaltyMissed || 0;
                break;
				case 'eficienciaTir':
			case 'blocks':
    valA = a.blocks || 0;
    valB = b.blocks || 0;
    break;
case 'faltesRebudes':
    valA = a.faltesRebudes || 0;
    valB = b.faltesRebudes || 0;
    break;
    const xutsA = a.gols + (a.xutsFallats || 0);
    const xutsB = b.gols + (b.xutsFallats || 0);
    valA = xutsA > 0 ? (a.gols / xutsA * 100) : 0;
    valB = xutsB > 0 ? (b.gols / xutsB * 100) : 0;
    break;
            case 'mediaGols':
    valA = a.partidos > 0 ? a.gols / a.partidos : 0;
    valB = b.partidos > 0 ? b.gols / b.partidos : 0;
    break;
case 'valor':
    valA = calculatePlayerValue({
        goalTypes: a.goalTypes,
        assistencies: a.assistencies,
        robatoris: a.robatoris,
        blocatges: a.blocatges,
        parades: a.parades,
        faltesRebudes: a.faltesRebudes,
        exclusionTypes: a.exclusionTypes,
        penaltyMissed: a.penaltyMissed,
        perdues: a.perdues,
        xutsFallats: a.xutsFallats
    });
    valB = calculatePlayerValue({
        goalTypes: b.goalTypes,
        assistencies: b.assistencies,
        robatoris: b.robatoris,
        blocatges: b.blocatges,
        parades: b.parades,
        faltesRebudes: b.faltesRebudes,
        exclusionTypes: b.exclusionTypes,
        penaltyMissed: b.penaltyMissed,
        perdues: b.perdues,
        xutsFallats: b.xutsFallats
    });
    break;
default:
    return 0;
        }
        
        return currentSortOrder === 'desc' ? valB - valA : valA - valB;
    });
    
    renderComparisonTable(sortedPlayers);
}

function renderComparisonTable(players) {
    const getSortIndicator = (column) => {
        if (currentSortColumn !== column) return '';
        return currentSortOrder === 'desc' ? ' ▼' : ' ▲';
    };
    
    document.getElementById('comparisonTable').innerHTML = `
        <thead>
            <tr>
                <th onclick="sortTable('num')" style="cursor: pointer;">Nº${getSortIndicator('num')}</th>
                <th onclick="sortTable('name')" style="cursor: pointer;">Jugador${getSortIndicator('name')}</th>
                <th onclick="sortTable('partidos')" style="cursor: pointer;">Partidos${getSortIndicator('partidos')}</th>
                <th onclick="sortTable('gols')" style="cursor: pointer;">Goles${getSortIndicator('gols')}</th>
                <th onclick="sortTable('h+')" style="cursor: pointer;">H+${getSortIndicator('h+')}</th>
                <th onclick="sortTable('penalty')" style="cursor: pointer;">Penalty${getSortIndicator('penalty')}</th>
                <th onclick="sortTable('contra')" style="cursor: pointer;">Contra${getSortIndicator('contra')}</th>
                <th onclick="sortTable('boya')" style="cursor: pointer;">Boya${getSortIndicator('boya')}</th>
                <th onclick="sortTable('normal')" style="cursor: pointer;">Normal${getSortIndicator('normal')}</th>
                <th onclick="sortTable('exclusions')" style="cursor: pointer;">Exclusiones${getSortIndicator('exclusions')}</th>
                <th onclick="sortTable('parades')" style="cursor: pointer;">🧤 Parades${getSortIndicator('parades')}</th>
                <th onclick="sortTable('assistencies')" style="cursor: pointer;">🎯 Assist${getSortIndicator('assistencies')}</th>
                <th onclick="sortTable('robatoris')" style="cursor: pointer;">🛡️ Rob${getSortIndicator('robatoris')}</th>
                <th onclick="sortTable('blocks')" style="cursor: pointer;">🚫 Blocks${getSortIndicator('blocks')}</th>
                <th onclick="sortTable('perdues')" style="cursor: pointer;">❌ Pèrd${getSortIndicator('perdues')}</th>
                <th onclick="sortTable('faltesRebudes')" style="cursor: pointer;">⚠️ FR${getSortIndicator('faltesRebudes')}</th>
                <th onclick="sortTable('xutsFallats')" style="cursor: pointer;">🚫 Xuts${getSortIndicator('xutsFallats')}</th>
                <th onclick="sortTable('penaltyMissed')" style="cursor: pointer;">Pen. Fallados${getSortIndicator('penaltyMissed')}</th>
                <th onclick="sortTable('eficienciaTir')" style="cursor: pointer;">🎯 Efic. Tir${getSortIndicator('eficienciaTir')}</th>
                <th onclick="sortTable('mediaGols')" style="cursor: pointer;">Media Goles/P${getSortIndicator('mediaGols')}</th>
                <th onclick="sortTable('valor')" style="cursor: pointer;">⭐ Valor${getSortIndicator('valor')}</th>
            </tr>
        </thead>
        <tbody>
            ${players.map(p => {
                const totalBlocks = (p.blocks || 0) + (p.blocatges || 0);
                const totalXuts = p.gols + (p.xutsFallats || 0);
                const efic = totalXuts > 0 ? (p.gols / totalXuts * 100) : 0;
                const eficColor = efic >= 50 ? '#22c55e' : efic >= 30 ? '#fbbf24' : '#ef4444';
                const mediaGols = p.partidos > 0 ? (p.gols / p.partidos) : 0;
                
                const valor = calculatePlayerValue({
                    gols: p.gols,
                    goalTypes: p.goalTypes,
                    assistencies: p.assistencies,
                    robatoris: p.robatoris,
                    blocatges: totalBlocks,
                    parades: p.parades,
                    faltesRebudes: p.faltesRebudes || 0,
                    exclusions: p.exclusions,
                    exclusionTypes: p.exclusionTypes || { normal: 0, penalty: 0 },
                    penaltyMissed: p.penaltyMissed,
                    perdues: p.perdues,
                    xutsFallats: p.xutsFallats
                });
                
                const valorColor = valor >= 10 ? '#22c55e' : valor >= 5 ? '#fbbf24' : '#ef4444';
                
                return `
                <tr>
                    <td><div class="player-num" style="width: 30px; height: 30px; font-size: 12px;">${p.num}</div></td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.partidos}</td>
                    <td><strong style="color: #fde047;">${p.gols}</strong></td>
                    <td>${p.goalTypes['h+'] || 0}</td>
                    <td>${p.goalTypes.penalty || 0}</td>
                    <td>${p.goalTypes.contra || 0}</td>
                    <td>${p.goalTypes.boya || 0}</td>
                    <td>${p.goalTypes.normal || 0}</td>
                    <td>${p.exclusions}</td>
                    <td style="color: #8b5cf6; font-weight: bold;">${p.parades || 0}</td>
                    <td style="color: #22c55e; font-weight: bold;">${p.assistencies || 0}</td>
                    <td style="color: #06b6d4; font-weight: bold;">${p.robatoris || 0}</td>
                    <td style="color: #a78bfa; font-weight: bold;">${totalBlocks}</td>
                    <td style="color: #ef4444; font-weight: bold;">${p.perdues || 0}</td>
                    <td style="color: #fbbf24; font-weight: bold;">${p.faltesRebudes || 0}</td>
                    <td style="color: #f97316; font-weight: bold;">${p.xutsFallats || 0}</td>
                    <td style="color: ${(p.penaltyMissed || 0) > 0 ? '#ef4444' : '#22c55e'}; font-weight: bold;">${p.penaltyMissed || 0}</td>
                    <td style="color: ${eficColor}; font-weight: bold;">${efic.toFixed(1)}%</td>
                    <td>${mediaGols.toFixed(1)}</td>
                    <td style="color: ${valorColor}; font-weight: bold;">${valor.toFixed(1)}</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    `;
}

function normalizeAllPlayers(matchData) {
  const norm = (p) => {
    p.estadistiques = p.estadistiques || {};
    p.estadistiques.goalTypes = { normal:0, 'h+':0, penalty:0, contra:0, boya:0, ...(p.estadistiques.goalTypes||{}) };
    p.estadistiques.exclusionTypes = { normal:0, penalty:0, ...(p.estadistiques.exclusionTypes||{}) };
    p.estadistiques.paradeTypes = { corner:0, rebuig:0, atrapa:0, penal:0, ...(p.estadistiques.paradeTypes||{}) };
    p.estadistiques.gols = p.estadistiques.gols ?? (
      (p.estadistiques.goalTypes.normal||0) + (p.estadistiques.goalTypes['h+']||0) +
      (p.estadistiques.goalTypes.penalty||0) + (p.estadistiques.goalTypes.contra||0) +
      (p.estadistiques.goalTypes.boya||0)
    );
    return p;
  };
  if (matchData?.data?.players) matchData.data.players = matchData.data.players.map(norm);
  if (matchData?.data?.rivalPlayers) matchData.data.rivalPlayers = matchData.data.rivalPlayers.map(norm);
}
// ============================================
// FUNCIONS PER ESTADÍSTIQUES DE ZONES
// ============================================

function renderGoalZoneStats() {
    if (allMatches.length === 0) return;
    
    console.log('🎯 renderGoalZoneStats INICIADA');
    
    // Calcular zones globals
    const globalZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    allMatches.forEach(match => {
    // NOMÉS jugadors del CN Terrassa (no rivals)
    match.jugadors.forEach(j => {
        // Saltar jugadors que no tenen número (indicaria que són rivals)
        if (!j.numero) return;
        
        const playerName = j.nom.trim();
            
            if (!playerZones[playerName]) {
                playerZones[playerName] = {
                    num: j.numero,
                    name: playerName,
                    totalGols: 0,
                    zones: {
    'top-left': 0, 'top-center': 0, 'top-right': 0,
    'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
    'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
    'unknown': 0
}
                };
            }
            
            playerZones[playerName].totalGols += j.estadistiques.gols || 0;
            
            // Debug: Comprovar si hi ha dades de zones
            if (j.estadistiques.goalZones) {
               console.log(`Jugador ${playerName} (${j.numero}) té zones:`, JSON.stringify(j.estadistiques.goalZones), 'Total gols:', j.estadistiques.gols);
                Object.keys(j.estadistiques.goalZones).forEach(zone => {
                    const count = j.estadistiques.goalZones[zone] || 0;
                    globalZones[zone] = (globalZones[zone] || 0) + count;
                    playerZones[playerName].zones[zone] = (playerZones[playerName].zones[zone] || 0) + count;
                });
            }
        });
    });
    
    const totalGols = Object.values(globalZones).reduce((sum, count) => sum + count, 0) - globalZones.unknown;
    
    console.log('📊 Total gols amb zona:', totalGols);
    console.log('📊 Zones globals:', globalZones);
    
    // Si no hi ha dades de zones, mostrar missatge informatiu
    if (totalGols === 0) {
        console.warn('⚠️ No hi ha dades de zones de porteria');
        
        const noDataHTML = `
            <div class="card" id="goalZonesAnalysisCard">
                <h2 class="section-title">🎯 Anàlisi de Zones de Porteria</h2>
                <div class="no-data" style="padding: 40px; text-align: center;">
                    <p style="font-size: 16px; color: #fbbf24; margin-bottom: 10px;">⚠️ No hi ha dades de zones de porteria</p>
                    <p style="font-size: 14px; color: #bae6fd;">
                        Els partits nous registrats amb l'app actualitzada mostraran les zones on es marquen els gols.
                    </p>
                    <p style="font-size: 12px; color: #bae6fd; margin-top: 10px;">
                        Partits analitzats: ${allMatches.length}
                    </p>
                </div>
            </div>
        `;
        
        const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
        
        if (comparisonTable) {
            const existingCard = document.getElementById('goalZonesAnalysisCard');
            if (existingCard) existingCard.remove();
            
            comparisonTable.insertAdjacentHTML('beforebegin', noDataHTML);
            console.log('✅ Card "no data" inserit');
        }
        
        return;
    }
    
    // Top 6 golejadors
    const topScorers = Object.values(playerZones)
        .filter(p => p.totalGols > 0)
        .sort((a, b) => b.totalGols - a.totalGols)
        .slice(0, 6);
    
    console.log('👤 Top scorers:', topScorers.length);
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const zoneLabelsShort = {
        'top-left': '⬆️E',
        'top-center': '⬆️C',
        'top-right': '⬆️D',
        'mid-left': '➡️E',
        'mid-center': '🎯',
        'mid-right': '⬅️D',
        'bottom-left': '⬇️E',
        'bottom-center': '⬇️B',
        'bottom-right': '⬇️D'
    };
    
    const maxCountGlobal = Math.max(...zoneOrder.map(z => globalZones[z] || 0));
    
    // Crear el HTML complet del card
    const goalZonesHTML = `
        <div class="card" id="goalZonesAnalysisCard">
            <h2 class="section-title">🎯 Anàlisi de Zones de Porteria</h2>
            <p style="font-size: 12px; color: #bae6fd; margin-bottom: 15px;">
                On marquen més gols els jugadors del CN Terrassa  (Els del centre són gols de vaselina)
            </p>
            
            <!-- Heatmap Global -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">📊 Mapa Global d'Equip</h3>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = globalZones[zone] || 0;
                        const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                        const intensity = maxCountGlobal > 0 ? count / maxCountGlobal : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${globalZones.unknown > 0 ? `
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                        ❓ Gols sense zona registrada: ${globalZones.unknown}
                    </div>
                ` : ''}
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                    Total de gols amb zona: ${totalGols}
                </div>
            </div>
            
            <!-- Heatmaps Individuals -->
            <div style="margin-top: 20px;">
                <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px;">👤 Mapes Individuals (Top 6 Golejadors)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${topScorers.map(player => {
                        console.log(`🔍 ${player.name} zones individuals:`, JSON.stringify(player.zones));
                        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                        
                        const preferredZone = zoneOrder.reduce((max, zone) => 
                            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                        , zoneOrder[0]);
                        
                        const preferredZoneLabel = {
                            'top-left': 'Dalt Esquerra',
                            'top-center': 'Dalt Centre',
                            'top-right': 'Dalt Dreta',
                            'mid-left': 'Centre Esquerra',
                            'mid-center': 'Centre',
                            'mid-right': 'Centre Dreta',
                            'bottom-left': 'Baix Esquerra',
                            'bottom-center': 'Baix Centre',
                            'bottom-right': 'Baix Dreta'
                        }[preferredZone];
                        
                        return `
                            <div style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px;">
                                <div style="text-align: center; margin-bottom: 8px;">
                                    <div style="font-size: 12px; font-weight: bold; color: #22d3ee;">
                                        ${player.num}. ${player.name.split(' ')[0]}
                                    </div>
                                    <div style="font-size: 10px; color: #bae6fd; margin-top: 2px;">
                                        ${player.totalGols} gols (${totalWithZone} amb zona)
                                    </div>
                                </div>
                                
                                <div class="goal-zone-heatmap" style="max-width: 180px; margin: 0 auto;">
                                    ${zoneOrder.map(zone => {
                                        const count = player.zones[zone] || 0;
                                        const intensity = maxCount > 0 ? count / maxCount : 0;
                                        const bgColor = getHeatmapColor(intensity);
                                        
                                        return `
                                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                                <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                                <div class="zone-count">${count}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                    <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                        ⭐ ${preferredZoneLabel} (${player.zones[preferredZone]})
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Inserir el card abans de la taula de comparació
    const comparisonTable = document.querySelector('#comparisonView .card:has(#comparisonTable)');
    
    if (comparisonTable) {
        // Eliminar card anterior si existeix
        const existingCard = document.getElementById('goalZonesAnalysisCard');
        if (existingCard) {
            existingCard.remove();
        }
        
        comparisonTable.insertAdjacentHTML('beforebegin', goalZonesHTML);
        console.log('✅ Card de zones inserit correctament amb dades');
    } else {
        console.error('❌ No s\'ha trobat #comparisonTable');
    }
}
function renderSwimRacesStats() {
    if (allMatches.length === 0) return '';
    
    const swimStats = {};
    
    // ✅ FIX: Primer obtenim tots els jugadors dels partits
    const allPlayers = new Set();
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            allPlayers.add(j.nom.trim());
        });
    });
    
    // Inicialitzar tots els jugadors
    allPlayers.forEach(playerName => {
        swimStats[playerName] = { won: 0, lost: 0, total: 0 };
    });
    
    // Comptar curses
    allMatches.forEach(match => {
        if (match.chronologicalActions) {
            match.chronologicalActions.forEach(action => {
                if (action.type === 'swim-race' && action.team === 'cnt') {
                    const playerName = action.playerName;
                    if (swimStats[playerName]) {
                        swimStats[playerName].total++;
                        if (action.result === 'win') {
                            swimStats[playerName].won++;
                        } else {
                            swimStats[playerName].lost++;
                        }
                    }
                }
            });
        }
    });
    
    // Filtrar jugadors amb curses
    const playersWithSwims = Object.entries(swimStats)
        .filter(([name, data]) => data.total > 0)
        .sort((a, b) => b[1].won - a[1].won);
    
    if (playersWithSwims.length === 0) {
        return '';
    }
    
    return `
        <div class="card">
            <h2 class="section-title">🏊 Estadístiques de Curses Inicials</h2>
            <div style="overflow-x: auto;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Jugador</th>
                            <th>🏆 Guanyades</th>
                            <th>❌ Perdudes</th>
                            <th>Total</th>
                            <th>% Èxit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playersWithSwims.map(([name, data]) => {
                            const percentage = ((data.won / data.total) * 100).toFixed(1);
                            const colorClass = percentage >= 50 ? '#22c55e' : '#ef4444';
                            return `
                                <tr>
                                    <td style="font-weight: bold;">${name.split(' ')[0]}</td>
                                    <td style="color: #22c55e; font-weight: bold;">${data.won}</td>
                                    <td style="color: #ef4444;">${data.lost}</td>
                                    <td>${data.total}</td>
                                    <td style="color: ${colorClass}; font-weight: bold;">${percentage}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 15px; padding: 12px; background: rgba(34, 211, 238, 0.1); border-radius: 8px; text-align: center;">
                <div style="font-size: 12px; color: #bae6fd;">Millor cursador</div>
                <div style="font-size: 18px; color: #22d3ee; font-weight: bold; margin-top: 4px;">
                    ${playersWithSwims[0][0].split(' ')[0]} (${playersWithSwims[0][1].won}/${playersWithSwims[0][1].total})
                </div>
            </div>
        </div>
    `;
}
function renderGoalkeeperZoneStats() {
    // Aquesta funció es cridarà al displayMatchData() i displayComparison()
    
    const goalkeeperZones = {
        1: {  // Max Valls
            num: 1,
            name: 'MAX VALLS',
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        },
        13: {  // Eric Mora
            num: 13,
            name: 'ERIC MORA',
            totalGolsRebuts: 0,
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        }
    };
    
    // Acumular dades de tots els partits
    allMatches.forEach(match => {
        match.jugadors.forEach(j => {
            if ((j.numero === 1 || j.numero === 13) && j.estadistiques.golsRebutsZones) {
                Object.keys(j.estadistiques.golsRebutsZones).forEach(zone => {
                    const count = j.estadistiques.golsRebutsZones[zone] || 0;
                    goalkeeperZones[j.numero].zones[zone] += count;
                    goalkeeperZones[j.numero].totalGolsRebuts += count;
                });
            }
        });
    });
    
    return goalkeeperZones;
}
function renderGlobalZoneHeatmap(zones) {
    const container = document.getElementById('globalGoalZoneHeatmap');
    if (!container) return;
    
    const totalGols = Object.values(zones).reduce((sum, count) => sum + count, 0) - zones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades de zones disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => zones[z] || 0));
    
    container.innerHTML = `
        <div class="goal-zone-heatmap">
            ${zoneOrder.map(zone => {
                const count = zones[zone] || 0;
                const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                const intensity = maxCount > 0 ? count / maxCount : 0;
                
                // Color segons intensitat
                const bgColor = getHeatmapColor(intensity);
                
                return `
                    <div class="goal-zone-cell" style="background: ${bgColor};">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-count">${count}</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                    </div>
                `;
            }).join('')}
        </div>
        ${zones.unknown > 0 ? `
            <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                ❓ Gols sense zona registrada: ${zones.unknown}
            </div>
        ` : ''}
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #bae6fd;">
            Total de gols amb zona: ${totalGols}
        </div>
    `;
}

function renderIndividualZoneMaps(players) {
    const container = document.getElementById('individualGoalZoneMaps');
    if (!container) return;
    
    if (players.length === 0) {
        container.innerHTML = '<div class="no-data">No hi ha dades disponibles</div>';
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️E',
        'top-center': '⬆️C',
        'top-right': '⬆️D',
        'mid-left': '➡️E',
        'mid-center': '🎯',
        'mid-right': '⬅️D',
        'bottom-left': '⬇️E',
        'bottom-center': '⬇️B',
        'bottom-right': '⬇️D'
    };
    
    container.innerHTML = players.map(player => {
        const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
        const maxCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
        
        // Trobar zona preferida
        const preferredZone = zoneOrder.reduce((max, zone) => 
            (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
        , zoneOrder[0]);
        
        const preferredZoneLabel = {
            'top-left': 'Dalt Esquerra',
            'top-center': 'Dalt Centre',
            'top-right': 'Dalt Dreta',
            'mid-left': 'Centre Esquerra',
            'mid-center': 'Centre',
            'mid-right': 'Centre Dreta',
            'bottom-left': 'Baix Esquerra',
            'bottom-center': 'Baix Centre',
            'bottom-right': 'Baix Dreta'
        }[preferredZone];
        
        return `
            <div class="individual-zone-card">
                <div class="player-name">${player.num}. ${player.name.split(' ')[0]}</div>
                <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                    ${player.totalGols} gols (${totalWithZone} amb zona)
                </div>
                <div class="goal-zone-heatmap">
                    ${zoneOrder.map(zone => {
                        const count = player.zones[zone] || 0;
                        const intensity = maxCount > 0 ? count / maxCount : 0;
                        const bgColor = getHeatmapColor(intensity);
                        
                        return `
                            <div class="goal-zone-cell" style="background: ${bgColor};">
                                <div class="zone-label">${zoneLabels[zone]}</div>
                                <div class="zone-count">${count}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                    ⭐ Zona preferida: ${preferredZoneLabel}
                </div>
            </div>
        `;
    }).join('');
}

function getHeatmapColor(intensity) {
    if (intensity === 0) return 'rgba(50, 50, 50, 0.3)';
    
    // Gradient de verd (menys) a groc (mitjà) a vermell (més)
    if (intensity < 0.33) {
        const r = Math.round(34 + (251 - 34) * (intensity / 0.33));
        const g = Math.round(197 + (191 - 197) * (intensity / 0.33));
        const b = Math.round(94 + (36 - 94) * (intensity / 0.33));
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else if (intensity < 0.66) {
        const adjusted = (intensity - 0.33) / 0.33;
        const r = Math.round(251 + (249 - 251) * adjusted);
        const g = Math.round(191 + (115 - 191) * adjusted);
        const b = Math.round(36 + (22 - 36) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.8)`;
    } else {
        const adjusted = (intensity - 0.66) / 0.34;
        const r = Math.round(249 + (239 - 249) * adjusted);
        const g = Math.round(115 + (68 - 115) * adjusted);
        const b = Math.round(22 + (68 - 22) * adjusted);
        return `rgba(${r}, ${g}, ${b}, 0.9)`;
    }
}
function renderMatchGoalZones() {
    const container = document.getElementById('matchGoalZonesContainer');
    if (!container || !currentMatch) return;
    
    // ✅ Calcular zones NOMÉS d'aquest partit (no acumular de tots)
    const matchZones = {
        'top-left': 0, 'top-center': 0, 'top-right': 0,
        'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
        'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
        'unknown': 0
    };
    
    const playerZones = {};
    
    currentMatch.jugadors.forEach(j => {
        if ((j.estadistiques.gols || 0) === 0) return;
        
        const playerName = j.nom.trim();
        
        playerZones[playerName] = {
            num: j.numero,
            name: playerName,
            totalGols: j.estadistiques.gols || 0,  // ✅ Gols NOMÉS d'aquest partit
            zones: {
                'top-left': 0, 'top-center': 0, 'top-right': 0,
                'mid-left': 0, 'mid-center': 0, 'mid-right': 0,
                'bottom-left': 0, 'bottom-center': 0, 'bottom-right': 0,
                'unknown': 0
            }
        };
        
        // ✅ Només les zones d'aquest partit
        if (j.estadistiques.goalZones) {
            Object.keys(j.estadistiques.goalZones).forEach(zone => {
                const count = j.estadistiques.goalZones[zone] || 0;
                matchZones[zone] = (matchZones[zone] || 0) + count;
                playerZones[playerName].zones[zone] = count;  // ✅ Assignar directament, no sumar
            });
        }
    });
    
    const totalGols = Object.values(matchZones).reduce((sum, count) => sum + count, 0) - matchZones.unknown;
    
    if (totalGols === 0) {
        container.innerHTML = `
            <div class="no-data">
                ⚠️ Aquest partit no té dades de zones de porteria.<br>
                <small style="margin-top: 8px; display: block;">
                    Els partits nous registrats amb l'app actualitzada mostraran les zones.
                </small>
            </div>
        `;
        return;
    }
    
    const zoneOrder = [
        'top-left', 'top-center', 'top-right',
        'mid-left', 'mid-center', 'mid-right',
        'bottom-left', 'bottom-center', 'bottom-right'
    ];
    
    const zoneLabels = {
        'top-left': '⬆️ Esq',
        'top-center': '⬆️ Centre',
        'top-right': '⬆️ Dret',
        'mid-left': '➡️ Esq',
        'mid-center': '🎯 Centre',
        'mid-right': '⬅️ Dret',
        'bottom-left': '⬇️ Esq',
        'bottom-center': '⬇️ Baix',
        'bottom-right': '⬇️ Dret'
    };
    
    const maxCount = Math.max(...zoneOrder.map(z => matchZones[z] || 0));
    
    // Mapa global del partit
    container.innerHTML = `
        <div style="margin-bottom: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                📊 Mapa Global del Partit
            </h3>
            <div class="goal-zone-heatmap">
                ${zoneOrder.map(zone => {
                    const count = matchZones[zone] || 0;
                    const percentage = totalGols > 0 ? ((count / totalGols) * 100).toFixed(1) : 0;
                    const intensity = maxCount > 0 ? count / maxCount : 0;
                    const bgColor = getHeatmapColor(intensity);
                    
                    return `
                        <div class="goal-zone-cell" style="background: ${bgColor};">
                            <div class="zone-label">${zoneLabels[zone]}</div>
                            <div class="zone-count">${count}</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.7);">${percentage}%</div>
                        </div>
                    `;
                }).join('')}
            </div>
            ${matchZones.unknown > 0 ? `
                <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #bae6fd;">
                    ❓ Gols sense zona registrada: ${matchZones.unknown}
                </div>
            ` : ''}
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #fde047;">
                Total de gols amb zona: ${totalGols}
            </div>
        </div>
        
        <div style="margin-top: 25px;">
            <h3 style="color: #22d3ee; font-size: 14px; margin-bottom: 10px; text-align: center;">
                👤 Zones per Jugador
            </h3>
            <div id="individualGoalZoneMaps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                ${Object.values(playerZones).map(player => {
                    const totalWithZone = Object.values(player.zones).reduce((sum, count) => sum + count, 0) - (player.zones.unknown || 0);
                    const maxPlayerCount = Math.max(...zoneOrder.map(z => player.zones[z] || 0));
                    
                    // Trobar zona preferida
                    const preferredZone = zoneOrder.reduce((max, zone) => 
                        (player.zones[zone] || 0) > (player.zones[max] || 0) ? zone : max
                    , zoneOrder[0]);
                    
                    const preferredZoneLabel = {
                        'top-left': 'Dalt Esquerra',
                        'top-center': 'Dalt Centre',
                        'top-right': 'Dalt Dreta',
                        'mid-left': 'Centre Esquerra',
                        'mid-center': 'Centre',
                        'mid-right': 'Centre Dreta',
                        'bottom-left': 'Baix Esquerra',
                        'bottom-center': 'Baix Centre',
                        'bottom-right': 'Baix Dreta'
                    }[preferredZone];
                    
                    const zoneLabelsShort = {
                        'top-left': '⬆️E',
                        'top-center': '⬆️C',
                        'top-right': '⬆️D',
                        'mid-left': '➡️E',
                        'mid-center': '🎯',
                        'mid-right': '⬅️D',
                        'bottom-left': '⬇️E',
                        'bottom-center': '⬇️B',
                        'bottom-right': '⬇️D'
                    };
                    
                    return `
                        <div class="individual-zone-card">
                            <div class="player-name">${player.num}. ${player.name.split(' ')[0]}</div>
                            <div style="font-size: 10px; color: #bae6fd; text-align: center; margin-bottom: 8px;">
                                ${player.totalGols} gols (${totalWithZone} amb zona)
                            </div>
                            <div class="goal-zone-heatmap">
                                ${zoneOrder.map(zone => {
                                    const count = player.zones[zone] || 0;
                                    const intensity = maxPlayerCount > 0 ? count / maxPlayerCount : 0;
                                    const bgColor = getHeatmapColor(intensity);
                                    
                                    return `
                                        <div class="goal-zone-cell" style="background: ${bgColor};">
                                            <div class="zone-label">${zoneLabelsShort[zone]}</div>
                                            <div class="zone-count">${count}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${totalWithZone > 0 && player.zones[preferredZone] > 0 ? `
                                <div style="font-size: 10px; color: #fde047; text-align: center; margin-top: 8px;">
                                    ⭐ ${preferredZoneLabel} (${player.zones[preferredZone]})
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

/**
 * Obtenir el temps de finalització d'un quart
 */
function getQuarterEndTime(quarterStartTimes, quarterRealEndTimes, quarter) {
    const QUARTER_DURATION = 480;
    
    // Prioritzar el temps real de finalització si existeix
    if (quarterRealEndTimes && quarterRealEndTimes[quarter]) {
        return quarterRealEndTimes[quarter];
    }
    
    // Si no existeix, utilitzar l'inici del següent quart
    const quarterOrder = ['q1', 'q2', 'q3', 'q4'];
    const currentIndex = quarterOrder.indexOf(quarter);
    
    if (currentIndex < 3) {
        const nextQuarter = quarterOrder[currentIndex + 1];
        if (quarterStartTimes[nextQuarter]) {
            return quarterStartTimes[nextQuarter];
        }
    }
    
    // Si no hi ha res, afegir 8 minuts a l'inici del quart
    return quarterStartTimes[quarter] + (QUARTER_DURATION * 1000);
}

   </script>
   <script>
    // 🔒 Bloqueo de clic derecho y atajos
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", event => {
      if ((event.ctrlKey && ["s", "u"].includes(event.key.toLowerCase())) ||
          event.key === "F12") {
        event.preventDefault();
      }
    });
    </script>
</body>
</html>
