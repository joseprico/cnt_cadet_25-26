<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CN Terrassa - Estad√≠sticas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container { max-width: 1024px; margin: 0 auto; padding: 12px; padding-top: 85px; padding-bottom: 80px; }
        .header-fixed { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: linear-gradient(90deg, #1e3a8a 0%, #0891b2 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 4px solid #22d3ee;
            z-index: 1000;
            padding: 6px 0;
        }
        .scoreboard { 
            max-width: 1024px; 
            margin: 0 auto; 
            padding: 0 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 4px;
        }
        .team-score { flex: 1; text-align: center; }
        .team-label { font-size: 9px; font-weight: bold; color: #67e8f9; margin-bottom: 1px; }
        .score-display { font-size: 28px; font-weight: 900; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .score-separator { font-size: 18px; font-weight: bold; color: #67e8f9; }
        .temps-mort-compact { 
            font-size: 8px; 
            color: #bae6fd; 
            margin-top: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }
        .card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn { 
            padding: 10px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s;
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        .btn-green { background: #22c55e; color: white; }
        .btn-green:hover { background: #16a34a; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-yellow { background: #fbbf24; color: #000; }
        .btn-yellow:hover { background: #f59e0b; }
        .tabs { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            padding: 8px;
        }
        .tab { 
            padding: 10px; 
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .tab.active { background: #06b6d4; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .players-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 4px; 
        }
        .player-card { 
            background: rgba(255,255,255,0.1); 
            border-radius: 6px; 
            padding: 6px; 
        }
        .player-header { display: flex; align-items: center; gap: 3px; margin-bottom: 3px; }
        .player-number { 
            background: #06b6d4; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 10px;
            flex-shrink: 0;
        }
        .player-number.rival { background: #ef4444; }
        .player-name-input { 
            flex: 1; 
            padding: 2px 3px; 
            font-size: 9px; 
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 3px; 
            color: white;
        }
        .player-name-input:focus { outline: none; border-color: #22d3ee; }
        .player-name-input.exc-1 { background: #fbbf24; color: #000; font-weight: bold; }
        .player-name-input.exc-2 { background: #f97316; color: white; font-weight: bold; }
        .player-name-input.exc-3 { background: #ef4444; color: white; font-weight: bold; }
        .stats-row { display: flex; gap: 3px; flex-direction: column; }
        .stat-box { background: rgba(0,0,0,0.2); border-radius: 4px; padding: 3px; }
        .stat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 2px;
        }
        .stat-label { font-size: 7px; color: #bae6fd; }
        .stat-controls { display: flex; align-items: center; gap: 2px; }
        .stat-value { font-size: 14px; font-weight: bold; min-width: 18px; text-align: center; }
        .stat-value.gols { color: #fde047; }
        .goal-type-badge {
            display: inline-block;
            padding: 1px 3px;
            font-size: 7px;
            background: #fbbf24;
            color: #000;
            border-radius: 2px;
            margin-right: 2px;
            font-weight: bold;
        }
        .input { 
            width: 100%; 
            padding: 8px 12px; 
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 8px; 
            color: white; 
            font-size: 14px;
        }
        .input:focus { outline: none; border-color: #22d3ee; }
        .input::placeholder { color: rgba(255,255,255,0.5); }
        textarea.input { min-height: 80px; font-family: inherit; resize: vertical; }
        .actions-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .lineup-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px; }
        .lineup-btn { 
            padding: 10px; 
            font-size: 13px; 
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .lineup-btn.selected { background: #22c55e; box-shadow: 0 2px 8px rgba(34,197,94,0.4); }
        .lineup-counter { text-align: center; font-size: 12px; color: #bae6fd; margin-bottom: 8px; }
        .period-scores { margin-top: 12px; }
        .period-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px; 
            background: rgba(0,0,0,0.2); 
            border-radius: 8px; 
            margin-bottom: 6px;
        }
        .period-label { font-weight: bold; font-size: 14px; }
        .period-score { font-size: 20px; font-weight: bold; color: #fde047; }
        h2 { font-size: 18px; font-weight: bold; margin-bottom: 12px; }
        .hidden { display: none; }
        label { display: block; font-size: 10px; font-weight: 600; margin-bottom: 4px; }
        svg { display: inline-block; vertical-align: middle; }
        .btn-small { padding: 2px; min-width: 20px; }
        .icon-sm { width: 10px; height: 10px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%);
            border-radius: 12px;
            padding: 20px;
            max-width: 300px;
            width: 100%;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .modal-btn {
            padding: 12px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn:hover { background: rgba(255,255,255,0.3); }
        .modal-btn.selected { 
            background: #22c55e; 
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34,197,94,0.5);
        }
        .github-status {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 12px;
            text-align: center;
        }
        .github-status.success { background: rgba(34, 197, 94, 0.3); border: 1px solid #22c55e; }
        .github-status.error { background: rgba(239, 68, 68, 0.3); border: 1px solid #ef4444; }
        .github-status.warning { background: rgba(251, 191, 36, 0.3); border: 1px solid #fbbf24; color: #000; }
    </style>
</head>
<body>
    <div class="header-fixed">
        <div class="scoreboard">
            <div class="team-score">
                <div class="team-label">CNT</div>
                <div class="score-display" id="scoreCNT">0</div>
                <div class="temps-mort-compact">
                    TM: <span id="tempsMortCNT">0</span>
                    <button class="btn btn-red" style="padding: 1px 3px; font-size: 8px;" onclick="updateTempsMortCNT(-1)">-</button>
                    <button class="btn btn-green" style="padding: 1px 3px; font-size: 8px;" onclick="updateTempsMortCNT(1)">+</button>
                </div>
            </div>
            <div class="score-separator">-</div>
            <div class="team-score">
                <div class="team-label" id="rivalTeamLabel">RIVAL</div>
                <div class="score-display" id="scoreRival">0</div>
                <div class="temps-mort-compact">
                    TM: <span id="tempsMortRival">0</span>
                    <button class="btn btn-red" style="padding: 1px 3px; font-size: 8px;" onclick="updateTempsMortRival(-1)">-</button>
                    <button class="btn btn-green" style="padding: 1px 3px; font-size: 8px;" onclick="updateTempsMortRival(1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para tipo de gol -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Tipo de Gol</div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="selectGoalType('normal')">Normal</button>
                <button class="modal-btn" onclick="selectGoalType('h+')">H+</button>
                <button class="modal-btn" onclick="selectGoalType('penalty')">Penalty</button>
                <button class="modal-btn" onclick="selectGoalType('contra')">Contra</button>
                <button class="modal-btn" onclick="selectGoalType('boya')">Boya</button>
            </div>
            <button class="btn btn-red" style="width: 100%;" onclick="closeGoalModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal para tipo de exclusi√≥n -->
    <div id="exclusionModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Tipo de Exclusi√≥n</div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="selectExclusionType('normal')">Exclusi√≥n</button>
                <button class="modal-btn" onclick="selectExclusionType('penalty')">Penalty</button>
            </div>
            <button class="btn btn-red" style="width: 100%;" onclick="closeExclusionModal()">Cancelar</button>
        </div>
    </div>

    <div class="container">
        <div class="card tabs">
            <button class="btn tab active" onclick="showView('stats')">CNT</button>
            <button class="btn tab" onclick="showView('rival')">Rival</button>
            <button class="btn tab" onclick="showView('lineups')">Alineaciones</button>
            <button class="btn tab" onclick="showView('config')">‚öôÔ∏è Config</button>
        </div>

        <!-- Vista de configuraci√≥n GitHub -->
        <div id="configView" class="hidden">
            <div class="card">
                <h2>Configuraci√≥n GitHub</h2>
                <div id="githubStatus"></div>
                <div style="margin-bottom: 12px;">
                    <label>Token de GitHub</label>
                    <input type="password" class="input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" onchange="saveGithubConfig()">
                    <p style="font-size: 10px; color: #bae6fd; margin-top: 4px;">
                        Crea un token en: Settings ‚Üí Developer settings ‚Üí Personal access tokens
                    </p>
                </div>
                <div style="margin-bottom: 12px;">
                    <label>Usuario/Repositorio</label>
                    <input type="text" class="input" id="githubRepo" value="joseprico/cnt_cadet_25-26" onchange="saveGithubConfig()">
                </div>
                <div style="margin-bottom: 12px;">
                    <label>Rama</label>
                    <input type="text" class="input" id="githubBranch" value="main" onchange="saveGithubConfig()">
                </div>
                <button class="btn btn-blue" onclick="testGithubConnection()">Probar conexi√≥n</button>
            </div>
        </div>

        <div id="statsView">
            <div class="card">
                <h2>CN TERRASSA</h2>
                <div class="players-grid" id="playersList"></div>
            </div>
        </div>

        <div id="rivalView" class="hidden">
            <div class="card">
                <div style="margin-bottom: 16px;">
                    <label>Nombre del equipo</label>
                    <input type="text" class="input" id="rivalTeamInput" placeholder="Nombre del equipo rival" onchange="updateRivalTeam()">
                </div>
                <h2>Jugadores Rival</h2>
                <div class="players-grid" id="rivalPlayersList"></div>
            </div>
        </div>

        <div id="lineupsView" class="hidden">
            <div id="lineupsContainer"></div>
        </div>

        <div class="card">
            <h2>Observacions</h2>
            <textarea class="input" id="observacions" placeholder="Anotaciones sobre el partido..."></textarea>
        </div>

        <div class="card">
            <h2>Marcadores por Periodo</h2>
            <div class="period-scores" id="periodScores"></div>
        </div>

        <div class="actions-grid">
            <button class="btn btn-green" onclick="uploadToGithub()">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Subir a GitHub
            </button>
            <button class="btn btn-yellow" onclick="exportData()">
                üíæ Guardar local
            </button>
            <button class="btn btn-red" onclick="resetAll()">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Reset
            </button>
        </div>
    </div>

    <script>
        const players = [
            { num: 1, name: 'DAVID CASADO' },
            { num: 2, name: 'SAMUEL DIAZ' },
            { num: 3, name: 'MAX CEREZO' },
            { num: 4, name: 'POL RICO' },
            { num: 5, name: 'OLIVER HERRERA' },
            { num: 6, name: 'NIL CARDENAS' },
            { num: 7, name: 'LLATZER PEREZ' },
            { num: 8, name: 'JORDI FARRE' },
            { num: 9, name: 'IVAN GALLEGO' },
            { num: 10, name: 'ADAY ACU√ëA' },
            { num: 11, name: 'HECTOR DIOS' },
            { num: 12, name: 'BIEL COBACHO' },
            { num: 13, name: 'GUILLEM POLEY' },
            { num: 14, name: 'JOSE MANUEL LLENIN' }
        ];

        let stats = {};
        let rivalStats = [];
        let lineups = { q1: [], q2: [], q3: [], q4: [] };
        let periodScores = { q1: {cnt: 0, rival: 0}, q2: {cnt: 0, rival: 0}, q3: {cnt: 0, rival: 0}, q4: {cnt: 0, rival: 0} };
        let tempsMortCNT = 0;
        let tempsMortRival = 0;
        let rivalTeam = '';
        let observacions = '';
        let currentGoalContext = null;
        let currentExclusionContext = null;
        let githubConfig = { token: '', repo: 'joseprico/cnt_cadet_25-26', branch: 'main' };

        function init() {
            loadFromLocalStorage();
            loadGithubConfig();
            
            if (Object.keys(stats).length === 0) {
                players.forEach(p => {
                    stats[p.num] = { 
                        exclusions: 0, 
                        gols: 0,
                        goalTypes: { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 },
                        exclusionTypes: { normal: 0, penalty: 0 }
                    };
                });
            }
            if (rivalStats.length === 0) {
                for (let i = 1; i <= 14; i++) {
                    rivalStats.push({ 
                        num: i, 
                        name: '', 
                        exclusions: 0, 
                        gols: 0,
                        goalTypes: { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 },
                        exclusionTypes: { normal: 0, penalty: 0 }
                    });
                }
            }
            renderPlayers();
            renderRivalPlayers();
            renderLineups();
            renderPeriodScores();
            updateScores();
            updateGithubStatus();
        }

        function saveGithubConfig() {
            githubConfig.token = document.getElementById('githubToken').value;
            githubConfig.repo = document.getElementById('githubRepo').value;
            githubConfig.branch = document.getElementById('githubBranch').value;
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            updateGithubStatus();
        }

        function loadGithubConfig() {
            const saved = localStorage.getItem('githubConfig');
            if (saved) {
                githubConfig = JSON.parse(saved);
                if (document.getElementById('githubToken')) {
                    document.getElementById('githubToken').value = githubConfig.token;
                    document.getElementById('githubRepo').value = githubConfig.repo;
                    document.getElementById('githubBranch').value = githubConfig.branch;
                }
            }
        }

        function updateGithubStatus() {
            const statusDiv = document.getElementById('githubStatus');
            if (!statusDiv) return;
            
            if (!githubConfig.token) {
                statusDiv.innerHTML = '<div class="github-status warning">‚ö†Ô∏è Token de GitHub no configurado</div>';
            } else {
                statusDiv.innerHTML = '<div class="github-status success">‚úì Configuraci√≥n guardada</div>';
            }
        }

        async function testGithubConnection() {
            const statusDiv = document.getElementById('githubStatus');
            if (!githubConfig.token) {
                statusDiv.innerHTML = '<div class="github-status error">‚ùå Configura primero el token</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="github-status">üîÑ Probando conexi√≥n...</div>';

            try {
                const [owner, repo] = githubConfig.repo.split('/');
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="github-status success">‚úì Conexi√≥n exitosa</div>';
                } else {
                    statusDiv.innerHTML = '<div class="github-status error">‚ùå Error: Verifica token y repositorio</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="github-status error">‚ùå Error de conexi√≥n</div>';
            }
        }

        async function uploadToGithub() {
            if (!githubConfig.token) {
                alert('Configura primero el token de GitHub en la pesta√±a Config');
                return;
            }

            observacions = document.getElementById('observacions').value;
            const data = {
                temporada: '25/26 CADET',
                equip: 'CN TERRASSA',
                data: new Date().toISOString(),
                scoreCNT: Object.values(stats).reduce((sum, s) => sum + s.gols, 0),
                scoreRival: rivalStats.reduce((sum, p) => sum + p.gols, 0),
                lineups,
                periodScores,
                tempsMortCNT,
                tempsMortRival,
                rivalTeam,
                rivalStats,
                jugadors: players.map(p => ({
                    numero: p.num,
                    nom: p.name,
                    estadistiques: stats[p.num]
                })),
                observacions
            };

            const fileName = `cnt_stats_${new Date().toISOString().split('T')[0]}.json`;
            const [owner, repo] = githubConfig.repo.split('/');

            try {
                // Verificar si el archivo ya existe
                let sha = null;
                try {
                    const checkResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}?ref=${githubConfig.branch}`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // El archivo no existe, est√° bien
                }

                // Subir o actualizar el archivo
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const uploadData = {
                    message: `Actualizar estad√≠sticas - ${new Date().toLocaleDateString('es-ES')}`,
                    content: content,
                    branch: githubConfig.branch
                };

                if (sha) {
                    uploadData.sha = sha;
                }

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });

                if (response.ok) {
                    alert('‚úì Archivo subido exitosamente a GitHub');
                } else {
                    const error = await response.json();
                    alert('Error al subir: ' + (error.message || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        function exportData() {
            observacions = document.getElementById('observacions').value;
            const data = {
                temporada: '25/26 CADET',
                equip: 'CN TERRASSA',
                data: new Date().toISOString(),
                scoreCNT: Object.values(stats).reduce((sum, s) => sum + s.gols, 0),
                scoreRival: rivalStats.reduce((sum, p) => sum + p.gols, 0),
                lineups,
                periodScores,
                tempsMortCNT,
                tempsMortRival,
                rivalTeam,
                rivalStats,
                jugadors: players.map(p => ({
                    numero: p.num,
                    nom: p.name,
                    estadistiques: stats[p.num]
                })),
                observacions
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cnt_stats_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveToLocalStorage() {
            const data = {
                stats,
                rivalStats,
                lineups,
                periodScores,
                tempsMortCNT,
                tempsMortRival,
                rivalTeam,
                observacions: document.getElementById('observacions')?.value || '',
                players: players.map(p => ({ num: p.num, name: p.name }))
            };
            localStorage.setItem('cntWaterpoloData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('cntWaterpoloData');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.stats) stats = data.stats;
                    if (data.rivalStats) rivalStats = data.rivalStats;
                    if (data.lineups) lineups = data.lineups;
                    if (data.periodScores) periodScores = data.periodScores;
                    if (data.tempsMortCNT !== undefined) tempsMortCNT = data.tempsMortCNT;
                    if (data.tempsMortRival !== undefined) tempsMortRival = data.tempsMortRival;
                    if (data.rivalTeam) rivalTeam = data.rivalTeam;
                    if (data.observacions) observacions = data.observacions;
                    if (data.players) {
                        data.players.forEach(p => {
                            const player = players.find(pl => pl.num === p.num);
                            if (player) player.name = p.name;
                        });
                    }
                    
                    if (document.getElementById('tempsMortCNT')) {
                        document.getElementById('tempsMortCNT').textContent = tempsMortCNT;
                    }
                    if (document.getElementById('tempsMortRival')) {
                        document.getElementById('tempsMortRival').textContent = tempsMortRival;
                    }
                    if (document.getElementById('rivalTeamInput')) {
                        document.getElementById('rivalTeamInput').value = rivalTeam;
                        document.getElementById('rivalTeamLabel').textContent = rivalTeam || 'RIVAL';
                    }
                    if (document.getElementById('observacions')) {
                        document.getElementById('observacions').value = observacions;
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos guardados:', error);
            }
        }

        function openGoalModal(playerNum, isRival, increment) {
            if (increment < 0) {
                if (isRival) {
                    updateRivalStat(playerNum, 'gols', increment);
                } else {
                    updateStat(playerNum, 'gols', increment);
                }
                return;
            }
            
            currentGoalContext = { playerNum, isRival };
            document.getElementById('goalModal').classList.add('show');
        }

        function selectGoalType(type) {
            if (!currentGoalContext) return;
            
            const { playerNum, isRival } = currentGoalContext;
            
            if (isRival) {
                if (!rivalStats[playerNum].goalTypes) {
                    rivalStats[playerNum].goalTypes = { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 };
                }
                rivalStats[playerNum].gols++;
                rivalStats[playerNum].goalTypes[type]++;
                document.getElementById(`rival-gols-${playerNum}`).textContent = rivalStats[playerNum].gols;
                renderRivalPlayers();
            } else {
                if (!stats[playerNum].goalTypes) {
                    stats[playerNum].goalTypes = { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 };
                }
                stats[playerNum].gols++;
                stats[playerNum].goalTypes[type]++;
                document.getElementById(`gols-${playerNum}`).textContent = stats[playerNum].gols;
                renderPlayers();
            }
            
            updateScores();
            if (lineups.q4.length === 7) {
                calculateFinalQuarter();
            }
            saveToLocalStorage();
            
            closeGoalModal();
        }

        function openExclusionModal(playerNum, isRival, increment) {
            if (increment < 0) {
                if (isRival) {
                    updateRivalExclusion(playerNum, increment);
                } else {
                    updateExclusion(playerNum, increment);
                }
                return;
            }
            
            currentExclusionContext = { playerNum, isRival };
            document.getElementById('exclusionModal').classList.add('show');
        }

        function selectExclusionType(type) {
            if (!currentExclusionContext) return;
            
            const { playerNum, isRival } = currentExclusionContext;
            
            if (isRival) {
                if (!rivalStats[playerNum].exclusionTypes) {
                    rivalStats[playerNum].exclusionTypes = { normal: 0, penalty: 0 };
                }
                rivalStats[playerNum].exclusions++;
                rivalStats[playerNum].exclusionTypes[type]++;
                document.getElementById(`rival-exc-${playerNum}`).textContent = rivalStats[playerNum].exclusions;
                updateRivalNameColor(playerNum, rivalStats[playerNum].exclusions);
                renderRivalPlayers();
            } else {
                if (!stats[playerNum].exclusionTypes) {
                    stats[playerNum].exclusionTypes = { normal: 0, penalty: 0 };
                }
                stats[playerNum].exclusions++;
                stats[playerNum].exclusionTypes[type]++;
                document.getElementById(`exc-${playerNum}`).textContent = stats[playerNum].exclusions;
                updatePlayerNameColor(playerNum, stats[playerNum].exclusions);
                renderPlayers();
            }
            
            saveToLocalStorage();
            closeExclusionModal();
        }

        function updateExclusion(playerNum, increment) {
            stats[playerNum].exclusions = Math.max(0, stats[playerNum].exclusions + increment);
            
            if (increment < 0) {
                const exclusionTypes = stats[playerNum].exclusionTypes;
                const types = ['penalty', 'normal'];
                for (let type of types) {
                    if (exclusionTypes[type] > 0) {
                        exclusionTypes[type]--;
                        break;
                    }
                }
                renderPlayers();
            }
            
            document.getElementById(`exc-${playerNum}`).textContent = stats[playerNum].exclusions;
            updatePlayerNameColor(playerNum, stats[playerNum].exclusions);
            saveToLocalStorage();
        }

        function updateRivalExclusion(idx, increment) {
            rivalStats[idx].exclusions = Math.max(0, rivalStats[idx].exclusions + increment);
            
            if (increment < 0) {
                const exclusionTypes = rivalStats[idx].exclusionTypes;
                const types = ['penalty', 'normal'];
                for (let type of types) {
                    if (exclusionTypes[type] > 0) {
                        exclusionTypes[type]--;
                        break;
                    }
                }
                renderRivalPlayers();
            }
            
            document.getElementById(`rival-exc-${idx}`).textContent = rivalStats[idx].exclusions;
            updateRivalNameColor(idx, rivalStats[idx].exclusions);
            saveToLocalStorage();
        }

        function closeExclusionModal() {
            document.getElementById('exclusionModal').classList.remove('show');
            currentExclusionContext = null;
        }

        function renderPlayers() {
            const container = document.getElementById('playersList');
            container.innerHTML = players.map(p => {
                const exclusions = stats[p.num]?.exclusions || 0;
                let excClass = '';
                if (exclusions === 1) excClass = 'exc-1';
                else if (exclusions === 2) excClass = 'exc-2';
                else if (exclusions >= 3) excClass = 'exc-3';
                
                const goalTypes = stats[p.num]?.goalTypes || { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 };
                let goalTypesDisplay = '';
                if (goalTypes['h+'] > 0) goalTypesDisplay += `<span class="goal-type-badge">H+:${goalTypes['h+']}</span>`;
                if (goalTypes.penalty > 0) goalTypesDisplay += `<span class="goal-type-badge">P:${goalTypes.penalty}</span>`;
                if (goalTypes.contra > 0) goalTypesDisplay += `<span class="goal-type-badge">C:${goalTypes.contra}</span>`;
                if (goalTypes.boya > 0) goalTypesDisplay += `<span class="goal-type-badge">B:${goalTypes.boya}</span>`;
                if (goalTypes.normal > 0) goalTypesDisplay += `<span class="goal-type-badge">N:${goalTypes.normal}</span>`;
                
                const exclusionTypes = stats[p.num]?.exclusionTypes || { normal: 0, penalty: 0 };
                let exclusionTypesDisplay = '';
                if (exclusionTypes.normal > 0) exclusionTypesDisplay += `<span class="goal-type-badge">EX:${exclusionTypes.normal}</span>`;
                if (exclusionTypes.penalty > 0) exclusionTypesDisplay += `<span class="goal-type-badge">P:${exclusionTypes.penalty}</span>`;
                
                return `
                <div class="player-card">
                    <div class="player-header">
                        <div class="player-number">${p.num}</div>
                        <input type="text" class="player-name-input ${excClass}" value="${p.name}" 
                               onchange="updatePlayerName(${p.num}, this.value)" placeholder="Nombre">
                    </div>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-header">
                                <div class="stat-label">Exclusions</div>
                                <div class="stat-controls">
                                    <button class="btn btn-red btn-small" onclick="openExclusionModal(${p.num}, false, -1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                    <span class="stat-value" id="exc-${p.num}">${exclusions}</span>
                                    <button class="btn btn-green btn-small" onclick="openExclusionModal(${p.num}, false, 1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            ${exclusionTypesDisplay ? `<div style="margin-top: 3px;">${exclusionTypesDisplay}</div>` : ''}
                        </div>
                        <div class="stat-box">
                            <div class="stat-header">
                                <div class="stat-label">Gols</div>
                                <div class="stat-controls">
                                    <button class="btn btn-red btn-small" onclick="openGoalModal(${p.num}, false, -1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                    <span class="stat-value gols" id="gols-${p.num}">${stats[p.num]?.gols || 0}</span>
                                    <button class="btn btn-green btn-small" onclick="openGoalModal(${p.num}, false, 1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            ${goalTypesDisplay ? `<div style="margin-top: 3px;">${goalTypesDisplay}</div>` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderRivalPlayers() {
            const container = document.getElementById('rivalPlayersList');
            container.innerHTML = rivalStats.map((p, idx) => {
                const exclusions = p.exclusions || 0;
                let excClass = '';
                if (exclusions === 1) excClass = 'exc-1';
                else if (exclusions === 2) excClass = 'exc-2';
                else if (exclusions >= 3) excClass = 'exc-3';
                
                const goalTypes = p.goalTypes || { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 };
                let goalTypesDisplay = '';
                if (goalTypes['h+'] > 0) goalTypesDisplay += `<span class="goal-type-badge">H+:${goalTypes['h+']}</span>`;
                if (goalTypes.penalty > 0) goalTypesDisplay += `<span class="goal-type-badge">P:${goalTypes.penalty}</span>`;
                if (goalTypes.contra > 0) goalTypesDisplay += `<span class="goal-type-badge">C:${goalTypes.contra}</span>`;
                if (goalTypes.boya > 0) goalTypesDisplay += `<span class="goal-type-badge">B:${goalTypes.boya}</span>`;
                if (goalTypes.normal > 0) goalTypesDisplay += `<span class="goal-type-badge">N:${goalTypes.normal}</span>`;
                
                const exclusionTypes = p.exclusionTypes || { normal: 0, penalty: 0 };
                let exclusionTypesDisplay = '';
                if (exclusionTypes.normal > 0) exclusionTypesDisplay += `<span class="goal-type-badge">EX:${exclusionTypes.normal}</span>`;
                if (exclusionTypes.penalty > 0) exclusionTypesDisplay += `<span class="goal-type-badge">P:${exclusionTypes.penalty}</span>`;
                
                return `
                <div class="player-card">
                    <div class="player-header">
                        <div class="player-number rival">${p.num}</div>
                        <input type="text" class="player-name-input ${excClass}" value="${p.name}" 
                               onchange="updateRivalName(${idx}, this.value)" placeholder="Nombre">
                    </div>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-header">
                                <div class="stat-label">Exclusions</div>
                                <div class="stat-controls">
                                    <button class="btn btn-red btn-small" onclick="openExclusionModal(${idx}, true, -1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                    <span class="stat-value" id="rival-exc-${idx}">${exclusions}</span>
                                    <button class="btn btn-green btn-small" onclick="openExclusionModal(${idx}, true, 1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            ${exclusionTypesDisplay ? `<div style="margin-top: 3px;">${exclusionTypesDisplay}</div>` : ''}
                        </div>
                        <div class="stat-box">
                            <div class="stat-header">
                                <div class="stat-label">Gols</div>
                                <div class="stat-controls">
                                    <button class="btn btn-red btn-small" onclick="openGoalModal(${idx}, true, -1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                    <span class="stat-value gols" id="rival-gols-${idx}">${p.gols || 0}</span>
                                    <button class="btn btn-green btn-small" onclick="openGoalModal(${idx}, true, 1)">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            ${goalTypesDisplay ? `<div style="margin-top: 3px;">${goalTypesDisplay}</div>` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderLineups() {
            const container = document.getElementById('lineupsContainer');
            container.innerHTML = ['q1', 'q2', 'q3', 'q4'].map((q, i) => `
                <div class="card">
                    <h2>${i + 1}¬∫ Cuarto - 7 Titulares</h2>
                    <div class="lineup-counter">${lineups[q].length}/7 seleccionados</div>
                    <div class="lineup-grid">
                        ${players.map(p => `
                            <button class="btn lineup-btn ${lineups[q].includes(p.num) ? 'selected' : ''}" 
                                    onclick="toggleLineup('${q}', ${p.num})">
                                ${p.num}. ${p.name.split(' ')[0]}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderPeriodScores() {
            const container = document.getElementById('periodScores');
            let html = '';
            ['q1', 'q2', 'q3', 'q4'].forEach((q, i) => {
                html += `
                    <div class="period-row">
                        <div class="period-label">${i + 1}¬∫ Cuarto</div>
                        <div class="period-score">${periodScores[q].cnt} - ${periodScores[q].rival}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updatePlayerName(playerNum, name) {
            const player = players.find(p => p.num === playerNum);
            if (player) {
                player.name = name;
                renderLineups();
                saveToLocalStorage();
            }
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('show');
            currentGoalContext = null;
        }

        function updateStat(playerNum, stat, increment) {
            stats[playerNum][stat] = Math.max(0, stats[playerNum][stat] + increment);
            document.getElementById(`${stat === 'exclusions' ? 'exc' : 'gols'}-${playerNum}`).textContent = stats[playerNum][stat];
            
            if (stat === 'exclusions') {
                updatePlayerNameColor(playerNum, stats[playerNum][stat]);
            }
            
            if (stat === 'gols' && increment < 0) {
                const goalTypes = stats[playerNum].goalTypes;
                const types = ['boya', 'contra', 'penalty', 'h+', 'normal'];
                for (let type of types) {
                    if (goalTypes[type] > 0) {
                        goalTypes[type]--;
                        break;
                    }
                }
                renderPlayers();
            }
            
            updateScores();
            if (lineups.q4.length === 7) {
                calculateFinalQuarter();
            }
            saveToLocalStorage();
        }

        function updateRivalStat(idx, stat, increment) {
            rivalStats[idx][stat] = Math.max(0, rivalStats[idx][stat] + increment);
            document.getElementById(`rival-${stat === 'exclusions' ? 'exc' : 'gols'}-${idx}`).textContent = rivalStats[idx][stat];
            
            if (stat === 'exclusions') {
                updateRivalNameColor(idx, rivalStats[idx][stat]);
            }
            
            if (stat === 'gols' && increment < 0) {
                const goalTypes = rivalStats[idx].goalTypes;
                const types = ['boya', 'contra', 'penalty', 'h+', 'normal'];
                for (let type of types) {
                    if (goalTypes[type] > 0) {
                        goalTypes[type]--;
                        break;
                    }
                }
                renderRivalPlayers();
            }
            
            updateScores();
            if (lineups.q4.length === 7) {
                calculateFinalQuarter();
            }
            saveToLocalStorage();
        }
        
        function updatePlayerNameColor(playerNum, exclusions) {
            const player = players.find(p => p.num === playerNum);
            if (!player) return;
            
            const nameInputs = document.querySelectorAll(`input.player-name-input[value="${player.name}"]`);
            nameInputs.forEach(input => {
                input.classList.remove('exc-1', 'exc-2', 'exc-3');
                if (exclusions === 1) input.classList.add('exc-1');
                else if (exclusions === 2) input.classList.add('exc-2');
                else if (exclusions >= 3) input.classList.add('exc-3');
            });
        }
        
        function updateRivalNameColor(idx, exclusions) {
            const cards = document.querySelectorAll('#rivalPlayersList .player-card');
            const nameInput = cards[idx]?.querySelector('.player-name-input');
            if (!nameInput) return;
            
            nameInput.classList.remove('exc-1', 'exc-2', 'exc-3');
            if (exclusions === 1) nameInput.classList.add('exc-1');
            else if (exclusions === 2) nameInput.classList.add('exc-2');
            else if (exclusions >= 3) nameInput.classList.add('exc-3');
        }

        function updateRivalName(idx, name) {
            rivalStats[idx].name = name;
            saveToLocalStorage();
        }

        function updateTempsMortCNT(increment) {
            tempsMortCNT = Math.max(0, tempsMortCNT + increment);
            document.getElementById('tempsMortCNT').textContent = tempsMortCNT;
            saveToLocalStorage();
        }

        function updateTempsMortRival(increment) {
            tempsMortRival = Math.max(0, tempsMortRival + increment);
            document.getElementById('tempsMortRival').textContent = tempsMortRival;
            saveToLocalStorage();
        }

        function updateRivalTeam() {
            rivalTeam = document.getElementById('rivalTeamInput').value;
            document.getElementById('rivalTeamLabel').textContent = rivalTeam || 'RIVAL';
            saveToLocalStorage();
        }

        function updateScores() {
            const cntScore = Object.values(stats).reduce((sum, s) => sum + s.gols, 0);
            const rivScore = rivalStats.reduce((sum, p) => sum + p.gols, 0);
            document.getElementById('scoreCNT').textContent = cntScore;
            document.getElementById('scoreRival').textContent = rivScore;
        }

        function toggleLineup(quarter, playerNum) {
            const lineup = lineups[quarter];
            const idx = lineup.indexOf(playerNum);
            if (idx > -1) {
                lineup.splice(idx, 1);
            } else if (lineup.length < 7) {
                lineup.push(playerNum);
            }
            
            if (lineup.length === 7) {
                const quarters = ['q1', 'q2', 'q3', 'q4'];
                const currentIndex = quarters.indexOf(quarter);
                if (currentIndex > 0) {
                    const previousQuarter = quarters[currentIndex - 1];
                    captureLineupScore(previousQuarter);
                }
            }
            
            renderLineups();
            saveToLocalStorage();
        }

        function captureLineupScore(quarter) {
            const cntScore = Object.values(stats).reduce((sum, s) => sum + s.gols, 0);
            const rivScore = rivalStats.reduce((sum, p) => sum + p.gols, 0);
            
            const quarters = ['q1', 'q2', 'q3', 'q4'];
            const quarterIndex = quarters.indexOf(quarter);
            const previousQuarters = quarters.slice(0, quarterIndex);
            const previousCntScore = previousQuarters.reduce((sum, q) => sum + periodScores[q].cnt, 0);
            const previousRivScore = previousQuarters.reduce((sum, q) => sum + periodScores[q].rival, 0);
            
            periodScores[quarter].cnt = cntScore - previousCntScore;
            periodScores[quarter].rival = rivScore - previousRivScore;
            
            renderPeriodScores();
        }
        
        function calculateFinalQuarter() {
            const cntScore = Object.values(stats).reduce((sum, s) => sum + s.gols, 0);
            const rivScore = rivalStats.reduce((sum, p) => sum + p.gols, 0);
            
            const previousCntScore = periodScores.q1.cnt + periodScores.q2.cnt + periodScores.q3.cnt;
            const previousRivScore = periodScores.q1.rival + periodScores.q2.rival + periodScores.q3.rival;
            
            periodScores.q4.cnt = cntScore - previousCntScore;
            periodScores.q4.rival = rivScore - previousRivScore;
            
            renderPeriodScores();
        }

        function showView(view) {
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('rivalView').classList.add('hidden');
            document.getElementById('lineupsView').classList.add('hidden');
            document.getElementById('configView').classList.add('hidden');
            document.getElementById(view + 'View').classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        function resetAll() {
            if (confirm('¬øSeguro que quieres resetear todas las estad√≠sticas?')) {
                players.forEach((p, idx) => {
                    p.name = ['DAVID CASADO', 'SAMUEL DIAZ', 'MAX CEREZO', 'POL RICO', 'OLIVER HERRERA', 'NIL CARDENAS', 'LLATZER PEREZ', 'JORDI FARRE', 'IVAN GALLEGO', 'ADAY ACU√ëA', 'HECTOR DIOS', 'BIEL COBACHO', 'GUILLEM POLEY', 'JOSE MANUEL LLENIN'][idx];
                    stats[p.num] = { 
                        exclusions: 0, 
                        gols: 0,
                        goalTypes: { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 },
                        exclusionTypes: { normal: 0, penalty: 0 }
                    };
                });
                rivalStats = [];
                for (let i = 1; i <= 14; i++) {
                    rivalStats.push({ 
                        num: i, 
                        name: '', 
                        exclusions: 0, 
                        gols: 0,
                        goalTypes: { normal: 0, 'h+': 0, penalty: 0, contra: 0, boya: 0 },
                        exclusionTypes: { normal: 0, penalty: 0 }
                    });
                }
                lineups = { q1: [], q2: [], q3: [], q4: [] };
                periodScores = { q1: {cnt: 0, rival: 0}, q2: {cnt: 0, rival: 0}, q3: {cnt: 0, rival: 0}, q4: {cnt: 0, rival: 0} };
                tempsMortCNT = 0;
                tempsMortRival = 0;
                rivalTeam = '';
                observacions = '';
                document.getElementById('rivalTeamInput').value = '';
                document.getElementById('rivalTeamLabel').textContent = 'RIVAL';
                document.getElementById('observacions').value = '';
                document.getElementById('tempsMortCNT').textContent = '0';
                document.getElementById('tempsMortRival').textContent = '0';
                renderPlayers();
                renderRivalPlayers();
                renderLineups();
                renderPeriodScores();
                updateScores();
                saveToLocalStorage();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const observacionsField = document.getElementById('observacions');
            if (observacionsField) {
                observacionsField.addEventListener('input', function() {
                    saveToLocalStorage();
                });
            }
        });

        init();
    </script>
</body>
</html>